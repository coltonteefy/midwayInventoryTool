<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Using a monospaced font for a futuristic, terminal-like feel -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <style>
    /* Global styles for the cyberpunk theme */
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #0d0c1d; /* Deep purple-blue background */
      color: #e2e8f0; /* Off-white for general text */
    }
    .neon-glow {
        box-shadow: 0 0 5px #1e90ff, 0 0 10px #1e90ff, 0 0 15px #1e90ff, 0 0 20px #1e90ff; /* Electric blue glow */
    }
    .text-glow-fuchsia {
        text-shadow: 0 0 3px #d62d88, 0 0 8px #d62d88; /* Fuchsia glow */
    }
    .text-glow-cyan {
        text-shadow: 0 0 3px #0891b2, 0 0 8px #0891b2; /* Cyan glow */
    }
    .btn-neon-cyan {
        background-color: #0891b2; /* Tailwind cyan-600 */
        color: white;
    }
    .btn-neon-cyan:hover {
        background-color: #06748c; /* Darker cyan */
    }
    .btn-neon-lime {
        background-color: #65a30d; /* Tailwind lime-600 */
        color: black;
    }
    .btn-neon-lime:hover {
        background-color: #4d820d; /* Darker lime */
    }
    .btn-neon-red {
        background-color: #dc2626; /* Tailwind red-600 */
        color: white;
    }
    .btn-neon-red:hover {
        background-color: #b91c1c; /* Darker red */
    }
    /* Custom table styling to fit the theme */
    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #1f2937; /* Darker border */
    }
    th {
      background-color: #1e1b4b; /* Dark purple header */
      font-weight: 700;
      color: #93c5fd; /* Light blue text for headers */
      text-transform: uppercase;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td.is-editing {
        background-color: #1f2937; /* Darker background when editing */
        outline: 2px solid #06b6d4; /* Neon cyan outline */
        outline-offset: -2px;
    }
    .order-card, .infographic-card {
        background-color: #1f2937; /* Dark gray for the card background */
        border: 1px solid #374151; /* Border color for the card */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* Infographic card layout */
    .infographic-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 640px) {
      .infographic-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1024px) {
      .infographic-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .infographic-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px dashed #374151;
    }
    .infographic-list li:last-child {
      border-bottom: none;
    }
    .infographic-list .rank {
      font-weight: bold;
      color: #06b6d4;
    }
    /* Modal/Drawer Styles */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 40;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    .modal-backdrop.is-open {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-main {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        background-color: #111827;
        z-index: 50;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        padding: 2rem;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
        max-height: 90%;
        overflow-y: auto;
    }
    .modal-main.is-open {
        opacity: 1;
        pointer-events: auto;
        transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>

    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>
    
    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>

    <div id="main-content" class="hidden space-y-8">
      <div class="flex justify-end items-center">
        <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs">Sign Out</button>
      </div>

      <!-- Inventory Section (now a table) -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Item Name
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Code
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Current Inventory
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Sell Price
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Total Amount Purchased
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Vials Sold
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  Image
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  COA
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700">
              <!-- Inventory rows will be added here by JS -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- New Cards for Total Cost, Revenue, and Profit -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <!-- Total Cost Card -->
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <!-- Total Revenue Card -->
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <!-- Total Profit Card -->
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>

      <!-- New Orders Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div id="orders-container" class="space-y-6">
          <!-- Order cards will be injected here -->
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
      </div>
      
      <!-- New Infographics Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <!-- Monthly Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <ul id="list-monthly-revenue" class="infographic-list"></ul>
          </div>
          <!-- Top Customers Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <ul id="list-top-customers" class="infographic-list"></ul>
          </div>
          <!-- Top Products by Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <ul id="list-top-products-revenue" class="infographic-list"></ul>
          </div>
          <!-- Top Products by Quantity Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <ul id="list-top-products-quantity" class="infographic-list"></ul>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
            No sales data to display yet.
        </div>
      </div>
    </div>
  </div>
  
  <!-- General Alert Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>

  <!-- Order Edit Modal -->
  <div id="edit-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-order-modal" class="modal-main hidden">
      <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
          <h2 class="text-2xl font-bold">Edit Order</h2>
          <button id="close-edit-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
          </button>
      </div>
      <form id="edit-order-form" class="space-y-4">
          <input type="hidden" id="edit-order-id">
          <!-- New input field for customer's name -->
          <div>
              <label for="edit-contact-name" class="block text-sm font-medium text-gray-400">Customer Name</label>
              <input type="text" id="edit-contact-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
              <label for="edit-order-total" class="block text-sm font-medium text-gray-400">Total Amount</label>
              <input type="number" step="0.01" id="edit-order-total" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
              <label for="edit-order-status" class="block text-sm font-medium text-gray-400">Payment Status</label>
              <select id="edit-order-status" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
                  <option value="Paid">Paid</option>
                  <option value="Unpaid">Unpaid</option>
              </select>
          </div>
          <div id="edit-order-items-list" class="space-y-2">
              <h3 class="text-md font-semibold text-gray-400 mt-4">Items:</h3>
              <!-- Editable items will be rendered here with labels -->
          </div>
          <div class="flex justify-between gap-4 mt-6">
              <button type="button" id="delete-order-btn" class="btn-neon-red px-4 py-2 rounded-lg font-semibold flex-1">Delete Order</button>
              <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold flex-1">Save Changes</button>
          </div>
      </form>
  </div>
  
  <!-- Firebase (v12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
      authDomain: "peptide-inventory.firebaseapp.com",
      projectId: "peptide-inventory",
      storageBucket: "peptide-inventory.firebasestorage.app",
      messagingSenderId: "547049240971",
      appId: "1:547049240971:web:83b2e836fee57bb41f578e",
      measurementId: "G-1W58JMJN37"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    try { getAnalytics(app); } catch (e) { /* ignore if blocked */ }

    const qs = (id) => document.getElementById(id);
    let userId = null;
    let totalRevenue = 0;
    let totalCost = 0;
    let allOrdersCache = [];

    // Constants for Firestore collection paths to keep things clean and reusable
    const INVENTORY_COLLECTION_PATH = 'inventory';
    const ORDERS_COLLECTION_PATH = 'orders';
    const INVENTORY_DOC_ID = 'eH6V9W9nSgX7Y4Z5J2k8'; // Replace with a dynamic ID if needed

    // DOM References for the new Edit Order feature
    const editOrderBackdrop = qs('edit-order-backdrop');
    const editOrderModal = qs('edit-order-modal');
    const closeEditModalBtn = qs('close-edit-modal-btn');
    const editOrderForm = qs('edit-order-form');
    const deleteOrderBtn = qs('delete-order-btn');

    /**
     * @description Displays a custom modal with a message.
     * @param {string} message The message to display.
     */
    function showModal(message) {
      qs('modal-message').textContent = message;
      qs('alert-modal').classList.remove('hidden');
    }

    /**
     * @description Simple email validation function using a regex.
     * @param {string} email
     * @returns {boolean}
     */
    function isValidEmail(email) {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    // Function to copy text to clipboard, uses a temporary textarea for cross-browser support in iframes
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showModal('Copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy text:', err);
            showModal('Failed to copy. Please select and copy manually.');
        } finally {
            document.body.removeChild(textarea);
        }
    }

    function formatTimestamp(ts) {
      if (!ts) return 'Unknown date';
      try {
        if (typeof ts.toDate === 'function') {
          return ts.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        const d = new Date(ts);
        if (!isNaN(d.getTime())) {
          return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      } catch (_) {}
      return 'Unknown date';
    }

    function currency(n) {
      const num = typeof n === 'number' ? n : Number(n ?? 0);
      return num.toFixed(2);
    }

    function updateFinancialUI() {
        const totalProfit = totalRevenue - totalCost;
        qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
        qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
        qs('total-profit').textContent = `$${totalProfit.toFixed(2)}`;
    }

    function updateUI(user) {
      const status = qs('status');
      const userDisplay = qs('user-id-display');
      const mainContent = qs('main-content');
      const loginForm = qs('login-form');

      if (user) {
        userId = user.uid;
        status.textContent = 'Status: Signed in';
        userDisplay.textContent = 'User ID: ' + userId;
        mainContent.classList.remove('hidden');
        loginForm.classList.add('hidden');
        listenForInventory();
        listenForOrders();
      } else {
        userId = null;
        status.textContent = 'Status: Signed out';
        userDisplay.textContent = 'User ID: N/A';
        mainContent.classList.add('hidden');
        loginForm.classList.remove('hidden');
      }
    }

    function listenForInventory() {
      if (!userId) return;
      const ref = collection(db, 'inventory');
      onSnapshot(ref, (snap) => {
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        if (snap.empty) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.setAttribute('colspan', '9');
          td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
          td.textContent = 'No inventory items.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        totalCost = 0;

        snap.forEach((d) => {
          const item = d.data();
          const tr = document.createElement('tr');
          tr.dataset.id = d.id;
          tr.className = 'hover:bg-gray-700 transition-colors duration-150';

          const nameTd = document.createElement('td');
          nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
          nameTd.textContent = item.name ?? '(no name)';
          nameTd.setAttribute('contenteditable', 'false');
          nameTd.dataset.field = 'name';

          const codeTd = document.createElement('td');
          codeTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          codeTd.textContent = item.code ?? '(no code)';

          const inventoryTd = document.createElement('td');
          inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          inventoryTd.textContent = item.currentInventory ?? 0;
          inventoryTd.setAttribute('contenteditable', 'false');
          inventoryTd.dataset.field = 'currentInventory';

          const priceTd = document.createElement('td');
          priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
          priceTd.setAttribute('contenteditable', 'false');
          priceTd.dataset.field = 'sellPricePerVial';
          priceTd.dataset.originalPrice = item.sellPricePerVial;

          const totalItemCostTd = document.createElement('td');
          totalItemCostTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          let totalItemCost = 0;
          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalItemCost = item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
          totalItemCostTd.textContent = `$${totalItemCost.toFixed(2)}`;

          const vialsSoldTd = document.createElement('td');
          vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          vialsSoldTd.textContent = item.vialsSold ?? 0;
          vialsSoldTd.setAttribute('contenteditable', 'false');
          vialsSoldTd.dataset.field = 'vialsSold';

          const imageTd = document.createElement('td');
          imageTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          imageTd.textContent = item.image ?? 'N/A';
          imageTd.dataset.field = 'image';
          imageTd.setAttribute('contenteditable', 'false');
          imageTd.addEventListener('click', () => {
            if (imageTd.textContent && imageTd.textContent !== 'N/A') {
              copyToClipboard(imageTd.textContent);
            }
          });
          
          const coaTd = document.createElement('td');
          coaTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          coaTd.textContent = item.coa ?? 'N/A';
          coaTd.dataset.field = 'coa';
          coaTd.setAttribute('contenteditable', 'false');
          coaTd.addEventListener('click', () => {
            if (coaTd.textContent && coaTd.textContent !== 'N/A') {
              copyToClipboard(coaTd.textContent);
            }
          });

          const actionTd = document.createElement('td');
          actionTd.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
          const editSaveBtn = document.createElement('button');
          editSaveBtn.textContent = 'Edit';
          editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
          
          editSaveBtn.addEventListener('click', () => {
              const isEditing = editSaveBtn.textContent === 'Edit';
              const editableTds = [nameTd, inventoryTd, priceTd, vialsSoldTd, imageTd, coaTd];

              if (isEditing) {
                  editSaveBtn.textContent = 'Save';
                  editSaveBtn.className = 'btn-neon-lime px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'true');
                      td.classList.add('is-editing');
                  });
              } else {
                  const docId = tr.dataset.id;
                  const newName = nameTd.textContent.trim();
                  const newQuantity = parseInt(inventoryTd.textContent.trim(), 10);
                  let newPrice = priceTd.textContent.trim();
                  newPrice = parseFloat(newPrice.replace(/^\$/, ''));
                  const newVialsSold = parseInt(vialsSoldTd.textContent.trim(), 10);
                  const newImage = imageTd.textContent.trim();
                  const newCoa = coaTd.textContent.trim();

                  const updateData = {};
                  if (newName !== (item.name ?? '')) updateData.name = newName;
                  if (!isNaN(newQuantity) && newQuantity !== item.currentInventory) updateData.currentInventory = newQuantity;
                  if (!isNaN(newPrice) && newPrice !== item.sellPricePerVial) updateData.sellPricePerVial = newPrice;
                  if (!isNaN(newVialsSold) && newVialsSold !== item.vialsSold) updateData.vialsSold = newVialsSold;
                  if (newImage !== (item.image ?? '')) updateData.image = newImage;
                  if (newCoa !== (item.coa ?? '')) updateData.coa = newCoa;
                  
                  if (Object.keys(updateData).length > 0) {
                      const itemRef = doc(db, 'inventory', docId);
                      updateDoc(itemRef, updateData)
                          .then(() => showModal(`Data updated for ${newName}.`))
                          .catch((e) => {
                              console.error('Error updating document:', e);
                              showModal('Error updating data. Check console for details.');
                          });
                  } else {
                      showModal('No changes to save.');
                  }

                  editSaveBtn.textContent = 'Edit';
                  editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'false');
                      td.classList.remove('is-editing');
                  });
              }
          });
          actionTd.appendChild(editSaveBtn);

          tr.appendChild(nameTd);
          tr.appendChild(codeTd);
          tr.appendChild(inventoryTd);
          tr.appendChild(priceTd);
          tr.appendChild(totalItemCostTd);
          tr.appendChild(vialsSoldTd);
          tr.appendChild(imageTd);
          tr.appendChild(coaTd);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);

          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalCost += item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
        });
        updateFinancialUI();
      }, (error) => {
        console.error('Error listening to inventory:', error);
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.setAttribute('colspan', '9');
        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
        td.textContent = 'Error loading inventory.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      });
    }

    function listenForOrders() {
      const ordersContainer = qs('orders-container');
      const loadingElement  = qs('loading-orders');
      
      const ref = collection(db, 'orders');

      onSnapshot(ref, (snap) => {
        ordersContainer.innerHTML = '';
        loadingElement.style.display = 'none';

        if (snap.empty) {
          ordersContainer.innerHTML = `
            <div class="text-center text-gray-500 py-12">
              <p class="text-lg">No orders found.</p>
              <p class="text-sm mt-2">Your orders will appear here once they've been placed.</p>
            </div>`;
          return;
        }
        
        totalRevenue = 0;
        allOrdersCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const paidOrders = allOrdersCache.filter(o => o.paymentStatus === 'Paid');

        const sortedOrders = [...allOrdersCache].sort((a, b) => {
          const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
          const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
          return timeB - timeA;
        });

        sortedOrders.forEach((order) => {
          const timestamp = formatTimestamp(order.timestamp);
          const items = Array.isArray(order.items) ? order.items : [];
          
          const itemsList = items.map(item => {
            const name = (item && item.name) ? item.name : 'Item';
            const price = (item && item.unitPrice != null) ? currency(item.unitPrice) : '0.00';
            const quantity = (item && item.quantity != null) ? item.quantity : 1;
            return `
              <li class="flex justify-between items-center mb-1">
                <span class="text-gray-400">${name} (x${quantity})</span>
                <span class="font-medium text-cyan-300">$${price}</span>
              </li>`;
          }).join('');

          const computed = items.reduce((sum, it) => sum + (Number(it?.unitPrice || 0) * Number(it?.quantity || 1)), 0);
          const totalSafe = (order.total != null) ? currency(order.total) : currency(computed);

          if (order.paymentStatus === 'Paid') {
            totalRevenue += Number(order.total || computed);
          }

          const status = order.paymentStatus || 'Unknown';
          const statusClass = status === 'Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';

          const contact = order.contactInfo || {};
          const orderIdText = order.orderId || order.id;

          const card = `
            <div class="order-card rounded-xl p-6 shadow-md border border-gray-700 relative">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start border-b pb-4 mb-4 border-gray-700">
                <div>
                  <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
                    <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
                  </h3>
                  <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
                </div>
                <div class="mt-4 sm:mt-0 text-left sm:text-right">
                  <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
                  <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                    ${status}
                  </span>
                </div>
              </div>
              <div class="mb-4">
                <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
                <ul class="list-none space-y-2 text-sm">
                  ${itemsList || '<li class="text-gray-500 italic">No items.</li>'}
                </ul>
              </div>
              <div>
                <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
                <div class="text-sm text-gray-500 space-y-1">
                  <p><span class="font-medium">Name:</span> ${contact.fullName || 'Not Provided'}</p>
                  <p><span class="font-medium">Email:</span> ${contact.email || 'Not Provided'}</p>
                  <p><span class="font-medium">Phone:</span> ${contact.phone || 'Not Provided'}</p>
                  <p><span class="font-medium">Address:</span> ${contact.shippingAddress || 'Not Provided'}</p>
                </div>
              </div>
              <!-- Edit button positioned at the bottom right of the card -->
              <div class="absolute bottom-4 right-4">
                <button class="edit-order-btn btn-neon-lime text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
                  Edit Order
                </button>
              </div>
            </div>`;
          ordersContainer.insertAdjacentHTML('beforeend', card);
        });
        updateFinancialUI();
        renderInfographics();
      }, (error) => {
        console.error('Error listening to orders:', error);
        showModal('Failed to load orders. Check console for details.');
        loadingElement.style.display = 'none';
        ordersContainer.innerHTML = `
          <div class="text-center text-red-500 py-12">
            <p class="text-lg">An error occurred.</p>
            <p class="text-sm mt-2">Check the console for more details.</p>
          </div>`;
      });
    }

    function renderInfographics() {
      const placeholder = qs('infographic-placeholder');
      const containerMonthly = qs('list-monthly-revenue');
      const containerCustomers = qs('list-top-customers');
      const containerProductsRev = qs('list-top-products-revenue');
      const containerProductsQty = qs('list-top-products-quantity');

      containerMonthly.innerHTML = '';
      containerCustomers.innerHTML = '';
      containerProductsRev.innerHTML = '';
      containerProductsQty.innerHTML = '';

      if (allOrdersCache.length === 0) {
        placeholder.classList.remove('hidden');
        return;
      }
      placeholder.classList.add('hidden');

      // 1. Monthly Revenue
      const monthlyRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.timestamp) {
          const month = order.timestamp.toDate().toLocaleString('en-US', { month: 'short', year: '2-digit' });
          monthlyRevenue[month] = (monthlyRevenue[month] || 0) + (order.total || 0);
        }
      });
      const sortedMonths = Object.keys(monthlyRevenue).sort((a, b) => {
        const [monthA, yearA] = a.split(' ');
        const [monthB, yearB] = b.split(' ');
        return new Date(`01 ${monthA} 20${yearA}`) - new Date(`01 ${monthB} 20${yearB}`);
      });
      sortedMonths.forEach(month => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${month}</span><span class="font-bold text-cyan-300">$${currency(monthlyRevenue[month])}</span>`;
        containerMonthly.appendChild(li);
      });
      
      // 2. Top Customers
      const customerRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.contactInfo?.fullName) {
          const name = order.contactInfo.fullName;
          customerRevenue[name] = (customerRevenue[name] || 0) + (order.total || 0);
        }
      });
      const sortedCustomers = Object.entries(customerRevenue).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedCustomers.forEach(([name, revenue]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">$${currency(revenue)}</span>`;
        containerCustomers.appendChild(li);
      });

      // 3. Top Products by Revenue
      const productRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.items) {
          order.items.forEach(item => {
            const name = item.name || 'Unknown Item';
            productRevenue[name] = (productRevenue[name] || 0) + (item.unitPrice * item.quantity);
          });
        }
      });
      const sortedProductsRev = Object.entries(productRevenue).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedProductsRev.forEach(([name, revenue]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">$${currency(revenue)}</span>`;
        containerProductsRev.appendChild(li);
      });

      // 4. Top Products by Quantity
      const productQuantity = {};
      allOrdersCache.forEach(order => {
        if (order.items) {
          order.items.forEach(item => {
            const name = item.name || 'Unknown Item';
            productQuantity[name] = (productQuantity[name] || 0) + (item.quantity || 0);
          });
        }
      });
      const sortedProductsQty = Object.entries(productQuantity).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedProductsQty.forEach(([name, quantity]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">${quantity} sold</span>`;
        containerProductsQty.appendChild(li);
      });
    }

    /**
     * @description Opens the edit order modal and populates it with the order data.
     * @param {object} orderData The Firestore document data for the order.
     */
    function openEditModal(orderData) {
        qs('edit-order-id').value = orderData.id;
        // Populate the new customer name field
        qs('edit-contact-name').value = orderData.contactInfo?.fullName || '';
        qs('edit-order-total').value = orderData.total ?? 0;
        qs('edit-order-status').value = orderData.paymentStatus ?? 'Unpaid';
        
        const itemsListContainer = qs('edit-order-items-list');
        itemsListContainer.innerHTML = '';
        (orderData.items || []).forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = 'flex items-center gap-2';
            // Added labels to the item inputs
            itemElement.innerHTML = `
                <label for="edit-item-name-${index}" class="sr-only">Item Name</label>
                <input type="text" id="edit-item-name-${index}" value="${item.name || ''}" class="flex-1 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-gray-300" placeholder="Item Name" disabled>
                
                <label for="edit-item-price-${index}" class="sr-only">Unit Price</label>
                <input type="number" step="0.01" id="edit-item-price-${index}" value="${item.unitPrice || 0}" class="w-24 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-gray-300" data-item-index="${index}" data-field="unitPrice">
                
                <label for="edit-item-quantity-${index}" class="sr-only">Quantity</label>
                <input type="number" id="edit-item-quantity-${index}" value="${item.quantity || 1}" class="w-16 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-gray-300" data-item-index="${index}" data-field="quantity">
            `;
            itemsListContainer.appendChild(itemElement);
        });

        editOrderModal.classList.remove('hidden');
        editOrderBackdrop.classList.remove('hidden');
        editOrderModal.classList.add('is-open');
        editOrderBackdrop.classList.add('is-open');
    }

    /**
     * @description Closes the edit order modal.
     */
    function closeEditModal() {
        editOrderModal.classList.remove('is-open');
        editOrderBackdrop.classList.remove('is-open');
        // Use a timeout to hide the modal after the transition
        setTimeout(() => {
          editOrderModal.classList.add('hidden');
          editOrderBackdrop.classList.add('hidden');
        }, 300);
    }

    /**
     * @description Handles the form submission to update the order.
     * @param {Event} e The form submit event.
     */
    async function handleEditOrder(e) {
        e.preventDefault();
        const orderId = qs('edit-order-id').value;
        const total = parseFloat(qs('edit-order-total').value);
        const paymentStatus = qs('edit-order-status').value;
        // Get the new customer name from the input field
        const newCustomerName = qs('edit-contact-name').value.trim();

        if (isNaN(total)) {
            showModal('Please enter a valid number for the total.');
            return;
        }
        if (!newCustomerName) {
            showModal('Customer name cannot be empty.');
            return;
        }

        // Gather the updated item data
        const itemInputs = document.querySelectorAll('#edit-order-items-list input[data-item-index]');
        const updatedItems = [];
        const originalOrder = allOrdersCache.find(o => o.id === orderId);

        for (let i = 0; i < itemInputs.length / 3; i++) {
            const nameInput = qs(`edit-item-name-${i}`);
            const priceInput = qs(`edit-item-price-${i}`);
            const quantityInput = qs(`edit-item-quantity-${i}`);

            const originalItem = originalOrder.items[i];
            const updatedItem = { ...originalItem };

            const newPrice = parseFloat(priceInput.value);
            const newQuantity = parseInt(quantityInput.value, 10);
            
            // Validate the new values
            if (isNaN(newPrice) || newPrice < 0) {
                showModal(`Invalid price for item ${i + 1}. Please enter a positive number.`);
                return;
            }
            if (isNaN(newQuantity) || newQuantity < 0) {
                showModal(`Invalid quantity for item ${i + 1}. Please enter a positive integer.`);
                return;
            }

            // Update the item object with the new values
            updatedItem.unitPrice = newPrice;
            updatedItem.quantity = newQuantity;
            
            updatedItems.push(updatedItem);
        }

        try {
            const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
            await updateDoc(orderRef, {
                total: total,
                paymentStatus: paymentStatus,
                'contactInfo.fullName': newCustomerName,
                items: updatedItems
            });
            showModal('Order updated successfully!');
            closeEditModal();
        } catch (error) {
            console.error('Error updating order:', error);
            showModal(`Failed to update order: ${error.message}`);
        }
    }

    /**
     * @description Deletes an order from the database.
     * @param {string} orderId The ID of the order to delete.
     */
    async function handleDeleteOrder(orderId) {
        const confirmed = window.confirm(`Are you sure you want to delete order ${orderId}? This cannot be undone.`);
        if (!confirmed) {
            return;
        }

        try {
            await deleteDoc(doc(db, ORDERS_COLLECTION_PATH, orderId));
            showModal(`Order ${orderId} has been deleted.`);
            closeEditModal();
        } catch (error) {
            console.error('Error deleting order:', error);
            showModal(`Failed to delete order: ${error.message}`);
        }
    }

    /**
     * @description Attaches all event listeners for the application.
     */
    function attachEventListeners() {
      // Event listener for the login form.
      qs('auth-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = qs('email').value;
        const password = qs('password').value;
        
        if (!isValidEmail(email)) {
          showModal('Please enter a valid email address.');
          return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            showModal('Login successful!');
        } catch (error) {
            console.error("Login failed:", error);
            let errorMessage = "Login failed. Check your credentials.";
            if (error.code === 'auth/wrong-password') {
                errorMessage = "Incorrect password. Please try again.";
            } else if (error.code === 'auth/user-not-found') {
                errorMessage = "Admin user not found.";
            }
            showModal(errorMessage);
        }
      });
      
      qs('signout-btn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          showModal('Signed out successfully.');
        } catch (error) {
          console.error("Sign out failed:", error);
          showModal(`Sign out failed: ${error.message}`);
        }
      });
      
      qs('close-modal-btn').addEventListener('click', () => qs('alert-modal').classList.add('hidden'));

      // Event delegation for dynamically created "Edit Order" buttons
      qs('orders-container').addEventListener('click', (e) => {
          const editButton = e.target.closest('.edit-order-btn');
          if (editButton) {
              const orderId = editButton.dataset.orderId;
              const orderToEdit = allOrdersCache.find(order => order.id === orderId);
              if (orderToEdit) {
                  openEditModal(orderToEdit);
              }
          }
      });

      // Event listeners for the new Order Edit Modal
      editOrderForm.addEventListener('submit', handleEditOrder);
      closeEditModalBtn.addEventListener('click', closeEditModal);
      editOrderBackdrop.addEventListener('click', closeEditModal);
      deleteOrderBtn.addEventListener('click', (e) => {
          const orderId = qs('edit-order-id').value;
          if (orderId) {
              handleDeleteOrder(orderId);
          } else {
              showModal('No order selected to delete.');
          }
      });
    }

    // Boot
    window.addEventListener('load', () => {
      try {
        onAuthStateChanged(auth, (user) => {
          console.log('Auth state changed:', user ? user.uid : 'None');
          updateUI(user);
        });
        
        attachEventListeners();
      } catch (err) {
        console.error('Init failed:', err);
        qs('status').textContent = `Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
