<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Using a monospaced font for a futuristic, terminal-like feel -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <style>
    /* Global styles for the cyberpunk theme */
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #0d0c1d; /* Deep purple-blue background */
      color: #e2e8f0; /* Off-white for general text */
    }
    .neon-glow {
        box-shadow: 0 0 5px #1e90ff, 0 0 10px #1e90ff, 0 0 15px #1e90ff, 0 0 20px #1e90ff; /* Electric blue glow */
    }
    .text-glow-fuchsia {
        text-shadow: 0 0 3px #d62d88, 0 0 8px #d62d88; /* Fuchsia glow */
    }
    .text-glow-cyan {
        text-shadow: 0 0 3px #0891b2, 0 0 8px #0891b2; /* Cyan glow */
    }
    .btn-neon-cyan {
        background-color: #0891b2; /* Tailwind cyan-600 */
        color: white;
    }
    .btn-neon-cyan:hover {
        background-color: #06748c; /* Darker cyan */
    }
    .btn-neon-lime {
        background-color: #65a30d; /* Tailwind lime-600 */
        color: black;
    }
    .btn-neon-lime:hover {
        background-color: #4d820d; /* Darker lime */
    }
    .btn-neon-red {
        background-color: #dc2626; /* Tailwind red-600 */
        color: white;
    }
    .btn-neon-red:hover {
        background-color: #b91c1c; /* Darker red */
    }
    /* Custom table styling to fit the theme */
    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #1f2937; /* Darker border */
    }
    th {
      background-color: #1e1b4b; /* Dark purple header */
      font-weight: 700;
      color: #93c5fd; /* Light blue text for headers */
      text-transform: uppercase;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td.is-editing {
        background-color: #1f2937; /* Darker background when editing */
        outline: 2px solid #06b6d4; /* Neon cyan outline */
        outline-offset: -2px;
    }
    .order-card, .infographic-card {
        background-color: #1f2937; /* Dark gray for the card background */
        border: 1px solid #374151; /* Border color for the card */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* Infographic card layout */
    .infographic-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 640px) {
      .infographic-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1024px) {
      .infographic-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .infographic-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px dashed #374151;
    }
    .infographic-list li:last-child {
      border-bottom: none;
    }
    .infographic-list .rank {
      font-weight: bold;
      color: #06b6d4;
    }
    /* Modal/Drawer Styles */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 40;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    .modal-backdrop.is-open {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-main {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        background-color: #111827;
        z-index: 50;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        padding: 2rem;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
        max-height: 90%;
        overflow-y: auto;
    }
    .modal-main.is-open {
        opacity: 1;
        pointer-events: auto;
        transform: translate(-50%, -50%) scale(1);
    }
    .full-page-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0d0c1d;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .full-page-modal.is-open {
      display: flex;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
        <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>
        
    </div>
    
    <div id="auth-buttons" class="space-x-4">
            <button id="add-cost-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Cost History</button>
            <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Sign Out</button>
        </div>
    
    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>
    
    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>

    <div id="main-content" class="hidden space-y-8">
      <!-- Inventory Section (now a table) -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Item Name
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Code
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Blend
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Current Inventory
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Sell Price
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Total Amount Purchased
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Vials Sold
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Total Vial Weight (mg)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  Image
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  COA
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700">
              <!-- Inventory rows will be added here by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- New: Add Inventory Item Section -->
      <div class="space-y-4">
          <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add New Inventory Item</h2>
          <form id="add-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <div class="w-full">
                      <label for="new-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
                      <input type="text" id="new-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" required>
                  </div>
                  <div class="w-full">
                      <label for="new-item-code" class="block text-sm font-medium text-gray-400">Item Code</label>
                      <input type="text" id="new-item-code" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MG-05" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold (Initial)</label>
                    <input type="number" id="new-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
                    <input type="number" step="0.01" id="new-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
                    <input type="number" step="0.01" id="new-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <div class="flex items-center space-x-2 mt-7">
                        <input type="checkbox" id="new-item-blend" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600">
                        <label for="new-item-blend" class="block text-sm font-medium text-gray-400">Is a Blend?</label>
                    </div>
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                      <label for="new-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
                      <input type="url" id="new-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/image.jpg">
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                      <label for="new-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
                      <input type="url" id="new-item-coa" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/coa.pdf">
                  </div>
              </div>
              <div class="space-y-4 mt-6 p-4 rounded-lg border-2 border-dashed border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-fuchsia">Initial Cost History</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      <div class="w-full">
                          <label for="new-cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                          <input type="number" step="0.01" id="new-cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="$0.00" required>
                      </div>
                      <div class="w-full">
                          <label for="new-total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                          <input type="number" id="new-total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                      </div>
                      <div class="w-full">
                          <label for="new-total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                          <input type="number" id="new-total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                      </div>
                      <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                          <label for="new-purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                          <input type="date" id="new-purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
                      </div>
                  </div>
              </div>
              <div class="flex justify-center mt-6">
                  <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Item</button>
              </div>
          </form>
      </div>

      <!-- New Cards for Total Cost, Revenue, and Profit -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <!-- Total Cost Card -->
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <!-- Total Revenue Card -->
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <!-- Total Profit Card -->
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>

      <!-- New Orders Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div id="orders-container" class="space-y-6">
          <!-- Order cards will be injected here -->
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
      </div>
      
      <!-- New Infographics Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <!-- Monthly Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <ul id="list-monthly-revenue" class="infographic-list"></ul>
          </div>
          <!-- Top Customers Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <ul id="list-top-customers" class="infographic-list"></ul>
          </div>
          <!-- Top Products by Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <ul id="list-top-products-revenue" class="infographic-list"></ul>
          </div>
          <!-- Top Products by Quantity Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <ul id="list-top-products-quantity" class="infographic-list"></ul>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
            No sales data to display yet.
        </div>
      </div>
    </div>
  </div>
  
  <!-- General Alert Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>

  <!-- Order Edit Modal -->
  <div id="edit-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-order-modal" class="modal-main hidden">
      <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
          <h2 class="text-2xl font-bold">Edit Order</h2>
          <button id="close-edit-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
          </button>
      </div>
      <form id="edit-order-form" class="space-y-4">
          <input type="hidden" id="edit-order-id">
          <!-- New input field for customer's name -->
          <div>
              <label for="edit-contact-name" class="block text-sm font-medium text-gray-400">Customer Name</label>
              <input type="text" id="edit-contact-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
              <label for="edit-order-total" class="block text-sm font-medium text-gray-400">Total Amount</label>
              <input type="number" step="0.01" id="edit-order-total" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
              <label for="edit-order-status" class="block text-sm font-medium text-gray-400">Payment Status</label>
              <select id="edit-order-status" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
                  <option value="Paid">Paid</option>
                  <option value="Unpaid">Unpaid</option>
              </select>
          </div>
          <!-- Item list with new item controls -->
          <div class="space-y-4">
            <h3 class="text-md font-semibold text-gray-400 mt-4">Order Items:</h3>
            <div id="edit-order-items-list" class="space-y-2">
                <!-- Editable items will be rendered here -->
            </div>
            
            <!-- ADDED: UI to add a new item to the order -->
            <div id="add-order-item-section" class="flex flex-col sm:flex-row gap-2 mt-4 items-end">
                <div class="flex-1 w-full">
                    <label for="add-item-select" class="block text-sm font-medium text-gray-400">Add Item</label>
                    <select id="add-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="">-- Select an item --</option>
                    </select>
                </div>
                <div class="w-20">
                    <label for="add-item-quantity" class="block text-sm font-medium text-gray-400">Qty</label>
                    <input type="number" id="add-item-quantity" value="1" min="1" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-sm text-gray-300">
                </div>
                <button type="button" id="add-item-to-order-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto mt-4 sm:mt-0">Add</button>
            </div>
          </div>
          
          <div class="flex justify-between gap-4 mt-6">
              <button type="button" id="delete-order-btn" class="btn-neon-red px-4 py-2 rounded-lg font-semibold flex-1">Delete Order</button>
              <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold flex-1">Save Changes</button>
          </div>
      </form>
  </div>
  
  <!-- Add Cost History Full-Page Modal -->
  <div id="add-cost-modal" class="full-page-modal">
    <div class="bg-gray-900 p-8 rounded-xl shadow-2xl w-full max-w-2xl">
      <div class="flex justify-between items-center text-lime-300 border-b pb-4 mb-4 border-gray-700">
        <h2 class="text-2xl font-bold">Add Cost History to Existing Item</h2>
        <button id="close-add-cost-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="add-cost-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="w-full col-span-1 md:col-span-2">
                <label for="existing-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
                <select id="existing-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
                    <option value="">-- Select an item --</option>
                </select>
            </div>
            <div class="w-full">
                <label for="cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                <input type="number" step="0.01" id="cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="$0.00" required>
            </div>
            <div class="w-full">
                <label for="total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                <input type="number" id="total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
            </div>
            <div class="w-full">
                <label for="total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                <input type="number" id="total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
            </div>
            <div class="w-full">
                <label for="purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                <input type="date" id="purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
            </div>
          </div>
          <div class="flex justify-center mt-6">
              <button type="submit" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Cost Entry</button>
          </div>
      </form>
    </div>
  </div>
  
  <!-- Firebase (v12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDocs, addDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    // ADDED: Firebase Functions (callables)
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
      authDomain: "peptide-inventory.firebaseapp.com",
      projectId: "peptide-inventory",
      storageBucket: "peptide-inventory.firebasestorage.app",
      messagingSenderId: "547049240971",
      appId: "1:547049240971:web:83b2e836fee57bb41f578e",
      measurementId: "G-1W58JMJN37"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    try { getAnalytics(app); } catch (e) { /* ignore if blocked */ }
    // ADDED: init Functions
    const fns = getFunctions(app);
    const resendFn = httpsCallable(fns, "resendOrderConfirmation");

    const qs = (id) => document.getElementById(id);
    let userId = null;
    let totalRevenue = 0;
    let totalCost = 0;
    let allOrdersCache = [];
    // Cache for previous orders to detect real state changes between snapshots
    let previousOrdersCache = new Map();
    // Cache for inventory items to quickly find them by name
    let inventoryCache = {};

    // Constants for Firestore collection paths
    const INVENTORY_COLLECTION_PATH = 'inventory';
    const ORDERS_COLLECTION_PATH = 'orders';

    // DOM References for the Edit Order feature
    const editOrderBackdrop = qs('edit-order-backdrop');
    const editOrderModal = qs('edit-order-modal');
    const closeEditModalBtn = qs('close-edit-modal-btn');
    const editOrderForm = qs('edit-order-form');
    const deleteOrderBtn = qs('delete-order-btn');
    
    // DOM References for Add Item feature
    const addItemForm = qs('add-item-form');
    const newItemNameInput = qs('new-item-name');
    const newItemCodeInput = qs('new-item-code');
    const newItemVialsSoldInput = qs('new-item-vials-sold');
    const newItemPriceInput = qs('new-item-price');
    const newItemTotalVialWeightInput = qs('new-item-total-vial-weight');
    const newItemBlendInput = qs('new-item-blend');
    const newItemImageInput = qs('new-item-image');
    const newItemCoaInput = qs('new-item-coa');
    const newCostPerKitInput = qs('new-cost-per-kit');
    const newTotalKitsBoughtInput = qs('new-total-kits-bought');
    const newTotalVialsPerKitInput = qs('new-total-vials-per-kit');
    const newPurchaseDateInput = qs('new-purchase-date');
    
    // DOM References for Add Cost History feature
    const addCostForm = qs('add-cost-form');
    const existingItemSelect = qs('existing-item-select');
    const costPerKitInput = qs('cost-per-kit');
    const totalKitsBoughtInput = qs('total-kits-bought');
    const totalVialsPerKitInput = qs('total-vials-per-kit');
    const purchaseDateInput = qs('purchase-date');
    
    // DOM References for Add Cost History Modal
    const addCostModal = qs('add-cost-modal');
    const addCostBtn = qs('add-cost-btn');
    const closeAddCostModalBtn = qs('close-add-cost-modal-btn');


    /**
     * @description Displays a custom modal with a message.
     * @param {string} message The message to display.
     */
    function showModal(message) {
      qs('modal-message').textContent = message;
      qs('alert-modal').classList.remove('hidden');
    }

    /**
     * @description Simple email validation function using a regex.
     * @param {string} email
     * @returns {boolean}
     */
    function isValidEmail(email) {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    // Function to copy text to clipboard (works inside iframes)
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showModal('Copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy text:', err);
            showModal('Failed to copy. Please select and copy manually.');
        } finally {
            document.body.removeChild(textarea);
        }
    }

    function formatTimestamp(ts) {
      if (!ts) return 'Unknown date';
      try {
        if (typeof ts.toDate === 'function') {
          return ts.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        const d = new Date(ts);
        if (!isNaN(d.getTime())) {
          return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      } catch (_) {}
      return 'Unknown date';
    }

    function currency(n) {
      const num = typeof n === 'number' ? n : Number(n ?? 0);
      return num.toFixed(2);
    }

    function updateFinancialUI() {
        const totalProfit = totalRevenue - totalCost;
        qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
        qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
        qs('total-profit').textContent = `$${totalProfit.toFixed(2)}`;
    }
    
    function updateUI(user) {
      const status = qs('status');
      const userDisplay = qs('user-id-display');
      const mainContent = qs('main-content');
      const loginForm = qs('login-form');
      const signoutBtn = qs('signout-btn');
      const addCostBtn = qs('add-cost-btn');

      if (user) {
        userId = user.uid;
        status.textContent = 'Status: Signed in';
        userDisplay.textContent = 'User ID: ' + userId;
        mainContent.classList.remove('hidden');
        loginForm.classList.add('hidden');
        signoutBtn.classList.remove('hidden');
        addCostBtn.classList.remove('hidden');
        listenForInventory();
        listenForOrders(); // start orders listener after auth
      } else {
        userId = null;
        status.textContent = 'Status: Signed out';
        userDisplay.textContent = 'User ID: N/A';
        mainContent.classList.add('hidden');
        loginForm.classList.remove('hidden');
        signoutBtn.classList.add('hidden');
        addCostBtn.classList.add('hidden');
      }
    }

    function listenForInventory() {
      if (!userId) return;
      const ref = collection(db, INVENTORY_COLLECTION_PATH);
      onSnapshot(ref, (snap) => {
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        existingItemSelect.innerHTML = '<option value="">-- Select an item --</option>'; // Clear and re-populate dropdown
        
        // ADDED: Clear and re-populate the "Add Item to Order" dropdown as well
        const addItemSelect = qs('add-item-select');
        addItemSelect.innerHTML = '<option value="">-- Select an item --</option>';

        if (snap.empty) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.setAttribute('colspan', '11');
          td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
          td.textContent = 'No inventory items.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        totalCost = 0;
        // Update the inventory cache for quick lookups
        inventoryCache = {};
        
        snap.forEach((d) => {
          const item = d.data();
          inventoryCache[d.id] = { id: d.id, ...item };
          
          // Populate the dropdown for the "Add Cost History" form
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = item.code ?? '(no code)';
          existingItemSelect.appendChild(option);

          // ADDED: Populate the dropdown for the "Add Item to Order" modal
          const addItemOption = document.createElement('option');
          addItemOption.value = d.id;
          addItemOption.textContent = item.name ?? '(no name)';
          addItemSelect.appendChild(addItemOption);

          const tr = document.createElement('tr');
          tr.dataset.id = d.id;
          tr.className = 'hover:bg-gray-700 transition-colors duration-150';

          const nameTd = document.createElement('td');
          nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
          nameTd.textContent = item.name ?? '(no name)';
          nameTd.setAttribute('contenteditable', 'false');
          nameTd.dataset.field = 'name';

          const codeTd = document.createElement('td');
          codeTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          codeTd.textContent = item.code ?? '(no code)';
          codeTd.dataset.field = 'code';

          const blendTd = document.createElement('td');
          blendTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          blendTd.textContent = item.blend ? 'Yes' : 'No';
          blendTd.dataset.field = 'blend';
          
          const inventoryTd = document.createElement('td');
          inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          inventoryTd.textContent = item.currentInventory ?? 0;
          inventoryTd.setAttribute('contenteditable', 'false');
          inventoryTd.dataset.field = 'currentInventory';

          const priceTd = document.createElement('td');
          priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
          priceTd.setAttribute('contenteditable', 'false');
          priceTd.dataset.field = 'sellPricePerVial';

          const totalItemCostTd = document.createElement('td');
          totalItemCostTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          let totalItemCost = 0;
          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalItemCost = item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
          totalItemCostTd.textContent = `$${totalItemCost.toFixed(2)}`;

          const vialsSoldTd = document.createElement('td');
          vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          vialsSoldTd.textContent = item.vialsSold ?? 0;
          vialsSoldTd.setAttribute('contenteditable', 'false');
          vialsSoldTd.dataset.field = 'vialsSold';
          
          const totalVialWeightTd = document.createElement('td');
          totalVialWeightTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          totalVialWeightTd.textContent = item.totalVialWeight ?? 0;
          totalVialWeightTd.setAttribute('contenteditable', 'false');
          totalVialWeightTd.dataset.field = 'totalVialWeight';

          const imageTd = document.createElement('td');
          imageTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          imageTd.textContent = item.image ?? 'N/A';
          imageTd.dataset.field = 'image';
          imageTd.setAttribute('contenteditable', 'false');
          imageTd.addEventListener('click', () => {
            if (imageTd.textContent && imageTd.textContent !== 'N/A') {
              copyToClipboard(imageTd.textContent);
            }
          });
          
          const coaTd = document.createElement('td');
          coaTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          coaTd.textContent = item.coa ?? 'N/A';
          coaTd.dataset.field = 'coa';
          coaTd.setAttribute('contenteditable', 'false');
          coaTd.addEventListener('click', () => {
            if (coaTd.textContent && coaTd.textContent !== 'N/A') {
              copyToClipboard(coaTd.textContent);
            }
          });

          const actionTd = document.createElement('td');
          actionTd.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
          const editSaveBtn = document.createElement('button');
          editSaveBtn.textContent = 'Edit';
          editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
          
          editSaveBtn.addEventListener('click', () => {
              const isEditing = editSaveBtn.textContent === 'Edit';
              const editableTds = [nameTd, inventoryTd, priceTd, vialsSoldTd, imageTd, coaTd, totalVialWeightTd];

              if (isEditing) {
                  editSaveBtn.textContent = 'Save';
                  editSaveBtn.className = 'btn-neon-lime px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'true');
                      td.classList.add('is-editing');
                  });
              } else {
                  const docId = tr.dataset.id;
                  const newName = nameTd.textContent.trim();
                  const newQuantity = parseInt(inventoryTd.textContent.trim(), 10);
                  let newPrice = priceTd.textContent.trim();
                  newPrice = parseFloat(newPrice.replace(/^\$/, ''));
                  const newVialsSold = parseInt(vialsSoldTd.textContent.trim(), 10);
                  const newTotalVialWeight = parseFloat(totalVialWeightTd.textContent.trim());
                  const newImage = imageTd.textContent.trim();
                  const newCoa = coaTd.textContent.trim();

                  const updateData = {};
                  if (newName !== (item.name ?? '')) updateData.name = newName;
                  if (!isNaN(newQuantity) && newQuantity !== item.currentInventory) updateData.currentInventory = newQuantity;
                  if (!isNaN(newPrice) && newPrice !== item.sellPricePerVial) updateData.sellPricePerVial = newPrice;
                  if (!isNaN(newVialsSold) && newVialsSold !== item.vialsSold) updateData.vialsSold = newVialsSold;
                  if (!isNaN(newTotalVialWeight) && newTotalVialWeight !== item.totalVialWeight) updateData.totalVialWeight = newTotalVialWeight;
                  if (newImage !== (item.image ?? '')) updateData.image = newImage;
                  if (newCoa !== (item.coa ?? '')) updateData.coa = newCoa;
                  
                  if (Object.keys(updateData).length > 0) {
                      const itemRef = doc(db, INVENTORY_COLLECTION_PATH, docId);
                      updateDoc(itemRef, updateData)
                          .then(() => showModal(`Data updated for ${newName}.`))
                          .catch((e) => {
                              console.error('Error updating document:', e);
                              showModal('Error updating data. Check console for details.');
                          });
                  } else {
                      showModal('No changes to save.');
                  }

                  editSaveBtn.textContent = 'Edit';
                  editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'false');
                      td.classList.remove('is-editing');
                  });
              }
          });
          actionTd.appendChild(editSaveBtn);

          tr.appendChild(nameTd);
          tr.appendChild(codeTd);
          tr.appendChild(blendTd);
          tr.appendChild(inventoryTd);
          tr.appendChild(priceTd);
          tr.appendChild(totalItemCostTd);
          tr.appendChild(vialsSoldTd);
          tr.appendChild(totalVialWeightTd);
          tr.appendChild(imageTd);
          tr.appendChild(coaTd);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);

          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalCost += item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
        });
        updateFinancialUI();
      }, (error) => {
        console.error('Error listening to inventory:', error);
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.setAttribute('colspan', '11');
        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
        td.textContent = 'Error loading inventory.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      });
    }

    /**
     * @description Updates the vialsSold count for items based on an order's payment status change.
     * @param {string} orderId The ID of the order.
     * @param {string} type 'increment' or 'decrement'.
     * @param {array} items The list of items to process.
     */
    // REPLACE the whole updateVialsSold(...) with this:
async function updateInventorySalesImpact(orderId, type, items) {
  // type: 'increment' when an order becomes Paid (sell items)
  //       'decrement' when an order becomes Unpaid (return items to stock)
  if (!items || items.length === 0) return;

  for (const item of items) {
    const inv = Object.values(inventoryCache).find(i => i.name === item.name);
    if (!inv) {
      console.warn(`Could not find inventory item with name: ${item.name}`);
      continue;
    }
    const delta = Number(item.quantity || 0) * (type === 'increment' ? 1 : -1);

    const newVialsSold = Number(inv.vialsSold || 0) + delta;
    const newCurrentInventory = Math.max(0, Number(inv.currentInventory || 0) - delta);

    try {
      await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), {
        vialsSold: newVialsSold,
        currentInventory: newCurrentInventory
      });
    } catch (err) {
      console.error(`Error updating inventory for ${inv.id}:`, err);
      showModal(`Error updating inventory for an item in order ${orderId}. See console for details.`);
    }
  }
}


    /**
     * @description Compares two item lists and updates vialsSold based on the net change.
     * @param {Array} prevItems The previous list of items.
     * @param {Array} currentItems The current list of items.
     */
    // REPLACE the entire compareOrderItemsAndUpdateVials(...) with this:
// Make it async and await the writes
async function compareOrderItemsAndUpdateVials(prevItems, currentItems) {
  const itemChanges = new Map(); // name -> net change in quantity

  for (const it of prevItems || []) {
    itemChanges.set(it.name, (itemChanges.get(it.name) || 0) - Number(it.quantity || 0));
  }
  for (const it of currentItems || []) {
    itemChanges.set(it.name, (itemChanges.get(it.name) || 0) + Number(it.quantity || 0));
  }

  const updates = [];
  for (const [name, change] of itemChanges.entries()) {
    if (!change) continue;
    const inv = Object.values(inventoryCache).find(i => i.name === name);
    if (!inv) continue;

    const newVialsSold = Number(inv.vialsSold || 0) + change;
    const newCurrentInventory = Math.max(0, Number(inv.currentInventory || 0) - change);

    // 👇 This is where the await goes
    updates.push(
      updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), {
        vialsSold: newVialsSold,
        currentInventory: newCurrentInventory
      })
    );
  }

  // Optionally wait for all writes to finish
  await Promise.all(updates);
}



    /**
     * @description Listens for order changes and processes ONLY real updates (no writes on first load).
     * Uses docChanges() to differentiate added/modified/removed.
     */
    function listenForOrders() {
      const ordersContainer = qs('orders-container');
      const loadingElement  = qs('loading-orders');
      const ref = collection(db, ORDERS_COLLECTION_PATH);

      onSnapshot(ref, (snap) => {
        // --- 1) Handle *real* changes only (initial load won't trigger writes) ---
        snap.docChanges().forEach((change) => {
          const id = change.doc.id;
          const currentOrder = { id, ...change.doc.data() };

          if (change.type === 'added') {
            // First time seeing this doc in this client session — seed cache only.
            previousOrdersCache.set(id, currentOrder);
            return;
          }

          if (change.type === 'removed') {
            // Optionally, if a Paid order is deleted, you might decrement vials here.
            previousOrdersCache.delete(id);
            return;
          }

          if (change.type === 'modified') {
            const previousOrder = previousOrdersCache.get(id);
if (!previousOrder) {
  previousOrdersCache.set(id, currentOrder);
  return;
}

const prevStatus = previousOrder.paymentStatus;
const curStatus  = currentOrder.paymentStatus;

const wasPaid    = prevStatus === 'Paid';
const wasUnpaid  = prevStatus === 'Unpaid';
const isPaid     = curStatus  === 'Paid';
const isUnpaid   = curStatus  === 'Unpaid';

// Only act if BOTH sides are strictly within {Paid, Unpaid}
const prevIsPaidOrUnpaid = wasPaid || wasUnpaid;
const curIsPaidOrUnpaid  = isPaid  || isUnpaid;

if (prevIsPaidOrUnpaid && curIsPaidOrUnpaid) {
  // Unpaid -> Paid: sell items
  if (wasUnpaid && isPaid) {
    updateInventorySalesImpact(currentOrder.id, 'increment', currentOrder.items);
  }
  // Paid -> Unpaid: return items to stock
  else if (wasPaid && isUnpaid) {
    updateInventorySalesImpact(currentOrder.id, 'decrement', currentOrder.items);
  }
  // Stayed Paid and items changed: adjust by the diff
  else if (wasPaid && isPaid) {
    const prevItemsStr = JSON.stringify(previousOrder.items || []);
    const curItemsStr  = JSON.stringify(currentOrder.items  || []);
    if (prevItemsStr !== curItemsStr) {
      compareOrderItemsAndUpdateVials(previousOrder.items || [], currentOrder.items || []);
    }
  }
}
// Else: one side was Pending (or any other status) — do nothing for inventory

// finally update cache
previousOrdersCache.set(id, currentOrder);
          }
        });

        // --- 2) Rebuild UI + aggregates from the full snapshot ---
        loadingElement.style.display = 'none';
        ordersContainer.innerHTML = '';

        if (snap.empty) {
          ordersContainer.innerHTML = `
            <div class="text-center text-gray-500 py-12">
              <p class="text-lg">No orders found.</p>
              <p class="text-sm mt-2">Your orders will appear here once they've been placed.</p>
            </div>`;
          // Reset caches/metrics
          allOrdersCache = [];
          totalRevenue = 0;
          previousOrdersCache.clear();
          updateFinancialUI();
          renderInfographics();
          return;
        }

        // Recompute allOrdersCache and metrics for UI
        totalRevenue = 0;
        allOrdersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Ensure cache mirrors latest state (for future change comparisons)
        previousOrdersCache.clear();
        snap.docs.forEach(d => previousOrdersCache.set(d.id, { id: d.id, ...d.data() }));

        // Sort and render cards (same as before)
        const sortedOrders = [...allOrdersCache].sort((a, b) => {
          const timeA = a.timestamp?.toMillis?.() ?? 0;
          const timeB = b.timestamp?.toMillis?.() ?? 0;
          return timeB - timeA;
        });

        sortedOrders.forEach((order) => {
          const timestamp = formatTimestamp(order.timestamp);
          const items = Array.isArray(order.items) ? order.items : [];
          
          const itemsList = items.map(item => {
            const name = item?.name ?? 'Item';
            const price = currency(item?.unitPrice ?? 0);
            const quantity = item?.quantity ?? 1;
            return `
              <li class="flex justify-between items-center mb-1">
                <span class="text-gray-400">${name} (x${quantity})</span>
                <span class="font-medium text-cyan-300">$${price}</span>
              </li>`;
          }).join('');

          const computed = items.reduce((sum, it) => sum + (Number(it?.unitPrice || 0) * Number(it?.quantity || 1)), 0);
          const totalSafe = (order.total != null) ? currency(order.total) : currency(computed);

          if (order.paymentStatus === 'Paid') {
            totalRevenue += Number(order.total || computed);
          }

          const status = order.paymentStatus || 'Unknown';
          const statusClass = status === 'Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';

          const contact = order.contactInfo || {};
          const orderIdText = order.orderId || order.id;

          const card = `
            <div class="order-card rounded-xl p-6 shadow-md border border-gray-700 relative">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start border-b pb-4 mb-4 border-gray-700">
                <div>
                  <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
                    <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
                  </h3>
                  <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
                </div>
                <div class="mt-4 sm:mt-0 text-left sm:text-right">
                  <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
                  <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                    ${status}
                  </span>
                </div>
              </div>
              <div class="mb-4">
                <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
                <ul class="list-none space-y-2 text-sm">
                  ${itemsList || '<li class="text-gray-500 italic">No items.</li>'}
                </ul>
              </div>
              <div>
                <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
                <div class="text-sm text-gray-500 space-y-1">
                  <p><span class="font-medium">Name:</span> ${contact.fullName || 'Not Provided'}</p>
                  <p><span class="font-medium">Email:</span> ${contact.email || 'Not Provided'}</p>
                  <p><span class="font-medium">Phone:</span> ${contact.phone || 'Not Provided'}</p>
                  <p><span class="font-medium">Address:</span> ${contact.shippingAddress || 'Not Provided'}</p>
                </div>
              </div>
              <!-- REPLACED: Actions container -> now has Edit + Resend stacked -->
              <div class="absolute bottom-4 right-4 flex flex-col items-end space-y-2">
                <button class="edit-order-btn btn-neon-lime text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
                  Edit Order
                </button>

                <!-- ADDED: Resend Email button -->
                <button class="resend-order-btn btn-neon-cyan text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
                  Resend Email
                </button>
              </div>
            </div>`;
          ordersContainer.insertAdjacentHTML('beforeend', card);
        });
        updateFinancialUI();
        renderInfographics();
      }, (error) => {
        console.error('Error listening to orders:', error);
        showModal('Failed to load orders. Check console for details.');
        const ordersContainer = qs('orders-container');
        const loadingElement  = qs('loading-orders');
        loadingElement.style.display = 'none';
        ordersContainer.innerHTML = `
          <div class="text-center text-red-500 py-12">
            <p class="text-lg">An error occurred.</p>
            <p class="text-sm mt-2">Check the console for more details.</p>
          </div>`;
      });
    }

    function renderInfographics() {
      const placeholder = qs('infographic-placeholder');
      const containerMonthly = qs('list-monthly-revenue');
      const containerCustomers = qs('list-top-customers');
      const containerProductsRev = qs('list-top-products-revenue');
      const containerProductsQty = qs('list-top-products-quantity');

      containerMonthly.innerHTML = '';
      containerCustomers.innerHTML = '';
      containerProductsRev.innerHTML = '';
      containerProductsQty.innerHTML = '';

      if (allOrdersCache.length === 0) {
        placeholder.classList.remove('hidden');
        return;
      }
      placeholder.classList.add('hidden');

      // 1. Monthly Revenue
      const monthlyRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.timestamp) {
          const month = order.timestamp.toDate().toLocaleString('en-US', { month: 'short', year: '2-digit' });
          monthlyRevenue[month] = (monthlyRevenue[month] || 0) + (order.total || 0);
        }
      });
      const sortedMonths = Object.keys(monthlyRevenue).sort((a, b) => {
        const [monthA, yearA] = a.split(' ');
        const [monthB, yearB] = b.split(' ');
        return new Date(`01 ${monthA} 20${yearA}`) - new Date(`01 ${monthB} 20${yearB}`);
      });
      sortedMonths.forEach(month => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${month}</span><span class="font-bold text-cyan-300">$${currency(monthlyRevenue[month])}</span>`;
        containerMonthly.appendChild(li);
      });
      
      // 2. Top Customers
      const customerRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.contactInfo?.fullName) {
          const name = order.contactInfo.fullName;
          customerRevenue[name] = (customerRevenue[name] || 0) + (order.total || 0);
        }
      });
      const sortedCustomers = Object.entries(customerRevenue).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedCustomers.forEach(([name, revenue]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">$${currency(revenue)}</span>`;
        containerCustomers.appendChild(li);
      });

      // 3. Top Products by Revenue
      const productRevenue = {};
      allOrdersCache.forEach(order => {
        if (order.paymentStatus === 'Paid' && order.items) {
          order.items.forEach(item => {
            const name = item.name || 'Unknown Item';
            productRevenue[name] = (productRevenue[name] || 0) + (item.unitPrice * item.quantity);
          });
        }
      });
      const sortedProductsRev = Object.entries(productRevenue).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedProductsRev.forEach(([name, revenue]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">$${currency(revenue)}</span>`;
        containerProductsRev.appendChild(li);
      });

      // 4. Top Products by Quantity
      const productQuantity = {};
      allOrdersCache.forEach(order => {
        if (order.items) {
          order.items.forEach(item => {
            const name = item.name || 'Unknown Item';
            productQuantity[name] = (productQuantity[name] || 0) + (item.quantity || 0);
          });
        }
      });
      const sortedProductsQty = Object.entries(productQuantity).sort(([, a], [, b]) => b - a).slice(0, 5);
      sortedProductsQty.forEach(([name, quantity]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><span class="font-bold text-cyan-300">${quantity} sold</span>`;
        containerProductsQty.appendChild(li);
      });
    }

    /**
     * @description Creates a new item DOM element for the edit order modal.
     * @param {object} item The item object.
     * @returns {HTMLElement} The created DOM element.
     */
    function createOrderItemElement(item) {
        const itemElement = document.createElement('div');
        itemElement.className = 'edit-order-item flex items-center gap-2 p-2 border border-gray-700 rounded-md';
        itemElement.dataset.itemName = item.name;

        // Use a span to display the item name since it's not editable.
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name || 'Unknown Item';
        nameSpan.className = 'flex-1 text-gray-300 text-sm font-semibold truncate';

        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = item.unitPrice || 0;
        priceInput.className = 'w-24 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-gray-300';
        priceInput.placeholder = 'Price';
        priceInput.dataset.field = 'unitPrice';

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = item.quantity || 1;
        quantityInput.min = '1';
        quantityInput.className = 'w-16 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-gray-300';
        quantityInput.placeholder = 'Qty';
        quantityInput.dataset.field = 'quantity';

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'btn-neon-red px-2 py-1 rounded-lg font-semibold text-xs ml-auto';
        removeButton.textContent = 'Remove';
        removeButton.addEventListener('click', () => {
            itemElement.remove();
            recalcEditModalTotal();
        });

        priceInput.addEventListener('input', recalcEditModalTotal);
        quantityInput.addEventListener('input', recalcEditModalTotal);

        itemElement.appendChild(nameSpan);
        itemElement.appendChild(priceInput);
        itemElement.appendChild(quantityInput);
        itemElement.appendChild(removeButton);

        return itemElement;
    }


    // ADD this helper somewhere above openEditModal/handleEditOrder:
function recalcEditModalTotal() {
  const itemEls = document.querySelectorAll('#edit-order-items-list .edit-order-item');
  let total = 0;
  itemEls.forEach(el => {
    const price = parseFloat(el.querySelector('[data-field="unitPrice"]').value) || 0;
    const qty   = parseInt(el.querySelector('[data-field="quantity"]').value, 10) || 0;
    total += price * qty;
  });
  // If you have shipping/tax fields, add here before assigning:
  qs('edit-order-total').value = total.toFixed(2);
}


    /**
     * @description Opens the edit order modal and populates it with the order data.
     * @param {object} orderData The Firestore document data for the order.
     */
    function openEditModal(orderData) {
        qs('edit-order-id').value = orderData.id;
        qs('edit-contact-name').value = orderData.contactInfo?.fullName || '';
        qs('edit-order-total').value = orderData.total ?? 0;
        qs('edit-order-status').value = orderData.paymentStatus ?? 'Unpaid';
        
        const itemsListContainer = qs('edit-order-items-list');
        itemsListContainer.innerHTML = '';
        (orderData.items || []).forEach(item => {
            const itemElement = createOrderItemElement(item);
            itemsListContainer.appendChild(itemElement);
        });

        recalcEditModalTotal();

        editOrderModal.classList.remove('hidden');
        editOrderBackdrop.classList.remove('hidden');
        editOrderModal.classList.add('is-open');
        editOrderBackdrop.classList.add('is-open');
    }

    /**
     * @description Closes the edit order modal.
     */
    function closeEditModal() {
        editOrderModal.classList.remove('is-open');
        editOrderBackdrop.classList.remove('is-open');
        // Use a timeout to hide the modal after the transition
        setTimeout(() => {
          editOrderModal.classList.add('hidden');
          editOrderBackdrop.classList.add('hidden');
        }, 300);
    }

    /**
     * @description Handles the form submission to update the order.
     * @param {Event} e The form submit event.
     */
    async function handleEditOrder(e) {
  e.preventDefault();
  const orderId = qs('edit-order-id').value;
  const paymentStatus = qs('edit-order-status').value;
  const newCustomerName = qs('edit-contact-name').value.trim();

  if (!newCustomerName) {
    showModal('Customer name cannot be empty.');
    return;
  }

  // 1) Gather items from DOM
  const updatedItems = [];
  const itemElements = document.querySelectorAll('#edit-order-items-list .edit-order-item');
  for (const el of itemElements) {
    const itemName = el.dataset.itemName;
    const price = parseFloat(el.querySelector('[data-field="unitPrice"]').value);
    const qty   = parseInt(el.querySelector('[data-field="quantity"]').value, 10);

    if (isNaN(price) || price < 0) {
      showModal(`Invalid price for item "${itemName}". Please enter a positive number.`);
      return;
    }
    if (isNaN(qty) || qty <= 0) {
      showModal(`Invalid quantity for item "${itemName}". Please enter a positive integer.`);
      return;
    }

    updatedItems.push({ name: itemName, unitPrice: price, quantity: qty });
  }

  if (updatedItems.length === 0) {
    showModal('An order must have at least one item.');
    return;
  }

  // 2) Compute a fresh total from items (add shipping/tax here if you have them)
  let t = 0;
  updatedItems.forEach(i => { t += Number(i.unitPrice) * Number(i.quantity); });
  const total = Number.isFinite(t) ? Number(t.toFixed(2)) : 0;

  // 3) Persist
  try {
    const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
    await updateDoc(orderRef, {
      total,
      paymentStatus,
      'contactInfo.fullName': newCustomerName,
      items: updatedItems
    });
    showModal('Order updated successfully!');
    closeEditModal();
  } catch (error) {
    console.error('Error updating order:', error);
    showModal(`Failed to update order: ${error.message}`);
  }
}


    /**
     * @description Deletes an order from the database.
     * @param {string} orderId The ID of the order to delete.
     */
    async function handleDeleteOrder(orderId) {
        const confirmed = window.confirm(`Are you sure you want to delete order ${orderId}? This cannot be undone.`);
        if (!confirmed) {
            return;
        }

        try {
            await deleteDoc(doc(db, ORDERS_COLLECTION_PATH, orderId));
            showModal(`Order ${orderId} has been deleted.`);
            closeEditModal();
        } catch (error) {
            console.error('Error deleting order:', error);
            showModal(`Failed to delete order: ${error.message}`);
        }
    }
    
    /**
     * @description Handles the form submission to add a new inventory item.
     * @param {Event} e The form submit event.
     */
    async function handleAddItem(e) {
        e.preventDefault();
        const name = newItemNameInput.value.trim();
        const code = newItemCodeInput.value.trim();
        const blend = newItemBlendInput.checked;
        const currentInventory = parseInt(newTotalKitsBoughtInput.value, 10) * parseInt(newTotalVialsPerKitInput.value, 10);
        const sellPricePerVial = parseFloat(newItemPriceInput.value);
        const totalVialWeight = parseFloat(newItemTotalVialWeightInput.value);
        const image = newItemImageInput.value.trim();
        const coa = newItemCoaInput.value.trim();
        const vialsSold = parseInt(newItemVialsSoldInput.value, 10);
        
        const costPerKit = parseFloat(newCostPerKitInput.value);
        const totalKitsBought = parseInt(newTotalKitsBoughtInput.value, 10);
        const totalVialsPerKit = parseInt(newTotalVialsPerKitInput.value, 10);
        const purchaseDate = newPurchaseDateInput.value;


      if (!name || !code) {
        showModal('Item Name and Code are required.');
        return;
      }
      if (isNaN(currentInventory) || currentInventory < 0) {
        showModal('Initial Inventory must be a non-negative number.');
        return;
      }
      if (isNaN(sellPricePerVial) || sellPricePerVial < 0) {
        showModal('Sell Price must be a non-negative number.');
        return;
      }
      if (isNaN(totalVialWeight) || totalVialWeight < 0) {
        showModal('Total Vial Weight must be a non-negative number.');
        return;
      }
      if (isNaN(vialsSold) || vialsSold < 0) {
        showModal('Vials Sold must be a non-negative number.');
        return;
      }
      if (isNaN(costPerKit) || costPerKit < 0) {
        showModal('Cost Per Kit must be a non-negative number.');
        return;
      }
      if (isNaN(totalKitsBought) || totalKitsBought < 0) {
        showModal('Total Kits Bought must be a non-negative number.');
        return;
      }
      if (isNaN(totalVialsPerKit) || totalVialsPerKit < 0) {
        showModal('Total Vials Per Kit must be a non-negative number.');
        return;
      }
      if (!purchaseDate) {
        showModal('Purchase Date is required.');
        return;
      }

      const newCostEntry = {
        costPerKit,
        purchaseDate,
        totalKitsBought,
        totalVialWeightInMg: totalVialWeight,
        totalVialsPerKit
      };
      
      const newItem = {
        name,
        code,
        blend,
        currentInventory,
        sellPricePerVial,
        totalVialWeight,
        image: image || 'N/A',
        coa: coa || 'N/A',
        vialsSold,
        costHistory: [newCostEntry]
      };
      
      try {
        const itemRef = doc(db, INVENTORY_COLLECTION_PATH, code);
        await setDoc(itemRef, newItem);
        showModal('New item added to inventory successfully!');
        addItemForm.reset();
      } catch (error) {
        console.error('Error adding new item:', error);
        showModal(`Failed to add new item: ${error.message}`);
      }
    }
    
    /**
     * @description Handles the form submission to add a new cost history entry to an existing item.
     * @param {Event} e The form submit event.
     */
    async function handleNewCostHistory(e) {
        e.preventDefault();
        const itemId = existingItemSelect.value;
        
        if (!itemId) {
            showModal('Please select an item from the dropdown.');
            return;
        }
        
        const costPerKit = parseFloat(costPerKitInput.value);
        const totalKitsBought = parseInt(totalKitsBoughtInput.value, 10);
        const totalVialsPerKit = parseInt(totalVialsPerKitInput.value, 10);
        const purchaseDate = purchaseDateInput.value;
        const totalVialWeight = inventoryCache[itemId]?.totalVialWeight; // Use existing weight

        if (isNaN(costPerKit) || costPerKit < 0) {
            showModal('Cost Per Kit must be a non-negative number.');
            return;
        }
        if (isNaN(totalKitsBought) || totalKitsBought < 0) {
            showModal('Cost Per Kit must be a non-negative number.');
            return;
        }
        if (isNaN(totalVialsPerKit) || totalVialsPerKit < 0) {
            showModal('Total Vials Per Kit must be a non-negative number.');
            return;
        }
        if (!purchaseDate) {
            showModal('Purchase Date is required.');
            return;
        }

        const newCostEntry = {
            costPerKit,
            purchaseDate,
            totalKitsBought,
            totalVialWeightInMg: totalVialWeight,
            totalVialsPerKit
        };
        
        try {
            const itemRef = doc(db, INVENTORY_COLLECTION_PATH, itemId);
            await updateDoc(itemRef, {
                costHistory: arrayUnion(newCostEntry)
            });
            showModal('New cost history added successfully!');
            addCostForm.reset();
        } catch (error) {
            console.error('Error adding new cost history:', error);
            showModal(`Failed to add new cost history: ${error.message}`);
        }
    }
    
    // Function to open the Add Cost History modal
    function openAddCostModal() {
      addCostModal.classList.add('is-open');
    }
    
    // Function to close the Add Cost History modal
    function closeAddCostModal() {
      addCostModal.classList.remove('is-open');
    }

    // ADDED: Build a clean order payload & call the callable to resend
    async function resendOrderEmailById(orderId, buttonEl) {
      const order = allOrdersCache.find(o => o.id === orderId);
      if (!order) {
        showModal(`Order not found: ${orderId}`);
        return;
      }

      // Build a safe, minimal snapshot (ensures orderId exists)
      const items = Array.isArray(order.items) ? order.items.map(i => ({
        id: i?.id ?? "",
        name: i?.name ?? "",
        quantity: Number(i?.quantity ?? 0),
        unitPrice: Number(i?.unitPrice ?? 0)
      })) : [];

      const computedSubtotal = items.reduce((s, i) => s + (Number(i.unitPrice) * Number(i.quantity)), 0);
      const shipping = Number(order.shippingCost ?? 0);
      const total = Number(order.total ?? (computedSubtotal + shipping));

      const payloadOrder = {
        orderId: order.orderId || order.id,
        contactInfo: {
          fullName: order.contactInfo?.fullName ?? "",
          email: order.contactInfo?.email ?? "",
          phone: order.contactInfo?.phone ?? "",
          shippingAddress: order.contactInfo?.shippingAddress ?? ""
        },
        items,
        subtotal: Number(order.subtotal ?? computedSubtotal),
        shippingCost: shipping,
        total,
        paymentStatus: order.paymentStatus ?? "unpaid",
        timestampISO:
          (order.timestamp?.toDate?.() && order.timestamp.toDate().toISOString()) ||
          new Date().toISOString()
      };

      // UI: disable while sending
      const originalText = buttonEl?.textContent;
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = "Resending...";
        buttonEl.classList.add("opacity-70", "cursor-not-allowed");
      }

      try {
        const res = await resendFn({ order: payloadOrder }); // calls Cloud Function
        showModal(`Resent confirmation to ${payloadOrder.contactInfo.email}`);
      } catch (err) {
        console.error("Resend failed:", err);
        showModal(`Resend failed: ${err.message || "See console"}`);
      } finally {
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = originalText || "Resend Email";
          buttonEl.classList.remove("opacity-70", "cursor-not-allowed");
        }
      }
    }
    
    /**
     * @description Handles the addition of a new item to the order edit modal.
     */
    function handleAddItemToOrder() {
        const select = qs('add-item-select');
        const quantityInput = qs('add-item-quantity');
        const selectedId = select.value;
        const quantity = parseInt(quantityInput.value, 10);

        if (!selectedId) {
            showModal('Please select an item to add.');
            return;
        }

        if (isNaN(quantity) || quantity <= 0) {
            showModal('Quantity must be a positive number.');
            return;
        }

        const selectedItem = inventoryCache[selectedId];
        if (!selectedItem) {
            showModal('Selected item not found in inventory.');
            return;
        }

        const newItem = {
            name: selectedItem.name,
            unitPrice: selectedItem.sellPricePerVial,
            quantity: quantity
        };

        const itemsListContainer = qs('edit-order-items-list');
        const newItemElement = createOrderItemElement(newItem);
        itemsListContainer.appendChild(newItemElement);

        recalcEditModalTotal();
        
        // Reset the form fields
        select.value = '';
        quantityInput.value = '1';
    }


    /**
     * @description Attaches all event listeners for the application.
     */
    function attachEventListeners() {
      // Event listener for the login form.
      qs('auth-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = qs('email').value;
        const password = qs('password').value;
        
        if (!isValidEmail(email)) {
          showModal('Please enter a valid email address.');
          return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            showModal('Login successful!');
        } catch (error) {
            console.error("Login failed:", error);
            let errorMessage = "Login failed. Check your credentials.";
            if (error.code === 'auth/wrong-password') {
                errorMessage = "Incorrect password. Please try again.";
            } else if (error.code === 'auth/user-not-found') {
                errorMessage = "Admin user not found.";
            }
            showModal(errorMessage);
        }
      });
      
      qs('signout-btn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          showModal('Signed out successfully.');
        } catch (error) {
          console.error("Sign out failed:", error);
          showModal(`Sign out failed: ${error.message}`);
        }
      });
      
      qs('close-modal-btn').addEventListener('click', () => qs('alert-modal').classList.add('hidden'));

      // Event delegation for dynamically created Edit + Resend buttons
      qs('orders-container').addEventListener('click', (e) => {
          const editButton = e.target.closest('.edit-order-btn');
          if (editButton) {
              const orderId = editButton.dataset.orderId;
              const orderToEdit = allOrdersCache.find(order => order.id === orderId);
              if (orderToEdit) {
                  openEditModal(orderToEdit);
              }
              return;
          }

          // ADDED: Handle Resend Email button
          const resendButton = e.target.closest('.resend-order-btn');
          if (resendButton) {
            const orderId = resendButton.dataset.orderId;
            resendOrderEmailById(orderId, resendButton);
          }
      });

      // Event listeners for the new Order Edit Modal
      editOrderForm.addEventListener('submit', handleEditOrder);
      closeEditModalBtn.addEventListener('click', closeEditModal);
      editOrderBackdrop.addEventListener('click', closeEditModal);
      deleteOrderBtn.addEventListener('click', (e) => {
          const orderId = qs('edit-order-id').value;
          if (orderId) {
              handleDeleteOrder(orderId);
          } else {
              showModal('No order selected to delete.');
          }
      });
      
      // New event listener for the Add Item form
      addItemForm.addEventListener('submit', handleAddItem);
      
      // New event listener for the Add Cost History form
      addCostForm.addEventListener('submit', handleNewCostHistory);
      
      // Event listeners for the new Add Cost History modal
      addCostBtn.addEventListener('click', openAddCostModal);
      closeAddCostModalBtn.addEventListener('click', closeAddCostModal);
      
      // ADDED: Listener for the "Add" button in the Edit Order modal
      qs('add-item-to-order-btn').addEventListener('click', handleAddItemToOrder);
    }

    // Boot
    window.addEventListener('load', () => {
      try {
        onAuthStateChanged(auth, (user) => {
          console.log('Auth state changed:', user ? user.uid : 'None');
          updateUI(user);
        });
        
        attachEventListeners();
      } catch (err) {
        console.error('Init failed:', err);
        qs('status').textContent = `Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
