<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Using a monospaced font for a futuristic, terminal-like feel -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <!-- D3.js for data visualization -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Global styles for the cyberpunk theme */
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #0d0c1d; /* Deep purple-blue background */
      color: #e2e8f0; /* Off-white for general text */
    }
    .neon-glow {
        box-shadow: 0 0 5px #1e90ff, 0 0 10px #1e90ff, 0 0 15px #1e90ff, 0 0 20px #1e90ff; /* Electric blue glow */
    }
    .text-glow-fuchsia {
        text-shadow: 0 0 3px #d62d88, 0 0 8px #d62d88; /* Fuchsia glow */
    }
    .text-glow-cyan {
        text-shadow: 0 0 3px #0891b2, 0 0 8px #0891b2; /* Cyan glow */
    }
    .btn-neon-cyan {
        background-color: #0891b2; /* Tailwind cyan-600 */
        color: white;
    }
    .btn-neon-cyan:hover {
        background-color: #06748c; /* Darker cyan */
    }
    .btn-neon-lime {
        background-color: #65a30d; /* Tailwind lime-600 */
        color: black;
    }
    .btn-neon-lime:hover {
        background-color: #4d820d; /* Darker lime */
    }
    /* Custom table styling to fit the theme */
    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #1f2937; /* Darker border */
    }
    th {
      background-color: #1e1b4b; /* Dark purple header */
      font-weight: 700;
      color: #93c5fd; /* Light blue text for headers */
      text-transform: uppercase;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td.is-editing {
        background-color: #1f2937; /* Darker background when editing */
        outline: 2px solid #06b6d4; /* Neon cyan outline */
        outline-offset: -2px;
    }
    .order-card, .infographic-card {
        background-color: #1f2937; /* Dark gray for the card background */
        border: 1px solid #374151; /* Border color for the card */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* D3 chart styling */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }
    .bar {
        fill: #06b6d4; /* Cyan color for bars */
        stroke: #1e1b4b; /* Dark purple border */
        stroke-width: 1px;
    }
    .bar-label {
        fill: #e2e8f0; /* Off-white for labels */
        font-size: 10px;
        text-anchor: middle;
    }
    .axis path,
    .axis line {
        stroke: #4b5563; /* Darker gray for axis lines */
    }
    .axis text {
        fill: #9ca3af; /* Lighter gray for axis labels */
        font-size: 10px;
    }
    .bar-y-label {
        fill: #e2e8f0;
        font-size: 10px;
        text-anchor: end;
    }
    /* Infographic card layout */
    .infographic-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 640px) {
      .infographic-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1024px) {
      .infographic-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .infographic-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px dashed #374151;
    }
    .infographic-list li:last-child {
      border-bottom: none;
    }
    .infographic-list .rank {
      font-weight: bold;
      color: #06b6d4;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
 
  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>
 
    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>
    
    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>
 
    <div id="main-content" class="hidden space-y-8">
      <div class="text-right">
        <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs">Sign Out</button>
      </div>
 
      <!-- Inventory Section (now a table) -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Item Name
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Code
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Current Inventory
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Sell Price
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Total Amount Purchased
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                  Vials Sold
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  Image
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">
                  COA
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700">
              <!-- Inventory rows will be added here by JS -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- New Cards for Total Cost, Revenue, and Profit -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <!-- Total Cost Card -->
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <!-- Total Revenue Card -->
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <!-- Total Profit Card -->
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>
 
      <!-- New Orders Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div id="orders-container" class="space-y-6">
          <!-- Order cards will be injected here -->
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
      </div>
      
      <!-- New Infographics Section -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <!-- Monthly Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <div id="chart-monthly-revenue" class="chart-container"></div>
          </div>
          <!-- Top Customers Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <div id="chart-top-customers" class="chart-container"></div>
          </div>
          <!-- Top Products by Revenue Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <div id="chart-top-products-revenue" class="chart-container"></div>
          </div>
          <!-- Top Products by Quantity Card -->
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <div id="chart-top-products-quantity" class="chart-container"></div>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
            No sales data to display yet.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>
 
  <!-- Firebase (v12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
 
    const firebaseConfig = {
      apiKey: secrets.API_KEY,
      authDomain: "peptide-inventory.firebaseapp.com",
      projectId: "peptide-inventory",
      storageBucket: "peptide-inventory.firebasestorage.app",
      messagingSenderId: "547049240971",
      appId: "1:547049240971:web:83b2e836fee57bb41f578e",
      measurementId: "G-1W58JMJN37"
    };
 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    try { getAnalytics(app); } catch (e) { /* ignore if blocked */ }
 
    const qs = (id) => document.getElementById(id);
    let userId = null;
    let totalRevenue = 0;
    let totalCost = 0;
    let paidOrdersCache = [];
 
    function showModal(message) {
      qs('modal-message').textContent = message;
      qs('alert-modal').classList.remove('hidden');
    }
 
    /**
     * @description Simple email validation function using a regex.
     * @param {string} email
     * @returns {boolean}
     */
    function isValidEmail(email) {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }
 
    // Function to copy text to clipboard, uses a temporary textarea for cross-browser support in iframes
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showModal('Copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy text:', err);
            showModal('Failed to copy. Please select and copy manually.');
        } finally {
            document.body.removeChild(textarea);
        }
    }
 
    function formatTimestamp(ts) {
      if (!ts) return 'Unknown date';
      try {
        if (typeof ts.toDate === 'function') {
          return ts.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        const d = new Date(ts);
        if (!isNaN(d.getTime())) {
          return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      } catch (_) {}
      return 'Unknown date';
    }
 
    function currency(n) {
      const num = typeof n === 'number' ? n : Number(n ?? 0);
      return num.toFixed(2);
    }
 
    function updateFinancialUI() {
        const totalProfit = totalRevenue - totalCost;
        qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
        qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
        qs('total-profit').textContent = `$${totalProfit.toFixed(2)}`;
    }
 
    function updateUI(user) {
      const status = qs('status');
      const userDisplay = qs('user-id-display');
      const mainContent = qs('main-content');
      const loginForm = qs('login-form');
 
      if (user) {
        userId = user.uid;
        status.textContent = 'Status: Signed in';
        userDisplay.textContent = 'User ID: ' + userId;
        mainContent.classList.remove('hidden');
        loginForm.classList.add('hidden');
        listenForInventory();
        listenForOrders();
      } else {
        userId = null;
        status.textContent = 'Status: Signed out';
        userDisplay.textContent = 'User ID: N/A';
        mainContent.classList.add('hidden');
        loginForm.classList.remove('hidden');
      }
    }
 
    function listenForInventory() {
      if (!userId) return;
      const ref = collection(db, 'inventory');
      onSnapshot(ref, (snap) => {
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        if (snap.empty) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.setAttribute('colspan', '9');
          td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
          td.textContent = 'No inventory items.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
 
        totalCost = 0;
 
        snap.forEach((d) => {
          const item = d.data();
          const tr = document.createElement('tr');
          tr.dataset.id = d.id;
          tr.className = 'hover:bg-gray-700 transition-colors duration-150';
 
          const nameTd = document.createElement('td');
          nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
          nameTd.textContent = item.name ?? '(no name)';
          nameTd.setAttribute('contenteditable', 'false');
          nameTd.dataset.field = 'name';
 
          const codeTd = document.createElement('td');
          codeTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          codeTd.textContent = item.code ?? '(no code)';
 
          const inventoryTd = document.createElement('td');
          inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          inventoryTd.textContent = item.currentInventory ?? 0;
          inventoryTd.setAttribute('contenteditable', 'false');
          inventoryTd.dataset.field = 'currentInventory';
 
          const priceTd = document.createElement('td');
          priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
          priceTd.setAttribute('contenteditable', 'false');
          priceTd.dataset.field = 'sellPricePerVial';
          priceTd.dataset.originalPrice = item.sellPricePerVial;
 
          const totalItemCostTd = document.createElement('td');
          totalItemCostTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          let totalItemCost = 0;
          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalItemCost = item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
          totalItemCostTd.textContent = `$${totalItemCost.toFixed(2)}`;
 
          const vialsSoldTd = document.createElement('td');
          vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
          vialsSoldTd.textContent = item.vialsSold ?? 0;
          vialsSoldTd.setAttribute('contenteditable', 'false');
          vialsSoldTd.dataset.field = 'vialsSold';
 
          const imageTd = document.createElement('td');
          imageTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          imageTd.textContent = item.image ?? 'N/A';
          imageTd.dataset.field = 'image';
          imageTd.setAttribute('contenteditable', 'false');
          imageTd.addEventListener('click', () => {
            if (imageTd.textContent && imageTd.textContent !== 'N/A') {
              copyToClipboard(imageTd.textContent);
            }
          });
          
          const coaTd = document.createElement('td');
          coaTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
          coaTd.textContent = item.coa ?? 'N/A';
          coaTd.dataset.field = 'coa';
          coaTd.setAttribute('contenteditable', 'false');
          coaTd.addEventListener('click', () => {
            if (coaTd.textContent && coaTd.textContent !== 'N/A') {
              copyToClipboard(coaTd.textContent);
            }
          });
 
          const actionTd = document.createElement('td');
          actionTd.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
          const editSaveBtn = document.createElement('button');
          editSaveBtn.textContent = 'Edit';
          editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
          
          editSaveBtn.addEventListener('click', () => {
              const isEditing = editSaveBtn.textContent === 'Edit';
              const editableTds = [nameTd, inventoryTd, priceTd, vialsSoldTd, imageTd, coaTd];
 
              if (isEditing) {
                  editSaveBtn.textContent = 'Save';
                  editSaveBtn.className = 'btn-neon-lime px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'true');
                      td.classList.add('is-editing');
                  });
              } else {
                  const docId = tr.dataset.id;
                  const newName = nameTd.textContent.trim();
                  const newQuantity = parseInt(inventoryTd.textContent.trim(), 10);
                  let newPrice = priceTd.textContent.trim();
                  newPrice = parseFloat(newPrice.replace(/^\$/, ''));
                  const newVialsSold = parseInt(vialsSoldTd.textContent.trim(), 10);
                  const newImage = imageTd.textContent.trim();
                  const newCoa = coaTd.textContent.trim();
 
                  const updateData = {};
                  if (newName !== (item.name ?? '')) updateData.name = newName;
                  if (!isNaN(newQuantity) && newQuantity !== item.currentInventory) updateData.currentInventory = newQuantity;
                  if (!isNaN(newPrice) && newPrice !== item.sellPricePerVial) updateData.sellPricePerVial = newPrice;
                  if (!isNaN(newVialsSold) && newVialsSold !== item.vialsSold) updateData.vialsSold = newVialsSold;
                  if (newImage !== (item.image ?? '')) updateData.image = newImage;
                  if (newCoa !== (item.coa ?? '')) updateData.coa = newCoa;
                  
                  if (Object.keys(updateData).length > 0) {
                      const itemRef = doc(db, 'inventory', docId);
                      updateDoc(itemRef, updateData)
                          .then(() => showModal(`Data updated for ${newName}.`))
                          .catch((e) => {
                              console.error('Error updating document:', e);
                              showModal('Error updating data. Check console for details.');
                          });
                  } else {
                      showModal('No changes to save.');
                  }
 
                  editSaveBtn.textContent = 'Edit';
                  editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
                  editableTds.forEach(td => {
                      td.setAttribute('contenteditable', 'false');
                      td.classList.remove('is-editing');
                  });
              }
          });
          actionTd.appendChild(editSaveBtn);
 
          tr.appendChild(nameTd);
          tr.appendChild(codeTd);
          tr.appendChild(inventoryTd);
          tr.appendChild(priceTd);
          tr.appendChild(totalItemCostTd);
          tr.appendChild(vialsSoldTd);
          tr.appendChild(imageTd);
          tr.appendChild(coaTd);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
 
          if (item.costHistory && Array.isArray(item.costHistory)) {
            totalCost += item.costHistory.reduce((sum, historyItem) => {
              const cost = (historyItem.costPerKit || 0) * (historyItem.totalKitsBought || 0);
              return sum + cost;
            }, 0);
          }
        });
        updateFinancialUI();
      }, (error) => {
        console.error('Error listening to inventory:', error);
        const tbody = qs('inventory-list');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.setAttribute('colspan', '9');
        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
        td.textContent = 'Error loading inventory.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      });
    }
 
    function listenForOrders() {
      const ordersContainer = qs('orders-container');
      const loadingElement  = qs('loading-orders');
      
      const ref = collection(db, 'orders');
 
      onSnapshot(ref, (snap) => {
        ordersContainer.innerHTML = '';
        loadingElement.style.display = 'none';
 
        if (snap.empty) {
          ordersContainer.innerHTML = `
            <div class="text-center text-gray-500 py-12">
              <p class="text-lg">No orders found.</p>
              <p class="text-sm mt-2">Your orders will appear here once they've been placed.</p>
            </div>`;
          return;
        }
        
        totalRevenue = 0;
        const orderData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        paidOrdersCache = orderData.filter(o => o.paymentStatus === 'Paid');
 
        orderData.sort((a, b) => {
          const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
          const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
          return timeB - timeA;
        });
 
        orderData.forEach((order) => {
          const timestamp = formatTimestamp(order.timestamp);
          const items = Array.isArray(order.items) ? order.items : [];
          
          const itemsList = items.map(item => {
            const name = (item && item.name) ? item.name : 'Item';
            const price = (item && item.unitPrice != null) ? currency(item.unitPrice) : '0.00';
            const quantity = (item && item.quantity != null) ? item.quantity : 1;
            return `
              <li class="flex justify-between items-center mb-1">
                <span class="text-gray-400">${name} (x${quantity})</span>
                <span class="font-medium text-cyan-300">$${price}</span>
              </li>`;
          }).join('');
 
          const computed = items.reduce((sum, it) => sum + (Number(it?.unitPrice || 0) * Number(it?.quantity || 1)), 0);
          const totalSafe = (order.total != null) ? currency(order.total) : currency(computed);
 
          if (order.paymentStatus === 'Paid') {
            totalRevenue += Number(order.total || computed);
          }
 
          const status = order.paymentStatus || 'Unknown';
          const statusClass = status === 'Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';
 
          const contact = order.contactInfo || {};
          const orderIdText = order.orderId || order.id;
 
          const card = `
            <div class="order-card rounded-xl p-6 shadow-md border border-gray-700">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-b pb-4 mb-4 border-gray-700">
                <div>
                  <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
                    <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
                  </h3>
                  <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
                </div>
                <div class="mt-4 sm:mt-0 text-left sm:text-right">
                  <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
                  <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                    ${status}
                  </span>
                </div>
              </div>
              <div class="mb-4">
                <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
                <ul class="list-none space-y-2 text-sm">
                  ${itemsList || '<li class="text-gray-500 italic">No items.</li>'}
                </ul>
              </div>
              <div>
                <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
                <div class="text-sm text-gray-500 space-y-1">
                  <p><span class="font-medium">Name:</span> ${contact.fullName || 'Not Provided'}</p>
                  <p><span class="font-medium">Email:</span> ${contact.email || 'Not Provided'}</p>
                  <p><span class="font-medium">Phone:</span> ${contact.phone || 'Not Provided'}</p>
                  <p><span class="font-medium">Address:</span> ${contact.shippingAddress || 'Not Provided'}</p>
                </div>
              </div>
            </div>`;
          ordersContainer.insertAdjacentHTML('beforeend', card);
        });
        updateFinancialUI();
        renderInfographics();
      }, (error) => {
        console.error('Error listening to orders:', error);
        showModal('Failed to load orders. Check console for details.');
        loadingElement.style.display = 'none';
        ordersContainer.innerHTML = `
          <div class="text-center text-red-500 py-12">
            <p class="text-lg">An error occurred.</p>
            <p class="text-sm mt-2">Check the console for more details.</p>
          </div>`;
      });
    }
 
    function renderBarChart(containerId, data, title, isCurrency) {
      const container = qs(containerId);
      container.innerHTML = '';
      if (data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 italic text-sm">No data available.</p>`;
        return;
      }
 
      const margin = { top: 20, right: 20, bottom: 60, left: 60 };
      const width = container.clientWidth - margin.left - margin.right;
      const height = 250 - margin.top - margin.bottom;
 
      const svg = d3.select(container)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
 
      const x = d3.scaleBand()
        .range([0, width])
        .domain(data.map(d => d.label))
        .padding(0.1);
 
      const y = d3.scaleLinear()
        .range([height, 0])
        .domain([0, d3.max(data, d => d.value) || 1]);
 
      svg.append("g")
        .attr("class", "axis x-axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-45)");
 
      svg.append("g")
        .attr("class", "axis y-axis")
        .call(d3.axisLeft(y).tickFormat(d => isCurrency ? `$${d3.format(".2s")(d)}` : d3.format(".0f")(d)));
 
      svg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.label))
        .attr("y", d => y(d.value))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(d.value));
 
      svg.selectAll(".bar-label")
          .data(data)
          .enter().append("text")
          .attr("class", "bar-label")
          .attr("x", d => x(d.label) + x.bandwidth() / 2)
          .attr("y", d => y(d.value) - 5)
          .text(d => isCurrency ? `$${currency(d.value)}` : d3.format(".0f")(d.value));
    }
 
    function renderList(containerId, data, isCurrency) {
      const container = qs(containerId);
      container.innerHTML = '';
      if (data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 italic text-sm">No data available.</p>`;
        return;
      }
      
      const list = d3.select(container).append('ul')
        .attr('class', 'infographic-list text-sm space-y-1');
 
      data.forEach((d, i) => {
        list.append('li')
          .html(`<span class="rank">${i + 1}.</span> <span>${d.label}</span> <span class="font-medium">${isCurrency ? `$${currency(d.value)}` : d3.format(".0f")(d.value)}</span>`);
      });
    }
    
    function renderInfographics() {
      const placeholder = qs('infographic-placeholder');
      if (paidOrdersCache.length === 0) {
        placeholder.style.display = 'block';
        return;
      } else {
        placeholder.style.display = 'none';
      }
 
      const monthlySales = d3.group(paidOrdersCache, d => {
        const date = d.timestamp.toDate();
        return `${date.getFullYear()}-${date.getMonth() + 1}`;
      });
      const monthlyData = Array.from(monthlySales, ([month, orders]) => {
        const total = d3.sum(orders, d => Number(d.total));
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return {
          label: d3.timeFormat("%b '%y")(date),
          value: total
        };
      }).sort((a,b) => new Date(a.label) - new Date(b.label));
      renderBarChart('chart-monthly-revenue', monthlyData, 'Monthly Revenue', true);
 
      const customerSales = d3.group(paidOrdersCache, d => d.contactInfo?.fullName || 'Anonymous');
      const customerData = Array.from(customerSales, ([customer, orders]) => {
        const total = d3.sum(orders, d => Number(d.total));
        return { label: customer, value: total };
      }).sort((a, b) => b.value - a.value).slice(0, 10);
      renderList('chart-top-customers', customerData, true);
 
      const productRevenue = d3.group(paidOrdersCache.flatMap(o => o.items), i => i.name || 'Unknown Product');
      const productRevenueData = Array.from(productRevenue, ([product, items]) => {
        const total = d3.sum(items, i => Number(i.unitPrice) * Number(i.quantity));
        return { label: product, value: total };
      }).sort((a, b) => b.value - a.value).slice(0, 10);
      renderBarChart('chart-top-products-revenue', productRevenueData, 'Top Products (Revenue)', true);
 
      const productQuantity = d3.group(paidOrdersCache.flatMap(o => o.items), i => i.name || 'Unknown Product');
      const productQuantityData = Array.from(productQuantity, ([product, items]) => {
        const total = d3.sum(items, i => Number(i.quantity));
        return { label: product, value: total };
      }).sort((a, b) => b.value - a.value).slice(0, 10);
      renderBarChart('chart-top-products-quantity', productQuantityData, 'Top Products (Quantity)', false);
    }
 
    // Boot
    window.addEventListener('load', async () => {
      try {
        // Auth state listener is crucial for managing UI state
        onAuthStateChanged(auth, (user) => {
          console.log('Auth state changed:', user ? user.uid : 'None');
          updateUI(user);
        });
        
        // Event listener for the login form. This now ONLY checks for a single user.
        qs('login-btn').addEventListener('click', async (e) => {
          e.preventDefault();
          const email = qs('email').value;
          const password = qs('password').value;
          
          if (!isValidEmail(email)) {
            showModal('Please enter a valid email address.');
            return;
          }
 
          try {
              // We no longer need to check credentials manually.
              // Firebase handles authentication, and Firestore rules handle authorization.
              await signInWithEmailAndPassword(auth, email, password);
              // If the sign-in is successful, the onAuthStateChanged listener will handle the UI.
              showModal('Login successful!');
          } catch (error) {
              console.error("Login failed:", error);
              // Firebase provides helpful error messages
              let errorMessage = "Login failed. Check your credentials.";
              if (error.code === 'auth/wrong-password') {
                  errorMessage = "Incorrect password. Please try again.";
              } else if (error.code === 'auth/user-not-found') {
                  errorMessage = "Admin user not found.";
              }
              showModal(errorMessage);
          }
        });
        
        qs('signout-btn').addEventListener('click', async () => {
          try {
            await signOut(auth);
            showModal('Signed out successfully.');
          } catch (error) {
            console.error("Sign out failed:", error);
            showModal(`Sign out failed: ${error.message}`);
          }
        });
        
        qs('close-modal-btn').addEventListener('click', () => qs('alert-modal').classList.add('hidden'));
 
        window.addEventListener('resize', () => {
          if (paidOrdersCache.length > 0) {
            renderInfographics();
          }
        });
      } catch (err) {
        console.error('Init failed:', err);
        qs('status').textContent = `Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
