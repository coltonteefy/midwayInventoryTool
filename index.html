<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <style>
    body { font-family:'Roboto Mono',monospace; background:#0d0c1d; color:#e2e8f0 }
    .neon-glow{ box-shadow:0 0 5px #1e90ff,0 0 10px #1e90ff,0 0 15px #1e90ff,0 0 20px #1e90ff }
    .text-glow-fuchsia{ text-shadow:0 0 3px #d62d88,0 0 8px #d62d88 }
    .text-glow-cyan{ text-shadow:0 0 3px #0891b2,0 0 8px #0891b2 }
    .btn-neon-cyan{ background:#0891b2; color:#fff } .btn-neon-cyan:hover{ background:#06748c }
    .btn-neon-lime{ background:#65a30d; color:#000 } .btn-neon-lime:hover{ background:#4d820d }
    .btn-neon-red{ background:#dc2626; color:#fff } .btn-neon-red:hover{ background:#b91c1c }
    table{ width:100%; border-collapse:collapse; text-align:left }
    th,td{ padding:12px; border-bottom:1px solid #1f2937 }
    th{ background:#1e1b4b; font-weight:700; color:#93c5fd; text-transform:uppercase }
    tr:last-child td{ border-bottom:none }
    td.is-editing{ background:#1f2937; outline:2px solid #06b6d4; outline-offset:-2px }
    .order-card,.infographic-card{ background:#1f2937; border:1px solid #374151; box-shadow:0 4px 6px rgba(0,0,0,.1) }
    .infographic-grid{ display:grid; gap:1.5rem; grid-template-columns:repeat(1,minmax(0,1fr)) }
    @media (min-width:640px){ .infographic-grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (min-width:1024px){ .infographic-grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }
    .infographic-list li{ display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px dashed #374151 }
    .infographic-list li:last-child{ border-bottom:none }
    .infographic-list .rank{ font-weight:bold; color:#06b6d4 }
    #trend-tool-section .trend-shell{ background:#10172b; border:1px solid #1f2937; border-radius:18px; padding:24px; box-shadow:0 18px 40px rgba(8,145,178,.12); }
    #trend-tool-section .trend-card{ background:#111827; border:1px solid #1f2937; border-radius:14px; padding:18px; box-shadow:0 12px 28px rgba(15,118,110,.15); display:flex; flex-direction:column; gap:1rem; }
    #trend-tool-section .trend-card p{ margin:0; }
    #trend-tool-section .trend-label{ font-size:.7rem; letter-spacing:.12em; text-transform:uppercase; color:#94a3b8; }
    #trend-tool-section .trend-value{ font-size:1.75rem; font-weight:700; color:#38bdf8; }
    #trend-tool-section .trend-subtext{ font-size:.85rem; color:#cbd5f5; }
    #trend-tool-section .trend-grid{ display:grid; gap:1rem; grid-template-columns:repeat(1,minmax(0,1fr)); }
    @media (min-width:640px){ #trend-tool-section .trend-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (min-width:1024px){ #trend-tool-section .trend-grid{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
    #trend-tool-section .trend-subgrid{ display:grid; gap:1rem; grid-template-columns:repeat(1,minmax(0,1fr)); }
    @media (min-width:768px){ #trend-tool-section .trend-subgrid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    #trend-tool-section .trend-list{ list-style:none; margin:0; padding:0; }
    #trend-tool-section .trend-list li{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.55rem 0; border-bottom:1px dashed #374151; }
    #trend-tool-section .trend-list li:last-child{ border-bottom:none; }
    #trend-tool-section .trend-list .rank{ font-weight:700; color:#38bdf8; font-size:.75rem; text-transform:uppercase; }
    #trend-tool-section .trend-list .name{ flex:1 1 auto; color:#e2e8f0; font-size:.9rem; }
    #trend-tool-section .trend-list .value{ font-weight:600; color:#cbd5f5; font-size:.85rem; text-align:right; white-space:nowrap; }
    #trend-tool-section label{ font-size:.7rem; letter-spacing:.12em; text-transform:uppercase; color:#94a3b8; margin:0; display:block; }
    #trend-tool-section select{ margin:0; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:40; opacity:0; transition:opacity .3s; pointer-events:none }
    .modal-backdrop.is-open{ opacity:1; pointer-events:auto }
    .modal-main{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:90%; max-width:600px; background:#111827; z-index:50; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.5); padding:2rem; transition:transform .3s,opacity .3s; opacity:0; pointer-events:none; max-height:90%; overflow-y:auto }
    .modal-main.is-open{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1) }
    @keyframes copyPulse{ 0%{transform:scale(1);} 40%{transform:scale(1.12);} 80%{transform:scale(0.98);} 100%{transform:scale(1);} }
    .copy-track.copied,.copy-contact.copied{ background:#22c55e!important; color:#06131a!important; animation:copyPulse .6s ease forwards; box-shadow:0 0 12px rgba(34,197,94,.45); }
    .txid-value{ word-break:break-all; overflow-wrap:anywhere; }

    /* Promo tool styles */
    #promo-tool {
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --fg:#e5e7eb;
      --accent:#38bdf8;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      margin-top:0;
      padding:3rem 1rem 4rem;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);
      border-radius:24px;
    }
    #promo-tool .promo-wrap {
      max-width:1050px;
      margin:0 auto;
    }
    #promo-tool .promo-title {
      margin:0 0 10px;
      font-size:22px;
      font-weight:700;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #promo-tool .promo-pill {
      font-size:11px;
      color:#082f49;
      background:#67e8f9;
      padding:4px 8px;
      border-radius:999px;
      font-weight:700;
    }
    #promo-tool .promo-card {
      background:var(--card);
      border:1px solid #1f2937;
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    #promo-tool label {
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:6px 0 6px;
    }
    #promo-tool input[type="text"],
    #promo-tool input[type="password"],
    #promo-tool input[type="number"],
    #promo-tool input[type="datetime-local"],
    #promo-tool select,
    #promo-tool textarea {
      width:100%;
      padding:10px 12px;
      background:#0b1220;
      color:var(--fg);
      border:1px solid #263244;
      border-radius:10px;
      outline:none;
    }
    #promo-tool input[type="checkbox"] {
      transform:scale(1.05);
    }
    #promo-tool textarea {
      min-height:120px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    #promo-tool .toolbar {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    #promo-tool .btn {
      appearance:none;
      border:1px solid #243244;
      background:#0b1220;
      color:var(--fg);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    #promo-tool .btn:hover {
      border-color:#324459;
    }
    #promo-tool .btn.primary {
      background:linear-gradient(180deg,#1e40af,#1d4ed8);
      border-color:#1d4ed8;
    }
    #promo-tool .btn.ok {
      background:linear-gradient(180deg,#0f9b6b,#10b981);
      border:1px solid #10b981;
    }
    #promo-tool .btn.warn {
      background:linear-gradient(180deg,#b45309,#f59e0b);
      border:1px solid #f59e0b;
      color:#0b1220;
    }
    #promo-tool .btn.ghost {
      background:transparent;
    }
    #promo-tool .codes {
      margin-top:16px;
      display:grid;
      gap:12px;
    }
    #promo-tool .code-card {
      background:#0b1220;
      border:1px solid #21304a;
      border-radius:12px;
      padding:12px;
    }
    #promo-tool .code-header {
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
      margin-bottom:6px;
    }
    #promo-tool .row {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    #promo-tool .row-3 {
      display:grid;
      grid-template-columns:1.2fr .8fr .8fr;
      gap:10px;
    }
    #promo-tool .row-4 {
      display:grid;
      grid-template-columns:1fr .7fr .7fr .7fr;
      gap:10px;
    }
    #promo-tool .hint {
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
    }
    #promo-tool .footnote {
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    #promo-tool .log {
      white-space:pre-wrap;
      background:#0b1220;
      border:1px solid #21304a;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }
    #promo-tool .log.muted {
      color:var(--muted);
    }
    #promo-tool .muted {
      color:var(--muted);
    }

    #email-list-wrapper.collapsed {
      max-height:72px;
      overflow:hidden;
      position:relative;
    }
    #email-list-wrapper.collapsed::after {
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:24px;
      background:linear-gradient(180deg,rgba(17,24,39,0) 0%,rgba(17,24,39,0.9) 100%);
      pointer-events:none;
    }

  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
      <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>
    </div>

    <div id="auth-buttons" class="space-x-4">
      <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Sign Out</button>
    </div>

    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>

    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>

    <div id="main-content" class="hidden space-y-8">
      <!-- Production Tools -->
      <section id="production-tools-section" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Production Tools</h2>
        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
          <div class="flex flex-wrap gap-4">
            <button id="toggle-cost-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Cost History</button>
            <button id="toggle-inventory-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Inventory</button>
            <button id="toggle-edit-item-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Edit Inventory</button>
            <button id="toggle-promo-tool-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Promo Tool</button>
          </div>
          <div id="inventory-tool-wrapper" class="mt-4 hidden">
            <section id="inventory-tool" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add New Inventory Item</h2>
              <form id="add-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <div class="w-full">
                    <label for="new-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
                    <input type="text" id="new-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-id" class="block text-sm font-medium text-gray-400">Item ID</label>
                    <input type="text" id="new-item-id" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., RT24" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold (Initial)</label>
                    <input type="number" id="new-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
                    <input type="number" step="0.01" id="new-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
                    <input type="number" step="0.01" id="new-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <div class="flex items-center space-x-2 mt-7">
                      <input type="checkbox" id="new-item-blend" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600">
                      <label for="new-item-blend" class="block text-sm font-medium text-gray-400">Is a Blend?</label>
                    </div>
                  </div>
                  <div class="w-full">
                    <div class="flex items-center space-x-2 mt-7">
                      <input type="checkbox" id="new-item-is-active" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600" checked>
                      <label for="new-item-is-active" class="block text-sm font-medium text-gray-400">Product is Active</label>
                    </div>
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                    <label for="new-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
                    <input type="url" id="new-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/image.jpg">
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                    <label for="new-item-description" class="block text-sm font-medium text-gray-400">Product Description</label>
                    <textarea id="new-item-description" rows="3" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Short summary shown to customers"></textarea>
                  </div>
                </div>

                <div class="space-y-3 mt-6 p-4 rounded-lg border border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-cyan">Certificate of Analysis</h3>
                  <div>
                    <label for="new-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
                    <input type="url" id="new-item-coa" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/coa.pdf">
                  </div>
                </div>

                <div class="space-y-4 mt-6 p-4 rounded-lg border-2 border-dashed border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-fuchsia">Initial Cost History</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="w-full">
                      <label for="new-cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                      <input type="number" step="0.01" id="new-cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="$0.00" required>
                    </div>
                    <div class="w-full">
                      <label for="new-total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                      <input type="number" id="new-total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                    </div>
                    <div class="w-full">
                      <label for="new-total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                      <input type="number" id="new-total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                    </div>
                    <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                      <label for="new-purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                      <input type="date" id="new-purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                  </div>
                </div>

                <div class="flex justify-center mt-6">
                  <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Item</button>
                </div>
              </form>
            </section>
          </div>
          <div id="inventory-editor-wrapper" class="mt-4 hidden">
            <section id="inventory-editor" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Edit Inventory Item</h2>
              <form id="edit-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="w-full md:col-span-2">
                    <label for="edit-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
                    <select id="edit-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
                      <option value="">-- Select an item --</option>
                    </select>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
                    <input type="text" id="edit-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-current-inventory" class="block text-sm font-medium text-gray-400">Current Inventory</label>
                    <input type="number" id="edit-item-current-inventory" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold</label>
                    <input type="number" id="edit-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
                    <input type="number" step="0.01" id="edit-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
                    <input type="number" step="0.01" id="edit-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
                    <input type="text" id="edit-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://..." disabled>
                  </div>
                </div>
                <div class="space-y-3 p-4 rounded-lg border border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-cyan">Certificate of Analysis</h3>
                  <div>
                    <label for="edit-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
                    <div class="mt-1 flex flex-col sm:flex-row gap-2">
                      <input type="text" id="edit-item-coa" class="flex-1 bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://..." disabled>
                      <button type="button" id="edit-item-deprecate-btn" class="btn-neon-red px-4 py-2 rounded-lg font-semibold text-xs sm:text-sm opacity-60 cursor-not-allowed" disabled>Deprecate</button>
                    </div>
                  </div>
                  <div>
                    <label for="edit-item-coa-lot" class="block text-sm font-medium text-gray-400">COA Lot</label>
                    <input type="text" id="edit-item-coa-lot" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="MG-..." disabled>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" id="edit-item-is-active" class="h-4 w-4 text-cyan-600 border-gray-600 rounded focus:ring-cyan-500" disabled>
                    <label for="edit-item-is-active" class="text-sm font-medium text-gray-400">Active</label>
                  </div>
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" id="edit-item-blend" class="h-4 w-4 text-cyan-600 border-gray-600 rounded focus:ring-cyan-500" disabled>
                    <label for="edit-item-blend" class="text-sm font-medium text-gray-400">Blend</label>
                  </div>
                </div>
                <div>
                  <label for="edit-item-description" class="block text-sm font-medium text-gray-400">Product Description</label>
                  <textarea id="edit-item-description" rows="3" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Short description of the product" disabled></textarea>
                </div>
                <div class="flex justify-center">
                  <button type="submit" id="edit-item-save-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto opacity-60 cursor-not-allowed" disabled>Save Changes</button>
                </div>
              </form>
            </section>
          </div>
          <div id="cost-tool-wrapper" class="mt-4 hidden">
            <section id="cost-tool" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add Cost History Entry</h2>
              <form id="add-cost-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="w-full md:col-span-2">
                    <label for="existing-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
                    <select id="existing-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
                      <option value="">-- Select an item --</option>
                    </select>
                  </div>
                  <div class="w-full">
                    <label for="cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                    <input type="number" step="0.01" id="cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="$0.00" required>
                  </div>
                  <div class="w-full">
                    <label for="total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                    <input type="number" id="total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
                  </div>
                  <div class="w-full">
                    <label for="total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                    <input type="number" id="total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
                  </div>
                  <div class="w-full">
                    <label for="purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                    <input type="date" id="purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
                  </div>
                </div>
                <div class="flex justify-center mt-6">
                  <button type="submit" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Cost Entry</button>
                </div>
              </form>
            </section>
          </div>
          <div id="promo-tool-wrapper" class="mt-4 hidden">
            <section id="promo-tool">
              <div class="promo-wrap">
                <h2 class="promo-title">Promo Codes Admin <span class="promo-pill">local tool</span></h2>
                <div class="promo-card">
                  <div class="row">
                    <div>
                      <label>Function Endpoint (HTTPS)</label>
                      <input id="endpoint" type="text" value="https://us-central1-peptide-inventory.cloudfunctions.net/upsertPromoCodesHttp" />
                      <div class="hint">Change if your project or region differs.</div>
                    </div>
                    <div>
                      <label>Admin Key</label>
                      <div style="display:flex; gap:8px;">
                        <input id="adminKey" type="password" placeholder="Your secret admin key" />
                        <button class="btn" id="toggleKey" title="Show/Hide">Show</button>
                      </div>
                      <div class="hint">Never embed this in public code. Use this page locally.</div>
                    </div>
                  </div>

                  <div class="toolbar">
                    <button class="btn" id="addRow">+ Add Code</button>
                    <button class="btn ghost" id="loadSample">Load sample</button>
                    <button class="btn" id="preview">Preview JSON</button>
                    <button class="btn ok" id="push">Push to Firebase</button>
                    <button class="btn ghost" id="exportJson">Export JSON</button>
                    <label class="btn ghost" for="importFile" style="cursor:pointer;">Import JSON</label>
                    <input id="importFile" type="file" accept="application/json" style="display:none;" />
                  </div>

                  <div id="codes" class="codes"></div>

                  <div class="footnote">
                    Tip: For <span class="muted">expiresAt</span> use your local date/time; it will be sent as ISO (UTC). “free_shipping” ignores value.
                  </div>

                  <h3 style="margin:18px 0 6px">Payload Preview / Response</h3>
                  <div id="log" class="log muted">No actions yet.</div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </section>

      <!-- Inventory Section -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Current Inventory</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Vials Sold</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Sell Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Vial Weight (mg)</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Active</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </div>

      <!-- Totals -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>

      <!-- Orders -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <label for="order-search" class="sr-only">Search Orders</label>
          <input id="order-search" type="search" placeholder="Search by order ID, customer name, or phone" class="w-full sm:w-80 bg-gray-800 border border-gray-600 rounded-md shadow-sm p-3 text-gray-200 focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" spellcheck="false">
        </div>
        <div id="orders-container" class="space-y-6">
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
        <div id="orders-pagination" class="mt-4 flex justify-center hidden">
          <button id="load-more-orders" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs">Load More</button>
        </div>
      </div>

      <!-- Email List -->
      <div id="email-list-section" class="space-y-4 mt-8">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Email List</h2>
          <div class="flex flex-wrap items-center gap-2">
            <button id="email-list-copy-all" class="btn-neon-cyan px-3 py-1 text-xs font-semibold rounded-lg hidden">Copy Emails</button>
            <button id="email-list-toggle" class="btn-neon-lime px-3 py-1 text-xs font-semibold rounded-lg" aria-expanded="true" aria-controls="email-list-wrapper">Collapse</button>
          </div>
        </div>
        <div id="email-list-wrapper" class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-3">
          <div id="email-list-summary" class="hidden text-gray-300 text-sm"></div>
          <div id="email-list-loading" class="text-gray-500 text-sm">Loading emails...</div>
          <div id="email-list-empty" class="hidden text-gray-500 text-sm">No emails found yet.</div>
          <ul id="email-list" class="hidden divide-y divide-gray-800"></ul>
        </div>
      </div>

      <!-- Trend Tool -->
      <div id="trend-tool-section" class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Product Trend Tool</h2>
        <div class="trend-shell">
          <div class="grid gap-4 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] mb-4">
            <div class="trend-card">
              <label for="trend-product-select">Focus Product</label>
              <select id="trend-product-select" class="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-3 text-gray-200 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="">Loading...</option>
              </select>
              <p class="trend-subtext">Pick a product to see velocity, bundle trends, and restock guidance.</p>
            </div>
            <div class="trend-card">
              <p class="trend-label">Top Performer (30d)</p>
              <p id="trend-top-performer" class="trend-value">—</p>
              <p id="trend-top-performer-meta" class="trend-subtext">Waiting on paid orders to surface a leader.</p>
            </div>
          </div>
          <div id="trend-no-data" class="text-center text-gray-500 py-8">
            Waiting on paid orders to compute trend insights.
          </div>
          <div id="trend-content" class="space-y-4 hidden">
            <div class="trend-grid">
              <div class="trend-card">
                <p class="trend-label">Units Sold (30d)</p>
                <p id="trend-metric-units-30" class="trend-value">0</p>
              </div>
              <div class="trend-card">
                <p class="trend-label">Orders (30d)</p>
                <p id="trend-metric-orders-30" class="trend-value">0</p>
                <p id="trend-metric-orders-detail" class="trend-subtext">—</p>
              </div>
              <div class="trend-card">
                <p class="trend-label">Sales Velocity</p>
                <p id="trend-metric-velocity" class="trend-value">0.00 units/day</p>
                <p id="trend-metric-velocity-subtext" class="trend-subtext">—</p>
              </div>
              <div class="trend-card">
                <p class="trend-label">Restock Suggestion</p>
                <p id="trend-metric-restock" class="trend-value">—</p>
                <p id="trend-restock-note" class="trend-subtext">Select a product to calculate restock guidance.</p>
              </div>
            </div>
            <div class="trend-subgrid">
              <div class="trend-card">
                <p class="trend-label">Frequently Bought With</p>
                <ul id="trend-co-purchase-list" class="trend-list"></ul>
              </div>
              <div class="trend-card">
                <p class="trend-label">Sales Snapshot</p>
                <div class="space-y-2 text-sm text-gray-300">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Revenue (30d)</span>
                    <span id="trend-revenue-30" class="font-semibold text-cyan-300">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Revenue (all)</span>
                    <span id="trend-revenue-all" class="font-semibold text-cyan-300">$0.00</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Units sold (all)</span>
                    <span id="trend-units-all" class="font-semibold text-cyan-300">0</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Avg per order</span>
                    <span id="trend-avg-per-order" class="font-semibold text-cyan-300">—</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Last sold</span>
                    <span id="trend-last-sold" class="font-semibold text-cyan-300">—</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Infographics -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Average Order Total</h3>
            <p id="average-order-total" class="text-3xl font-bold text-center text-cyan-200">$0.00</p>
            <p class="text-xs text-center text-slate-400 mt-2">Paid orders only</p>
          </div>
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Daily Total Sales</h3>
            <p id="daily-total-sales" class="text-3xl font-bold text-center text-cyan-200">$0.00</p>
            <p class="text-xs text-center text-slate-400 mt-2">Paid orders today</p>
          </div>
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Weekly Total Sales</h3>
            <p id="weekly-total-sales" class="text-3xl font-bold text-center text-cyan-200">$0.00</p>
            <p class="text-xs text-center text-slate-400 mt-2">Paid orders last 7 days</p>
          </div>
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Daily Average Order Total</h3>
            <p id="daily-average-order" class="text-3xl font-bold text-center text-cyan-200">N/A</p>
            <p class="text-xs text-center text-slate-400 mt-2">Paid orders today</p>
          </div>
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Utah Taxes</h3>
            <p id="utah-tax-total" class="text-3xl font-bold text-center text-cyan-200">$0.00</p>
            <p id="utah-order-count" class="text-sm text-center text-cyan-100">0 paid orders</p>
            <p class="text-xs text-center text-slate-400 mt-2">Aggregated paid orders</p>
          </div>
          <div class="infographic-card rounded-lg p-4 flex flex-col justify-center">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-2">Largest Order</h3>
            <p id="largest-order-amount" class="text-3xl font-bold text-center text-cyan-200">$0.00</p>
            <p id="largest-order-meta" class="text-sm text-center text-cyan-100">No paid orders yet</p>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <ul id="list-monthly-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <ul id="list-top-customers" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <ul id="list-top-products-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <ul id="list-top-products-quantity" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Affiliate Promo Codes</h3>
            <ul id="list-affiliate-promos" class="infographic-list"></ul>
            <p id="affiliate-promos-empty" class="text-xs text-center text-slate-400 mt-2 hidden">No affiliate promo sales yet.</p>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
          No sales data to display yet.
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="edit-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-order-modal" class="modal-main hidden">
    <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
      <h2 class="text-2xl font-bold">Edit Order</h2>
      <button id="close-edit-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="edit-order-form" class="space-y-4">
      <input type="hidden" id="edit-order-id">
      <div>
        <label for="edit-contact-name" class="block text-sm font-medium text-gray-400">Customer Name</label>
        <input type="text" id="edit-contact-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
      </div>
      <div>
        <label for="edit-order-total" class="block text-sm font-medium text-gray-400">Total Amount</label>
        <input type="number" step="0.01" id="edit-order-total" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500">
      </div>
      <div class="text-sm text-gray-400 -mt-2">
        Shipping (preserved): <span id="edit-shipping-display">$0.00</span>
      </div>
      <div>
        <label for="edit-order-status" class="block text-sm font-medium text-gray-400">Payment Status</label>
        <select id="edit-order-status" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          <option value="Paid">Paid</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <!-- Read-only Items -->
      <div class="space-y-4">
        <h3 class="text-md font-semibold text-gray-400 mt-4">Order Items:</h3>
        <div id="edit-order-items-list" class="space-y-2"></div>

        <!-- Shipping & Tracking (kept) -->
        <div class="space-y-4 mt-6">
          <h3 class="text-md font-semibold text-gray-400">Shipping & Tracking</h3>
          <div id="edit-order-tracking-list" class="space-y-2"></div>
          <input type="hidden" id="edit-order-tracking-hidden" value="[]">
          <div class="flex flex-col sm:flex-row gap-2 items-end">
            <div class="w-full sm:w-48">
              <label for="edit-track-carrier" class="block text-sm font-medium text-gray-400">Carrier</label>
              <select id="edit-track-carrier" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="">-- Select --</option>
                <option>USPS</option>
                <option>UPS</option>
                <option>FedEx</option>
                <option>DHL</option>
                <option>Other</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="edit-track-number" class="block text-sm font-medium text-gray-400">Tracking Number</label>
              <input id="edit-track-number" type="text" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., 9400 1234 5678 9012 3456 78">
            </div>
            <button type="button" id="edit-track-add-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto mt-4 sm:mt-0">Add Tracking</button>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Prepare Order Modal -->
  <div id="prepare-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="prepare-order-modal" class="modal-main hidden">
    <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
      <h2 class="text-2xl font-bold">Prepare Order</h2>
      <button id="prepare-order-close-icon" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors" aria-label="Close prepare order modal">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="space-y-6 text-gray-300">
      <div>
        <p class="text-sm text-gray-400 uppercase tracking-wide">Order ID</p>
        <p id="prepare-order-id" class="mt-1 text-lg font-semibold text-cyan-200">—</p>
      </div>
      <div>
        <p class="text-sm text-gray-400 uppercase tracking-wide">Customer</p>
        <div id="prepare-order-customer" class="mt-1 text-sm text-gray-200">—</div>
      </div>
      <div>
        <div class="flex items-center justify-between">
          <p class="text-sm text-gray-400 uppercase tracking-wide">Items</p>
          <p id="prepare-order-total-items" class="text-sm text-gray-300">Total Items: 0</p>
        </div>
        <ul id="prepare-order-items" class="mt-2 space-y-2 text-sm text-gray-200">
          <li class="text-gray-500 italic">No items found for this order.</li>
        </ul>
      </div>
      <div>
        <p class="text-sm text-gray-400 uppercase tracking-wide">Notes</p>
        <textarea id="prepare-order-notes" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-md p-3 text-sm text-gray-200 focus:ring-cyan-500 focus:border-cyan-500" rows="3" placeholder="Packing notes or reminders"></textarea>
      </div>
    </div>
    <div class="flex justify-end gap-3 mt-8">
      <button id="prepare-order-cancel-btn" class="btn-neon-red px-4 py-2 rounded-lg font-semibold">Cancel</button>
      <button id="prepare-order-start-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold">Mark As In Progress</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, setDoc, arrayUnion, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
    authDomain: "peptide-inventory.firebaseapp.com",
    projectId: "peptide-inventory",
    storageBucket: "peptide-inventory.firebasestorage.app",
    messagingSenderId: "547049240971",
    appId: "1:547049240971:web:83b2e836fee57bb41f578e",
    measurementId: "G-1W58JMJN37"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  try { getAnalytics(app); } catch (_) {}
  const fns = getFunctions(app);
  const resendFn = httpsCallable(fns, "resendOrderConfirmation");
  const sendShippingFn = httpsCallable(fns, "sendShippingConfirmation");

  const qs = (id) => document.getElementById(id);
  const ORDERS_PAGE_SIZE = 5;
  const UTAH_SALES_TAX_RATE = 0.065; // fallback rate if no explicit tax is stored
  const AFFILIATE_PROMO_CODES = new Map(
    [
      ['ROOKIE', { label: 'Rookie' }],
    ].map(([code, meta])=>[String(code || '').toUpperCase(), meta])
  ); // Add new affiliate codes or labels here to include them in the infographic
  const AFFILIATE_PAYOUT_STORAGE_KEY = 'affiliatePayoutLedger';
  const DAY_MS = 24 * 60 * 60 * 1000;
  const TREND_WINDOW_DAYS = 30;
  const TREND_PAIR_WINDOW_DAYS = 90;
  const RESTOCK_WINDOW_DAYS = 14;
  const TREND_MINIMUM_BUFFER = 2;
  let visibleOrdersCount = ORDERS_PAGE_SIZE;
  let orderSearchTerm = '';
  let userAdjustedOrderView = false;
  let sortedOrdersCache = [];
  let userId = null;
  let totalRevenue = 0;
  let totalCost = 0;
  let allOrdersCache = [];
  let previousOrdersCache = new Map();
  let inventoryCache = {};
  let activePrepareOrderId = null;
  let trendAnalyticsCache = null;
  let trendSelectedKey = null;
  let affiliatePayoutLedger = loadAffiliatePayoutLedger();
  let emailListDocsCache = [];
  let emailListLoaded = false;
  let emailListError = null;
  let emailListCollapsed = true;
  let emailListCombinedEntries = [];

  const loadMoreOrdersBtn = qs('load-more-orders');
  const ordersPagination = qs('orders-pagination');
  const orderSearchInput = qs('order-search');
  const emailListContainer = qs('email-list');
  const emailListLoadingEl = qs('email-list-loading');
  const emailListEmptyEl = qs('email-list-empty');
  const emailListSummaryEl = qs('email-list-summary');
  const emailListWrapper = qs('email-list-wrapper');
  const emailListToggleBtn = qs('email-list-toggle');
  const emailListCopyBtn = qs('email-list-copy-all');
  const emailListPendingWrites = new Set();

  if(emailListToggleBtn){
    emailListToggleBtn.addEventListener('click', () => {
      setEmailListCollapsed(!emailListCollapsed);
    });
  }

  if(emailListCopyBtn){
    emailListCopyBtn.addEventListener('click', () => {
      if(emailListCombinedEntries.length === 0){
        showModal('No emails available to copy yet.');
        return;
      }
      const payload = emailListCombinedEntries
        .map(entry => `${entry.uid || ''}, ${entry.email}`)
        .join('\n');
      if(copyToClipboard(payload)) indicateCopy(emailListCopyBtn);
    });
  }

  setEmailListCollapsed(true);

  const processedTransitions = new Set();
  function transitionKey(before, after) {
    const b = before ? before.paymentStatus : '∅';
    const a = after  ? after.paymentStatus  : '∅';
    const itemsHash = JSON.stringify(after?.items || []);
    return `${after.id}|${b}->${a}|${itemsHash}`;
  }

  const INVENTORY_COLLECTION_PATH = 'inventory';
  const ORDERS_COLLECTION_PATH = 'orders';
  const EMAIL_LIST_COLLECTION_PATH = 'emailList';

  // Edit modal DOM
  const editOrderBackdrop = qs('edit-order-backdrop');
  const editOrderModal = qs('edit-order-modal');
  const closeEditModalBtn = qs('close-edit-modal-btn');
  const editOrderForm = qs('edit-order-form');

  const prepareOrderBackdrop = qs('prepare-order-backdrop');
  const prepareOrderModal = qs('prepare-order-modal');
  const prepareOrderCloseIcon = qs('prepare-order-close-icon');
  const prepareOrderCancelBtn = qs('prepare-order-cancel-btn');
  const prepareOrderStartBtn = qs('prepare-order-start-btn');
  const prepareOrderIdEl = qs('prepare-order-id');
  const prepareOrderCustomerEl = qs('prepare-order-customer');
  const prepareOrderItemsEl = qs('prepare-order-items');
  const prepareOrderTotalItemsEl = qs('prepare-order-total-items');
  const prepareOrderNotesInput = qs('prepare-order-notes');

  // Trend tool DOM
  const trendProductSelect = qs('trend-product-select');
  const trendTopPerformerEl = qs('trend-top-performer');
  const trendTopPerformerMetaEl = qs('trend-top-performer-meta');
  const trendContentEl = qs('trend-content');
  const trendNoDataEl = qs('trend-no-data');
  const trendUnits30El = qs('trend-metric-units-30');
  const trendOrders30El = qs('trend-metric-orders-30');
  const trendOrdersDetailEl = qs('trend-metric-orders-detail');
  const trendVelocityEl = qs('trend-metric-velocity');
  const trendVelocitySubtextEl = qs('trend-metric-velocity-subtext');
  const trendRestockValueEl = qs('trend-metric-restock');
  const trendRestockNoteEl = qs('trend-restock-note');
  const trendRevenueAllEl = qs('trend-revenue-all');
  const trendRevenue30El = qs('trend-revenue-30');
  const trendUnitsAllEl = qs('trend-units-all');
  const trendAvgPerOrderEl = qs('trend-avg-per-order');
  const trendLastSoldEl = qs('trend-last-sold');
  const trendCoPurchaseListEl = qs('trend-co-purchase-list');

  if(trendProductSelect){
    trendProductSelect.addEventListener('change', () => {
      trendSelectedKey = trendProductSelect.value;
      renderTrendDetails();
    });
  }

  // Add Item form inputs
  const addItemForm = qs('add-item-form');
  const newItemNameInput = qs('new-item-name');
  const newItemIdInput = qs('new-item-id');
  const newItemVialsSoldInput = qs('new-item-vials-sold');
  const newItemPriceInput = qs('new-item-price');
  const newItemTotalVialWeightInput = qs('new-item-total-vial-weight');
  const newItemBlendInput = qs('new-item-blend');
  const newItemIsActiveInput = qs('new-item-is-active');
  const newItemImageInput = qs('new-item-image');
  const newItemCoaInput = qs('new-item-coa');
  const newItemDescriptionInput = qs('new-item-description');
  const newCostPerKitInput = qs('new-cost-per-kit');
  const newTotalKitsBoughtInput = qs('new-total-kits-bought');
  const newTotalVialsPerKitInput = qs('new-total-vials-per-kit');
  const newPurchaseDateInput = qs('new-purchase-date');

  const inventoryEditorWrapper = qs('inventory-editor-wrapper');
  const toggleEditItemToolBtn = qs('toggle-edit-item-tool-btn');

  const editItemForm = qs('edit-item-form');
  const editItemSelect = qs('edit-item-select');
  const editItemNameInput = qs('edit-item-name');
  const editItemCurrentInventoryInput = qs('edit-item-current-inventory');
  const editItemVialsSoldInput = qs('edit-item-vials-sold');
  const editItemPriceInput = qs('edit-item-price');
  const editItemTotalVialWeightInput = qs('edit-item-total-vial-weight');
  const editItemImageInput = qs('edit-item-image');
  const editItemCoaInput = qs('edit-item-coa');
  const editItemCoaLotInput = qs('edit-item-coa-lot');
  const editItemIsActiveInput = qs('edit-item-is-active');
  const editItemBlendInput = qs('edit-item-blend');
  const editItemDescriptionInput = qs('edit-item-description');
  const editItemDeprecateBtn = qs('edit-item-deprecate-btn');
  const editItemSaveBtn = qs('edit-item-save-btn');

  // Add Cost
  const addCostForm = qs('add-cost-form');
  const existingItemSelect = qs('existing-item-select');
  const costPerKitInput = qs('cost-per-kit');
  const totalKitsBoughtInput = qs('total-kits-bought');
  const totalVialsPerKitInput = qs('total-vials-per-kit');
  const purchaseDateInput = qs('purchase-date');

  const costToolWrapper = qs('cost-tool-wrapper');
  const toggleCostToolBtn = qs('toggle-cost-tool-btn');
  const inventoryToolWrapper = qs('inventory-tool-wrapper');
  const toggleInventoryToolBtn = qs('toggle-inventory-tool-btn');
  const promoToolWrapper = qs('promo-tool-wrapper');
  const togglePromoToolBtn = qs('toggle-promo-tool-btn');
  const productionToolsSection = qs('production-tools-section');

  const TOOL_CONFIG = [
    { wrapper: costToolWrapper, button: toggleCostToolBtn, openLabel: 'Add Cost History', closeLabel: 'Add Cost History' },
    { wrapper: inventoryToolWrapper, button: toggleInventoryToolBtn, openLabel: 'Add Inventory', closeLabel: 'Add Inventory' },
    { wrapper: inventoryEditorWrapper, button: toggleEditItemToolBtn, openLabel: 'Edit Inventory', closeLabel: 'Edit Inventory' },
    { wrapper: promoToolWrapper, button: togglePromoToolBtn, openLabel: 'Promo Tool', closeLabel: 'Promo Tool' }
  ];

  function setToolOpen(tool, open){
    if(!tool || !tool.wrapper || !tool.button) return;
    if(open){
      tool.wrapper.classList.remove('hidden');
      tool.button.textContent = tool.closeLabel;
    }else{
      tool.wrapper.classList.add('hidden');
      tool.button.textContent = tool.openLabel;
    }
  }

  function closeAllTools(except){
    TOOL_CONFIG.forEach((tool)=>{
      if(tool === except) return;
      setToolOpen(tool,false);
    });
  }

  function normalizeLotTimestamp(entry){
    if(!entry) return new Date().toISOString().replace(/[^0-9]/g,'');
    const candidate = entry.timestamp ?? entry.purchaseDate ?? entry.date ?? entry.createdAt ?? entry.addedAt ?? entry.purchasedAt;
    if(!candidate) return new Date().toISOString().replace(/[^0-9]/g,'');
    if(typeof candidate === 'string'){
      const cleaned = candidate.replace(/[^0-9]/g,'');
      return cleaned || candidate;
    }
    if(typeof candidate === 'number') return String(Math.trunc(candidate));
    if(typeof candidate === 'object'){
      if(typeof candidate.toMillis === 'function') return String(candidate.toMillis());
      if(typeof candidate.seconds === 'number'){
        const millis = (candidate.seconds*1000) + (candidate.nanoseconds?candidate.nanoseconds/1e6:0);
        return String(Math.trunc(millis));
      }
    }
    return new Date().toISOString().replace(/[^0-9]/g,'');
  }

  function buildLotId(itemId, costHistory){
    const baseId = (itemId || '').toUpperCase();
    if(!Array.isArray(costHistory) || costHistory.length === 0){
      return `MG-${baseId}-${Date.now()}-1`;
    }
    const lastIndex = costHistory.length - 1;
    const lastEntry = costHistory[lastIndex] || {};
    const tsPart = normalizeLotTimestamp(lastEntry);
    const lotPosition = lastIndex + 1;
    return `MG-${baseId}-${tsPart}-${lotPosition}`;
  }

  function extractLotFromCostEntry(entry){
    if(!entry) return null;
    const candidates = [entry.lot, entry.lotId, entry.lotNumber];
    for(const candidate of candidates){
      if(typeof candidate === 'string'){
        const trimmed = candidate.trim();
        if(trimmed) return trimmed;
      }
    }
    return null;
  }

  function getMostRecentLotFromHistory(costHistory){
    if(!Array.isArray(costHistory) || costHistory.length === 0) return null;
    return extractLotFromCostEntry(costHistory[costHistory.length - 1]);
  }

  function extractCoaUrl(raw){
    if(!raw) return '';
    if(typeof raw === 'string') return raw;
    if(typeof raw === 'object') return raw.url || '';
    return '';
  }

  function extractCoaLot(raw){
    if(!raw) return '';
    if(typeof raw === 'string') return '';
    if(typeof raw === 'object'){
      const lot = raw.lot;
      if(typeof lot === 'string') return lot;
    }
    return '';
  }

  function computeNextCoaLot(itemId){
    const costHistory = Array.isArray(inventoryCache[itemId]?.costHistory) ? inventoryCache[itemId].costHistory : [];

    const storedLot = getMostRecentLotFromHistory(costHistory);
    if(storedLot) return storedLot;

    if(!costHistory.length){
      return buildLotId(itemId, costHistory);
    }

    return buildLotId(itemId, costHistory);
  }

  function ensureCoaStructure(itemId, item){
    const url = extractCoaUrl(item?.coa) || 'N/A';
    const lotExisting = (item?.coa && typeof item.coa === 'object') ? item.coa.lot : null;
    const lotFromHistory = getMostRecentLotFromHistory(item?.costHistory);
    const lot = lotExisting || lotFromHistory || buildLotId(itemId, item?.costHistory);
    return { url, lot };
  }

  function updateDeprecateButton(item, forceDisabled = false){
    if(!editItemDeprecateBtn) return;
    const coaUrl = extractCoaUrl(item?.coa);
    const hasActiveCoa = Boolean(coaUrl && coaUrl !== 'N/A');
    const shouldDisable = forceDisabled || !hasActiveCoa;
    editItemDeprecateBtn.disabled = shouldDisable;
    editItemDeprecateBtn.classList.toggle('opacity-60', shouldDisable);
    editItemDeprecateBtn.classList.toggle('cursor-not-allowed', shouldDisable);
  }

  function setEditFormDisabled(disabled){
    const inputs = [
      editItemNameInput,
      editItemCurrentInventoryInput,
      editItemVialsSoldInput,
      editItemPriceInput,
      editItemTotalVialWeightInput,
      editItemImageInput,
      editItemCoaInput,
      editItemCoaLotInput,
      editItemDescriptionInput,
      editItemIsActiveInput,
      editItemBlendInput
    ];
    inputs.forEach((input)=>{
      if(!input) return;
      input.disabled = disabled;
    });
    if(editItemSaveBtn){
      editItemSaveBtn.disabled = disabled;
      editItemSaveBtn.classList.toggle('opacity-60', disabled);
      editItemSaveBtn.classList.toggle('cursor-not-allowed', disabled);
    }
    const currentItem = (!disabled && editItemSelect) ? inventoryCache[editItemSelect.value] : null;
    updateDeprecateButton(currentItem, disabled);
  }

  function resetEditItemForm(){
    if(editItemNameInput) editItemNameInput.value='';
    if(editItemCurrentInventoryInput) editItemCurrentInventoryInput.value='';
    if(editItemVialsSoldInput) editItemVialsSoldInput.value='';
    if(editItemPriceInput) editItemPriceInput.value='';
    if(editItemTotalVialWeightInput) editItemTotalVialWeightInput.value='';
    if(editItemImageInput) editItemImageInput.value='';
    if(editItemCoaInput) editItemCoaInput.value='';
    if(editItemCoaLotInput) editItemCoaLotInput.value='';
    if(editItemDescriptionInput) editItemDescriptionInput.value='';
    if(editItemIsActiveInput) editItemIsActiveInput.checked=false;
    if(editItemBlendInput) editItemBlendInput.checked=false;
    if(editItemDeprecateBtn){
      editItemDeprecateBtn.textContent = 'Deprecate';
    }
    setEditFormDisabled(true);
  }

  function loadSelectedInventoryForEdit(itemId){
    if(!itemId || !inventoryCache[itemId]){
      resetEditItemForm();
      return;
    }

    const inv = inventoryCache[itemId];
    setEditFormDisabled(false);

    const asNumber = (val, fallback = '') => {
      const num = Number(val);
      if(Number.isFinite(num)) return num;
      return fallback;
    };
    const cleanField = (val) => {
      if(typeof val === 'string' && val.trim().toUpperCase() === 'N/A') return '';
      return val ?? '';
    };

    if(editItemNameInput) editItemNameInput.value = inv.name ?? '';
    if(editItemCurrentInventoryInput) editItemCurrentInventoryInput.value = asNumber(inv.currentInventory, '');
    if(editItemVialsSoldInput) editItemVialsSoldInput.value = asNumber(inv.vialsSold, '');
    if(editItemPriceInput) editItemPriceInput.value = asNumber(inv.sellPricePerVial, '');
    if(editItemTotalVialWeightInput) editItemTotalVialWeightInput.value = asNumber(inv.totalVialWeight, '');
    if(editItemImageInput) editItemImageInput.value = cleanField(inv.image);
    if(editItemCoaInput) editItemCoaInput.value = cleanField(extractCoaUrl(inv.coa));
    if(editItemCoaLotInput) editItemCoaLotInput.value = cleanField(extractCoaLot(inv.coa));
    if(editItemDescriptionInput) editItemDescriptionInput.value = cleanField(inv.productDescription);
    if(editItemIsActiveInput) editItemIsActiveInput.checked = Boolean(inv.productIsActive);
    if(editItemBlendInput) editItemBlendInput.checked = Boolean(inv.blend);
    updateDeprecateButton(inv);
  }

  function showModal(message){ qs('modal-message').textContent = message; qs('alert-modal').classList.remove('hidden'); }
  function isValidEmail(e){ return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase()); }
  function normalizeEmail(raw){
    if(typeof raw !== 'string') return null;
    const trimmed = raw.trim();
    if(!trimmed) return null;
    const lower = trimmed.toLowerCase();
    return isValidEmail(lower) ? lower : null;
  }
  const BASE62_ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  function toBase62(num){
    if(typeof num !== 'number' || !Number.isFinite(num)) return '0';
    let value = num >>> 0;
    if(value === 0) return '0';
    let out = '';
    while(value > 0){
      const remainder = value % 62;
      out = BASE62_ALPHABET.charAt(remainder) + out;
      value = Math.floor(value / 62);
    }
    return out;
  }
  function deriveStableUid(email, seed){
    const normalized = normalizeEmail(email);
    if(!normalized) return null;
    const payload = `${normalized}|${seed || ''}`;
    let h1 = 0x811c9dc5;
    let h2 = 0;
    for(let i=0; i<payload.length; i++){
      const code = payload.charCodeAt(i);
      h1 ^= code;
      h1 = Math.imul(h1, 16777619) >>> 0;
      h2 = (Math.imul(h2, 33) + code) >>> 0;
    }
    const h3 = Math.imul(h1 ^ h2, 2246822519) >>> 0;
    const h4 = Math.imul((h1 + h2 + payload.length) >>> 0, 3266489917) >>> 0;
    const part1 = toBase62(h1).padStart(8,'A');
    const part2 = toBase62(h2).padStart(8,'A');
    const part3 = toBase62(h3).padStart(8,'A');
    const part4 = toBase62(h4).padStart(8,'A');
    const combined = `${part1}${part2}${part3}${part4}`;
    return combined.slice(0, 28);
  }
  function toUidString(raw){
    if(raw === null || typeof raw === 'undefined') return null;
    if(typeof raw === 'string'){
      const trimmed = raw.trim();
      if(!trimmed) return null;
      if(trimmed.includes('@')) return null;
      if(trimmed.toLowerCase() === 'null' || trimmed.toLowerCase() === 'undefined') return null;
      return trimmed;
    }
    if(typeof raw === 'number'){
      return String(raw);
    }
    if(typeof raw === 'object'){
      const candidates = [
        raw.uid,
        raw.userUid,
        raw.userID,
        raw.userId,
        raw.customerUid,
        raw.customerID,
        raw.customerId,
        raw.authUid,
        raw.ownerUid,
        raw.accountUid,
        raw.accountId,
        raw.memberUid,
        raw.recipientUid,
        raw.recipientId
      ];
      for(const candidate of candidates){
        const resolved = toUidString(candidate);
        if(resolved) return resolved;
      }
      return null;
    }
    return null;
  }
  function extractEmailsFromEmailListDoc(entry){
    const results = [];
    if(!entry) return results;
    const seen = new Set();
    const data = entry.data || {};
    const docUid = toUidString(
      data.uid ??
      data.userUid ??
      data.userID ??
      data.userId ??
      data.customerUid ??
      data.customerID ??
      data.customerId ??
      data.authUid ??
      data.ownerUid ??
      data.accountUid ??
      data.accountId ??
      data.memberUid
    );
    const add = (value, metaUid) => {
      if(!value) return;
      if(typeof value === 'object'){
        if(typeof value.email === 'string'){
          const nestedUid = toUidString(value.uid ?? value.userUid ?? value.userId ?? metaUid ?? docUid);
          add(value.email, nestedUid);
        }
        return;
      }
      const normalized = normalizeEmail(value);
      if(!normalized || seen.has(normalized)) return;
      seen.add(normalized);
      const display = typeof value === 'string' && value.trim() ? value.trim() : normalized;
      const uid = toUidString(metaUid) || docUid || deriveStableUid(normalized, normalized);
      results.push({ normalized, display, uid });
    };
    add(entry.id, docUid);
    const candidates = [
      data?.email,
      data?.emailAddress,
      data?.address,
      data?.contact,
      data?.contactEmail,
      data?.value,
      data?.primaryEmail
    ];
    candidates.forEach(value => add(value, docUid));
    if(Array.isArray(data?.emails)) data.emails.forEach(value => add(value, docUid));
    if(Array.isArray(data?.values)) data.values.forEach(value => add(value, docUid));
    if(Array.isArray(data?.list)) data.list.forEach(value => add(value, docUid));
    return results;
  }
  function extractEmailsFromOrder(order){
    const results = [];
    if(!order || typeof order !== 'object') return results;
    const seen = new Set();

    const uidCandidates = new Set();
    const collectUid = (value) => {
      const uid = toUidString(value);
      if(uid) uidCandidates.add(uid);
    };
    const collectFromObject = (obj) => {
      if(!obj || typeof obj !== 'object') return;
      collectUid(obj.uid);
      collectUid(obj.userUid);
      collectUid(obj.userID);
      collectUid(obj.userId);
      collectUid(obj.customerUid);
      collectUid(obj.customerID);
      collectUid(obj.customerId);
      collectUid(obj.authUid);
      collectUid(obj.ownerUid);
      collectUid(obj.accountUid);
      collectUid(obj.accountId);
      collectUid(obj.memberUid);
      collectUid(obj.recipientUid);
      collectUid(obj.recipientId);
    };

    collectFromObject(order);
    collectUid(order.uid);
    collectUid(order.userUid);
    collectUid(order.userID);
    collectUid(order.userId);
    collectUid(order.customerUid);
    collectUid(order.customerID);
    collectUid(order.customerId);
    collectUid(order.authUid);
    collectUid(order.ownerUid);
    collectUid(order.createdByUid);
    collectUid(order.createdBy);
    collectUid(order.placedByUid);
    collectUid(order.accountUid);
    collectUid(order.accountId);
    collectUid(order.memberUid);

    const nestedObjects = [
      order.user,
      order.customer,
      order.account,
      order.profile,
      order.billing,
      order.shipping,
      order.contact,
      order.contactInfo,
      order.recipient,
      order.metadata,
      order.meta,
      order.customerProfile
    ];
    nestedObjects.forEach(collectFromObject);

    const nestedArrays = [
      order.users,
      order.customers,
      order.members,
      order.participants,
      order.attendees
    ];
    nestedArrays.forEach(list=>{
      if(Array.isArray(list)){
        list.forEach(item=>collectFromObject(item));
      }
    });

    const orderSeed = String(
      order.id ??
      order.orderId ??
      order.orderNumber ??
      order.externalId ??
      order.customerId ??
      order.customerID ??
      order.uid ??
      order.userUid ??
      order.userId ??
      order.accountId ??
      order.accountUid ??
      ''
    );
    const fallbackUid = uidCandidates.values().next().value || null;

    const addEmail = (value, metaUid) => {
      if(!value) return;
      if(typeof value === 'object'){
        const candidateEmail = value.email ?? value.address ?? value.value ?? value.contactEmail;
        const candidateUid = toUidString(value.uid ?? value.userUid ?? value.userId ?? value.customerUid ?? value.recipientUid ?? metaUid);
        if(candidateEmail){
          addEmail(candidateEmail, candidateUid);
        }
        return;
      }
      const normalized = normalizeEmail(value);
      if(!normalized || seen.has(normalized)) return;
      seen.add(normalized);
      const display = typeof value === 'string' && value.trim() ? value.trim() : normalized;
      const baseUid = toUidString(metaUid) || fallbackUid;
      const uid = baseUid || deriveStableUid(normalized, orderSeed || normalized) || deriveStableUid(normalized, normalized);
      results.push({ normalized, display, uid });
    };

    const contact = order.contactInfo || {};
    const contactUid = toUidString(contact.uid ?? contact.userUid ?? contact.userId ?? contact.customerUid);
    const contactCandidates = [
      contact.email,
      contact.emailPrimary,
      contact.primaryEmail,
      contact.altEmail,
      contact.alternateEmail
    ];
    contactCandidates.forEach(value => addEmail(value, contactUid));
    if(Array.isArray(contact.emails)) contact.emails.forEach(value => addEmail(value, contactUid));

    const directCandidates = [
      { value: order.email, uid: order.uid ?? order.userUid ?? order.userId ?? order.customerUid },
      { value: order.customerEmail, uid: order.customerUid ?? order.customerId },
      { value: order.receiptEmail, uid: order.uid ?? order.userUid ?? order.userId },
      { value: order.recipientEmail, uid: order.recipientUid ?? order.recipientId }
    ];
    directCandidates.forEach(({ value, uid }) => addEmail(value, uid));

    const additionalObjects = [
      order.customer,
      order.user,
      order.account,
      order.profile,
      order.billing,
      order.shipping,
      order.contact,
      order.recipient
    ];
    additionalObjects.forEach(obj=>{
      if(!obj || typeof obj !== 'object') return;
      const objUid = toUidString(obj.uid ?? obj.userUid ?? obj.userId ?? obj.customerUid ?? obj.accountUid ?? obj.memberUid ?? obj.recipientUid);
      addEmail(obj.email, objUid);
    });

    const orderEmailsArray = Array.isArray(order.emails) ? order.emails : [];
    orderEmailsArray.forEach(value => addEmail(value, fallbackUid));

    const recipientsArray = Array.isArray(order.recipients) ? order.recipients : [];
    recipientsArray.forEach(item=>{
      if(item && typeof item === 'object'){
        const itemUid = toUidString(item.uid ?? item.userUid ?? item.userId ?? item.customerUid ?? item.recipientUid);
        const candidateEmail = item.email ?? item.address ?? item.value ?? item.contactEmail;
        addEmail(candidateEmail, itemUid);
      }else{
        addEmail(item, fallbackUid);
      }
    });

    const usersArray = Array.isArray(order.users) ? order.users : [];
    usersArray.forEach(userObj=>{
      if(!userObj || typeof userObj !== 'object') return;
      const userUid = toUidString(userObj.uid ?? userObj.userUid ?? userObj.userId ?? userObj.id);
      addEmail(userObj.email, userUid);
    });

    const customersArray = Array.isArray(order.customers) ? order.customers : [];
    customersArray.forEach(customerObj=>{
      if(!customerObj || typeof customerObj !== 'object') return;
      const customerUid = toUidString(customerObj.uid ?? customerObj.userUid ?? customerObj.userId ?? customerObj.customerUid ?? customerObj.id);
      addEmail(customerObj.email, customerUid);
    });

    const participantsLists = [order.participants, order.members, order.attendees];
    participantsLists.forEach(list=>{
      if(Array.isArray(list)){
        list.forEach(item=>{
          if(item && typeof item === 'object'){
            const participantUid = toUidString(item.uid ?? item.userUid ?? item.userId ?? item.memberUid);
            addEmail(item.email, participantUid);
          }else{
            addEmail(item, fallbackUid);
          }
        });
      }
    });

    return results;
  }
  function copyToClipboard(text){
    const t=document.createElement('textarea');
    t.value=text;
    document.body.appendChild(t);
    t.select();
    let success=false;
    try{
      success=document.execCommand('copy');
      if(!success) throw new Error('Clipboard command rejected');
    }catch(e){
      showModal('Failed to copy.');
    }finally{
      document.body.removeChild(t);
    }
    return success;
  }
  function indicateCopy(btn){
    if(!btn) return;
    if(!btn.dataset.originalLabel){ btn.dataset.originalLabel = btn.textContent.trim(); }
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    if(btn._copyTimeout) clearTimeout(btn._copyTimeout);
    btn._copyTimeout = setTimeout(()=>{
      const label = btn.dataset.originalLabel || 'Copy';
      btn.textContent = label;
      btn.classList.remove('copied');
      btn._copyTimeout = null;
    }, 1200);
  }
  function resetCopyState(btn, fallback='Copy'){
    if(!btn) return;
    if(btn._copyTimeout){
      clearTimeout(btn._copyTimeout);
      btn._copyTimeout = null;
    }
    const label = btn.dataset?.originalLabel || fallback;
    btn.textContent = label;
    btn.classList.remove('copied');
  }
  function formatTimestamp(ts){ if(!ts) return 'Unknown date'; try{ if(typeof ts.toDate==='function'){ return ts.toDate().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});} const d=new Date(ts); if(!isNaN(d.getTime())) return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}catch(_){} return 'Unknown date'; }
  function currency(n){ const num=typeof n==='number'?n:Number(n??0); return num.toFixed(2); }
  function toDateOrNull(raw){
    if(!raw) return null;
    if(raw instanceof Date){
      return Number.isNaN(raw.valueOf())?null:raw;
    }
    if(typeof raw==='object'){
      if(typeof raw.toDate==='function'){
        try{
          const d=raw.toDate();
          if(d instanceof Date && !Number.isNaN(d.valueOf())) return d;
        }catch(_){}
      }
      if(typeof raw.toMillis==='function'){
        try{
          const d=new Date(raw.toMillis());
          if(!Number.isNaN(d.valueOf())) return d;
        }catch(_){}
      }
      if(typeof raw.seconds==='number'){
        const millis=(raw.seconds*1000)+(raw.nanoseconds?raw.nanoseconds/1e6:0);
        const d=new Date(millis);
        if(!Number.isNaN(d.valueOf())) return d;
      }
    }
    if(typeof raw==='number'){
      const d=new Date(raw);
      return Number.isNaN(d.valueOf())?null:d;
    }
    if(typeof raw==='string'){
      const trimmed=raw.trim();
      if(!trimmed) return null;
      const direct=new Date(trimmed);
      if(!Number.isNaN(direct.valueOf())) return direct;
      const numeric=Number(trimmed);
      if(Number.isFinite(numeric)){
        const d=new Date(numeric);
        if(!Number.isNaN(d.valueOf())) return d;
      }
    }
    return null;
  }
  function extractOrderDate(order){
    if(!order || typeof order!=='object') return null;
    const candidates=[
      order.timestamp,
      order.createdAt,
      order.created_at,
      order.orderedAt,
      order.orderDate,
      order.date,
      order.updatedAt
    ];
    for(const candidate of candidates){
      const date=toDateOrNull(candidate);
      if(date) return date;
    }
    return null;
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  const CARRIERS = ["USPS","UPS","FedEx","DHL","Other"];
  function buildTrackingUrl(carrier, num){
    const n=(num||"").trim(); const c=(carrier||"").toLowerCase(); if(!n) return "";
    if(c==="usps") return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(n)}`;
    if(c==="ups") return `https://www.ups.com/track?loc=en_US&tracknum=${encodeURIComponent(n)}`;
    if(c==="fedex") return `https://www.fedex.com/fedextrack/?trknbr=${encodeURIComponent(n)}`;
    if(c==="dhl") return `https://www.dhl.com/us-en/home/tracking.html?tracking-id=${encodeURIComponent(n)}`;
    return `https://www.google.com/search?q=${encodeURIComponent((carrier||"tracking")+" "+n)}`;
  }

  function extractTrackingEntries(raw){
    if(Array.isArray(raw)) return raw.map(entry => ({ ...entry }));
    if(raw && typeof raw === 'object' && Array.isArray(raw.entries)){
      return raw.entries.map(entry => ({ ...entry }));
    }
    return [];
  }

  function extractTrackingHasShipped(raw){
    if(raw && typeof raw === 'object'){
      if(typeof raw.hasShipped === 'boolean') return raw.hasShipped;
      if(Array.isArray(raw.entries)) return raw.entries.some(entry => Boolean(entry?.hasShipped));
    }
    if(Array.isArray(raw)) return raw.some(entry => Boolean(entry?.hasShipped));
    return false;
  }

  let _trackingMemoryCache = [];
  function readTrackingFromModal(){ const hidden=qs('edit-order-tracking-hidden'); if(!hidden) return _trackingMemoryCache.slice(); try{ return JSON.parse(hidden.value||"[]"); }catch{ return []; } }
  function setTrackingHidden(arr){ const hidden=qs('edit-order-tracking-hidden'); _trackingMemoryCache=Array.isArray(arr)?arr.slice():[]; if(hidden) hidden.value=JSON.stringify(_trackingMemoryCache); }
  function renderTrackingList(arr){
    const list=qs('edit-order-tracking-list'); if(!list) return; list.innerHTML='';
    (arr||[]).forEach((t,idx)=>{ const url=t.url||buildTrackingUrl(t.carrier,t.number);
      const row=document.createElement('div');
      const borderClass = t.hasShipped ? 'border-emerald-500' : 'border-gray-700';
      row.className=`flex items-center gap-2 p-2 border ${borderClass} rounded-md`;
      const shippedLabel = t.hasShipped ? 'Shipped' : 'Pending';
      const shippedClass = t.hasShipped ? 'text-emerald-300' : 'text-gray-500';
      row.innerHTML=`<span class="flex-1 text-gray-300 text-sm truncate"><span class="font-semibold">${t.carrier||'Carrier'}</span> — ${t.number||'—'}</span>
      <span class="text-xs font-semibold ${shippedClass}">${shippedLabel}</span>
      <a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 text-xs">Open</a>
      <button type="button" class="btn-neon-red px-2 py-1 rounded-lg font-semibold text-xs" data-remove="${idx}">Remove</button>`;
      list.appendChild(row);
    });
    list.querySelectorAll('[data-remove]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.remove); const cur=readTrackingFromModal(); cur.splice(idx,1); setTrackingHidden(cur); renderTrackingList(cur);
      });
    });
  }

  function updateFinancialUI(){
    const profit = totalRevenue - totalCost;
    qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
    qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    qs('total-profit').textContent = `$${profit.toFixed(2)}`;
  }

  function updateUI(user){
    const status=qs('status');
    const userDisplay=qs('user-id-display');
    const mainContent=qs('main-content');
    const loginForm=qs('login-form');
    const signoutBtn=qs('signout-btn');

    if(user){
      userId=user.uid;
      if(status) status.textContent='Status: Signed in';
      if(userDisplay) userDisplay.textContent='User ID: '+userId;
      if(mainContent) mainContent.classList.remove('hidden');
      if(loginForm) loginForm.classList.add('hidden');
      if(signoutBtn) signoutBtn.classList.remove('hidden');
      TOOL_CONFIG.forEach((tool)=>{
        if(tool.button) tool.button.classList.remove('hidden');
        setToolOpen(tool,false);
      });
      if(productionToolsSection) productionToolsSection.classList.remove('hidden');
      listenForInventory(); listenForOrders(); listenForEmailList();
    }else{
      userId=null;
      if(status) status.textContent='Status: Signed out';
      if(userDisplay) userDisplay.textContent='User ID: N/A';
      if(mainContent) mainContent.classList.add('hidden');
      if(loginForm) loginForm.classList.remove('hidden');
      if(signoutBtn) signoutBtn.classList.add('hidden');
      TOOL_CONFIG.forEach((tool)=>{
        setToolOpen(tool,false);
        if(tool.button) tool.button.classList.add('hidden');
      });
      if(productionToolsSection) productionToolsSection.classList.add('hidden');
      visibleOrdersCount = ORDERS_PAGE_SIZE;
      userAdjustedOrderView = false;
      orderSearchTerm = '';
      if(orderSearchInput) orderSearchInput.value='';
      sortedOrdersCache = [];
      allOrdersCache = [];
      previousOrdersCache.clear();
      updateLoadMoreVisibility(0);
      emailListDocsCache = [];
      emailListLoaded = false;
      emailListError = null;
      if(emailListContainer){
        emailListContainer.innerHTML = '';
        emailListContainer.classList.add('hidden');
      }
      if(emailListSummaryEl){
        emailListSummaryEl.textContent = '';
        emailListSummaryEl.classList.add('hidden');
      }
      if(emailListEmptyEl) emailListEmptyEl.classList.add('hidden');
      if(emailListLoadingEl){
        emailListLoadingEl.textContent = 'Loading emails...';
        emailListLoadingEl.classList.remove('hidden');
      }
      emailListCombinedEntries = [];
      emailListCollapsed = true;
      emailListPendingWrites.clear();
      setEmailListCollapsed(true);
      refreshEmailListUI();
    }
  }

  /* ============================
 * Inventory listener (RESTORED EDITING)
 * ============================ */
  /* ============================
 * Inventory listener (RESTORED EDITING + COST HISTORY SELECT BY ID)
 * ============================ */
function listenForInventory() {
  if (!userId) return;
  const ref = collection(db, INVENTORY_COLLECTION_PATH);

  onSnapshot(ref, (snap) => {
    const tbody = qs('inventory-list');
    if(tbody) tbody.innerHTML = '';

    const previousCostSelection = existingItemSelect ? (existingItemSelect.value || '') : '';
    const previousEditSelection = editItemSelect ? (editItemSelect.value || '') : '';

    if(existingItemSelect) existingItemSelect.innerHTML = '<option value="">-- Select an item --</option>';
    if(editItemSelect) editItemSelect.innerHTML = '<option value="">-- Select an item --</option>';

    if (snap.empty) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.setAttribute('colspan', '11');
      td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
      td.textContent = 'No inventory items.';
      tr.appendChild(td);
      if(tbody) tbody.appendChild(tr);
      resetEditItemForm();
      return;
    }

    totalCost = 0;
    inventoryCache = {};

    // Build fast lookup maps for order/inventory joins
    const inventoryById = {};
    const inventoryByNameLower = {};

    const docsMissingActiveFlag = [];
    const docsNeedingCoaUpgrade = [];

    snap.forEach((d) => {
      const item = d.data();
      const hasActiveFlag = typeof item.productIsActive === 'boolean';
      if (!hasActiveFlag) docsMissingActiveFlag.push(d.ref);
      const inv = { id: d.id, ...item, productIsActive: hasActiveFlag ? item.productIsActive : true };
      if (!item.coa || typeof item.coa !== 'object' || !('url' in item.coa)) {
        const newCoa = ensureCoaStructure(d.id, inv);
        inv.coa = newCoa;
        docsNeedingCoaUpgrade.push({ ref: d.ref, coa: newCoa });
      }
      inventoryCache[d.id] = inv;
      inventoryById[d.id] = inv;
      if (item.name) inventoryByNameLower[item.name.toLowerCase()] = inv;
    });

    if (docsMissingActiveFlag.length) {
      docsMissingActiveFlag.forEach((ref) => {
        updateDoc(ref, { productIsActive: true }).catch((err) => {
          console.error('Failed to backfill productIsActive flag:', err);
        });
      });
    }

    if (docsNeedingCoaUpgrade.length) {
      docsNeedingCoaUpgrade.forEach(({ ref, coa }) => {
        updateDoc(ref, { coa }).catch((err) => {
          console.error('Failed to upgrade COA structure:', err);
        });
      });
    }

    // helper available to the rest of the file:
    window._getInvFromOrderItem = function (it) {
      if (!it) return null;
      if (it.id && inventoryById[it.id]) return inventoryById[it.id];
      if (it.name && inventoryByNameLower[it.name.toLowerCase()]) return inventoryByNameLower[it.name.toLowerCase()];
      return null;
    };

    /* NEW: Populate the Cost History and Item Editor dropdowns with items by ID */
    const ids = Object.keys(inventoryById)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

    ids.forEach((id) => {
      const inv = inventoryById[id];
      const stock = Number.isFinite(inv?.currentInventory) ? inv.currentInventory : 0;

      if (existingItemSelect) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${id} — ${inv?.name || '(no name)'} (${stock} in stock)`;
        existingItemSelect.appendChild(opt);
      }

      if (editItemSelect) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${id} — ${inv?.name || '(no name)'}`;
        editItemSelect.appendChild(opt);
      }
    });

    if (existingItemSelect && previousCostSelection && ids.includes(previousCostSelection)) {
      existingItemSelect.value = previousCostSelection;
    }

    if (editItemSelect) {
      if (previousEditSelection && ids.includes(previousEditSelection)) {
        editItemSelect.value = previousEditSelection;
        loadSelectedInventoryForEdit(previousEditSelection);
      } else {
        editItemSelect.value = '';
        resetEditItemForm();
      }
    }

    // ===== Table render (unchanged) =====
    snap.forEach((d) => {
      const item = inventoryCache[d.id] || d.data();
      const tr = document.createElement('tr');
      tr.dataset.id = d.id;
      tr.className = 'hover:bg-gray-700 transition-colors duration-150';

      const nameTd = document.createElement('td');
      nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
      nameTd.textContent = item.name ?? '(no name)';
      nameTd.setAttribute('contenteditable', 'false');
      nameTd.dataset.field = 'name';

      const idTd = document.createElement('td');
      idTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      idTd.textContent = d.id; // show the Firestore doc id

      const activeTd = document.createElement('td');
      activeTd.className = 'px-6 py-4 whitespace-nowrap text-sm';
      const activeBtn = document.createElement('button');
      activeBtn.type = 'button';
      const setActiveVisual = (isActive) => {
        activeBtn.textContent = isActive ? 'Active' : 'Inactive';
        activeBtn.className = isActive
          ? 'px-3 py-1 rounded-lg text-xs font-semibold btn-neon-lime'
          : 'px-3 py-1 rounded-lg text-xs font-semibold btn-neon-red';
      };
      setActiveVisual(Boolean(item.productIsActive));
      activeBtn.addEventListener('click', async () => {
        const docId = tr.dataset.id;
        const current = Boolean(inventoryCache[docId]?.productIsActive);
        const next = !current;
        activeBtn.disabled = true;
        try {
          await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, docId), { productIsActive: next });
          if (inventoryCache[docId]) inventoryCache[docId].productIsActive = next;
          setActiveVisual(next);
          showModal(`Marked ${item.name || docId} as ${next ? 'active' : 'inactive'}.`);
        } catch (err) {
          console.error('Error updating productIsActive:', err);
          showModal('Failed to update product status.');
          setActiveVisual(current);
        } finally {
          activeBtn.disabled = false;
        }
      });
      activeTd.appendChild(activeBtn);

      const inventoryTd = document.createElement('td');
      inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      inventoryTd.textContent = item.currentInventory ?? 0;
      inventoryTd.setAttribute('contenteditable', 'false');
      inventoryTd.dataset.field = 'currentInventory';

      const vialsSoldTd = document.createElement('td');
      vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      vialsSoldTd.textContent = item.vialsSold ?? 0;
      vialsSoldTd.setAttribute('contenteditable', 'false');
      vialsSoldTd.dataset.field = 'vialsSold';

      const priceTd = document.createElement('td');
      priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
      priceTd.setAttribute('contenteditable', 'false');
      priceTd.dataset.field = 'sellPricePerVial';

      const totalVialWeightTd = document.createElement('td');
      totalVialWeightTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      totalVialWeightTd.textContent = item.totalVialWeight ?? 0;
      totalVialWeightTd.setAttribute('contenteditable', 'false');
      totalVialWeightTd.dataset.field = 'totalVialWeight';

      tr.appendChild(nameTd);
      tr.appendChild(idTd);
      tr.appendChild(inventoryTd);
      tr.appendChild(vialsSoldTd);
      tr.appendChild(priceTd);
      tr.appendChild(totalVialWeightTd);
      tr.appendChild(activeTd);
      tbody.appendChild(tr);

      if (Array.isArray(item.costHistory)) {
        totalCost += item.costHistory.reduce((sum, h) => sum + ((h.costPerKit || 0) * (h.totalKitsBought || 0)), 0);
      }
    });

    updateFinancialUI();
  }, (error) => {
    console.error('Error listening to inventory:', error);
    const tbody = qs('inventory-list');
    tbody.innerHTML = '';
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.setAttribute('colspan', '11');
    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
    td.textContent = 'Error loading inventory.';
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}


  

  /* vialsSold adjustments on status changes (keep) */
  async function updateInventorySalesImpact(orderId,type,items){
    if(!items || items.length===0) return;
    for(const it of items){
      const inv=window._getInvFromOrderItem(it); if(!inv) continue;
      const qty=Number(it.quantity||0); const sign=(type==='increment')?1:-1;
      try{
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), { vialsSold: increment(sign*qty) });
      }catch(err){ console.error(`Error updating vialsSold for ${inv.id}:`,err); showModal(`Error updating vialsSold for an item in order ${orderId}.`); }
    }
  }

  async function compareOrderItemsAndUpdateVials(prevItems,currentItems){
    const changes=new Map();
    for(const it of prevItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)-Number(it.quantity||0)); }
    for(const it of currentItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)+Number(it.quantity||0)); }
    const ops=[]; for(const [invId,delta] of changes.entries()){ if(!delta) continue; ops.push(updateDoc(doc(db, INVENTORY_COLLECTION_PATH, invId),{ vialsSold: increment(delta) })); }
    await Promise.all(ops);
  }

  /* Orders listener */
  function listenForOrders(){
    const ordersContainer=qs('orders-container'); const loading=qs('loading-orders'); const ref=collection(db, ORDERS_COLLECTION_PATH);
    onSnapshot(ref, async (snap)=>{
      // Handle modifications only (no added/removed side-effects & no extra fields)
      for(const change of snap.docChanges()){
        const id=change.doc.id; const currentOrder={ id, ...change.doc.data() };
        if(change.doc.metadata.hasPendingWrites){ previousOrdersCache.set(id,currentOrder); continue; }
        if(change.type==='modified'){
          const prev=previousOrdersCache.get(id); if(!prev){ previousOrdersCache.set(id,currentOrder); continue; }
          const key=transitionKey(prev,currentOrder); if(processedTransitions.has(key)){ previousOrdersCache.set(id,currentOrder); continue; }
          processedTransitions.add(key);

          const wasPaid = prev.paymentStatus==='Paid';
          const isPaid  = currentOrder.paymentStatus==='Paid';
          const wasUnpaid = prev.paymentStatus==='Unpaid';
          const isUnpaid  = currentOrder.paymentStatus==='Unpaid';

          // if(wasUnpaid && isPaid)       updateInventorySalesImpact(currentOrder.id,'increment',currentOrder.items);
          // else if(wasPaid && isUnpaid)  updateInventorySalesImpact(currentOrder.id,'decrement',currentOrder.items);
          // else if(wasPaid && isPaid){
          //   const p=JSON.stringify(prev.items||[]), c=JSON.stringify(currentOrder.items||[]);
          //   if(p!==c) compareOrderItemsAndUpdateVials(prev.items||[], currentOrder.items||[]);
          // }
          previousOrdersCache.set(id,currentOrder);
        } else if(change.type==='added'){
          previousOrdersCache.set(id,currentOrder);
        }
      }
      if(processedTransitions.size>1000) processedTransitions.clear();

      // Rebuild UI
      loading.style.display='none';
      if(snap.empty){
        ordersContainer.innerHTML=`<div class="text-center text-gray-500 py-12"><p class="text-lg">No orders found.</p><p class="text-sm mt-2">Your orders will appear here once they've been placed.</p></div>`;
        allOrdersCache=[]; totalRevenue=0; previousOrdersCache.clear();
        sortedOrdersCache=[];
        visibleOrdersCount = ORDERS_PAGE_SIZE;
        userAdjustedOrderView = false;
        updateFinancialUI();
        renderInfographics();
        updateLoadMoreVisibility(0);
        refreshEmailListUI();
        return;
      }

      allOrdersCache=snap.docs.map(d=>({ id:d.id, ...d.data() }));
      previousOrdersCache.clear(); snap.docs.forEach(d=>previousOrdersCache.set(d.id,{ id:d.id, ...d.data() }));

      const sorted=[...allOrdersCache].sort((a,b)=>{ const A=a.timestamp?.toMillis?.()??0; const B=b.timestamp?.toMillis?.()??0; return B-A; });

      totalRevenue = sorted.reduce((sum, order)=>{
        const items=Array.isArray(order.items)?order.items:[];
        const computed = items.reduce((s,it)=>s + (Number(it?.unitPrice||0)*Number(it?.quantity||1)),0);
        if(order.paymentStatus==='Paid'){ return sum + Number(order.total || computed); }
        return sum;
      },0);

      updateFinancialUI(); renderInfographics();

      sortedOrdersCache = sorted;
      if(!userAdjustedOrderView){
        visibleOrdersCount = Math.min(sortedOrdersCache.length, ORDERS_PAGE_SIZE);
      }
      if(sortedOrdersCache.length === 0){
        visibleOrdersCount = ORDERS_PAGE_SIZE;
      } else if(visibleOrdersCount > sortedOrdersCache.length){
        visibleOrdersCount = sortedOrdersCache.length;
      }

      renderOrdersList(sortedOrdersCache);
      refreshEmailListUI();
    },(err)=>{
      console.error('Error listening to orders:',err);
      const ordersContainer=qs('orders-container'); const loading=qs('loading-orders');
      loading.style.display='none';
      ordersContainer.innerHTML = `<div class="text-center text-red-500 py-12"><p class="text-lg">An error occurred.</p><p class="text-sm mt-2">Check the console for more details.</p></div>`;
      updateLoadMoreVisibility(0);
    });
  }

  function setEmailListCollapsed(flag){
    emailListCollapsed = Boolean(flag);
    if(emailListWrapper){
      emailListWrapper.classList.toggle('collapsed', emailListCollapsed);
    }
    if(emailListToggleBtn){
      emailListToggleBtn.textContent = emailListCollapsed ? 'Expand' : 'Collapse';
      emailListToggleBtn.setAttribute('aria-expanded', emailListCollapsed ? 'false' : 'true');
    }
  }

  function refreshEmailListUI(){
    if(!emailListContainer || !emailListLoadingEl || !emailListEmptyEl || !emailListSummaryEl) return;

    const entriesMap = new Map();
    const orders = Array.isArray(allOrdersCache) ? allOrdersCache : [];
    const savedDocs = Array.isArray(emailListDocsCache) ? emailListDocsCache : [];
    const orderBackfillMap = new Map();

    emailListCombinedEntries = [];

    savedDocs.forEach((docEntry)=>{
      const emails = extractEmailsFromEmailListDoc(docEntry);
      emails.forEach(({ normalized, display, uid })=>{
        if(!normalized) return;
        const ensuredUid = uid || deriveStableUid(normalized, normalized);
        const existing = entriesMap.get(normalized);
        if(existing){
          if(!existing.uid){
            existing.uid = ensuredUid;
          }
          existing.source = 'saved';
        }else{
          entriesMap.set(normalized, { normalized, email: display, source: 'saved', uid: ensuredUid });
        }
      });
    });

    orders.forEach((order)=>{
      const emails = extractEmailsFromOrder(order);
      emails.forEach(({ normalized, display, uid })=>{
        if(!normalized) return;
        const cleanUid = toUidString(uid) || deriveStableUid(normalized, normalized);
        const existing = entriesMap.get(normalized);
        if(existing){
          if(!existing.uid){
            existing.uid = cleanUid;
          }
        }else{
          entriesMap.set(normalized, { normalized, email: display, source: 'orders', uid: cleanUid });
        }
        const prior = orderBackfillMap.get(normalized);
        if(prior){
          if(!prior.uid){
            prior.uid = cleanUid;
          }
        }else{
          orderBackfillMap.set(normalized, { normalized, email: display, uid: cleanUid });
        }
      });
    });

    const entries = Array.from(entriesMap.values()).sort((a,b)=>a.normalized.localeCompare(b.normalized));
    const hasOrdersData = orders.length > 0;
    emailListCombinedEntries = entries;

    const savedEntriesCount = entries.filter(entry => entry.source === 'saved').length;
    const orderOnlyCount = entries.length - savedEntriesCount;

    ensureEmailListBackfill(Array.from(orderBackfillMap.values()));

    if(emailListError){
      emailListLoadingEl.textContent = 'Unable to load saved email list. Showing order emails only.';
      emailListLoadingEl.classList.remove('hidden');
    }else if(emailListLoaded || hasOrdersData){
      emailListLoadingEl.classList.add('hidden');
    }

    if(emailListCopyBtn){
      resetCopyState(emailListCopyBtn, 'Copy Emails');
      if(entries.length > 0){
        emailListCopyBtn.classList.remove('hidden');
      }else{
        emailListCopyBtn.classList.add('hidden');
      }
    }

    if(entries.length === 0){
      emailListContainer.innerHTML = '';
      emailListContainer.classList.add('hidden');
      emailListSummaryEl.classList.add('hidden');
      if(emailListLoaded || hasOrdersData || emailListError){
        emailListEmptyEl.classList.remove('hidden');
      }else{
        emailListEmptyEl.classList.add('hidden');
      }
      setEmailListCollapsed(emailListCollapsed);
      return;
    }

    emailListEmptyEl.classList.add('hidden');
    emailListContainer.innerHTML = entries.map(entry=>{
      const badgeClass = entry.source === 'orders' ? 'text-amber-300' : 'text-gray-500';
      const badgeText = entry.source === 'orders' ? 'From orders' : 'Saved email';
      const uidLine = entry.uid ? `<span class="block text-xs text-gray-500 break-all">UID: ${escapeHtml(entry.uid)}</span>` : '';
      return `<li class="py-2 flex flex-wrap items-start justify-between gap-3">
        <div class="min-w-0">
          <span class="text-gray-100 font-mono break-words">${escapeHtml(entry.email)}</span>
          ${uidLine}
        </div>
        <span class="text-xs font-semibold ${badgeClass} whitespace-nowrap">${badgeText}</span>
      </li>`;
    }).join('');
    emailListContainer.classList.remove('hidden');

    const summaryParts = [
      `Total ${entries.length}`,
      emailListLoaded ? `${savedEntriesCount} saved` : 'Saved list loading…',
      `${orderOnlyCount} from orders`
    ];
    emailListSummaryEl.textContent = summaryParts.join(' • ');
    emailListSummaryEl.classList.remove('hidden');
    setEmailListCollapsed(emailListCollapsed);
  }

  function ensureEmailListBackfill(orderEntries){
    if(!Array.isArray(orderEntries) || orderEntries.length === 0) return;
    if(!userId) return;

    const existingDocs = new Map();
    emailListDocsCache.forEach(({ id, data })=>{
      const key = normalizeEmail(data?.email ?? id) || id;
      existingDocs.set(key, data || {});
    });

    const queue = [];
    orderEntries.forEach((entry)=>{
      const id = entry?.normalized;
      if(!id || emailListPendingWrites.has(id)) return;
      const email = entry?.email || entry?.normalized || id;
      const derivedUid = deriveStableUid(id, email);
      const cleanUid = toUidString(entry?.uid) || derivedUid;
      const existing = existingDocs.get(id);
      const existingUid = existing ? toUidString(
        existing.uid ??
        existing.userUid ??
        existing.userID ??
        existing.userId ??
        existing.customerUid ??
        existing.customerID ??
        existing.customerId ??
        existing.authUid ??
        existing.ownerUid ??
        existing.accountUid ??
        existing.accountId ??
        existing.memberUid
      ) : null;
      if(existingUid && existingUid === cleanUid) return;
      emailListPendingWrites.add(id);
      queue.push({ id, email, uid: cleanUid, exists: Boolean(existing) });
    });
    if(queue.length === 0) return;
    const now = Date.now();
    const operations = queue.map(({ id, email, uid, exists })=>{
      const payload = { email, uid };
      if(exists){
        payload.updatedAt = now;
      }else{
        payload.createdFrom = 'orders';
        payload.createdAt = now;
      }
      return setDoc(
        doc(db, EMAIL_LIST_COLLECTION_PATH, id),
        payload,
        { merge: true }
      );
    });
    Promise.all(operations)
      .catch((err)=>{
        console.error('Failed to backfill order emails into emailList:', err);
      })
      .finally(()=>{
        queue.forEach(({ id })=> emailListPendingWrites.delete(id));
      });
  }

  function listenForEmailList(){
    const ref = collection(db, EMAIL_LIST_COLLECTION_PATH);
    onSnapshot(ref, (snap)=>{
      emailListLoaded = true;
      emailListError = null;
      emailListDocsCache = snap.docs.map(d=>({ id:d.id, data:d.data() }));
      refreshEmailListUI();
    },(err)=>{
      console.error('Error listening to email list:', err);
      emailListLoaded = true;
      emailListError = err;
      emailListDocsCache = [];
      refreshEmailListUI();
    });
  }

  function toFiniteNumber(value){
    if(typeof value === 'number') return Number.isFinite(value) ? value : null;
    if(typeof value === 'string'){
      const trimmed = value.trim();
      if(!trimmed) return null;
      const num = Number(trimmed.replace(/[^0-9.+-]/g,''));
      return Number.isFinite(num) ? num : null;
    }
    return null;
  }

  function resolveOrderItemsTotal(order){
    const items = Array.isArray(order?.items) ? order.items : [];
    const computed = items.reduce((sum,it)=> sum + (Number(it?.unitPrice||0)*Number(it?.quantity||1)),0);
    return Number.isFinite(computed) ? computed : 0;
  }

  function resolveOrderSubtotal(order, fallbackComputed){
    if(!order || typeof order !== 'object'){
      return Number.isFinite(fallbackComputed) ? fallbackComputed : 0;
    }
    const subtotal = toFiniteNumber(order?.subtotal);
    if(subtotal !== null) return subtotal;
    if(Number.isFinite(fallbackComputed)) return fallbackComputed;
    return resolveOrderItemsTotal(order);
  }

  function resolveOrderTotal(order){
    const total = toFiniteNumber(order?.total);
    if(total !== null) return total;
    return resolveOrderItemsTotal(order);
  }

  function resolvePromoCode(order){
    if(!order || typeof order !== 'object') return '';
    const promo = order.promo;
    if(typeof promo === 'string'){
      const trimmed = promo.trim();
      if(trimmed) return trimmed;
    }else if(promo && typeof promo === 'object'){
      const fields = ['code','id','key','label','name'];
      for(const field of fields){
        const value = promo[field];
        if(typeof value === 'string'){
          const trimmed = value.trim();
          if(trimmed) return trimmed;
        }
      }
    }
    const fallbackFields = [order.promoCode, order.promo_code, order.discountCode, order.discount_code];
    for(const value of fallbackFields){
      if(typeof value === 'string'){
        const trimmed = value.trim();
        if(trimmed) return trimmed;
      }
    }
    return '';
  }

  function loadAffiliatePayoutLedger(){
    if(typeof localStorage === 'undefined') return new Map();
    try{
      const raw = localStorage.getItem(AFFILIATE_PAYOUT_STORAGE_KEY);
      if(!raw) return new Map();
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return new Map();
      const entries = Object.entries(parsed).map(([code, record])=>{
        const normalized = String(code || '').toUpperCase();
        const subtotal = toFiniteNumber(record?.paidThroughSubtotal);
        const paidAtRaw = Number(record?.paidAt);
        return [
          normalized,
          {
            paidThroughSubtotal: subtotal !== null ? subtotal : 0,
            paidAt: Number.isFinite(paidAtRaw) ? paidAtRaw : null
          }
        ];
      });
      return new Map(entries);
    }catch(_){
      return new Map();
    }
  }

  function persistAffiliatePayoutLedger(){
    if(typeof localStorage === 'undefined') return;
    try{
      const obj = {};
      affiliatePayoutLedger.forEach((record, code)=>{
        obj[code] = {
          paidThroughSubtotal: Number(record?.paidThroughSubtotal) || 0,
          paidAt: Number.isFinite(record?.paidAt) ? record.paidAt : null
        };
      });
      localStorage.setItem(AFFILIATE_PAYOUT_STORAGE_KEY, JSON.stringify(obj));
    }catch(_){
      /* ignore persistence errors */
    }
  }

  function recordAffiliatePayout(code, subtotal){
    const normalized = String(code || '').toUpperCase();
    const safeSubtotal = Number.isFinite(subtotal) ? subtotal : 0;
    if(!(affiliatePayoutLedger instanceof Map)){
      affiliatePayoutLedger = new Map();
    }
    affiliatePayoutLedger.set(normalized, {
      paidThroughSubtotal: safeSubtotal,
      paidAt: Date.now()
    });
    persistAffiliatePayoutLedger();
  }

  function getAffiliateLedgerEntry(code){
    const normalized = String(code || '').toUpperCase();
    if(!(affiliatePayoutLedger instanceof Map)) return null;
    return affiliatePayoutLedger.get(normalized) || null;
  }

  function extractOrderSalesTax(order){
    if(!order || typeof order !== 'object') return 0;

    const candidateFields = [
      order?.salesTax,
      order?.sales_tax,
      order?.tax,
      order?.taxAmount,
      order?.tax_amount,
      order?.taxTotal,
      order?.totalTax,
      order?.taxes,
      order?.orderTax,
      order?.totals?.tax,
      order?.totals?.salesTax,
      order?.totals?.taxAmount,
      order?.summary?.tax,
      order?.summary?.salesTax,
      order?.summary?.taxTotal,
      order?.charges?.tax,
      order?.charges?.salesTax,
      order?.charges?.taxAmount
    ];

    for(const value of candidateFields){
      const numeric = toFiniteNumber(value);
      if(numeric !== null && numeric > 0) return numeric;
    }

    const collectionCandidates = [
      order?.fees,
      order?.fee,
      order?.charges,
      order?.surcharges,
      order?.additionalFees
    ];

    for(const collection of collectionCandidates){
      if(!Array.isArray(collection)) continue;
      for(const entry of collection){
        const label = String(entry?.label || entry?.name || entry?.type || '').toLowerCase();
        if(label.includes('tax')){
          const amount = toFiniteNumber(entry?.amount ?? entry?.value ?? entry?.total ?? entry?.price);
          if(amount !== null && amount > 0) return amount;
        }
      }
    }

    if(order?.charges && typeof order.charges === 'object' && !Array.isArray(order.charges)){
      const nestedTax = toFiniteNumber(order.charges.tax ?? order.charges.salesTax ?? order.charges.taxAmount);
      if(nestedTax !== null && nestedTax > 0) return nestedTax;
    }

    return 0;
  }

  function isUtahState(value){
    if(typeof value !== 'string') return false;
    const normalized = value.trim().toLowerCase();
    if(!normalized) return false;
    return normalized === 'ut' || normalized === 'utah' || normalized === 'utah, usa' || normalized === 'ut, usa';
  }

  function containsUtah(value){
    if(typeof value !== 'string') return false;
    const upper = value.toUpperCase();
    if(upper.includes('UTAH')) return true;
    return /\bUT\b/.test(upper);
  }

  function isUtahOrder(order){
    const stateFields = [
      order?.shipping?.state,
      order?.shippingState,
      order?.shippingDetails?.state,
      order?.shipping_address?.state,
      order?.shippingAddress?.state,
      order?.contactInfo?.state,
      order?.contactInfo?.shippingState,
      order?.contactInfo?.shipping?.state
    ];
    if(stateFields.some(value => isUtahState(value))) return true;

    const addressCandidates = [
      order?.contactInfo?.shippingAddress,
      order?.shippingAddress,
      order?.shipping?.address,
      order?.shipping?.fullAddress,
      order?.shipping?.line1,
      order?.shipping?.line2
    ];
    return addressCandidates.some(str => containsUtah(str));
  }

  function extractUtahTax(order){
    const potentialTaxFields = [
      order?.tax,
      order?.taxes,
      order?.taxAmount,
      order?.tax_amount,
      order?.taxTotal,
      order?.totalTax,
      order?.salesTax,
      order?.sales_tax,
      order?.orderTax,
      order?.totals?.tax,
      order?.totals?.salesTax,
      order?.summary?.tax,
      order?.summary?.taxTotal
    ];

    for(const value of potentialTaxFields){
      const numeric = toFiniteNumber(value);
      if(numeric !== null) return numeric;
    }

    if(Array.isArray(order?.items)){
      const perItemTax = order.items.reduce((sum,item)=>{
        const candidates = [
          item?.tax,
          item?.taxAmount,
          item?.tax_amount,
          item?.salesTax,
          item?.sales_tax
        ];
        const numeric = candidates.map(toFiniteNumber).find(v => v !== null);
        return sum + (numeric ?? 0);
      },0);
      if(perItemTax > 0) return perItemTax;
    }

    const total = resolveOrderTotal(order);
    if(total > 0) return total * UTAH_SALES_TAX_RATE;
    return 0;
  }

  function renderInfographics(){
    const placeholder=qs('infographic-placeholder');
    const avg=qs('average-order-total');
    const dailyTotal=qs('daily-total-sales');
    const weeklyTotal=qs('weekly-total-sales');
    const dailyAverage=qs('daily-average-order');
    const utahTax=qs('utah-tax-total');
    const utahCount=qs('utah-order-count');
    const largestAmount=qs('largest-order-amount');
    const largestMeta=qs('largest-order-meta');
    const m=qs('list-monthly-revenue');
    const c=qs('list-top-customers');
    const pr=qs('list-top-products-revenue');
    const pq=qs('list-top-products-quantity');
    const ap=qs('list-affiliate-promos');
    const apEmpty=qs('affiliate-promos-empty');
    if(avg) avg.textContent='N/A';
    if(dailyTotal) dailyTotal.textContent='$0.00';
    if(weeklyTotal) weeklyTotal.textContent='$0.00';
    if(dailyAverage) dailyAverage.textContent='N/A';
    if(utahTax) utahTax.textContent='$0.00';
    if(utahCount) utahCount.textContent='0 paid orders';
    if(largestAmount) largestAmount.textContent='$0.00';
    if(largestMeta) largestMeta.textContent='No paid orders yet';
    m.innerHTML=''; c.innerHTML=''; pr.innerHTML=''; pq.innerHTML='';
    if(ap) ap.innerHTML='';
    if(apEmpty) apEmpty.classList.add('hidden');
    const paidOrders = allOrdersCache.filter(o=>o.paymentStatus==='Paid');
    updateTrendUI(buildTrendAnalytics(paidOrders));
    if(allOrdersCache.length===0){ placeholder.classList.remove('hidden'); return; }
    placeholder.classList.add('hidden');
    if(avg){
      if(paidOrders.length===0){
        avg.textContent='N/A';
      }else{
        const totalPaid = paidOrders.reduce((sum, order)=> sum + resolveOrderTotal(order),0);
        const average = totalPaid / paidOrders.length;
        avg.textContent = `$${currency(average)}`;
      }
    }

    let startOfToday=null;
    let endOfToday=null;
    if((dailyTotal || dailyAverage || weeklyTotal) && paidOrders.length>0){
      startOfToday=new Date();
      startOfToday.setHours(0,0,0,0);
      endOfToday=new Date(startOfToday);
      endOfToday.setDate(endOfToday.getDate()+1);
    }

    if((dailyTotal || dailyAverage) && paidOrders.length>0 && startOfToday && endOfToday){
      let todayCount=0;
      let todayTotal=0;
      paidOrders.forEach(order=>{
        const orderDate=extractOrderDate(order);
        if(orderDate && orderDate>=startOfToday && orderDate<endOfToday){
          todayCount++;
          todayTotal+=resolveOrderTotal(order);
        }
      });
      if(dailyTotal) dailyTotal.textContent=`$${currency(todayTotal)}`;
      if(dailyAverage) dailyAverage.textContent=todayCount>0?`$${currency(todayTotal/todayCount)}`:'N/A';
    }

    if(weeklyTotal && paidOrders.length>0 && startOfToday && endOfToday){
      const startOfWeek=new Date(startOfToday);
      startOfWeek.setDate(startOfWeek.getDate()-6);
      let sevenDayTotal=0;
      paidOrders.forEach(order=>{
        const orderDate=extractOrderDate(order);
        if(orderDate && orderDate>=startOfWeek && orderDate<endOfToday){
          sevenDayTotal+=resolveOrderTotal(order);
        }
      });
      weeklyTotal.textContent=`$${currency(sevenDayTotal)}`;
    }

    if((largestAmount || largestMeta) && paidOrders.length>0){
      let bestOrder=null;
      let bestTotal=-Infinity;
      paidOrders.forEach(order=>{
        const total = resolveOrderTotal(order);
        if(total > bestTotal){
          bestTotal = total;
          bestOrder = order;
        }
      });
      if(bestOrder){
        if(largestAmount){
          largestAmount.textContent = `$${currency(bestTotal)}`;
        }
        if(largestMeta){
          const customer = (bestOrder.contactInfo?.fullName || '').trim();
          const orderId = bestOrder.orderId || bestOrder.id || '';
          const timestamp = bestOrder.timestamp?.toDate?.();
          const parts = [];
          if(customer) parts.push(customer);
          if(orderId) parts.push(`#${orderId}`);
          if(timestamp instanceof Date && !Number.isNaN(timestamp.valueOf())){
            parts.push(timestamp.toLocaleDateString('en-US'));
          }
          const meta = parts.length ? parts.join(' • ') : 'Paid order';
          largestMeta.textContent = meta;
        }
      }
    }

    if(utahTax || utahCount){
      const utahOrders = paidOrders.filter(isUtahOrder);
      if(utahCount){
        const countLabel = utahOrders.length === 1 ? '1 paid order' : `${utahOrders.length} paid orders`;
        utahCount.textContent = countLabel;
      }
      if(utahTax && utahOrders.length>0){
        const totalTax = utahOrders.reduce((sum, order)=> sum + extractUtahTax(order),0);
        utahTax.textContent = `$${currency(totalTax)}`;
      }
    }

    const monthlyTotals = new Map();
    paidOrders.forEach(order=>{
      const orderDate = extractOrderDate(order);
      if(!orderDate) return;
      const year = orderDate.getFullYear();
      const monthIndex = orderDate.getMonth(); // 0-based
      const key = `${year}-${String(monthIndex + 1).padStart(2,'0')}`;
      const existing = monthlyTotals.get(key) || 0;
      monthlyTotals.set(key, existing + resolveOrderTotal(order));
    });
    const sortedMonthlyKeys = Array.from(monthlyTotals.keys()).sort((a,b)=> a.localeCompare(b));
    sortedMonthlyKeys.forEach(key=>{
      const [yearStr, monthStr] = key.split('-');
      const year = Number(yearStr);
      const monthIndex = Number(monthStr) - 1;
      const labelDate = new Date(year, monthIndex, 1);
      const label = labelDate.toLocaleString('en-US',{ month:'long', year:'numeric' });
      const total = monthlyTotals.get(key) || 0;
      const li=document.createElement('li');
      li.innerHTML=`<span>${label}</span><span class="font-bold text-cyan-300">$${currency(total)}</span>`;
      m.appendChild(li);
    });

    const cust={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.contactInfo?.fullName){ const n=o.contactInfo.fullName; cust[n]=(cust[n]||0)+(o.total||0);} });
    Object.entries(cust).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; c.appendChild(li);
    });

    const prodRev={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodRev[name]=(prodRev[name]||0)+((it.unitPrice||0)*(it.quantity||0)); }); } });
    Object.entries(prodRev).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; pr.appendChild(li);
    });

    const prodQty={}; allOrdersCache.forEach(o=>{ if(o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodQty[name]=(prodQty[name]||0)+(it.quantity||0); }); } });
    Object.entries(prodQty).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,q])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">${q} sold</span>`; pq.appendChild(li);
    });

    if(ap){
      const affiliateTotals = new Map();
      const includeAllCodes = AFFILIATE_PROMO_CODES.size === 0;
      paidOrders.forEach(order=>{
        const codeRaw = resolvePromoCode(order);
        if(!codeRaw) return;
        const normalized = codeRaw.toUpperCase();
        if(!includeAllCodes && !AFFILIATE_PROMO_CODES.has(normalized)) return;
        const subtotal = resolveOrderSubtotal(order);
        if(subtotal <= 0) return;
        const current = affiliateTotals.get(normalized) || { code: normalized, label: codeRaw, count:0, subtotal:0 };
        current.count += 1;
        current.subtotal += subtotal;
        affiliateTotals.set(normalized, current);
      });
      const sorted = Array.from(affiliateTotals.values()).sort((a,b)=>{
        if(b.subtotal !== a.subtotal) return b.subtotal - a.subtotal;
        return a.code.localeCompare(b.code);
      });
      if(sorted.length === 0){
        if(apEmpty) apEmpty.classList.remove('hidden');
      }else{
        sorted.forEach(entry=>{
          const meta = AFFILIATE_PROMO_CODES.get(entry.code) || {};
          const label = meta.label || entry.label || entry.code;
          const salesLabel = entry.count === 1 ? '1 sale' : `${entry.count} sales`;
          const totalOwed = entry.subtotal * 0.10;
          const ledger = getAffiliateLedgerEntry(entry.code);
          const paidThroughSubtotal = Number(ledger?.paidThroughSubtotal) || 0;
          const outstandingSubtotal = Math.max(0, entry.subtotal - paidThroughSubtotal);
          const outstandingOwed = outstandingSubtotal * 0.10;
          const trackedPaid = Math.max(0, totalOwed - outstandingOwed);
          const outstandingLabel = outstandingOwed > 0.009
            ? `$${currency(outstandingOwed)} outstanding`
            : 'No outstanding payout';
          const outstandingClass = outstandingOwed > 0.009 ? 'text-amber-300 font-semibold' : 'text-emerald-300';
          const lastPaidAt = ledger?.paidAt && Number.isFinite(ledger.paidAt) ? new Date(ledger.paidAt) : null;
          const lastPaidDate = lastPaidAt && !Number.isNaN(lastPaidAt.valueOf())
            ? lastPaidAt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})
            : null;
          const lastPaidLabel = lastPaidDate
            ? `Logged ${lastPaidDate}${trackedPaid>0.009?` • $${currency(trackedPaid)} tracked`:''}`
            : 'No payout logged yet';

          const li=document.createElement('li');
          li.className='flex flex-col gap-2';

          const header=document.createElement('div');
          header.className='flex items-center justify-between gap-3';
          header.innerHTML=`<span class="font-semibold text-slate-200">${escapeHtml(label)}</span><span class="font-bold text-cyan-300">$${currency(totalOwed)} total</span>`;

          const subline=document.createElement('div');
          subline.className='flex items-center justify-between text-xs text-slate-400';
          subline.innerHTML=`<span>${salesLabel}</span><span class="${outstandingClass}">${outstandingLabel}</span>`;

          const footer=document.createElement('div');
          footer.className='flex flex-wrap items-center justify-between gap-3';
          const lastPaidSpan=document.createElement('span');
          lastPaidSpan.className='text-xs text-slate-500';
          lastPaidSpan.textContent=lastPaidLabel;
          const button=document.createElement('button');
          button.className='btn-neon-lime px-3 py-1 rounded text-xs font-semibold affiliate-pay-btn';
          button.textContent=outstandingOwed>0.009?'Log Payout':'Paid Up';
          if(outstandingOwed<=0.009){
            button.disabled=true;
            button.classList.add('opacity-60','cursor-not-allowed');
          }
          button.addEventListener('click',()=>{
            recordAffiliatePayout(entry.code, entry.subtotal);
            renderInfographics();
          });
          footer.append(lastPaidSpan, button);

          li.append(header, subline, footer);
          ap.appendChild(li);
        });
      }
    }
  }

  function resolveOrderKey(order, index){
    if(order && typeof order === 'object'){
      if(order.id) return `id:${order.id}`;
      if(order.orderId) return `orderId:${order.orderId}`;
      if(order.orderNumber) return `orderNumber:${order.orderNumber}`;
      if(order.externalId) return `external:${order.externalId}`;
      const ts = order.timestamp?.toMillis?.();
      if(Number.isFinite(ts)) return `ts:${ts}`;
      const created = toDateOrNull(order.createdAt ?? order.created_at ?? order.orderedAt ?? order.orderDate);
      if(created) return `created:${created.getTime()}`;
    }
    return `idx:${index}`;
  }

  function resolveUnitPrice(item){
    if(!item || typeof item !== 'object') return 0;
    const candidates = [
      item.unitPrice,
      item.price,
      item.unit_price,
      item.amount,
      item.cost,
      item.linePrice,
      item.lineTotal,
      item.totalPrice,
      item.subtotal
    ];
    for(const candidate of candidates){
      const parsed = toFiniteNumber(candidate);
      if(parsed !== null) return parsed;
    }
    if(item.unitPriceCents || item.priceCents){
      const cents = Number(item.unitPriceCents ?? item.priceCents);
      if(Number.isFinite(cents)) return cents / 100;
    }
    return 0;
  }

  function getProductKey(item){
    if(!item || typeof item !== 'object') return null;
    const candidates = [
      item.id,
      item.itemId,
      item.productId,
      item.sku,
      item.skuId,
      item.productCode,
      item.code,
      item.name,
      item.title,
      item.label
    ];
    for(const candidate of candidates){
      if(typeof candidate === 'string'){
        const trimmed = candidate.trim();
        if(trimmed) return trimmed;
      }else if(typeof candidate === 'number' && Number.isFinite(candidate)){
        return String(candidate);
      }
    }
    return null;
  }

  function getProductDisplayName(item, inventory){
    const candidates = [
      inventory?.name,
      item?.name,
      item?.title,
      item?.label,
      item?.productName,
      item?.sku,
      item?.id
    ];
    for(const value of candidates){
      if(typeof value === 'string'){
        const trimmed = value.trim();
        if(trimmed) return trimmed;
      }else if(typeof value === 'number' && Number.isFinite(value)){
        return String(value);
      }
    }
    return 'Unknown Item';
  }

  function getProductCode(item, inventory, fallback){
    const candidates = [
      inventory?.id,
      inventory?.code,
      item?.id,
      item?.itemId,
      item?.productId,
      item?.sku,
      item?.skuId,
      item?.code,
      item?.productCode,
      fallback
    ];
    for(const candidate of candidates){
      if(typeof candidate === 'string'){
        const trimmed = candidate.trim();
        if(trimmed) return trimmed;
      }else if(typeof candidate === 'number' && Number.isFinite(candidate)){
        return String(candidate);
      }
    }
    return fallback ?? null;
  }

  function ensureProductStats(map, key, item, inventory){
    let stats = map.get(key);
    const displayName = getProductDisplayName(item, inventory);
    const codeCandidate = getProductCode(item, inventory, key);
    if(!stats){
      stats = {
        key,
        id: item?.id ?? null,
        code: codeCandidate || key,
        name: displayName,
        inventoryId: inventory?.id ?? null,
        currentInventory: inventory && Number.isFinite(Number(inventory.currentInventory)) ? Number(inventory.currentInventory) : null,
        totalQuantity: 0,
        totalRevenue: 0,
        quantity30: 0,
        revenue30: 0,
        orderIds: new Set(),
        orderIds30: new Set(),
        coPurchases: new Map(),
        lastSoldAt: null,
        firstSoldAt: null
      };
      map.set(key, stats);
    }
    if(!stats.code || stats.code === stats.key || stats.code === 'Unknown Item'){
      if(codeCandidate) stats.code = codeCandidate;
    }
    if(displayName && (!stats.name || stats.name === stats.key || stats.name === 'Unknown Item' || stats.name === '(no name)')){
      stats.name = displayName;
    }
    if(item?.id && !stats.id) stats.id = item.id;
    if(inventory){
      stats.inventoryId = inventory.id ?? stats.inventoryId;
      const inventoryName = typeof inventory.name === 'string' ? inventory.name.trim() : '';
      if(inventoryName && (!stats.name || stats.name === stats.key || stats.name === 'Unknown Item' || stats.name === '(no name)')){
        stats.name = inventoryName;
      }
      const invCode = getProductCode(null, inventory, null);
      if(invCode && (!stats.code || stats.code === stats.key)) stats.code = invCode;
      const invQty = Number(inventory.currentInventory);
      if(Number.isFinite(invQty)) stats.currentInventory = invQty;
    }
    if(!stats.code) stats.code = codeCandidate || stats.key;
    return stats;
  }

  function finalizeTrendStats(raw, now){
    const orderCount = raw.orderIds.size;
    const orderCount30 = raw.orderIds30.size;
    const totalQuantity = raw.totalQuantity;
    const totalRevenue = raw.totalRevenue;
    const quantity30 = raw.quantity30;
    const revenue30 = raw.revenue30;
    const daysActive = raw.firstSoldAt ? Math.max(1, Math.round((now.getTime() - raw.firstSoldAt.getTime()) / DAY_MS) + 1) : 0;
    const avgDailyAll = daysActive > 0 ? totalQuantity / daysActive : 0;
    const velocityPerDay = quantity30 > 0 ? quantity30 / TREND_WINDOW_DAYS : avgDailyAll;
    const avgQtyPerOrder = orderCount > 0 ? totalQuantity / orderCount : 0;
    const frequency = orderCount30 > 0 ? TREND_WINDOW_DAYS / orderCount30 : (orderCount > 0 ? Math.max(1, daysActive / orderCount) : null);
    const safety = Math.max(TREND_MINIMUM_BUFFER, Math.ceil(avgQtyPerOrder || 0));
    const recommendedBase = velocityPerDay > 0 ? velocityPerDay : avgDailyAll;
    const recommendedStock = recommendedBase > 0 ? Math.ceil((recommendedBase * RESTOCK_WINDOW_DAYS) + safety) : safety;
    const currentInventory = Number.isFinite(raw.currentInventory) ? raw.currentInventory : null;
    const restockQty = currentInventory === null ? null : Math.max(0, recommendedStock - currentInventory);
    const coPurchases = Array.from(raw.coPurchases.values()).map(entry => ({
      key: entry.key,
      code: entry.code,
      name: entry.name,
      count: entry.count,
      orderShare: orderCount > 0 ? entry.count / orderCount : 0,
      lastSoldAt: entry.lastSoldAt
    })).sort((a,b)=> b.count - a.count);

    return {
      key: raw.key,
      id: raw.id,
      code: raw.code,
      name: raw.name,
      inventoryId: raw.inventoryId,
      totalQuantity,
      totalRevenue,
      quantity30,
      revenue30,
      orderCount,
      orderCount30,
      avgQtyPerOrder,
      velocityPerDay,
      avgDailyAll,
      sellFrequencyDays: frequency,
      lastSoldAt: raw.lastSoldAt,
      firstSoldAt: raw.firstSoldAt,
      currentInventory,
      recommendedStock,
      restockQty,
      coPurchases
    };
  }

  function buildTrendAnalytics(paidOrders){
    const list = Array.isArray(paidOrders) ? paidOrders : [];
    const statsMap = new Map();
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - (TREND_WINDOW_DAYS * DAY_MS));
    const pairWindowStart = new Date(now.getTime() - (TREND_PAIR_WINDOW_DAYS * DAY_MS));
    const orderKeysAll = new Set();
    const orderKeys30 = new Set();
    let latestSale = null;
    const inventoryResolver = (typeof window !== 'undefined' && typeof window._getInvFromOrderItem === 'function') ? window._getInvFromOrderItem : null;

    list.forEach((order, index)=>{
      if(!order || typeof order !== 'object') return;
      const orderKey = resolveOrderKey(order, index);
      orderKeysAll.add(orderKey);
      const orderDate = extractOrderDate(order);
      const within30 = orderDate ? orderDate >= thirtyDaysAgo : false;
      if(within30) orderKeys30.add(orderKey);
      if(orderDate && (!latestSale || orderDate > latestSale)) latestSale = orderDate;

      const items = Array.isArray(order.items) ? order.items : [];
      if(items.length === 0) return;

      const orderProductKeys = new Set();

      items.forEach((item)=>{
        if(!item || typeof item !== 'object') return;
        const key = getProductKey(item);
        if(!key) return;
        const inventory = inventoryResolver ? inventoryResolver(item) : null;
        const stats = ensureProductStats(statsMap, key, item, inventory);
        const quantityParsed = toFiniteNumber(item.quantity);
        const qty = quantityParsed === null ? 1 : quantityParsed;
        const safeQty = Number.isFinite(qty) ? qty : 1;
        const unitPrice = resolveUnitPrice(item);
        stats.totalQuantity += safeQty;
        stats.totalRevenue += unitPrice * safeQty;
        stats.orderIds.add(orderKey);
        if(within30){
          stats.quantity30 += safeQty;
          stats.revenue30 += unitPrice * safeQty;
          stats.orderIds30.add(orderKey);
        }
        if(orderDate){
          if(!stats.lastSoldAt || orderDate > stats.lastSoldAt) stats.lastSoldAt = orderDate;
          if(!stats.firstSoldAt || orderDate < stats.firstSoldAt) stats.firstSoldAt = orderDate;
        }
        orderProductKeys.add(key);
      });

      if(orderProductKeys.size > 1){
        const combosEligible = !orderDate || orderDate >= pairWindowStart;
        if(combosEligible){
          const keys = Array.from(orderProductKeys);
          keys.forEach((key)=>{
            const stats = statsMap.get(key);
            if(!stats) return;
            keys.forEach((otherKey)=>{
              if(otherKey === key) return;
              const otherStats = statsMap.get(otherKey);
              const coMap = stats.coPurchases;
              const existing = coMap.get(otherKey) || { key: otherKey, name: otherStats?.name || otherKey, code: otherStats?.code || otherKey, count: 0, lastSoldAt: null };
              existing.count += 1;
              if(orderDate && (!existing.lastSoldAt || orderDate > existing.lastSoldAt)) existing.lastSoldAt = orderDate;
              if(otherStats?.name) existing.name = otherStats.name;
              if(otherStats?.code) existing.code = otherStats.code;
              coMap.set(otherKey, existing);
            });
          });
        }
      }
    });

    const products = Array.from(statsMap.values()).map(raw => finalizeTrendStats(raw, now));
    const productMap = new Map();
    products.forEach(product => productMap.set(product.key, product));

    const productsSorted = [...products].sort((a,b)=>{
      if(b.quantity30 !== a.quantity30) return b.quantity30 - a.quantity30;
      if(b.totalQuantity !== a.totalQuantity) return b.totalQuantity - a.totalQuantity;
      return a.name.localeCompare(b.name);
    });
    const top30 = productsSorted.find(p=>p.quantity30>0) || productsSorted[0] || null;

    const totalQuantity30 = products.reduce((sum,p)=> sum + p.quantity30,0);
    const totalRevenue30 = products.reduce((sum,p)=> sum + p.revenue30,0);
    const totalRevenueAll = products.reduce((sum,p)=> sum + p.totalRevenue,0);
    const totalUnitsAll = products.reduce((sum,p)=> sum + p.totalQuantity,0);

    const overall = {
      quantity30: totalQuantity30,
      totalRevenue30,
      totalRevenueAll,
      totalUnitsAll,
      orders30: orderKeys30.size,
      ordersAll: orderKeysAll.size,
      velocityPerDay: totalQuantity30 / Math.max(1, TREND_WINDOW_DAYS),
      avgUnitsPerOrderAll: totalUnitsAll / Math.max(1, orderKeysAll.size),
      avgUnitsPerOrder30: totalQuantity30 / Math.max(1, orderKeys30.size),
      activeProducts30: products.filter(p=>p.quantity30>0).length,
      lastSale: latestSale,
      top30
    };

    return { products, productMap, overall, top30 };
  }

  function formatCount(value){
    const num = Number(value);
    if(!Number.isFinite(num)) return '0';
    return num.toLocaleString('en-US');
  }

  function formatTrendDate(date){
    if(!(date instanceof Date) || Number.isNaN(date.valueOf())) return '—';
    const base = date.toLocaleDateString('en-US',{ month:'short', day:'numeric', year:'numeric' });
    const diffMs = Date.now() - date.getTime();
    if(!Number.isFinite(diffMs)) return base;
    const diffDays = Math.round(diffMs / DAY_MS);
    if(diffDays < 0){
      const future = Math.abs(diffDays);
      if(future === 1) return `${base} (tomorrow)`;
      return `${base} (in ${future} days)`;
    }
    if(diffDays === 0) return `${base} (today)`;
    if(diffDays === 1) return `${base} (yesterday)`;
    return `${base} (${diffDays} days ago)`;
  }

  function getProductPrimaryLabel(entity){
    if(!entity) return 'Unknown Product';
    if(typeof entity === 'string'){
      const trimmed = entity.trim();
      return trimmed || 'Unknown Product';
    }
    return entity.code || entity.id || entity.key || entity.name || 'Unknown Product';
  }

  function updateTrendUI(trendData){
    trendAnalyticsCache = trendData || { products: [], productMap: new Map(), overall: { quantity30: 0, orders30: 0, velocityPerDay: 0 }, top30: null };
    const data = trendAnalyticsCache;
    if(trendTopPerformerEl && trendTopPerformerMetaEl){
      const top = data.top30;
      if(top){
        trendTopPerformerEl.textContent = getProductPrimaryLabel(top);
        const qtyLabel = formatCount(top.quantity30);
        const revenueLabel = currency(top.revenue30 || 0);
        const ordersLabel = formatCount(top.orderCount30 || 0);
        trendTopPerformerMetaEl.textContent = `${qtyLabel} units • $${revenueLabel} revenue • ${ordersLabel} orders (30d)`;
      }else{
        trendTopPerformerEl.textContent = 'No paid orders yet';
        trendTopPerformerMetaEl.textContent = 'Sales activity will appear here once orders are paid.';
      }
    }
    if(!trendProductSelect){
      renderTrendDetails();
      return;
    }

    const products = Array.isArray(data.products) ? data.products : [];
    const currentValue = trendSelectedKey ?? trendProductSelect.value ?? '';
    trendProductSelect.innerHTML = '';
    const overallOpt = document.createElement('option');
    overallOpt.value = '__overall';
    overallOpt.textContent = 'All products (30 days)';
    trendProductSelect.appendChild(overallOpt);
    const sortedProducts = [...products].sort((a,b)=>{
      const labelA = getProductPrimaryLabel(a);
      const labelB = getProductPrimaryLabel(b);
      return labelA.localeCompare(labelB, undefined, { sensitivity: 'base', numeric: true });
    });
    sortedProducts.forEach(product=>{
      const opt = document.createElement('option');
      opt.value = product.key;
      const primaryLabel = getProductPrimaryLabel(product);
      const suffix = product.quantity30 > 0
        ? `${formatCount(product.quantity30)} sold / 30d`
        : `${formatCount(product.totalQuantity)} total sold`;
      opt.textContent = `${primaryLabel} (${suffix})`;
      trendProductSelect.appendChild(opt);
    });
    const fallback = currentValue && (currentValue === '__overall' || data.productMap?.has(currentValue))
      ? currentValue
      : (sortedProducts[0]?.key ?? '__overall');
    trendSelectedKey = fallback;
    trendProductSelect.value = fallback;
    renderTrendDetails();
  }

  function renderTrendDetails(){
    if(!trendAnalyticsCache) return;
    if(!trendContentEl || !trendNoDataEl) return;
    const data = trendAnalyticsCache;
    const products = Array.isArray(data.products) ? data.products : [];

    if(products.length === 0){
      trendContentEl.classList.add('hidden');
      trendNoDataEl.classList.remove('hidden');
      if(trendUnits30El) trendUnits30El.textContent = '0';
      if(trendOrders30El) trendOrders30El.textContent = '0';
      if(trendOrdersDetailEl) trendOrdersDetailEl.textContent = 'No paid orders in the last 30 days.';
      if(trendVelocityEl) trendVelocityEl.textContent = '0.00 units/day';
      if(trendVelocitySubtextEl) trendVelocitySubtextEl.textContent = 'Waiting on sales data.';
      if(trendRestockValueEl) trendRestockValueEl.textContent = '—';
      if(trendRestockNoteEl) trendRestockNoteEl.textContent = 'Once inventory syncs with sales we will recommend a restock amount.';
      if(trendRevenue30El) trendRevenue30El.textContent = '$0.00';
      if(trendRevenueAllEl) trendRevenueAllEl.textContent = '$0.00';
      if(trendUnitsAllEl) trendUnitsAllEl.textContent = '0';
      if(trendAvgPerOrderEl) trendAvgPerOrderEl.textContent = '—';
      if(trendLastSoldEl) trendLastSoldEl.textContent = '—';
      if(trendCoPurchaseListEl){
        trendCoPurchaseListEl.innerHTML = '';
        const li = document.createElement('li');
        li.className = 'text-sm text-gray-500 italic';
        li.textContent = 'No bundle activity yet.';
        trendCoPurchaseListEl.appendChild(li);
      }
      return;
    }

    trendNoDataEl.classList.add('hidden');
    trendContentEl.classList.remove('hidden');

    let selectedKey = trendSelectedKey ?? trendProductSelect?.value ?? '__overall';
    if(selectedKey !== '__overall' && !data.productMap.has(selectedKey)){
      selectedKey = products[0]?.key ?? '__overall';
    }
    trendSelectedKey = selectedKey;
    if(trendProductSelect && trendProductSelect.value !== selectedKey){
      trendProductSelect.value = selectedKey;
    }

    if(selectedKey === '__overall'){
      if(trendUnits30El) trendUnits30El.textContent = formatCount(data.overall.quantity30 || 0);
      if(trendOrders30El) trendOrders30El.textContent = formatCount(data.overall.orders30 || 0);
      if(trendOrdersDetailEl){
        trendOrdersDetailEl.textContent = data.overall.orders30 > 0
          ? `≈ ${(data.overall.orders30 / (TREND_WINDOW_DAYS / 7)).toFixed(2)} orders/week`
          : 'No paid orders in the last 30 days.';
      }
      if(trendVelocityEl) trendVelocityEl.textContent = `${(data.overall.velocityPerDay || 0).toFixed(2)} units/day`;
      if(trendVelocitySubtextEl){
        trendVelocitySubtextEl.textContent = data.overall.activeProducts30 > 0
          ? `${data.overall.activeProducts30} products sold in the last ${TREND_WINDOW_DAYS} days`
          : 'No product movement in the last 30 days.';
      }
      if(trendRestockValueEl) trendRestockValueEl.textContent = '—';
      if(trendRestockNoteEl) trendRestockNoteEl.textContent = 'Select a product to see restock guidance.';
      if(trendRevenue30El) trendRevenue30El.textContent = `$${currency(data.overall.totalRevenue30 || 0)}`;
      if(trendRevenueAllEl) trendRevenueAllEl.textContent = `$${currency(data.overall.totalRevenueAll || 0)}`;
      if(trendUnitsAllEl) trendUnitsAllEl.textContent = formatCount(data.overall.totalUnitsAll || 0);
      if(trendAvgPerOrderEl){
        const avg = data.overall.avgUnitsPerOrderAll || 0;
        trendAvgPerOrderEl.textContent = avg > 0 ? `${avg.toFixed(2)} units/order` : '—';
      }
      if(trendLastSoldEl){
        trendLastSoldEl.textContent = data.overall.lastSale ? formatTrendDate(data.overall.lastSale) : 'No paid orders yet';
      }
      if(trendCoPurchaseListEl){
        trendCoPurchaseListEl.innerHTML = '';
        const li = document.createElement('li');
        li.className = 'text-sm text-gray-500 italic';
        li.textContent = 'Select a product to see bundle behaviour.';
        trendCoPurchaseListEl.appendChild(li);
      }
      return;
    }

    const product = data.productMap.get(selectedKey);
    if(!product){
      return;
    }

    if(trendUnits30El) trendUnits30El.textContent = formatCount(product.quantity30 || 0);
    if(trendOrders30El) trendOrders30El.textContent = formatCount(product.orderCount30 || 0);
    if(trendOrdersDetailEl){
      trendOrdersDetailEl.textContent = product.orderCount30 > 0
        ? `≈ ${(product.orderCount30 / (TREND_WINDOW_DAYS / 7)).toFixed(2)} orders/week`
        : (product.orderCount > 0 ? 'No paid orders in the last 30 days; showing lifetime pace.' : 'No orders yet.');
    }
    if(trendVelocityEl) trendVelocityEl.textContent = `${(product.velocityPerDay || 0).toFixed(2)} units/day`;
    if(trendVelocitySubtextEl){
      trendVelocitySubtextEl.textContent = product.sellFrequencyDays
        ? `≈ every ${product.sellFrequencyDays.toFixed(1)} days`
        : 'Not enough data to project cadence.';
    }
    if(trendRestockValueEl && trendRestockNoteEl){
      if(product.restockQty === null){
        trendRestockValueEl.textContent = '—';
        trendRestockNoteEl.textContent = 'Inventory not linked; restock guidance unavailable.';
      }else if(product.restockQty === 0){
        trendRestockValueEl.textContent = 'All set';
        trendRestockNoteEl.textContent = `Current inventory ${formatCount(product.currentInventory ?? 0)} meets the ${RESTOCK_WINDOW_DAYS}-day buffer (~${formatCount(product.recommendedStock)} units).`;
      }else{
        trendRestockValueEl.textContent = `${formatCount(product.restockQty)} units`;
        trendRestockNoteEl.textContent = `Target ~${formatCount(product.recommendedStock)} units (${RESTOCK_WINDOW_DAYS}-day buffer). Current inventory: ${formatCount(product.currentInventory ?? 0)}.`;
      }
    }
    if(trendRevenue30El) trendRevenue30El.textContent = `$${currency(product.revenue30 || 0)}`;
    if(trendRevenueAllEl) trendRevenueAllEl.textContent = `$${currency(product.totalRevenue || 0)}`;
    if(trendUnitsAllEl) trendUnitsAllEl.textContent = formatCount(product.totalQuantity || 0);
    if(trendAvgPerOrderEl){
      trendAvgPerOrderEl.textContent = product.avgQtyPerOrder > 0 ? `${product.avgQtyPerOrder.toFixed(2)} units/order` : '—';
    }
    if(trendLastSoldEl){
      trendLastSoldEl.textContent = product.lastSoldAt ? formatTrendDate(product.lastSoldAt) : 'Not sold yet';
    }
    if(trendCoPurchaseListEl){
      trendCoPurchaseListEl.innerHTML = '';
      if(product.coPurchases.length === 0){
        const li = document.createElement('li');
        li.className = 'text-sm text-gray-500 italic';
        li.textContent = 'No pairing data yet.';
        trendCoPurchaseListEl.appendChild(li);
      }else{
        product.coPurchases.slice(0,5).forEach((entry, index)=>{
          const li = document.createElement('li');
          const rank = document.createElement('span');
          rank.className = 'rank';
          rank.textContent = `#${index+1}`;
          const name = document.createElement('span');
          name.className = 'name';
          name.textContent = getProductPrimaryLabel(entry);
          const value = document.createElement('span');
          value.className = 'value';
          const percent = entry.orderShare > 0 ? Math.round(entry.orderShare * 100) : 0;
          const countLabel = `${formatCount(entry.count)} orders`;
          value.textContent = percent > 0 ? `${countLabel} (${percent}%)` : countLabel;
          li.append(rank, name, value);
          trendCoPurchaseListEl.appendChild(li);
        });
      }
    }
  }

  function updateLoadMoreVisibility(total){
    if(!ordersPagination || !loadMoreOrdersBtn) return;
    if(total === 0 || visibleOrdersCount >= total){
      ordersPagination.classList.add('hidden');
    }else{
      ordersPagination.classList.remove('hidden');
    }
  }

  function getNormalizedOrderSearchTerm(){
    return orderSearchTerm.trim().toLowerCase();
  }

  function orderMatchesSearch(order, normalizedTerm, normalizedDigits){
    if(!normalizedTerm) return true;
    const idPart = String(order?.orderId ?? order?.id ?? '').toLowerCase();
    const namePart = String(order?.contactInfo?.fullName ?? '').toLowerCase();
    const phoneRaw = String(order?.contactInfo?.phone ?? '');
    const phonePart = phoneRaw.toLowerCase();
    if(idPart.includes(normalizedTerm) || namePart.includes(normalizedTerm) || phonePart.includes(normalizedTerm)) return true;
    if(!normalizedDigits) return false;
    const phoneDigits = phoneRaw.replace(/[^0-9]/g,'');
    return phoneDigits.includes(normalizedDigits);
  }

  function filterOrders(baseOrders){
    const list = Array.isArray(baseOrders) ? baseOrders : [];
    const normalizedTerm = getNormalizedOrderSearchTerm();
    if(!normalizedTerm) return list;
    const normalizedDigits = normalizedTerm.replace(/[^0-9]/g,'');
    return list.filter(order => orderMatchesSearch(order, normalizedTerm, normalizedDigits));
  }

  function renderOrdersList(sortedOrders){
    const ordersContainer=qs('orders-container');
    if(!ordersContainer) return;
    ordersContainer.innerHTML='';
    const loading=qs('loading-orders');
    if(loading) loading.style.display='none';

    const filteredOrders = filterOrders(sortedOrders);
    if(filteredOrders.length === 0){
      const trimmedTerm = orderSearchTerm.trim();
      const headline = trimmedTerm
        ? `No orders match "${escapeHtml(trimmedTerm)}".`
        : 'No orders found.';
      const detail = trimmedTerm
        ? 'Try a different name, order ID, or phone number.'
        : 'Your orders will appear here once they have been placed.';
      ordersContainer.innerHTML=`<div class="text-center text-gray-500 py-12"><p class="text-lg">${headline}</p><p class="text-sm mt-2">${detail}</p></div>`;
      updateLoadMoreVisibility(0);
      return;
    }

    if(visibleOrdersCount <= 0){
      visibleOrdersCount = Math.min(filteredOrders.length, ORDERS_PAGE_SIZE);
    }

    const subset = filteredOrders.slice(0, Math.max(0, visibleOrdersCount));

    subset.forEach(order=>{
      const timestamp=formatTimestamp(order.timestamp);
      const items=Array.isArray(order.items)?order.items:[];
      const itemsList = items.map(item=>{
        const label = item.id || item.name || 'Item';
        const price = currency(item?.unitPrice ?? 0);
        const quantity = item?.quantity ?? 1;
        return `<li class="flex justify-between items-center mb-1"><span class="text-gray-400">${label} (x${quantity})</span><span class="font-medium text-cyan-300">$${price}</span></li>`;
      }).join('');

      const computed = resolveOrderItemsTotal(order);
      const totalSafe = (order.total!=null)?currency(order.total):currency(computed);
      const discountedSubtotal = resolveOrderSubtotal(order, computed);
      const shippingCostSafe = Number(order.shippingCost ?? 0);
      const hasFreeShip = shippingCostSafe===0 && (order.promo?.type==='free_shipping');
      const salesTaxValue = extractOrderSalesTax(order);
      const paymentDetails = (()=>{
        const payment = order.payment || {};
        const meta = payment.meta || {};
        const methodRaw = payment.method || payment.type || meta.type || order.paymentType || order.paymentMethod || order.payment_method;
        const venmoUser = payment.venmoUser || meta.venmoUser;
        const txid = payment.txid || payment.transactionId || payment.txId || meta.txid || meta.transactionId || meta.txId;
        const method = methodRaw ? String(methodRaw) : '';
        const methodLower = method.toLowerCase();

        if(methodLower.includes('venmo')){
          const label = venmoUser ? `${method} (${venmoUser})` : (method || 'Venmo');
          return { label, txid: '' };
        }

        if(methodLower.includes('bitcoin') || methodLower==='btc'){
          const label = method || 'Bitcoin';
          return { label, txid: txid ? String(txid) : '' };
        }

        if(venmoUser && method) return { label: `${method} (${venmoUser})`, txid: '' };
        if(method) return { label: method, txid: '' };
        if(venmoUser) return { label: venmoUser, txid: '' };
        return { label: 'Not specified', txid: '' };
      })();
      const promoCodeDisplay = resolvePromoCode(order);
      const itemDiscount = Math.max(0, computed - discountedSubtotal);
      const status=order.paymentStatus||'Unknown';
      const statusClass = status==='Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';
      const contact=order.contactInfo||{};
      const contactEntries=[
        { label:'Name', value: contact.fullName },
        { label:'Email', value: contact.email },
        { label:'Phone', value: contact.phone },
        { label:'Address', value: contact.shippingAddress }
      ];
      const contactHtml = contactEntries.map(({label,value})=>{
        const raw = (value ?? '').toString();
        const hasValue = raw.trim().length>0;
        const display = hasValue ? raw : 'Not Provided';
        const displayHtml = hasValue ? display.replace(/\n/g,'<br>') : display;
        const copyAttr = hasValue ? ` data-copy="${encodeURIComponent(raw)}"` : '';
        const copyBtn = hasValue ? `<button type="button" class="copy-contact btn-neon-cyan px-2 py-0.5 rounded text-xs font-semibold shrink-0"${copyAttr}>Copy</button>` : '';
        const valueMarkup = `<span class="text-gray-300 break-words grow">${displayHtml}</span>`;
        return `<div class="flex flex-wrap items-start gap-2"><span class="font-medium text-gray-500">${label}:</span><div class="flex items-start gap-2 min-w-0 flex-1">${valueMarkup}${copyBtn}</div></div>`;
      }).join('');
      const orderIdText=order.orderId || order.id;
      const trackingEntries = extractTrackingEntries(order.tracking);
      const anyShipped = trackingEntries.some(t=>t?.hasShipped===true);
      const isDelivered = order.orderDelivered === true;
      const deliveredWithoutTracking = trackingEntries.length === 0 && isDelivered;
      const orderCardBorderClass = (anyShipped || deliveredWithoutTracking) ? 'border-emerald-500' : 'border-gray-700';
      const deliveredStatusText = isDelivered ? 'Delivered' : 'Not delivered';
      const deliveredToggleHtml = `
        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-400 mt-1">
          <span class="font-semibold ${isDelivered ? 'text-emerald-300' : 'text-gray-500'}">${deliveredStatusText}</span>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" class="order-delivered-toggle h-4 w-4 text-lime-500 focus:ring-cyan-500 border-gray-600 rounded" data-order-id="${order.id}" aria-label="${isDelivered ? 'Unmark delivered' : 'Mark delivered'}" ${isDelivered ? 'checked' : ''}>
          </label>
        </div>`;
      const trackingHtml = trackingEntries.length
        ? trackingEntries.map((t,idx)=>{
            const url=t.url||buildTrackingUrl(t.carrier,t.number);
            const label=`${t.carrier||"Carrier"}: ${t.number||"—"}`;
            const numberAttr = t.number||"";
            const shipped = t.hasShipped === true;
            const shippedLabel = shipped ? 'Shipped' : 'Pending';
            const shippedClass = shipped ? 'text-emerald-300' : 'text-gray-500';
            const checkedAttr = shipped ? 'checked' : '';
            return `<div class="space-y-1 text-xs">
              <div class="flex flex-wrap items-center gap-2">
                <a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 hover:text-cyan-200">${label}</a>
                <span class="font-semibold ${shippedClass}">${shippedLabel}</span>
                <button type="button" class="btn-neon-cyan px-2 py-0.5 rounded copy-track" data-track="${numberAttr}">Copy</button>
                <button type="button" class="btn-neon-lime px-2 py-0.5 rounded send-tracking-email-btn" data-order-id="${order.id}" data-track="${numberAttr}">Send Email</button>
              </div>
              <label class="inline-flex items-center gap-2 text-xs text-gray-400">
                <input type="checkbox" class="tracking-ship-toggle h-4 w-4 text-lime-500 focus:ring-cyan-500 border-gray-600 rounded" data-order-id="${order.id}" data-track-index="${idx}" ${checkedAttr}>
                Item has shipped
              </label>
            </div>`;
          }).join("")
        : `<div class="space-y-1 text-xs">
            <span class="text-gray-500 italic">No tracking added yet</span>
            ${deliveredToggleHtml}
          </div>`;

      const card=`
      <div class="order-card rounded-xl p-6 shadow-md border ${orderCardBorderClass} relative">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start border-b pb-4 mb-4 border-gray-700">
          <div>
            <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
              <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
            </h3>
            <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
            <button class="prepare-order-btn btn-neon-cyan text-xs px-3 py-1 rounded-lg mt-3" data-order-id="${order.id}">
              Prepare Order
            </button>
          </div>
          <div class="mt-4 sm:mt-0 text-left sm:text-right">
            <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
            <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${status}</span>
            <div class="mt-2 text-xs text-gray-400 space-y-1">
              <div><span class="text-gray-500">Subtotal:</span> $${currency(discountedSubtotal)}</div>
              ${salesTaxValue>0?`<div><span class="text-gray-500">Sales Tax:</span> $${currency(salesTaxValue)}</div>`:``}
              ${itemDiscount>0?`<div><span class="text-gray-500">Items discount:</span> <span class="text-green-300 font-semibold">-$${currency(itemDiscount)}</span></div>`:``}
              <div><span class="text-gray-500">Shipping:</span> ${hasFreeShip?`<span class="text-green-300 font-semibold">FREE</span>`:`$${currency(shippingCostSafe)}`}</div>
              <div>
                <span class="text-gray-500">Payment Type:</span> <span class="text-gray-300">${paymentDetails.label}</span>
                ${paymentDetails.txid ? `<div class="text-gray-500 text-xs mt-1 pl-4">TXID: <span class="text-gray-300 txid-value">${paymentDetails.txid}</span></div>` : ''}
                ${promoCodeDisplay ? `<div class="text-gray-500 text-xs mt-1 pl-4">Promo Code: <span class="text-gray-300">${escapeHtml(promoCodeDisplay)}</span></div>` : ''}
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
          <ul class="list-none space-y-2 text-sm">${itemsList || '<li class="text-gray-500 italic">No items.</li>'}</ul>
        </div>

        <div>
          <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
          <div class="text-sm text-gray-500 space-y-1">
            ${contactHtml}
          </div>
        </div>

        <div class="mt-4">
          <p class="font-semibold text-gray-400 mb-2">Tracking:</p>
          <div class="space-y-1">${trackingHtml}</div>
        </div>

      <div class="pt-10 bottom-4 right-4 flex space-x-2 items-end space-y-2">
        <button class="delete-order-card-btn btn-neon-red text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Delete
        </button>
        <button class="edit-order-btn btn-neon-lime text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Edit Order
        </button>
        <button class="resend-order-btn btn-neon-cyan text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Resend Email
        </button>
      </div>

      </div>`;
      ordersContainer.insertAdjacentHTML('beforeend', card);
      const last=ordersContainer.lastElementChild;
      last.querySelectorAll('.copy-track').forEach(btn=>btn.addEventListener('click',()=>{
        const v=btn.dataset.track||"";
        if(!v) return;
        if(copyToClipboard(v)) indicateCopy(btn);
      }));
      last.querySelectorAll('.copy-contact').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const encoded=btn.dataset.copy||'';
          if(!encoded) return;
          const text=decodeURIComponent(encoded);
          if(text && copyToClipboard(text)) indicateCopy(btn);
        });
      });
      last.querySelectorAll('.tracking-ship-toggle').forEach(input=>{
        input.addEventListener('change', handleTrackingShippedToggle);
      });
      last.querySelectorAll('.order-delivered-toggle').forEach(input=>{
        input.addEventListener('change', handleOrderDeliveredToggle);
      });
    });

    updateLoadMoreVisibility(filteredOrders.length);
  }

  if(loadMoreOrdersBtn){
    loadMoreOrdersBtn.addEventListener('click',()=>{
      const filtered = filterOrders(sortedOrdersCache);
      if(filtered.length===0) return;
      visibleOrdersCount = Math.min(visibleOrdersCount + ORDERS_PAGE_SIZE, filtered.length);
      userAdjustedOrderView = true;
      renderOrdersList(sortedOrdersCache);
    });
  }

  if(orderSearchInput){
    const handleOrderSearch = () => {
      orderSearchTerm = orderSearchInput.value || '';
      visibleOrdersCount = ORDERS_PAGE_SIZE;
      renderOrdersList(sortedOrdersCache);
    };
    orderSearchInput.addEventListener('input', handleOrderSearch);
    orderSearchInput.addEventListener('search', handleOrderSearch);
  }

  /* Read-only order item element */
  function createOrderItemElement(item){
    const wrap=document.createElement('div');
    wrap.className='edit-order-item flex items-center gap-2 p-2 border border-gray-700 rounded-md';
    const label=item.id || item.name || 'Unknown Item';
    const nameSpan=document.createElement('span'); nameSpan.textContent=label; nameSpan.className='flex-1 text-gray-300 text-sm font-semibold truncate';
    const qtySpan=document.createElement('span'); qtySpan.className='text-gray-400 text-sm'; qtySpan.textContent=`Qty: ${item.quantity || 0}`;
    const priceSpan=document.createElement('span'); priceSpan.className='text-cyan-300 text-sm font-semibold'; priceSpan.textContent=`$${currency(item.unitPrice||0)}`;
    wrap.appendChild(nameSpan); wrap.appendChild(qtySpan); wrap.appendChild(priceSpan);
    // keep minimal datasets (no code)
    wrap.dataset.itemName = item.name || '';
    wrap.dataset.itemId   = item.id   || '';
    return wrap;
  }

  /* Prepare order modal helpers */
  function populatePrepareOrderCustomer(order){
    if(!prepareOrderCustomerEl) return;
    const container = prepareOrderCustomerEl;
    container.innerHTML='';
    container.classList.remove('italic','text-gray-500');
    container.classList.add('space-y-1');

    const contact = order?.contactInfo || {};
    const fragments = [];
    const name = contact.fullName || contact.name;
    if(name){ const div=document.createElement('div'); div.className='font-semibold text-gray-100'; div.textContent=name; fragments.push(div); }
    if(contact.email){ const div=document.createElement('div'); div.className='text-gray-300'; div.textContent=contact.email; fragments.push(div); }
    if(contact.phone){ const div=document.createElement('div'); div.className='text-gray-300'; div.textContent=contact.phone; fragments.push(div); }
    const shipping = contact.shippingAddress || order?.shippingAddress;
    if(shipping){ const div=document.createElement('div'); div.className='text-gray-300 whitespace-pre-line'; div.textContent=shipping; fragments.push(div); }

    if(!fragments.length){
      const fallback=document.createElement('div');
      fallback.className='text-gray-500 italic';
      fallback.textContent='No customer info on record.';
      fragments.push(fallback);
    }

    fragments.forEach(node=>container.appendChild(node));
  }

  function populatePrepareOrderItems(order){
    if(!prepareOrderItemsEl) return;
    prepareOrderItemsEl.innerHTML='';
    const items = Array.isArray(order?.items) ? order.items : [];
    let totalQuantity = 0;
    if(!items.length){
      const empty=document.createElement('li');
      empty.className='text-gray-500 italic';
      empty.textContent='No items found for this order.';
      prepareOrderItemsEl.appendChild(empty);
      prepareOrderItemsEl.dataset.totalQuantity = '0';
      updatePrepareOrderSummary(0,0);
      return;
    }

    items.forEach(item=>{
      const li=document.createElement('li');
      li.className='flex items-center justify-between gap-3 rounded border border-gray-700 p-3 bg-gray-900/40';
      const quantity=Number(item?.quantity ?? 1);
      const name=item?.id || item?.name || 'Item';
      totalQuantity += Number.isFinite(quantity) ? quantity : 0;

      const checkbox=document.createElement('input');
      checkbox.type='checkbox';
      checkbox.className='prepare-item-checkbox h-4 w-4 text-lime-400 focus:ring-cyan-500 border-gray-600 rounded';
      checkbox.dataset.quantity = String(Number.isFinite(quantity) ? quantity : 1);

      const detailsWrap=document.createElement('div');
      detailsWrap.className='flex-1 min-w-0';

      const labelSpan=document.createElement('span');
      labelSpan.className='block text-gray-100 font-semibold truncate';
      labelSpan.dataset.role = 'prepare-item-name';
      labelSpan.textContent=name;

      const metaSpan=document.createElement('span');
      metaSpan.className='block text-xs text-gray-400 mt-1';
      metaSpan.dataset.role = 'prepare-item-meta';
      metaSpan.textContent=`Qty: ${quantity}`;

      const totalSpan=document.createElement('span');
      const unitPrice=Number(item?.unitPrice ?? 0);
      const lineTotal=currency(unitPrice * quantity);
      totalSpan.className='font-semibold text-cyan-300';
      totalSpan.dataset.role = 'prepare-item-price';
      totalSpan.textContent=`$${lineTotal}`;
      totalSpan.dataset.lineTotal = lineTotal;

      detailsWrap.appendChild(labelSpan);
      detailsWrap.appendChild(metaSpan);

      li.appendChild(checkbox);
      li.appendChild(detailsWrap);
      li.appendChild(totalSpan);
      prepareOrderItemsEl.appendChild(li);

      applyPrepareOrderStyles(li, checkbox);

      checkbox.addEventListener('change', ()=>{
        applyPrepareOrderStyles(li, checkbox);
        refreshPrepareOrderPreparedCount();
      });
    });

    prepareOrderItemsEl.dataset.totalQuantity = String(totalQuantity);
    refreshPrepareOrderPreparedCount();
  }

  function applyPrepareOrderStyles(rowEl, checkbox){
    if(!rowEl) return;
    rowEl.classList.toggle('border-emerald-500', checkbox.checked);
    rowEl.classList.toggle('bg-emerald-900/30', checkbox.checked);
    const details = rowEl.querySelector('[data-role="prepare-item-name"]');
    const meta = rowEl.querySelector('[data-role="prepare-item-meta"]');
    const price = rowEl.querySelector('[data-role="prepare-item-price"]');
    if(details) details.classList.toggle('line-through', checkbox.checked);
    if(meta){
      meta.classList.toggle('text-emerald-300', checkbox.checked);
      meta.classList.toggle('text-gray-400', !checkbox.checked);
    }
    if(price){
      price.classList.toggle('text-emerald-300', checkbox.checked);
      price.classList.toggle('text-cyan-300', !checkbox.checked);
    }
  }

  function updatePrepareOrderSummary(totalItems, preparedItems){
    if(!prepareOrderTotalItemsEl) return;
    const preparedText = totalItems > 0 ? ` • Prepared: ${preparedItems}` : '';
    prepareOrderTotalItemsEl.textContent = `Total Items: ${totalItems}${preparedText}`;
  }

  function refreshPrepareOrderPreparedCount(){
    const totalItems = Number(prepareOrderItemsEl?.dataset.totalQuantity || 0);
    let prepared = 0;
    prepareOrderItemsEl?.querySelectorAll('.prepare-item-checkbox')?.forEach(cb=>{
      if(cb.checked){ prepared += Number(cb.dataset.quantity || 1); }
    });
    updatePrepareOrderSummary(totalItems, prepared);
  }

  function openPrepareOrderModal(order){
    if(!prepareOrderModal || !prepareOrderBackdrop){ console.warn('Prepare order modal elements not found.'); return; }
    if(!order){ showModal('Unable to load order details for preparation.'); return; }

    activePrepareOrderId = order.id || null;
    if(prepareOrderIdEl) prepareOrderIdEl.textContent = order.orderId || order.id || 'Unknown Order';
    populatePrepareOrderCustomer(order);
    populatePrepareOrderItems(order);
    if(prepareOrderNotesInput) prepareOrderNotesInput.value='';

    prepareOrderModal.classList.remove('hidden');
    prepareOrderBackdrop.classList.remove('hidden');
    prepareOrderModal.classList.add('is-open');
    prepareOrderBackdrop.classList.add('is-open');
  }

  function closePrepareOrderModal(){
    if(!prepareOrderModal || !prepareOrderBackdrop) return;
    prepareOrderModal.classList.remove('is-open');
    prepareOrderBackdrop.classList.remove('is-open');
    activePrepareOrderId=null;
    if(prepareOrderNotesInput) prepareOrderNotesInput.value='';
    setTimeout(()=>{
      prepareOrderModal.classList.add('hidden');
      prepareOrderBackdrop.classList.add('hidden');
      if(prepareOrderItemsEl){
        prepareOrderItemsEl.dataset.totalQuantity = '0';
        prepareOrderItemsEl.innerHTML='';
      }
      updatePrepareOrderSummary(0,0);
    },300);
  }

  function handlePrepareOrderStart(){
    if(!activePrepareOrderId){ closePrepareOrderModal(); return; }
    const order = allOrdersCache.find(o=>o.id===activePrepareOrderId);
    const displayId = order?.orderId || activePrepareOrderId;
    const notes = (prepareOrderNotesInput?.value || '').trim();
    closePrepareOrderModal();
    if(notes){
      showModal(`Prep started for ${displayId}.\nNotes:\n${notes}`);
    }else{
      showModal(`Prep started for ${displayId}.`);
    }
  }

  function openEditModal(orderData){
    qs('edit-order-id').value = orderData.id;
    qs('edit-contact-name').value = orderData.contactInfo?.fullName || '';
    qs('edit-order-total').value = orderData.total ?? 0;
    qs('edit-order-status').value = orderData.paymentStatus ?? 'Unpaid';
    const shippingCost = Number(orderData?.shippingCost ?? 0);
    const freeShip = (orderData?.promo?.type === 'free_shipping') || shippingCost === 0;
    const shipEl = document.getElementById('edit-shipping-display'); shipEl.textContent = freeShip ? 'FREE' : `$${currency(shippingCost)}`;

    const cont=qs('edit-order-items-list'); cont.innerHTML='';
    (orderData.items||[]).forEach(item=>cont.appendChild(createOrderItemElement(item)));

    const trackingEntries = extractTrackingEntries(orderData.tracking);
    const defaultHasShipped = extractTrackingHasShipped(orderData.tracking);
    const normalizedEntries = trackingEntries.map(entry => ({
      ...entry,
      hasShipped: typeof entry?.hasShipped === 'boolean' ? entry.hasShipped : defaultHasShipped
    }));
    setTrackingHidden(normalizedEntries);
    renderTrackingList(normalizedEntries);

    editOrderModal.classList.remove('hidden'); editOrderBackdrop.classList.remove('hidden');
    editOrderModal.classList.add('is-open'); editOrderBackdrop.classList.add('is-open');
  }
  function closeEditModal(){ editOrderModal.classList.remove('is-open'); editOrderBackdrop.classList.remove('is-open'); setTimeout(()=>{ editOrderModal.classList.add('hidden'); editOrderBackdrop.classList.add('hidden'); },300); }

  function handleAddTrackingEntry(){
    const carrierSel=qs('edit-track-carrier'); const numberInp=qs('edit-track-number');
    if(!carrierSel||!numberInp){ showModal('Tracking UI is not available in this view.'); return; }
    const carrier=carrierSel.value.trim(); const number=numberInp.value.trim();
    if(!carrier||!number){ showModal('Please select a carrier and enter a tracking number.'); return; }
    const t={ carrier, number, url:buildTrackingUrl(carrier,number), addedAt:new Date().toISOString(), hasShipped:false };
    const cur=readTrackingFromModal(); cur.push(t); setTrackingHidden(cur); renderTrackingList(cur); numberInp.value='';
  }

  // Save: only status, customer name, total (if changed), tracking; NO item changes, NO extra snapshot fields
  async function handleEditOrder(e){
    e.preventDefault();
    const orderId=qs('edit-order-id').value;
    const paymentStatus=qs('edit-order-status').value;
    const newCustomerName=qs('edit-contact-name').value.trim();
    const newTotal = Number(qs('edit-order-total').value || 0);

    if(!newCustomerName){ showModal('Customer name cannot be empty.'); return; }

    const existing = allOrdersCache.find(o=>o.id===orderId) || {};
    const existingShipping = Number(existing.shippingCost ?? 0);
    const newTrackingRaw = readTrackingFromModal ? readTrackingFromModal() : extractTrackingEntries(existing.tracking);
    const newTracking = Array.isArray(newTrackingRaw)
      ? newTrackingRaw.map(entry => ({
          ...entry,
          hasShipped: entry?.hasShipped === true
        }))
      : [];

    try{
      const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
      await updateDoc(orderRef, {
        paymentStatus,
        'contactInfo.fullName': newCustomerName,
        total: Number.isFinite(newTotal)? newTotal : existing.total,
        shippingCost: existingShipping,   // preserve
        tracking: newTracking             // keep shipping feature (tracking)
        // NOTE: intentionally not touching items, subtotal, promo, or any extra fields
      });
      showModal('Order updated successfully!');
      closeEditModal();
    }catch(err){
      console.error('Error updating order:',err);
      showModal(`Failed to update order: ${err.message}`);
    }
  }

  /* Add Inventory Item */
  async function handleAddItem(e){
    e.preventDefault();
    const name=newItemNameInput.value.trim();
    const id=newItemIdInput.value.trim();
    const blend=newItemBlendInput.checked;
    const productIsActive=newItemIsActiveInput.checked;
    const currentInventory=parseInt(newTotalKitsBoughtInput.value,10)*parseInt(newTotalVialsPerKitInput.value,10);
    const sellPricePerVial=parseFloat(newItemPriceInput.value);
    const totalVialWeight=parseFloat(newItemTotalVialWeightInput.value);
    const image=newItemImageInput.value.trim();
    const coa=newItemCoaInput.value.trim();
    const description=newItemDescriptionInput.value.trim();
    const vialsSold=parseInt(newItemVialsSoldInput.value,10);

    const costPerKit=parseFloat(newCostPerKitInput.value);
    const totalKitsBought=parseInt(newTotalKitsBoughtInput.value,10);
    const totalVialsPerKit=parseInt(newTotalVialsPerKitInput.value,10);
    const purchaseDate=newPurchaseDateInput.value;

    if(!name || !id){ showModal('Item Name and ID are required.'); return; }
    if(isNaN(currentInventory)||currentInventory<0){ showModal('Initial Inventory must be a non-negative number.'); return; }
    if(isNaN(sellPricePerVial)||sellPricePerVial<0){ showModal('Sell Price must be a non-negative number.'); return; }
    if(isNaN(totalVialWeight)||totalVialWeight<0){ showModal('Total Vial Weight must be a non-negative number.'); return; }
    if(isNaN(vialsSold)||vialsSold<0){ showModal('Vials Sold must be a non-negative number.'); return; }
    if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
    if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
    if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials Per Kit must be a non-negative number.'); return; }
    if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

    const baseCostEntry = { costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
    const initialLotId = buildLotId(id, [baseCostEntry]);
    const newCostEntry = { ...baseCostEntry, lot: initialLotId };
    const newItemCoa = { url: coa || 'N/A', lot: initialLotId };
    const newItem = { name, blend, productIsActive, productDescription: description || 'N/A', currentInventory, sellPricePerVial, totalVialWeight, image: image||'N/A', coa: newItemCoa, vialsSold, costHistory:[newCostEntry] };

    try{
      const itemRef = doc(db, INVENTORY_COLLECTION_PATH, id); // write at ID; no code field
      await setDoc(itemRef, newItem);
      showModal('New item added to inventory successfully!');
      addItemForm.reset();
    }catch(err){
      console.error('Error adding new item:',err);
      showModal(`Failed to add new item: ${err.message}`);
    }
  }

  async function handleEditInventoryItem(e){
    e.preventDefault();
    if(!editItemSelect){ showModal('Item selector not available.'); return; }

    const itemId = editItemSelect.value;
    if(!itemId){ showModal('Select an item to edit.'); return; }

    const original = inventoryCache[itemId];
    if(!original){
      showModal('Selected item is no longer available.');
      resetEditItemForm();
      return;
    }

    const name = (editItemNameInput?.value || '').trim();
    const currentInventoryVal = editItemCurrentInventoryInput?.value ?? '';
    const vialsSoldVal = editItemVialsSoldInput?.value ?? '';
    const priceVal = editItemPriceInput?.value ?? '';
    const totalWeightVal = editItemTotalVialWeightInput?.value ?? '';
    const image = (editItemImageInput?.value || '').trim();
    const coaInputValue = (editItemCoaInput?.value || '').trim();
    const coaLotInputValue = (editItemCoaLotInput?.value || '').trim();
    const description = (editItemDescriptionInput?.value || '').trim();
    const productIsActive = Boolean(editItemIsActiveInput?.checked);
    const blend = Boolean(editItemBlendInput?.checked);

    if(!name){ showModal('Item name cannot be empty.'); return; }

    const toNumber = (val) => {
      const num = Number(val);
      return Number.isFinite(num) ? num : NaN;
    };

    const currentInventory = toNumber(currentInventoryVal);
    const vialsSold = toNumber(vialsSoldVal);
    const sellPricePerVial = toNumber(priceVal);
    const totalVialWeight = toNumber(totalWeightVal);

    if(Number.isNaN(currentInventory) || currentInventory < 0){ showModal('Current inventory must be a non-negative number.'); return; }
    if(Number.isNaN(vialsSold) || vialsSold < 0){ showModal('Vials sold must be a non-negative number.'); return; }
    if(Number.isNaN(sellPricePerVial) || sellPricePerVial < 0){ showModal('Sell price must be a non-negative number.'); return; }
    if(Number.isNaN(totalVialWeight) || totalVialWeight < 0){ showModal('Total vial weight must be a non-negative number.'); return; }

    const normalized = {
      image: image || 'N/A',
      description: description || 'N/A'
    };
    const normalizedCoaUrl = coaInputValue || 'N/A';
    const sanitizeNa = (val) => {
      const str = (val ?? '').trim();
      if(!str) return 'N/A';
      return str.toUpperCase() === 'N/A' ? 'N/A' : str;
    };

    const existingCoaUrl = extractCoaUrl(original.coa) || 'N/A';
    const existingCoaLot = sanitizeNa(extractCoaLot(original.coa));

    let normalizedCoaLot = coaLotInputValue;
    if(!normalizedCoaLot){
      normalizedCoaLot = existingCoaLot !== 'N/A' ? existingCoaLot : '';
    }
    if(!normalizedCoaLot && normalizedCoaUrl !== existingCoaUrl && normalizedCoaUrl !== 'N/A'){
      normalizedCoaLot = buildLotId(itemId, inventoryCache[itemId]?.costHistory || []);
    }
    normalizedCoaLot = sanitizeNa(normalizedCoaLot);

    const numOrZero = (val) => {
      const num = Number(val);
      return Number.isFinite(num) ? num : 0;
    };

    const updateData = {};
    if(name !== (original.name ?? '')) updateData.name = name;
    if(currentInventory !== numOrZero(original.currentInventory)) updateData.currentInventory = currentInventory;
    if(vialsSold !== numOrZero(original.vialsSold)) updateData.vialsSold = vialsSold;
    if(sellPricePerVial !== numOrZero(original.sellPricePerVial)) updateData.sellPricePerVial = sellPricePerVial;
    if(totalVialWeight !== numOrZero(original.totalVialWeight)) updateData.totalVialWeight = totalVialWeight;
    if(productIsActive !== Boolean(original.productIsActive)) updateData.productIsActive = productIsActive;
    if(blend !== Boolean(original.blend)) updateData.blend = blend;

    const existingImage = (original.image && original.image !== 'N/A') ? original.image : 'N/A';
    if(normalized.image !== existingImage) updateData.image = normalized.image;

    const lotChanged = normalizedCoaLot !== existingCoaLot;
    if(normalizedCoaUrl !== existingCoaUrl || lotChanged){
      updateData.coa = { url: normalizedCoaUrl, lot: normalizedCoaLot };
    }

    const existingDescription = (original.productDescription && original.productDescription !== 'N/A') ? original.productDescription : 'N/A';
    if(normalized.description !== existingDescription) updateData.productDescription = normalized.description;

    if(Object.keys(updateData).length === 0){
      showModal('No changes to save.');
      return;
    }

    const docRef = doc(db, INVENTORY_COLLECTION_PATH, itemId);
    const originalLabel = editItemSaveBtn?.textContent;
    if(editItemSaveBtn){
      editItemSaveBtn.disabled = true;
      editItemSaveBtn.textContent = 'Saving...';
      editItemSaveBtn.classList.add('opacity-60','cursor-not-allowed');
    }

    try{
      await updateDoc(docRef, updateData);
      if(inventoryCache[itemId]) Object.assign(inventoryCache[itemId], updateData);
      showModal('Item updated successfully.');
      loadSelectedInventoryForEdit(itemId);
    }catch(err){
      console.error('Error updating inventory item:', err);
      showModal(`Failed to update item: ${err.message || 'Check console for details.'}`);
    }finally{
      if(editItemSaveBtn){
        editItemSaveBtn.disabled = false;
        editItemSaveBtn.textContent = originalLabel || 'Save Changes';
        editItemSaveBtn.classList.remove('cursor-not-allowed');
        editItemSaveBtn.classList.toggle('opacity-60', !editItemSelect.value);
      }
    }
  }

  async function handleDeprecateCurrentCoa(){
    if(!editItemSelect){ showModal('Item selector not available.'); return; }
    const itemId = editItemSelect.value;
    if(!itemId){ showModal('Select an item to edit before deprecating its COA.'); return; }

    const original = inventoryCache[itemId];
    if(!original){
      showModal('Selected item is no longer available.');
      resetEditItemForm();
      return;
    }

    const currentUrl = extractCoaUrl(original.coa);
    if(!currentUrl || currentUrl === 'N/A'){
      showModal('No COA URL to deprecate for this item.');
      updateDeprecateButton(original);
      return;
    }
    const currentLot = (typeof original.coa === 'object' && typeof original.coa.lot === 'string') ? original.coa.lot : '';
    const costHistoryForLot = Array.isArray(original.costHistory) ? original.costHistory : [];
    const archivedLot = currentLot || buildLotId(itemId, costHistoryForLot);
    const entry = { lot: archivedLot, url: currentUrl };
    const docRef = doc(db, INVENTORY_COLLECTION_PATH, itemId);

    const restoreLabel = editItemDeprecateBtn?.textContent;
    if(editItemDeprecateBtn){
      editItemDeprecateBtn.disabled = true;
      editItemDeprecateBtn.textContent = 'Deprecating...';
      editItemDeprecateBtn.classList.add('opacity-60','cursor-not-allowed');
    }

    try{
      const nextLot = computeNextCoaLot(itemId);
      const clearedCoa = { url: '', lot: nextLot };

      await updateDoc(docRef, {
        pastCoas: arrayUnion(entry),
        coa: clearedCoa
      });

      if(inventoryCache[itemId]){
        inventoryCache[itemId].coa = clearedCoa;
        const past = Array.isArray(inventoryCache[itemId].pastCoas) ? inventoryCache[itemId].pastCoas.slice() : [];
        past.push(entry);
        inventoryCache[itemId].pastCoas = past;
      }

      if(editItemCoaInput) editItemCoaInput.value = '';
      if(editItemCoaLotInput) editItemCoaLotInput.value = clearedCoa.lot;
      loadSelectedInventoryForEdit(itemId);
      showModal('Current COA archived and awaiting new documentation.');
    }catch(err){
      console.error('Failed to archive COA:', err);
      showModal(`Failed to archive COA: ${err.message || 'Check console for details.'}`);
      if(editItemDeprecateBtn){
        editItemDeprecateBtn.disabled = false;
      }
    }finally{
      if(editItemDeprecateBtn){
        editItemDeprecateBtn.textContent = restoreLabel || 'Deprecate';
        const itemForButton = inventoryCache[itemId];
        updateDeprecateButton(itemForButton);
      }
    }
  }

  /* Add Cost History */
async function handleNewCostHistory(e){
  e.preventDefault();
  const itemId=existingItemSelect.value;
  if(!itemId){ showModal('Please select an item from the dropdown.'); return; }

  const costPerKit=parseFloat(costPerKitInput.value);
  const totalKitsBought=parseInt(totalKitsBoughtInput.value,10);
  const totalVialsPerKit=parseInt(totalVialsPerKitInput.value,10);
  const purchaseDate=purchaseDateInput.value;
  const totalVialWeight=inventoryCache[itemId]?.totalVialWeight;

  if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
  if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
  if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials per Kit must be a non-negative number.'); return; }
  if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

  const baseCostEntry={ costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
  const existingCostHistory = Array.isArray(inventoryCache[itemId]?.costHistory) ? inventoryCache[itemId].costHistory.slice() : [];
  const pendingCostHistory = existingCostHistory.concat(baseCostEntry);
  const newLotId = buildLotId(itemId, pendingCostHistory);
  const newCostEntry = { ...baseCostEntry, lot: newLotId };
  const vialsToAdd = totalKitsBought * totalVialsPerKit;

  try{
    const itemRef=doc(db, INVENTORY_COLLECTION_PATH, itemId);
    await updateDoc(itemRef,{
      costHistory: arrayUnion(newCostEntry),
      currentInventory: increment(vialsToAdd)
    });
    if(inventoryCache[itemId]){
      const history = Array.isArray(inventoryCache[itemId].costHistory) ? inventoryCache[itemId].costHistory.slice() : [];
      history.push(newCostEntry);
      inventoryCache[itemId].costHistory = history;
      const currentCount = Number(inventoryCache[itemId].currentInventory) || 0;
      inventoryCache[itemId].currentInventory = currentCount + vialsToAdd;
    }
    showModal(`New cost history added, inventory updated, and lot ${newLotId} generated.`);
    addCostForm.reset();
  }catch(err){
    console.error('Error adding new cost history:',err);
    showModal(`Failed to add new cost history: ${err.message}`);
  }
}

  function buildExternalOrderPayload(order){
    const items = Array.isArray(order.items)? order.items.map(i=>({
      id:i?.id??"",
      name:i?.name??"",
      quantity:Number(i?.quantity??0),
      unitPrice:Number(i?.unitPrice??0)
    })) : [];
    const computedSubtotal = items.reduce((s,i)=>s+(Number(i.unitPrice)*Number(i.quantity)),0);
    const shipping = Number(order.shippingCost ?? 0);
    const total = Number(order.total ?? (computedSubtotal + shipping));
    const trackingEntries = extractTrackingEntries(order.tracking);
    const defaultHasShipped = extractTrackingHasShipped(order.tracking);

    return {
      orderId: order.orderId || order.id,
      contactInfo: {
        fullName: order.contactInfo?.fullName ?? "",
        email: order.contactInfo?.email ?? "",
        phone: order.contactInfo?.phone ?? "",
        shippingAddress: order.contactInfo?.shippingAddress ?? ""
      },
      items,
      subtotal: resolveOrderSubtotal(order, computedSubtotal),
      shippingCost: shipping,
      total,
      paymentStatus: order.paymentStatus ?? "unpaid",
      timestampISO: (order.timestamp?.toDate?.() && order.timestamp.toDate().toISOString()) || new Date().toISOString(),
      tracking: trackingEntries.map(t=>({
        carrier:t.carrier||"",
        number:t.number||"",
        url:t.url||buildTrackingUrl(t.carrier,t.number),
        hasShipped: typeof t.hasShipped === 'boolean' ? t.hasShipped : defaultHasShipped
      }))
    };
  }

  /* Resend email (with tracking) */
  async function resendOrderEmailById(orderId,btn){
    const order=allOrdersCache.find(o=>o.id===orderId);
    if(!order){ showModal(`Order not found: ${orderId}`); return; }
    const payloadOrder = buildExternalOrderPayload(order);

    const original=btn?.textContent; if(btn){ btn.disabled=true; btn.textContent="Resending..."; btn.classList.add("opacity-70","cursor-not-allowed"); }
    try{ await resendFn({ order: payloadOrder }); showModal(`Resent confirmation to ${payloadOrder.contactInfo.email}`); }
    catch(err){ console.error("Resend failed:",err); showModal(`Resend failed: ${err.message||"See console"}`); }
    finally{ if(btn){ btn.disabled=false; btn.textContent=original||"Resend Email"; btn.classList.remove("opacity-70","cursor-not-allowed"); } }
  }

  async function handleOrderDeliveredToggle(ev){
    const checkbox = ev.currentTarget;
    const orderId = checkbox?.dataset?.orderId || '';
    const desiredState = checkbox?.checked === true;
    if(!orderId) return;

    const order = allOrdersCache.find(o=>o.id===orderId);
    if(!order){
      checkbox.checked = !desiredState;
      showModal(`Order not found: ${orderId}`);
      return;
    }

    const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
    checkbox.disabled = true;
    try{
      await updateDoc(orderRef, { orderDelivered: desiredState });
    }catch(err){
      console.error('Failed to update delivered status:', err);
      checkbox.checked = !desiredState;
      showModal(`Failed to update delivered status: ${err.message}`);
    }finally{
      checkbox.disabled = false;
    }
  }

  async function handleTrackingShippedToggle(ev){
    const checkbox = ev.currentTarget;
    const orderId = checkbox?.dataset?.orderId || '';
    const index = Number(checkbox?.dataset?.trackIndex);
    const desiredState = checkbox?.checked === true;
    if(!orderId || Number.isNaN(index)) return;

    const order = allOrdersCache.find(o=>o.id===orderId);
    if(!order){
      checkbox.checked = !desiredState;
      showModal(`Order not found: ${orderId}`);
      return;
    }

    const trackingEntries = extractTrackingEntries(order.tracking);
    if(index < 0 || index >= trackingEntries.length){
      checkbox.checked = !desiredState;
      showModal('Tracking entry not found.');
      return;
    }

    trackingEntries[index] = { ...trackingEntries[index], hasShipped: desiredState };

    const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
    checkbox.disabled = true;
    try{
      await updateDoc(orderRef, { tracking: trackingEntries });
    }catch(err){
      console.error('Failed to update shipped status:', err);
      checkbox.checked = !desiredState;
      showModal(`Failed to update shipped status: ${err.message}`);
    }finally{
      checkbox.disabled = false;
    }
  }

  async function sendTrackingEmail(orderId, trackingNumber, btn){
    const order = allOrdersCache.find(o=>o.id===orderId);
    if(!order){ showModal(`Order not found: ${orderId}`); return; }
    const payloadOrder = buildExternalOrderPayload(order);
    const targetTracking = trackingNumber || payloadOrder.tracking?.[0]?.number || "";
    if(!targetTracking){ showModal('No tracking number available for this order.'); return; }

    const original = btn?.textContent;
    if(btn){ btn.disabled = true; btn.textContent = 'Sending...'; btn.classList.add('opacity-70','cursor-not-allowed'); }
    try{
      await sendShippingFn({ order: payloadOrder, trackingNumber: targetTracking });
      showModal(`Shipping confirmation sent to ${payloadOrder.contactInfo.email || 'customer'}.`);
    }catch(err){
      console.error('Shipping confirmation failed:', err);
      showModal(`Failed to send shipping confirmation: ${err.message || 'See console'}`);
    }finally{
      if(btn){ btn.disabled = false; btn.textContent = original || 'Send Email'; btn.classList.remove('opacity-70','cursor-not-allowed'); }
    }
  }

  /* Events */
  function attachEventListeners(){
    qs('auth-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=qs('email').value; const password=qs('password').value;
      if(!isValidEmail(email)){ showModal('Please enter a valid email address.'); return; }
      try{ await signInWithEmailAndPassword(auth,email,password); showModal('Login successful!'); }
      catch(error){ console.error("Login failed:",error); let msg="Login failed. Check your credentials."; if(error.code==='auth/wrong-password') msg="Incorrect password. Please try again."; else if(error.code==='auth/user-not-found') msg="Admin user not found."; showModal(msg); }
    });

    qs('signout-btn').addEventListener('click', async ()=>{
      try{ await signOut(auth); showModal('Signed out successfully.'); }
      catch(error){ console.error("Sign out failed:",error); showModal(`Sign out failed: ${error.message}`); }
    });

    qs('close-modal-btn').addEventListener('click',()=>qs('alert-modal').classList.add('hidden'));

    qs('orders-container').addEventListener('click', (e)=>{
      const prepareBtn = e.target.closest('.prepare-order-btn');
      if(prepareBtn){
        const orderId = prepareBtn.dataset.orderId;
        const order = allOrdersCache.find(o=>o.id===orderId);
        if(order){
          openPrepareOrderModal(order);
        }else{
          showModal(`Order not found: ${orderId}`);
        }
        return;
      }
        // NEW: Delete button on card
      const delBtn = e.target.closest('.delete-order-card-btn');
      if (delBtn) {
        const orderId = delBtn.dataset.orderId;
        if (orderId) deleteOrderAndRollback(orderId, delBtn);
        return;
      }
      const editButton=e.target.closest('.edit-order-btn');
      if(editButton){ const orderId=editButton.dataset.orderId; const order=allOrdersCache.find(o=>o.id===orderId); if(order) openEditModal(order); return; }
      const resendButton=e.target.closest('.resend-order-btn');
      if(resendButton){ const orderId=resendButton.dataset.orderId; resendOrderEmailById(orderId,resendButton); return; }
      const sendTrackButton = e.target.closest('.send-tracking-email-btn');
      if(sendTrackButton){ const orderId=sendTrackButton.dataset.orderId; const track=sendTrackButton.dataset.track||""; if(orderId) sendTrackingEmail(orderId, track, sendTrackButton); return; }
    });

    if(editOrderForm) editOrderForm.addEventListener('submit', handleEditOrder);
    if(closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
    if(editOrderBackdrop) editOrderBackdrop.addEventListener('click', closeEditModal);

    if(prepareOrderCloseIcon) prepareOrderCloseIcon.addEventListener('click', closePrepareOrderModal);
    if(prepareOrderCancelBtn) prepareOrderCancelBtn.addEventListener('click', closePrepareOrderModal);
    if(prepareOrderBackdrop) prepareOrderBackdrop.addEventListener('click', closePrepareOrderModal);
    if(prepareOrderStartBtn) prepareOrderStartBtn.addEventListener('click', handlePrepareOrderStart);

    document.addEventListener('keydown', (evt)=>{
      if(evt.key !== 'Escape') return;
      if(prepareOrderModal && prepareOrderModal.classList.contains('is-open')){
        closePrepareOrderModal();
        evt.preventDefault();
        return;
      }
      if(editOrderModal && editOrderModal.classList.contains('is-open')){
        closeEditModal();
        evt.preventDefault();
      }
    });

    if(addItemForm) addItemForm.addEventListener('submit', handleAddItem);
    if(addCostForm) addCostForm.addEventListener('submit', handleNewCostHistory);
    if(editItemSelect) editItemSelect.addEventListener('change', ()=>{
      loadSelectedInventoryForEdit(editItemSelect.value);
    });
    if(editItemDeprecateBtn) editItemDeprecateBtn.addEventListener('click', handleDeprecateCurrentCoa);
    if(editItemForm) editItemForm.addEventListener('submit', handleEditInventoryItem);

    TOOL_CONFIG.forEach((tool)=>{
      if(!tool.button || !tool.wrapper) return;
      tool.button.addEventListener('click', ()=>{
        const isHidden = tool.wrapper.classList.contains('hidden');
        if(isHidden){
          closeAllTools(tool);
          setToolOpen(tool,true);
        }else{
          setToolOpen(tool,false);
        }
      });
    });

    const addTrackBtn=qs('edit-track-add-btn');
    if(addTrackBtn) addTrackBtn.addEventListener('click', handleAddTrackingEntry);

  }

  /* ============================
 * Delete order from card (rollback inventory & vialsSold)
 * ============================ */
/* Delete order from card (NO inventory changes) */
async function deleteOrderAndRollback(orderId, buttonEl) {
  const order = allOrdersCache.find(o => o.id === orderId);
  if (!order) { showModal(`Order not found: ${orderId}`); return; }

  const prettyId = order.orderId || orderId;
  const ok = window.confirm(`Delete order ${prettyId}? This WILL redistribute inventory and update vialsSold.`);
  if (!ok) return;

  // UI: disable while working
  const originalText = buttonEl?.textContent;
  if (buttonEl) {
    buttonEl.disabled = true;
    buttonEl.textContent = "Deleting...";
    buttonEl.classList.add("opacity-70", "cursor-not-allowed");
  }

  try {
    // Redistribute inventory and update vialsSold
    if (Array.isArray(order.items)) {
      for (const item of order.items) {
        const inv = window._getInvFromOrderItem(item);
        if (!inv) continue;
        const qty = Number(item.quantity || 0);
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), {
          currentInventory: increment(qty),
          vialsSold: increment(-qty)
        });
      }
    }
    await deleteDoc(doc(db, ORDERS_COLLECTION_PATH, orderId));
    showModal(`Order ${prettyId} deleted and inventory updated.`);
  } catch (err) {
    console.error("Delete failed:", err);
    showModal(`Failed to delete order: ${err.message || "See console"}`);
  } finally {
    if (buttonEl) {
      buttonEl.disabled = false;
      buttonEl.textContent = originalText || "Delete";
      buttonEl.classList.remove("opacity-70", "cursor-not-allowed");
    }
  }
}



  window.addEventListener('load', ()=>{
    try{
      onAuthStateChanged(auth,(user)=>{ updateUI(user); });
      attachEventListeners();
    }catch(err){ console.error('Init failed:',err); qs('status').textContent=`Error: ${err.message}`; }
  });
  </script>
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const codesEl = $("codes");
      const logEl = $("log");
      const endpointEl = $("endpoint");
      const adminKeyEl = $("adminKey");
      const toggleKeyBtn = $("toggleKey");

      toggleKeyBtn.addEventListener("click", () => {
        adminKeyEl.type = adminKeyEl.type === "password" ? "text" : "password";
        toggleKeyBtn.textContent = adminKeyEl.type === "password" ? "Show" : "Hide";
      });

      // --- Row template ---
      function newRow(data = {}) {
        const div = document.createElement("div");
        div.className = "code-card";
        div.innerHTML = `
      <div class="code-header">
        <strong>Promo code</strong>
        <button class="btn warn" type="button" data-action="remove">Remove</button>
      </div>

      <div class="row-4">
        <div>
          <label>Code</label>
          <input type="text" data-field="code" placeholder="WELCOME10" value="${esc(data.code || "")}" />
        </div>
        <div>
          <label>Type</label>
          <select data-field="type">
            <option value="percent">percent</option>
            <option value="fixed">fixed</option>
            <option value="free_shipping">free_shipping</option>
          </select>
        </div>
        <div>
          <label>Value</label>
          <input type="number" step="0.01" data-field="value" placeholder="10 (for 10%)" />
        </div>
        <div>
          <label>Label (optional)</label>
          <input type="text" data-field="label" placeholder="10% off" value="${esc(data.label || "")}" />
        </div>
      </div>

      <div class="row-4" style="margin-top:8px;">
        <div>
          <label>Active</label>
          <div style="display:flex;align-items:center;height:40px">
            <input type="checkbox" data-field="active" ${data.active === false ? "" : "checked"} />
          </div>
        </div>
        <div>
          <label>Global Usage Limit (optional)</label>
          <input type="number" data-field="usageLimit" placeholder="e.g. 500" value="${numOrEmpty(data.usageLimit)}" />
        </div>
        <div>
          <label>Per-User Limit (optional)</label>
          <input type="number" data-field="perUserLimit" placeholder="e.g. 1" value="${numOrEmpty(data.perUserLimit)}" />
        </div>
        <div>
          <label>Expires At (optional)</label>
          <input type="datetime-local" data-field="expiresAt" />
        </div>
      </div>
      `;

        // set selects/values post-DOM insert
        const typeSel = div.querySelector('[data-field="type"]');
        typeSel.value = data.type || "percent";

        const valueEl = div.querySelector('[data-field="value"]');
        if (typeof data.value !== "undefined") valueEl.value = data.value;

        const expiresEl = div.querySelector('[data-field="expiresAt"]');
        if (data.expiresAt) {
          const dt = toLocalDatetimeInput(data.expiresAt);
          if (dt) expiresEl.value = dt;
        }

        // uppercase CODE on input
        const codeEl = div.querySelector('[data-field="code"]');
        codeEl.addEventListener("input", () => { codeEl.value = codeEl.value.toUpperCase().replace(/\s+/g,''); });

        // disable value for free_shipping
        const onTypeChange = () => {
          if (typeSel.value === "free_shipping") {
            valueEl.value = "";
            valueEl.disabled = true;
          } else {
            valueEl.disabled = false;
          }
        };
        typeSel.addEventListener("change", onTypeChange);
        onTypeChange();

        // remove
        div.querySelector('[data-action="remove"]').addEventListener("click", () => {
          div.remove();
          note(`Removed a code row.`);
        });

        return div;
      }

      function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
      function numOrEmpty(v){ return (v === 0 || (typeof v === "number" && Number.isFinite(v))) ? String(v) : ""; }

      function toLocalDatetimeInput(v){
        // Accept ISO string, millis, or Date
        const d = v instanceof Date ? v : (typeof v === "number" ? new Date(v) : new Date(String(v)));
        if (isNaN(d)) return "";
        // datetime-local expects "YYYY-MM-DDTHH:mm"
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function fromDatetimeLocalToISO(s){
        if (!s) return undefined;
        const d = new Date(s);
        if (isNaN(d)) return undefined;
        return d.toISOString(); // server accepts ISO
      }

      function collectPayload(){
        const adminKey = adminKeyEl.value.trim();
        const endpoint = endpointEl.value.trim();
        if (!endpoint) throw new Error("Endpoint required.");
        if (!adminKey) throw new Error("Admin key required.");

        const rows = Array.from(codesEl.querySelectorAll(".code-card"));
        if (rows.length === 0) throw new Error("Add at least one code.");

        const codes = rows.map(card => {
          const get = sel => card.querySelector(sel);
          const code = (get('[data-field="code"]').value || "").trim().toUpperCase();
          const type = (get('[data-field="type"]').value || "").trim();
          const valueRaw = get('[data-field="value"]').value;
          const label = (get('[data-field="label"]').value || "").trim();
          const active = get('[data-field="active"]').checked;
          const usageLimitRaw = get('[data-field="usageLimit"]').value;
          const perUserLimitRaw = get('[data-field="perUserLimit"]').value;
          const expiresAtLocal = get('[data-field="expiresAt"]').value;

          if (!code) throw new Error("Each code row needs a CODE.");
          if (!type) throw new Error(`Code ${code}: type required.`);

          const toNum = (x) => {
            if (x === "" || x === null || typeof x === "undefined") return undefined;
            const n = Number(x);
            return Number.isFinite(n) ? n : undefined;
          };

          const doc = { code, type, active };
          if (label) doc.label = label;

          // only include value for percent/fixed
          if (type !== "free_shipping") {
            const v = toNum(valueRaw);
            if (typeof v === "undefined") throw new Error(`Code ${code}: value required for type "${type}".`);
            doc.value = v;
          }

          const usageLimit = toNum(usageLimitRaw);
          if (typeof usageLimit !== "undefined") doc.usageLimit = usageLimit;

          const perUserLimit = toNum(perUserLimitRaw);
          if (typeof perUserLimit !== "undefined") doc.perUserLimit = perUserLimit;

          const expiresAtISO = fromDatetimeLocalToISO(expiresAtLocal);
          if (expiresAtISO) doc.expiresAt = expiresAtISO;

          return doc;
        });

        return { endpoint, body: { adminKey, codes } };
      }

      function note(msg){ logEl.textContent = msg; logEl.classList.remove("muted"); }
      function show(obj, title=""){ logEl.textContent = (title ? title + "\n" : "") + JSON.stringify(obj, null, 2); logEl.classList.remove("muted"); }
      function warn(msg){ logEl.textContent = "⚠ " + msg; logEl.classList.remove("muted"); }
      function err(msg){ logEl.textContent = "❌ " + msg; logEl.classList.remove("muted"); }

      // Buttons
      $("addRow").addEventListener("click", () => {
        codesEl.appendChild(newRow());
        note("Added a code row.");
      });

      $("loadSample").addEventListener("click", () => {
        codesEl.innerHTML = "";
        codesEl.appendChild(newRow({ code:"WELCOME10", type:"percent", value:10, label:"10% off", active:true, perUserLimit:1 }));
        codesEl.appendChild(newRow({ code:"FREESHIP", type:"free_shipping", label:"Free shipping", active:true }));
        note("Loaded sample codes.");
      });

      $("preview").addEventListener("click", () => {
        try {
          const { body } = collectPayload();
          show(body, "Preview payload:");
        } catch (e) { err(e.message); }
      });

      $("push").addEventListener("click", async () => {
        try {
          const { endpoint, body } = collectPayload();
          show(body, "Sending payload...");
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(body)
          });
          const text = await res.text();
          let parsed; try { parsed = JSON.parse(text); } catch { parsed = { raw: text }; }
          show({ status: res.status, response: parsed }, "Response:");
        } catch (e) {
          err(e.message || String(e));
        }
      });

      $("exportJson").addEventListener("click", () => {
        try {
          const { body } = collectPayload();
          const blob = new Blob([JSON.stringify(body, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "promos.json";
          a.click();
          URL.revokeObjectURL(a.href);
          note("Exported promos.json");
        } catch (e) { err(e.message); }
      });

      $("importFile").addEventListener("change", async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        try {
          const text = await f.text();
          const obj = JSON.parse(text);
          if (!obj || !Array.isArray(obj.codes)) throw new Error("JSON must have a 'codes' array.");
          if (obj.adminKey) adminKeyEl.value = obj.adminKey;
          codesEl.innerHTML = "";
          for (const c of obj.codes) codesEl.appendChild(newRow(c));
          show(obj, "Imported JSON:");
        } catch (e) { err("Import failed: " + e.message); }
      });

      // start with one blank row
      codesEl.appendChild(newRow());

    })();
  </script>
</body>
</html>
