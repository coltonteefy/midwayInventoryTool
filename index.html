<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <style>
    body { font-family:'Roboto Mono',monospace; background:#0d0c1d; color:#e2e8f0 }
    .neon-glow{ box-shadow:0 0 5px #1e90ff,0 0 10px #1e90ff,0 0 15px #1e90ff,0 0 20px #1e90ff }
    .text-glow-fuchsia{ text-shadow:0 0 3px #d62d88,0 0 8px #d62d88 }
    .text-glow-cyan{ text-shadow:0 0 3px #0891b2,0 0 8px #0891b2 }
    .btn-neon-cyan{ background:#0891b2; color:#fff } .btn-neon-cyan:hover{ background:#06748c }
    .btn-neon-lime{ background:#65a30d; color:#000 } .btn-neon-lime:hover{ background:#4d820d }
    .btn-neon-red{ background:#dc2626; color:#fff } .btn-neon-red:hover{ background:#b91c1c }
    table{ width:100%; border-collapse:collapse; text-align:left }
    th,td{ padding:12px; border-bottom:1px solid #1f2937 }
    th{ background:#1e1b4b; font-weight:700; color:#93c5fd; text-transform:uppercase }
    tr:last-child td{ border-bottom:none }
    td.is-editing{ background:#1f2937; outline:2px solid #06b6d4; outline-offset:-2px }
    .order-card,.infographic-card{ background:#1f2937; border:1px solid #374151; box-shadow:0 4px 6px rgba(0,0,0,.1) }
    .infographic-grid{ display:grid; gap:1.5rem; grid-template-columns:repeat(1,minmax(0,1fr)) }
    @media (min-width:640px){ .infographic-grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (min-width:1024px){ .infographic-grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }
    .infographic-list li{ display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px dashed #374151 }
    .infographic-list li:last-child{ border-bottom:none }
    .infographic-list .rank{ font-weight:bold; color:#06b6d4 }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:40; opacity:0; transition:opacity .3s; pointer-events:none }
    .modal-backdrop.is-open{ opacity:1; pointer-events:auto }
    .modal-main{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:90%; max-width:600px; background:#111827; z-index:50; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.5); padding:2rem; transition:transform .3s,opacity .3s; opacity:0; pointer-events:none; max-height:90%; overflow-y:auto }
    .modal-main.is-open{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1) }
    @keyframes copyPulse{ 0%{transform:scale(1);} 40%{transform:scale(1.12);} 80%{transform:scale(0.98);} 100%{transform:scale(1);} }
    .copy-track.copied,.copy-contact.copied{ background:#22c55e!important; color:#06131a!important; animation:copyPulse .6s ease forwards; box-shadow:0 0 12px rgba(34,197,94,.45); }

    /* Promo tool styles */
    #promo-tool {
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --fg:#e5e7eb;
      --accent:#38bdf8;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      margin-top:0;
      padding:3rem 1rem 4rem;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);
      border-radius:24px;
    }
    #promo-tool .promo-wrap {
      max-width:1050px;
      margin:0 auto;
    }
    #promo-tool .promo-title {
      margin:0 0 10px;
      font-size:22px;
      font-weight:700;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #promo-tool .promo-pill {
      font-size:11px;
      color:#082f49;
      background:#67e8f9;
      padding:4px 8px;
      border-radius:999px;
      font-weight:700;
    }
    #promo-tool .promo-card {
      background:var(--card);
      border:1px solid #1f2937;
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    #promo-tool label {
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:6px 0 6px;
    }
    #promo-tool input[type="text"],
    #promo-tool input[type="password"],
    #promo-tool input[type="number"],
    #promo-tool input[type="datetime-local"],
    #promo-tool select,
    #promo-tool textarea {
      width:100%;
      padding:10px 12px;
      background:#0b1220;
      color:var(--fg);
      border:1px solid #263244;
      border-radius:10px;
      outline:none;
    }
    #promo-tool input[type="checkbox"] {
      transform:scale(1.05);
    }
    #promo-tool textarea {
      min-height:120px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    #promo-tool .toolbar {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    #promo-tool .btn {
      appearance:none;
      border:1px solid #243244;
      background:#0b1220;
      color:var(--fg);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    #promo-tool .btn:hover {
      border-color:#324459;
    }
    #promo-tool .btn.primary {
      background:linear-gradient(180deg,#1e40af,#1d4ed8);
      border-color:#1d4ed8;
    }
    #promo-tool .btn.ok {
      background:linear-gradient(180deg,#0f9b6b,#10b981);
      border:1px solid #10b981;
    }
    #promo-tool .btn.warn {
      background:linear-gradient(180deg,#b45309,#f59e0b);
      border:1px solid #f59e0b;
      color:#0b1220;
    }
    #promo-tool .btn.ghost {
      background:transparent;
    }
    #promo-tool .codes {
      margin-top:16px;
      display:grid;
      gap:12px;
    }
    #promo-tool .code-card {
      background:#0b1220;
      border:1px solid #21304a;
      border-radius:12px;
      padding:12px;
    }
    #promo-tool .code-header {
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:space-between;
      margin-bottom:6px;
    }
    #promo-tool .row {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    #promo-tool .row-3 {
      display:grid;
      grid-template-columns:1.2fr .8fr .8fr;
      gap:10px;
    }
    #promo-tool .row-4 {
      display:grid;
      grid-template-columns:1fr .7fr .7fr .7fr;
      gap:10px;
    }
    #promo-tool .hint {
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
    }
    #promo-tool .footnote {
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    #promo-tool .log {
      white-space:pre-wrap;
      background:#0b1220;
      border:1px solid #21304a;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }
    #promo-tool .log.muted {
      color:var(--muted);
    }
    #promo-tool .muted {
      color:var(--muted);
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
      <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>
    </div>

    <div id="auth-buttons" class="space-x-4">
      <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Sign Out</button>
    </div>

    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>

    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>

    <div id="main-content" class="hidden space-y-8">
      <!-- Production Tools -->
      <section id="production-tools-section" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Production Tools</h2>
        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
          <div class="flex flex-wrap gap-4">
            <button id="toggle-cost-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Cost History</button>
            <button id="toggle-inventory-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Inventory</button>
            <button id="toggle-edit-item-tool-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Edit Inventory</button>
            <button id="toggle-promo-tool-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Promo Tool</button>
          </div>
          <div id="inventory-tool-wrapper" class="mt-4 hidden">
            <section id="inventory-tool" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add New Inventory Item</h2>
              <form id="add-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <div class="w-full">
                    <label for="new-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
                    <input type="text" id="new-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-id" class="block text-sm font-medium text-gray-400">Item ID</label>
                    <input type="text" id="new-item-id" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., RT24" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold (Initial)</label>
                    <input type="number" id="new-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
                    <input type="number" step="0.01" id="new-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <label for="new-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
                    <input type="number" step="0.01" id="new-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
                  </div>
                  <div class="w-full">
                    <div class="flex items-center space-x-2 mt-7">
                      <input type="checkbox" id="new-item-blend" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600">
                      <label for="new-item-blend" class="block text-sm font-medium text-gray-400">Is a Blend?</label>
                    </div>
                  </div>
                  <div class="w-full">
                    <div class="flex items-center space-x-2 mt-7">
                      <input type="checkbox" id="new-item-is-active" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600" checked>
                      <label for="new-item-is-active" class="block text-sm font-medium text-gray-400">Product is Active</label>
                    </div>
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                    <label for="new-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
                    <input type="url" id="new-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/image.jpg">
                  </div>
                  <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                    <label for="new-item-description" class="block text-sm font-medium text-gray-400">Product Description</label>
                    <textarea id="new-item-description" rows="3" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Short summary shown to customers"></textarea>
                  </div>
                </div>

                <div class="space-y-3 mt-6 p-4 rounded-lg border border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-cyan">Certificate of Analysis</h3>
                  <div>
                    <label for="new-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
                    <input type="url" id="new-item-coa" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/coa.pdf">
                  </div>
                </div>

                <div class="space-y-4 mt-6 p-4 rounded-lg border-2 border-dashed border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-fuchsia">Initial Cost History</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="w-full">
                      <label for="new-cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                      <input type="number" step="0.01" id="new-cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="$0.00" required>
                    </div>
                    <div class="w-full">
                      <label for="new-total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                      <input type="number" id="new-total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                    </div>
                    <div class="w-full">
                      <label for="new-total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                      <input type="number" id="new-total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
                    </div>
                    <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                      <label for="new-purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                      <input type="date" id="new-purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                  </div>
                </div>

                <div class="flex justify-center mt-6">
                  <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Item</button>
                </div>
              </form>
            </section>
          </div>
          <div id="inventory-editor-wrapper" class="mt-4 hidden">
            <section id="inventory-editor" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Edit Inventory Item</h2>
              <form id="edit-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="w-full md:col-span-2">
                    <label for="edit-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
                    <select id="edit-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
                      <option value="">-- Select an item --</option>
                    </select>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
                    <input type="text" id="edit-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-current-inventory" class="block text-sm font-medium text-gray-400">Current Inventory</label>
                    <input type="number" id="edit-item-current-inventory" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold</label>
                    <input type="number" id="edit-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
                    <input type="number" step="0.01" id="edit-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
                    <input type="number" step="0.01" id="edit-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" min="0" disabled>
                  </div>
                  <div class="w-full">
                    <label for="edit-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
                    <input type="text" id="edit-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://..." disabled>
                  </div>
                </div>
                <div class="space-y-3 p-4 rounded-lg border border-gray-700">
                  <h3 class="text-lg font-semibold text-white text-glow-cyan">Certificate of Analysis</h3>
                  <div>
                    <label for="edit-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
                    <div class="mt-1 flex flex-col sm:flex-row gap-2">
                      <input type="text" id="edit-item-coa" class="flex-1 bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://..." disabled>
                      <button type="button" id="edit-item-deprecate-btn" class="btn-neon-red px-4 py-2 rounded-lg font-semibold text-xs sm:text-sm opacity-60 cursor-not-allowed" disabled>Deprecate</button>
                    </div>
                  </div>
                  <div>
                    <label for="edit-item-coa-lot" class="block text-sm font-medium text-gray-400">COA Lot</label>
                    <input type="text" id="edit-item-coa-lot" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="MG-..." disabled>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" id="edit-item-is-active" class="h-4 w-4 text-cyan-600 border-gray-600 rounded focus:ring-cyan-500" disabled>
                    <label for="edit-item-is-active" class="text-sm font-medium text-gray-400">Active</label>
                  </div>
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" id="edit-item-blend" class="h-4 w-4 text-cyan-600 border-gray-600 rounded focus:ring-cyan-500" disabled>
                    <label for="edit-item-blend" class="text-sm font-medium text-gray-400">Blend</label>
                  </div>
                </div>
                <div>
                  <label for="edit-item-description" class="block text-sm font-medium text-gray-400">Product Description</label>
                  <textarea id="edit-item-description" rows="3" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Short description of the product" disabled></textarea>
                </div>
                <div class="flex justify-center">
                  <button type="submit" id="edit-item-save-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto opacity-60 cursor-not-allowed" disabled>Save Changes</button>
                </div>
              </form>
            </section>
          </div>
          <div id="cost-tool-wrapper" class="mt-4 hidden">
            <section id="cost-tool" class="space-y-4">
              <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add Cost History Entry</h2>
              <form id="add-cost-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="w-full md:col-span-2">
                    <label for="existing-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
                    <select id="existing-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
                      <option value="">-- Select an item --</option>
                    </select>
                  </div>
                  <div class="w-full">
                    <label for="cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                    <input type="number" step="0.01" id="cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="$0.00" required>
                  </div>
                  <div class="w-full">
                    <label for="total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                    <input type="number" id="total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
                  </div>
                  <div class="w-full">
                    <label for="total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                    <input type="number" id="total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
                  </div>
                  <div class="w-full">
                    <label for="purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                    <input type="date" id="purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
                  </div>
                </div>
                <div class="flex justify-center mt-6">
                  <button type="submit" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Cost Entry</button>
                </div>
              </form>
            </section>
          </div>
          <div id="promo-tool-wrapper" class="mt-4 hidden">
            <section id="promo-tool">
              <div class="promo-wrap">
                <h2 class="promo-title">Promo Codes Admin <span class="promo-pill">local tool</span></h2>
                <div class="promo-card">
                  <div class="row">
                    <div>
                      <label>Function Endpoint (HTTPS)</label>
                      <input id="endpoint" type="text" value="https://us-central1-peptide-inventory.cloudfunctions.net/upsertPromoCodesHttp" />
                      <div class="hint">Change if your project or region differs.</div>
                    </div>
                    <div>
                      <label>Admin Key</label>
                      <div style="display:flex; gap:8px;">
                        <input id="adminKey" type="password" placeholder="Your secret admin key" />
                        <button class="btn" id="toggleKey" title="Show/Hide">Show</button>
                      </div>
                      <div class="hint">Never embed this in public code. Use this page locally.</div>
                    </div>
                  </div>

                  <div class="toolbar">
                    <button class="btn" id="addRow">+ Add Code</button>
                    <button class="btn ghost" id="loadSample">Load sample</button>
                    <button class="btn" id="preview">Preview JSON</button>
                    <button class="btn ok" id="push">Push to Firebase</button>
                    <button class="btn ghost" id="exportJson">Export JSON</button>
                    <label class="btn ghost" for="importFile" style="cursor:pointer;">Import JSON</label>
                    <input id="importFile" type="file" accept="application/json" style="display:none;" />
                  </div>

                  <div id="codes" class="codes"></div>

                  <div class="footnote">
                    Tip: For <span class="muted">expiresAt</span> use your local date/time; it will be sent as ISO (UTC). “free_shipping” ignores value.
                  </div>

                  <h3 style="margin:18px 0 6px">Payload Preview / Response</h3>
                  <div id="log" class="log muted">No actions yet.</div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </section>

      <!-- Inventory Section -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Current Inventory</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Vials Sold</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Sell Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Vial Weight (mg)</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Active</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </div>

      <!-- Totals -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>

      <!-- Orders -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <label for="order-search" class="sr-only">Search Orders</label>
          <input id="order-search" type="search" placeholder="Search by order ID, customer name, or phone" class="w-full sm:w-80 bg-gray-800 border border-gray-600 rounded-md shadow-sm p-3 text-gray-200 focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" spellcheck="false">
        </div>
        <div id="orders-container" class="space-y-6">
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
        <div id="orders-pagination" class="mt-4 flex justify-center hidden">
          <button id="load-more-orders" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs">Load More</button>
        </div>
      </div>

      <!-- Infographics -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <ul id="list-monthly-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <ul id="list-top-customers" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <ul id="list-top-products-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <ul id="list-top-products-quantity" class="infographic-list"></ul>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
          No sales data to display yet.
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="edit-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-order-modal" class="modal-main hidden">
    <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
      <h2 class="text-2xl font-bold">Edit Order</h2>
      <button id="close-edit-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="edit-order-form" class="space-y-4">
      <input type="hidden" id="edit-order-id">
      <div>
        <label for="edit-contact-name" class="block text-sm font-medium text-gray-400">Customer Name</label>
        <input type="text" id="edit-contact-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
      </div>
      <div>
        <label for="edit-order-total" class="block text-sm font-medium text-gray-400">Total Amount</label>
        <input type="number" step="0.01" id="edit-order-total" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500">
      </div>
      <div class="text-sm text-gray-400 -mt-2">
        Shipping (preserved): <span id="edit-shipping-display">$0.00</span>
      </div>
      <div>
        <label for="edit-order-status" class="block text-sm font-medium text-gray-400">Payment Status</label>
        <select id="edit-order-status" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          <option value="Paid">Paid</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <!-- Read-only Items -->
      <div class="space-y-4">
        <h3 class="text-md font-semibold text-gray-400 mt-4">Order Items:</h3>
        <div id="edit-order-items-list" class="space-y-2"></div>

        <!-- Shipping & Tracking (kept) -->
        <div class="space-y-4 mt-6">
          <h3 class="text-md font-semibold text-gray-400">Shipping & Tracking</h3>
          <div id="edit-order-tracking-list" class="space-y-2"></div>
          <input type="hidden" id="edit-order-tracking-hidden" value="[]">
          <div class="flex flex-col sm:flex-row gap-2 items-end">
            <div class="w-full sm:w-48">
              <label for="edit-track-carrier" class="block text-sm font-medium text-gray-400">Carrier</label>
              <select id="edit-track-carrier" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="">-- Select --</option>
                <option>USPS</option>
                <option>UPS</option>
                <option>FedEx</option>
                <option>DHL</option>
                <option>Other</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="edit-track-number" class="block text-sm font-medium text-gray-400">Tracking Number</label>
              <input id="edit-track-number" type="text" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., 9400 1234 5678 9012 3456 78">
            </div>
            <button type="button" id="edit-track-add-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto mt-4 sm:mt-0">Add Tracking</button>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, setDoc, arrayUnion, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
    authDomain: "peptide-inventory.firebaseapp.com",
    projectId: "peptide-inventory",
    storageBucket: "peptide-inventory.firebasestorage.app",
    messagingSenderId: "547049240971",
    appId: "1:547049240971:web:83b2e836fee57bb41f578e",
    measurementId: "G-1W58JMJN37"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  try { getAnalytics(app); } catch (_) {}
  const fns = getFunctions(app);
  const resendFn = httpsCallable(fns, "resendOrderConfirmation");
  const sendShippingFn = httpsCallable(fns, "sendShippingConfirmation");

  const qs = (id) => document.getElementById(id);
  const ORDERS_PAGE_SIZE = 5;
  let visibleOrdersCount = ORDERS_PAGE_SIZE;
  let orderSearchTerm = '';
  let userAdjustedOrderView = false;
  let sortedOrdersCache = [];
  let userId = null;
  let totalRevenue = 0;
  let totalCost = 0;
  let allOrdersCache = [];
  let previousOrdersCache = new Map();
  let inventoryCache = {};

  const loadMoreOrdersBtn = qs('load-more-orders');
  const ordersPagination = qs('orders-pagination');
  const orderSearchInput = qs('order-search');

  const processedTransitions = new Set();
  function transitionKey(before, after) {
    const b = before ? before.paymentStatus : '∅';
    const a = after  ? after.paymentStatus  : '∅';
    const itemsHash = JSON.stringify(after?.items || []);
    return `${after.id}|${b}->${a}|${itemsHash}`;
  }

  const INVENTORY_COLLECTION_PATH = 'inventory';
  const ORDERS_COLLECTION_PATH = 'orders';

  // Edit modal DOM
  const editOrderBackdrop = qs('edit-order-backdrop');
  const editOrderModal = qs('edit-order-modal');
  const closeEditModalBtn = qs('close-edit-modal-btn');
  const editOrderForm = qs('edit-order-form');

  // Add Item form inputs
  const addItemForm = qs('add-item-form');
  const newItemNameInput = qs('new-item-name');
  const newItemIdInput = qs('new-item-id');
  const newItemVialsSoldInput = qs('new-item-vials-sold');
  const newItemPriceInput = qs('new-item-price');
  const newItemTotalVialWeightInput = qs('new-item-total-vial-weight');
  const newItemBlendInput = qs('new-item-blend');
  const newItemIsActiveInput = qs('new-item-is-active');
  const newItemImageInput = qs('new-item-image');
  const newItemCoaInput = qs('new-item-coa');
  const newItemDescriptionInput = qs('new-item-description');
  const newCostPerKitInput = qs('new-cost-per-kit');
  const newTotalKitsBoughtInput = qs('new-total-kits-bought');
  const newTotalVialsPerKitInput = qs('new-total-vials-per-kit');
  const newPurchaseDateInput = qs('new-purchase-date');

  const inventoryEditorWrapper = qs('inventory-editor-wrapper');
  const toggleEditItemToolBtn = qs('toggle-edit-item-tool-btn');

  const editItemForm = qs('edit-item-form');
  const editItemSelect = qs('edit-item-select');
  const editItemNameInput = qs('edit-item-name');
  const editItemCurrentInventoryInput = qs('edit-item-current-inventory');
  const editItemVialsSoldInput = qs('edit-item-vials-sold');
  const editItemPriceInput = qs('edit-item-price');
  const editItemTotalVialWeightInput = qs('edit-item-total-vial-weight');
  const editItemImageInput = qs('edit-item-image');
  const editItemCoaInput = qs('edit-item-coa');
  const editItemCoaLotInput = qs('edit-item-coa-lot');
  const editItemIsActiveInput = qs('edit-item-is-active');
  const editItemBlendInput = qs('edit-item-blend');
  const editItemDescriptionInput = qs('edit-item-description');
  const editItemDeprecateBtn = qs('edit-item-deprecate-btn');
  const editItemSaveBtn = qs('edit-item-save-btn');

  // Add Cost
  const addCostForm = qs('add-cost-form');
  const existingItemSelect = qs('existing-item-select');
  const costPerKitInput = qs('cost-per-kit');
  const totalKitsBoughtInput = qs('total-kits-bought');
  const totalVialsPerKitInput = qs('total-vials-per-kit');
  const purchaseDateInput = qs('purchase-date');

  const costToolWrapper = qs('cost-tool-wrapper');
  const toggleCostToolBtn = qs('toggle-cost-tool-btn');
  const inventoryToolWrapper = qs('inventory-tool-wrapper');
  const toggleInventoryToolBtn = qs('toggle-inventory-tool-btn');
  const promoToolWrapper = qs('promo-tool-wrapper');
  const togglePromoToolBtn = qs('toggle-promo-tool-btn');
  const productionToolsSection = qs('production-tools-section');

  const TOOL_CONFIG = [
    { wrapper: costToolWrapper, button: toggleCostToolBtn, openLabel: 'Add Cost History', closeLabel: 'Add Cost History' },
    { wrapper: inventoryToolWrapper, button: toggleInventoryToolBtn, openLabel: 'Add Inventory', closeLabel: 'Add Inventory' },
    { wrapper: inventoryEditorWrapper, button: toggleEditItemToolBtn, openLabel: 'Edit Inventory', closeLabel: 'Edit Inventory' },
    { wrapper: promoToolWrapper, button: togglePromoToolBtn, openLabel: 'Promo Tool', closeLabel: 'Promo Tool' }
  ];

  function setToolOpen(tool, open){
    if(!tool || !tool.wrapper || !tool.button) return;
    if(open){
      tool.wrapper.classList.remove('hidden');
      tool.button.textContent = tool.closeLabel;
    }else{
      tool.wrapper.classList.add('hidden');
      tool.button.textContent = tool.openLabel;
    }
  }

  function closeAllTools(except){
    TOOL_CONFIG.forEach((tool)=>{
      if(tool === except) return;
      setToolOpen(tool,false);
    });
  }

  function normalizeLotTimestamp(entry){
    if(!entry) return new Date().toISOString().replace(/[^0-9]/g,'');
    const candidate = entry.timestamp ?? entry.purchaseDate ?? entry.date ?? entry.createdAt ?? entry.addedAt ?? entry.purchasedAt;
    if(!candidate) return new Date().toISOString().replace(/[^0-9]/g,'');
    if(typeof candidate === 'string'){
      const cleaned = candidate.replace(/[^0-9]/g,'');
      return cleaned || candidate;
    }
    if(typeof candidate === 'number') return String(Math.trunc(candidate));
    if(typeof candidate === 'object'){
      if(typeof candidate.toMillis === 'function') return String(candidate.toMillis());
      if(typeof candidate.seconds === 'number'){
        const millis = (candidate.seconds*1000) + (candidate.nanoseconds?candidate.nanoseconds/1e6:0);
        return String(Math.trunc(millis));
      }
    }
    return new Date().toISOString().replace(/[^0-9]/g,'');
  }

  function buildLotId(itemId, costHistory){
    const baseId = (itemId || '').toUpperCase();
    if(!Array.isArray(costHistory) || costHistory.length === 0){
      return `MG-${baseId}-${Date.now()}-1`;
    }
    const lastIndex = costHistory.length - 1;
    const lastEntry = costHistory[lastIndex] || {};
    const tsPart = normalizeLotTimestamp(lastEntry);
    const lotPosition = lastIndex + 1;
    return `MG-${baseId}-${tsPart}-${lotPosition}`;
  }

  function extractCoaUrl(raw){
    if(!raw) return '';
    if(typeof raw === 'string') return raw;
    if(typeof raw === 'object') return raw.url || '';
    return '';
  }

  function extractCoaLot(raw){
    if(!raw) return '';
    if(typeof raw === 'string') return '';
    if(typeof raw === 'object'){
      const lot = raw.lot;
      if(typeof lot === 'string') return lot;
    }
    return '';
  }

  function computeNextCoaLot(itemId){
    const costHistory = Array.isArray(inventoryCache[itemId]?.costHistory) ? inventoryCache[itemId].costHistory : [];
    const upperId = (itemId || '').toUpperCase();

    if(!costHistory.length){
      return buildLotId(itemId, costHistory);
    }

    const lastIndex = costHistory.length - 1;
    const timestamp = normalizeLotTimestamp(costHistory[lastIndex]);
    const lotPosition = lastIndex + 1;
    return `MG-${upperId}-${timestamp}-${lotPosition}`;
  }

  function ensureCoaStructure(itemId, item){
    const url = extractCoaUrl(item?.coa) || 'N/A';
    const lotExisting = (item?.coa && typeof item.coa === 'object') ? item.coa.lot : null;
    const lot = lotExisting || buildLotId(itemId, item?.costHistory);
    return { url, lot };
  }

  function updateDeprecateButton(item, forceDisabled = false){
    if(!editItemDeprecateBtn) return;
    const coaUrl = extractCoaUrl(item?.coa);
    const hasActiveCoa = Boolean(coaUrl && coaUrl !== 'N/A');
    const shouldDisable = forceDisabled || !hasActiveCoa;
    editItemDeprecateBtn.disabled = shouldDisable;
    editItemDeprecateBtn.classList.toggle('opacity-60', shouldDisable);
    editItemDeprecateBtn.classList.toggle('cursor-not-allowed', shouldDisable);
  }

  function setEditFormDisabled(disabled){
    const inputs = [
      editItemNameInput,
      editItemCurrentInventoryInput,
      editItemVialsSoldInput,
      editItemPriceInput,
      editItemTotalVialWeightInput,
      editItemImageInput,
      editItemCoaInput,
      editItemCoaLotInput,
      editItemDescriptionInput,
      editItemIsActiveInput,
      editItemBlendInput
    ];
    inputs.forEach((input)=>{
      if(!input) return;
      input.disabled = disabled;
    });
    if(editItemSaveBtn){
      editItemSaveBtn.disabled = disabled;
      editItemSaveBtn.classList.toggle('opacity-60', disabled);
      editItemSaveBtn.classList.toggle('cursor-not-allowed', disabled);
    }
    const currentItem = (!disabled && editItemSelect) ? inventoryCache[editItemSelect.value] : null;
    updateDeprecateButton(currentItem, disabled);
  }

  function resetEditItemForm(){
    if(editItemNameInput) editItemNameInput.value='';
    if(editItemCurrentInventoryInput) editItemCurrentInventoryInput.value='';
    if(editItemVialsSoldInput) editItemVialsSoldInput.value='';
    if(editItemPriceInput) editItemPriceInput.value='';
    if(editItemTotalVialWeightInput) editItemTotalVialWeightInput.value='';
    if(editItemImageInput) editItemImageInput.value='';
    if(editItemCoaInput) editItemCoaInput.value='';
    if(editItemCoaLotInput) editItemCoaLotInput.value='';
    if(editItemDescriptionInput) editItemDescriptionInput.value='';
    if(editItemIsActiveInput) editItemIsActiveInput.checked=false;
    if(editItemBlendInput) editItemBlendInput.checked=false;
    if(editItemDeprecateBtn){
      editItemDeprecateBtn.textContent = 'Deprecate';
    }
    setEditFormDisabled(true);
  }

  function loadSelectedInventoryForEdit(itemId){
    if(!itemId || !inventoryCache[itemId]){
      resetEditItemForm();
      return;
    }

    const inv = inventoryCache[itemId];
    setEditFormDisabled(false);

    const asNumber = (val, fallback = '') => {
      const num = Number(val);
      if(Number.isFinite(num)) return num;
      return fallback;
    };
    const cleanField = (val) => {
      if(typeof val === 'string' && val.trim().toUpperCase() === 'N/A') return '';
      return val ?? '';
    };

    if(editItemNameInput) editItemNameInput.value = inv.name ?? '';
    if(editItemCurrentInventoryInput) editItemCurrentInventoryInput.value = asNumber(inv.currentInventory, '');
    if(editItemVialsSoldInput) editItemVialsSoldInput.value = asNumber(inv.vialsSold, '');
    if(editItemPriceInput) editItemPriceInput.value = asNumber(inv.sellPricePerVial, '');
    if(editItemTotalVialWeightInput) editItemTotalVialWeightInput.value = asNumber(inv.totalVialWeight, '');
    if(editItemImageInput) editItemImageInput.value = cleanField(inv.image);
    if(editItemCoaInput) editItemCoaInput.value = cleanField(extractCoaUrl(inv.coa));
    if(editItemCoaLotInput) editItemCoaLotInput.value = cleanField(extractCoaLot(inv.coa));
    if(editItemDescriptionInput) editItemDescriptionInput.value = cleanField(inv.productDescription);
    if(editItemIsActiveInput) editItemIsActiveInput.checked = Boolean(inv.productIsActive);
    if(editItemBlendInput) editItemBlendInput.checked = Boolean(inv.blend);
    updateDeprecateButton(inv);
  }

  function showModal(message){ qs('modal-message').textContent = message; qs('alert-modal').classList.remove('hidden'); }
  function isValidEmail(e){ return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase()); }
  function copyToClipboard(text){
    const t=document.createElement('textarea');
    t.value=text;
    document.body.appendChild(t);
    t.select();
    let success=false;
    try{
      success=document.execCommand('copy');
      if(!success) throw new Error('Clipboard command rejected');
    }catch(e){
      showModal('Failed to copy.');
    }finally{
      document.body.removeChild(t);
    }
    return success;
  }
  function indicateCopy(btn){
    if(!btn) return;
    if(!btn.dataset.originalLabel){ btn.dataset.originalLabel = btn.textContent.trim(); }
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    if(btn._copyTimeout) clearTimeout(btn._copyTimeout);
    btn._copyTimeout = setTimeout(()=>{
      const label = btn.dataset.originalLabel || 'Copy';
      btn.textContent = label;
      btn.classList.remove('copied');
      btn._copyTimeout = null;
    }, 1200);
  }
  function formatTimestamp(ts){ if(!ts) return 'Unknown date'; try{ if(typeof ts.toDate==='function'){ return ts.toDate().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});} const d=new Date(ts); if(!isNaN(d.getTime())) return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}catch(_){} return 'Unknown date'; }
  function currency(n){ const num=typeof n==='number'?n:Number(n??0); return num.toFixed(2); }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  const CARRIERS = ["USPS","UPS","FedEx","DHL","Other"];
  function buildTrackingUrl(carrier, num){
    const n=(num||"").trim(); const c=(carrier||"").toLowerCase(); if(!n) return "";
    if(c==="usps") return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(n)}`;
    if(c==="ups") return `https://www.ups.com/track?loc=en_US&tracknum=${encodeURIComponent(n)}`;
    if(c==="fedex") return `https://www.fedex.com/fedextrack/?trknbr=${encodeURIComponent(n)}`;
    if(c==="dhl") return `https://www.dhl.com/us-en/home/tracking.html?tracking-id=${encodeURIComponent(n)}`;
    return `https://www.google.com/search?q=${encodeURIComponent((carrier||"tracking")+" "+n)}`;
  }

  let _trackingMemoryCache = [];
  function readTrackingFromModal(){ const hidden=qs('edit-order-tracking-hidden'); if(!hidden) return _trackingMemoryCache.slice(); try{ return JSON.parse(hidden.value||"[]"); }catch{ return []; } }
  function setTrackingHidden(arr){ const hidden=qs('edit-order-tracking-hidden'); _trackingMemoryCache=Array.isArray(arr)?arr.slice():[]; if(hidden) hidden.value=JSON.stringify(_trackingMemoryCache); }
  function renderTrackingList(arr){
    const list=qs('edit-order-tracking-list'); if(!list) return; list.innerHTML='';
    (arr||[]).forEach((t,idx)=>{ const url=t.url||buildTrackingUrl(t.carrier,t.number);
      const row=document.createElement('div'); row.className='flex items-center gap-2 p-2 border border-gray-700 rounded-md';
      row.innerHTML=`<span class="flex-1 text-gray-300 text-sm truncate"><span class="font-semibold">${t.carrier||'Carrier'}</span> — ${t.number||'—'}</span>
      <a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 text-xs">Open</a>
      <button type="button" class="btn-neon-red px-2 py-1 rounded-lg font-semibold text-xs" data-remove="${idx}">Remove</button>`;
      list.appendChild(row);
    });
    list.querySelectorAll('[data-remove]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.remove); const cur=readTrackingFromModal(); cur.splice(idx,1); setTrackingHidden(cur); renderTrackingList(cur);
      });
    });
  }

  function updateFinancialUI(){
    const profit = totalRevenue - totalCost;
    qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
    qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    qs('total-profit').textContent = `$${profit.toFixed(2)}`;
  }

  function updateUI(user){
    const status=qs('status');
    const userDisplay=qs('user-id-display');
    const mainContent=qs('main-content');
    const loginForm=qs('login-form');
    const signoutBtn=qs('signout-btn');

    if(user){
      userId=user.uid;
      if(status) status.textContent='Status: Signed in';
      if(userDisplay) userDisplay.textContent='User ID: '+userId;
      if(mainContent) mainContent.classList.remove('hidden');
      if(loginForm) loginForm.classList.add('hidden');
      if(signoutBtn) signoutBtn.classList.remove('hidden');
      TOOL_CONFIG.forEach((tool)=>{
        if(tool.button) tool.button.classList.remove('hidden');
        setToolOpen(tool,false);
      });
      if(productionToolsSection) productionToolsSection.classList.remove('hidden');
      listenForInventory(); listenForOrders();
    }else{
      userId=null;
      if(status) status.textContent='Status: Signed out';
      if(userDisplay) userDisplay.textContent='User ID: N/A';
      if(mainContent) mainContent.classList.add('hidden');
      if(loginForm) loginForm.classList.remove('hidden');
      if(signoutBtn) signoutBtn.classList.add('hidden');
      TOOL_CONFIG.forEach((tool)=>{
        setToolOpen(tool,false);
        if(tool.button) tool.button.classList.add('hidden');
      });
      if(productionToolsSection) productionToolsSection.classList.add('hidden');
      visibleOrdersCount = ORDERS_PAGE_SIZE;
      userAdjustedOrderView = false;
      orderSearchTerm = '';
      if(orderSearchInput) orderSearchInput.value='';
      sortedOrdersCache = [];
      updateLoadMoreVisibility(0);
    }
  }

  /* ============================
 * Inventory listener (RESTORED EDITING)
 * ============================ */
  /* ============================
 * Inventory listener (RESTORED EDITING + COST HISTORY SELECT BY ID)
 * ============================ */
function listenForInventory() {
  if (!userId) return;
  const ref = collection(db, INVENTORY_COLLECTION_PATH);

  onSnapshot(ref, (snap) => {
    const tbody = qs('inventory-list');
    if(tbody) tbody.innerHTML = '';

    const previousCostSelection = existingItemSelect ? (existingItemSelect.value || '') : '';
    const previousEditSelection = editItemSelect ? (editItemSelect.value || '') : '';

    if(existingItemSelect) existingItemSelect.innerHTML = '<option value="">-- Select an item --</option>';
    if(editItemSelect) editItemSelect.innerHTML = '<option value="">-- Select an item --</option>';

    if (snap.empty) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.setAttribute('colspan', '11');
      td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
      td.textContent = 'No inventory items.';
      tr.appendChild(td);
      if(tbody) tbody.appendChild(tr);
      resetEditItemForm();
      return;
    }

    totalCost = 0;
    inventoryCache = {};

    // Build fast lookup maps for order/inventory joins
    const inventoryById = {};
    const inventoryByNameLower = {};

    const docsMissingActiveFlag = [];
    const docsNeedingCoaUpgrade = [];

    snap.forEach((d) => {
      const item = d.data();
      const hasActiveFlag = typeof item.productIsActive === 'boolean';
      if (!hasActiveFlag) docsMissingActiveFlag.push(d.ref);
      const inv = { id: d.id, ...item, productIsActive: hasActiveFlag ? item.productIsActive : true };
      if (!item.coa || typeof item.coa !== 'object' || !('url' in item.coa)) {
        const newCoa = ensureCoaStructure(d.id, inv);
        inv.coa = newCoa;
        docsNeedingCoaUpgrade.push({ ref: d.ref, coa: newCoa });
      }
      inventoryCache[d.id] = inv;
      inventoryById[d.id] = inv;
      if (item.name) inventoryByNameLower[item.name.toLowerCase()] = inv;
    });

    if (docsMissingActiveFlag.length) {
      docsMissingActiveFlag.forEach((ref) => {
        updateDoc(ref, { productIsActive: true }).catch((err) => {
          console.error('Failed to backfill productIsActive flag:', err);
        });
      });
    }

    if (docsNeedingCoaUpgrade.length) {
      docsNeedingCoaUpgrade.forEach(({ ref, coa }) => {
        updateDoc(ref, { coa }).catch((err) => {
          console.error('Failed to upgrade COA structure:', err);
        });
      });
    }

    // helper available to the rest of the file:
    window._getInvFromOrderItem = function (it) {
      if (!it) return null;
      if (it.id && inventoryById[it.id]) return inventoryById[it.id];
      if (it.name && inventoryByNameLower[it.name.toLowerCase()]) return inventoryByNameLower[it.name.toLowerCase()];
      return null;
    };

    /* NEW: Populate the Cost History and Item Editor dropdowns with items by ID */
    const ids = Object.keys(inventoryById)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

    ids.forEach((id) => {
      const inv = inventoryById[id];
      const stock = Number.isFinite(inv?.currentInventory) ? inv.currentInventory : 0;

      if (existingItemSelect) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${id} — ${inv?.name || '(no name)'} (${stock} in stock)`;
        existingItemSelect.appendChild(opt);
      }

      if (editItemSelect) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${id} — ${inv?.name || '(no name)'}`;
        editItemSelect.appendChild(opt);
      }
    });

    if (existingItemSelect && previousCostSelection && ids.includes(previousCostSelection)) {
      existingItemSelect.value = previousCostSelection;
    }

    if (editItemSelect) {
      if (previousEditSelection && ids.includes(previousEditSelection)) {
        editItemSelect.value = previousEditSelection;
        loadSelectedInventoryForEdit(previousEditSelection);
      } else {
        editItemSelect.value = '';
        resetEditItemForm();
      }
    }

    // ===== Table render (unchanged) =====
    snap.forEach((d) => {
      const item = inventoryCache[d.id] || d.data();
      const tr = document.createElement('tr');
      tr.dataset.id = d.id;
      tr.className = 'hover:bg-gray-700 transition-colors duration-150';

      const nameTd = document.createElement('td');
      nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
      nameTd.textContent = item.name ?? '(no name)';
      nameTd.setAttribute('contenteditable', 'false');
      nameTd.dataset.field = 'name';

      const idTd = document.createElement('td');
      idTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      idTd.textContent = d.id; // show the Firestore doc id

      const activeTd = document.createElement('td');
      activeTd.className = 'px-6 py-4 whitespace-nowrap text-sm';
      const activeBtn = document.createElement('button');
      activeBtn.type = 'button';
      const setActiveVisual = (isActive) => {
        activeBtn.textContent = isActive ? 'Active' : 'Inactive';
        activeBtn.className = isActive
          ? 'px-3 py-1 rounded-lg text-xs font-semibold btn-neon-lime'
          : 'px-3 py-1 rounded-lg text-xs font-semibold btn-neon-red';
      };
      setActiveVisual(Boolean(item.productIsActive));
      activeBtn.addEventListener('click', async () => {
        const docId = tr.dataset.id;
        const current = Boolean(inventoryCache[docId]?.productIsActive);
        const next = !current;
        activeBtn.disabled = true;
        try {
          await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, docId), { productIsActive: next });
          if (inventoryCache[docId]) inventoryCache[docId].productIsActive = next;
          setActiveVisual(next);
          showModal(`Marked ${item.name || docId} as ${next ? 'active' : 'inactive'}.`);
        } catch (err) {
          console.error('Error updating productIsActive:', err);
          showModal('Failed to update product status.');
          setActiveVisual(current);
        } finally {
          activeBtn.disabled = false;
        }
      });
      activeTd.appendChild(activeBtn);

      const inventoryTd = document.createElement('td');
      inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      inventoryTd.textContent = item.currentInventory ?? 0;
      inventoryTd.setAttribute('contenteditable', 'false');
      inventoryTd.dataset.field = 'currentInventory';

      const vialsSoldTd = document.createElement('td');
      vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      vialsSoldTd.textContent = item.vialsSold ?? 0;
      vialsSoldTd.setAttribute('contenteditable', 'false');
      vialsSoldTd.dataset.field = 'vialsSold';

      const priceTd = document.createElement('td');
      priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
      priceTd.setAttribute('contenteditable', 'false');
      priceTd.dataset.field = 'sellPricePerVial';

      const totalVialWeightTd = document.createElement('td');
      totalVialWeightTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      totalVialWeightTd.textContent = item.totalVialWeight ?? 0;
      totalVialWeightTd.setAttribute('contenteditable', 'false');
      totalVialWeightTd.dataset.field = 'totalVialWeight';

      tr.appendChild(nameTd);
      tr.appendChild(idTd);
      tr.appendChild(inventoryTd);
      tr.appendChild(vialsSoldTd);
      tr.appendChild(priceTd);
      tr.appendChild(totalVialWeightTd);
      tr.appendChild(activeTd);
      tbody.appendChild(tr);

      if (Array.isArray(item.costHistory)) {
        totalCost += item.costHistory.reduce((sum, h) => sum + ((h.costPerKit || 0) * (h.totalKitsBought || 0)), 0);
      }
    });

    updateFinancialUI();
  }, (error) => {
    console.error('Error listening to inventory:', error);
    const tbody = qs('inventory-list');
    tbody.innerHTML = '';
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.setAttribute('colspan', '11');
    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
    td.textContent = 'Error loading inventory.';
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}


  

  /* vialsSold adjustments on status changes (keep) */
  async function updateInventorySalesImpact(orderId,type,items){
    if(!items || items.length===0) return;
    for(const it of items){
      const inv=window._getInvFromOrderItem(it); if(!inv) continue;
      const qty=Number(it.quantity||0); const sign=(type==='increment')?1:-1;
      try{
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), { vialsSold: increment(sign*qty) });
      }catch(err){ console.error(`Error updating vialsSold for ${inv.id}:`,err); showModal(`Error updating vialsSold for an item in order ${orderId}.`); }
    }
  }

  async function compareOrderItemsAndUpdateVials(prevItems,currentItems){
    const changes=new Map();
    for(const it of prevItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)-Number(it.quantity||0)); }
    for(const it of currentItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)+Number(it.quantity||0)); }
    const ops=[]; for(const [invId,delta] of changes.entries()){ if(!delta) continue; ops.push(updateDoc(doc(db, INVENTORY_COLLECTION_PATH, invId),{ vialsSold: increment(delta) })); }
    await Promise.all(ops);
  }

  /* Orders listener */
  function listenForOrders(){
    const ordersContainer=qs('orders-container'); const loading=qs('loading-orders'); const ref=collection(db, ORDERS_COLLECTION_PATH);
    onSnapshot(ref, async (snap)=>{
      // Handle modifications only (no added/removed side-effects & no extra fields)
      for(const change of snap.docChanges()){
        const id=change.doc.id; const currentOrder={ id, ...change.doc.data() };
        if(change.doc.metadata.hasPendingWrites){ previousOrdersCache.set(id,currentOrder); continue; }
        if(change.type==='modified'){
          const prev=previousOrdersCache.get(id); if(!prev){ previousOrdersCache.set(id,currentOrder); continue; }
          const key=transitionKey(prev,currentOrder); if(processedTransitions.has(key)){ previousOrdersCache.set(id,currentOrder); continue; }
          processedTransitions.add(key);

          const wasPaid = prev.paymentStatus==='Paid';
          const isPaid  = currentOrder.paymentStatus==='Paid';
          const wasUnpaid = prev.paymentStatus==='Unpaid';
          const isUnpaid  = currentOrder.paymentStatus==='Unpaid';

          // if(wasUnpaid && isPaid)       updateInventorySalesImpact(currentOrder.id,'increment',currentOrder.items);
          // else if(wasPaid && isUnpaid)  updateInventorySalesImpact(currentOrder.id,'decrement',currentOrder.items);
          // else if(wasPaid && isPaid){
          //   const p=JSON.stringify(prev.items||[]), c=JSON.stringify(currentOrder.items||[]);
          //   if(p!==c) compareOrderItemsAndUpdateVials(prev.items||[], currentOrder.items||[]);
          // }
          previousOrdersCache.set(id,currentOrder);
        } else if(change.type==='added'){
          previousOrdersCache.set(id,currentOrder);
        }
      }
      if(processedTransitions.size>1000) processedTransitions.clear();

      // Rebuild UI
      loading.style.display='none';
      if(snap.empty){
        ordersContainer.innerHTML=`<div class="text-center text-gray-500 py-12"><p class="text-lg">No orders found.</p><p class="text-sm mt-2">Your orders will appear here once they've been placed.</p></div>`;
        allOrdersCache=[]; totalRevenue=0; previousOrdersCache.clear();
        sortedOrdersCache=[];
        visibleOrdersCount = ORDERS_PAGE_SIZE;
        userAdjustedOrderView = false;
        updateFinancialUI(); renderInfographics(); updateLoadMoreVisibility(0); return;
      }

      allOrdersCache=snap.docs.map(d=>({ id:d.id, ...d.data() }));
      previousOrdersCache.clear(); snap.docs.forEach(d=>previousOrdersCache.set(d.id,{ id:d.id, ...d.data() }));

      const sorted=[...allOrdersCache].sort((a,b)=>{ const A=a.timestamp?.toMillis?.()??0; const B=b.timestamp?.toMillis?.()??0; return B-A; });

      totalRevenue = sorted.reduce((sum, order)=>{
        const items=Array.isArray(order.items)?order.items:[];
        const computed = items.reduce((s,it)=>s + (Number(it?.unitPrice||0)*Number(it?.quantity||1)),0);
        if(order.paymentStatus==='Paid'){ return sum + Number(order.total || computed); }
        return sum;
      },0);

      updateFinancialUI(); renderInfographics();

      sortedOrdersCache = sorted;
      if(!userAdjustedOrderView){
        visibleOrdersCount = Math.min(sortedOrdersCache.length, ORDERS_PAGE_SIZE);
      }
      if(sortedOrdersCache.length === 0){
        visibleOrdersCount = ORDERS_PAGE_SIZE;
      } else if(visibleOrdersCount > sortedOrdersCache.length){
        visibleOrdersCount = sortedOrdersCache.length;
      }

      renderOrdersList(sortedOrdersCache);
    },(err)=>{
      console.error('Error listening to orders:',err);
      const ordersContainer=qs('orders-container'); const loading=qs('loading-orders');
      loading.style.display='none';
      ordersContainer.innerHTML = `<div class="text-center text-red-500 py-12"><p class="text-lg">An error occurred.</p><p class="text-sm mt-2">Check the console for more details.</p></div>`;
      updateLoadMoreVisibility(0);
    });
  }

  function renderInfographics(){
    const placeholder=qs('infographic-placeholder');
    const m=qs('list-monthly-revenue'), c=qs('list-top-customers'), pr=qs('list-top-products-revenue'), pq=qs('list-top-products-quantity');
    m.innerHTML=''; c.innerHTML=''; pr.innerHTML=''; pq.innerHTML='';
    if(allOrdersCache.length===0){ placeholder.classList.remove('hidden'); return; }
    placeholder.classList.add('hidden');

    const monthly={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.timestamp){ const mo=o.timestamp.toDate().toLocaleString('en-US',{month:'short',year:'2-digit'}); monthly[mo]=(monthly[mo]||0)+(o.total||0);} });
    Object.keys(monthly).sort((a,b)=>{ const [ma,ya]=a.split(' '), [mb,yb]=b.split(' '); return new Date(`01 ${ma} 20${ya}`)-new Date(`01 ${mb} 20${yb}`); }).forEach(month=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${month}</span><span class="font-bold text-cyan-300">$${currency(monthly[month])}</span>`; m.appendChild(li);
    });

    const cust={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.contactInfo?.fullName){ const n=o.contactInfo.fullName; cust[n]=(cust[n]||0)+(o.total||0);} });
    Object.entries(cust).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; c.appendChild(li);
    });

    const prodRev={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodRev[name]=(prodRev[name]||0)+((it.unitPrice||0)*(it.quantity||0)); }); } });
    Object.entries(prodRev).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; pr.appendChild(li);
    });

    const prodQty={}; allOrdersCache.forEach(o=>{ if(o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodQty[name]=(prodQty[name]||0)+(it.quantity||0); }); } });
    Object.entries(prodQty).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,q])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">${q} sold</span>`; pq.appendChild(li);
    });
  }

  function updateLoadMoreVisibility(total){
    if(!ordersPagination || !loadMoreOrdersBtn) return;
    if(total === 0 || visibleOrdersCount >= total){
      ordersPagination.classList.add('hidden');
    }else{
      ordersPagination.classList.remove('hidden');
    }
  }

  function getNormalizedOrderSearchTerm(){
    return orderSearchTerm.trim().toLowerCase();
  }

  function orderMatchesSearch(order, normalizedTerm, normalizedDigits){
    if(!normalizedTerm) return true;
    const idPart = String(order?.orderId ?? order?.id ?? '').toLowerCase();
    const namePart = String(order?.contactInfo?.fullName ?? '').toLowerCase();
    const phoneRaw = String(order?.contactInfo?.phone ?? '');
    const phonePart = phoneRaw.toLowerCase();
    if(idPart.includes(normalizedTerm) || namePart.includes(normalizedTerm) || phonePart.includes(normalizedTerm)) return true;
    if(!normalizedDigits) return false;
    const phoneDigits = phoneRaw.replace(/[^0-9]/g,'');
    return phoneDigits.includes(normalizedDigits);
  }

  function filterOrders(baseOrders){
    const list = Array.isArray(baseOrders) ? baseOrders : [];
    const normalizedTerm = getNormalizedOrderSearchTerm();
    if(!normalizedTerm) return list;
    const normalizedDigits = normalizedTerm.replace(/[^0-9]/g,'');
    return list.filter(order => orderMatchesSearch(order, normalizedTerm, normalizedDigits));
  }

  function renderOrdersList(sortedOrders){
    const ordersContainer=qs('orders-container');
    if(!ordersContainer) return;
    ordersContainer.innerHTML='';
    const loading=qs('loading-orders');
    if(loading) loading.style.display='none';

    const filteredOrders = filterOrders(sortedOrders);
    if(filteredOrders.length === 0){
      const trimmedTerm = orderSearchTerm.trim();
      const headline = trimmedTerm
        ? `No orders match "${escapeHtml(trimmedTerm)}".`
        : 'No orders found.';
      const detail = trimmedTerm
        ? 'Try a different name, order ID, or phone number.'
        : 'Your orders will appear here once they have been placed.';
      ordersContainer.innerHTML=`<div class="text-center text-gray-500 py-12"><p class="text-lg">${headline}</p><p class="text-sm mt-2">${detail}</p></div>`;
      updateLoadMoreVisibility(0);
      return;
    }

    if(visibleOrdersCount <= 0){
      visibleOrdersCount = Math.min(filteredOrders.length, ORDERS_PAGE_SIZE);
    }

    const subset = filteredOrders.slice(0, Math.max(0, visibleOrdersCount));

    subset.forEach(order=>{
      const timestamp=formatTimestamp(order.timestamp);
      const items=Array.isArray(order.items)?order.items:[];
      const itemsList = items.map(item=>{
        const label = item.id || item.name || 'Item';
        const price = currency(item?.unitPrice ?? 0);
        const quantity = item?.quantity ?? 1;
        return `<li class="flex justify-between items-center mb-1"><span class="text-gray-400">${label} (x${quantity})</span><span class="font-medium text-cyan-300">$${price}</span></li>`;
      }).join('');

      const computed = items.reduce((s,it)=>s + (Number(it?.unitPrice||0)*Number(it?.quantity||1)),0);
      const totalSafe = (order.total!=null)?currency(order.total):currency(computed);
      const discountedSubtotal = Number(order.subtotal ?? computed);
      const shippingCostSafe = Number(order.shippingCost ?? 0);
      const hasFreeShip = shippingCostSafe===0 && (order.promo?.type==='free_shipping');
      const paymentDetails = (()=>{
        const payment = order.payment || {};
        const meta = payment.meta || {};
        const methodRaw = payment.method || payment.type || meta.type || order.paymentType || order.paymentMethod || order.payment_method;
        const venmoUser = payment.venmoUser || meta.venmoUser;
        const txid = payment.txid || payment.transactionId || payment.txId || meta.txid || meta.transactionId || meta.txId;
        const method = methodRaw ? String(methodRaw) : '';
        const methodLower = method.toLowerCase();

        if(methodLower.includes('venmo')){
          const label = venmoUser ? `${method} (${venmoUser})` : (method || 'Venmo');
          return { label, txid: '' };
        }

        if(methodLower.includes('bitcoin') || methodLower==='btc'){
          const label = method || 'Bitcoin';
          return { label, txid: txid ? String(txid) : '' };
        }

        if(venmoUser && method) return { label: `${method} (${venmoUser})`, txid: '' };
        if(method) return { label: method, txid: '' };
        if(venmoUser) return { label: venmoUser, txid: '' };
        return { label: 'Not specified', txid: '' };
      })();
      const promoCodeRaw = (() => {
        const promo = order.promo;
        if(typeof promo === 'string') return promo;
        if(promo && typeof promo === 'object'){
          if(promo.code) return promo.code;
          if(promo.id) return promo.id;
          if(promo.key) return promo.key;
          if(promo.label) return promo.label;
          if(promo.name) return promo.name;
        }
        return order.promoCode || order.promo_code || order.discountCode || order.discount_code || '';
      })();
      const promoCodeDisplay = promoCodeRaw ? String(promoCodeRaw).trim() : '';
      const itemDiscount = Math.max(0, computed - discountedSubtotal);
      const status=order.paymentStatus||'Unknown';
      const statusClass = status==='Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';
      const contact=order.contactInfo||{};
      const contactEntries=[
        { label:'Name', value: contact.fullName },
        { label:'Email', value: contact.email },
        { label:'Phone', value: contact.phone },
        { label:'Address', value: contact.shippingAddress }
      ];
      const contactHtml = contactEntries.map(({label,value})=>{
        const raw = (value ?? '').toString();
        const hasValue = raw.trim().length>0;
        const display = hasValue ? raw : 'Not Provided';
        const displayHtml = hasValue ? display.replace(/\n/g,'<br>') : display;
        const copyAttr = hasValue ? ` data-copy="${encodeURIComponent(raw)}"` : '';
        const copyBtn = hasValue ? `<button type="button" class="copy-contact btn-neon-cyan px-2 py-0.5 rounded text-xs font-semibold shrink-0"${copyAttr}>Copy</button>` : '';
        const valueMarkup = `<span class="text-gray-300 break-words grow">${displayHtml}</span>`;
        return `<div class="flex flex-wrap items-start gap-2"><span class="font-medium text-gray-500">${label}:</span><div class="flex items-start gap-2 min-w-0 flex-1">${valueMarkup}${copyBtn}</div></div>`;
      }).join('');
      const orderIdText=order.orderId || order.id;
      const tracking=Array.isArray(order.tracking)?order.tracking:[];
      const trackingHtml = tracking.length
        ? tracking.map(t=>{
            const url=t.url||buildTrackingUrl(t.carrier,t.number);
            const label=`${t.carrier||"Carrier"}: ${t.number||"—"}`;
            const numberAttr = t.number||"";
            return `<div class="flex flex-wrap items-center gap-2 text-xs">
              <a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 hover:text-cyan-200">${label}</a>
              <button type="button" class="btn-neon-cyan px-2 py-0.5 rounded copy-track" data-track="${numberAttr}">Copy</button>
              <button type="button" class="btn-neon-lime px-2 py-0.5 rounded send-tracking-email-btn" data-order-id="${order.id}" data-track="${numberAttr}">Send Email</button>
            </div>`;
          }).join("")
        : `<span class="text-gray-500 text-xs italic">No tracking added yet</span>`;

      const card=`
      <div class="order-card rounded-xl p-6 shadow-md border border-gray-700 relative">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start border-b pb-4 mb-4 border-gray-700">
          <div>
            <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
              <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
            </h3>
            <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
          </div>
          <div class="mt-4 sm:mt-0 text-left sm:text-right">
            <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
            <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${status}</span>
            <div class="mt-2 text-xs text-gray-400 space-y-1">
              <div><span class="text-gray-500">Subtotal:</span> $${currency(discountedSubtotal)}</div>
              ${itemDiscount>0?`<div><span class="text-gray-500">Items discount:</span> <span class="text-green-300 font-semibold">-$${currency(itemDiscount)}</span></div>`:``}
              <div><span class="text-gray-500">Shipping:</span> ${hasFreeShip?`<span class="text-green-300 font-semibold">FREE</span>`:`$${currency(shippingCostSafe)}`}</div>
              <div>
                <span class="text-gray-500">Payment Type:</span> <span class="text-gray-300">${paymentDetails.label}</span>
                ${paymentDetails.txid ? `<div class="text-gray-500 text-xs mt-1 pl-4">TXID: <span class="text-gray-300">${paymentDetails.txid}</span></div>` : ''}
                ${promoCodeDisplay ? `<div class="text-gray-500 text-xs mt-1 pl-4">Promo Code: <span class="text-gray-300">${escapeHtml(promoCodeDisplay)}</span></div>` : ''}
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
          <ul class="list-none space-y-2 text-sm">${itemsList || '<li class="text-gray-500 italic">No items.</li>'}</ul>
        </div>

        <div>
          <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
          <div class="text-sm text-gray-500 space-y-1">
            ${contactHtml}
          </div>
        </div>

        <div class="mt-4">
          <p class="font-semibold text-gray-400 mb-2">Tracking:</p>
          <div class="space-y-1">${trackingHtml}</div>
        </div>

      <div class="pt-10 bottom-4 right-4 flex space-x-2 items-end space-y-2">
        <button class="delete-order-card-btn btn-neon-red text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Delete
        </button>
        <button class="edit-order-btn btn-neon-lime text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Edit Order
        </button>
        <button class="resend-order-btn btn-neon-cyan text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
          Resend Email
        </button>
      </div>

      </div>`;
      ordersContainer.insertAdjacentHTML('beforeend', card);
      const last=ordersContainer.lastElementChild;
      last.querySelectorAll('.copy-track').forEach(btn=>btn.addEventListener('click',()=>{
        const v=btn.dataset.track||"";
        if(!v) return;
        if(copyToClipboard(v)) indicateCopy(btn);
      }));
      last.querySelectorAll('.copy-contact').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const encoded=btn.dataset.copy||'';
          if(!encoded) return;
          const text=decodeURIComponent(encoded);
          if(text && copyToClipboard(text)) indicateCopy(btn);
        });
      });
    });

    updateLoadMoreVisibility(filteredOrders.length);
  }

  if(loadMoreOrdersBtn){
    loadMoreOrdersBtn.addEventListener('click',()=>{
      const filtered = filterOrders(sortedOrdersCache);
      if(filtered.length===0) return;
      visibleOrdersCount = Math.min(visibleOrdersCount + ORDERS_PAGE_SIZE, filtered.length);
      userAdjustedOrderView = true;
      renderOrdersList(sortedOrdersCache);
    });
  }

  if(orderSearchInput){
    const handleOrderSearch = () => {
      orderSearchTerm = orderSearchInput.value || '';
      visibleOrdersCount = ORDERS_PAGE_SIZE;
      renderOrdersList(sortedOrdersCache);
    };
    orderSearchInput.addEventListener('input', handleOrderSearch);
    orderSearchInput.addEventListener('search', handleOrderSearch);
  }

  /* Read-only order item element */
  function createOrderItemElement(item){
    const wrap=document.createElement('div');
    wrap.className='edit-order-item flex items-center gap-2 p-2 border border-gray-700 rounded-md';
    const label=item.id || item.name || 'Unknown Item';
    const nameSpan=document.createElement('span'); nameSpan.textContent=label; nameSpan.className='flex-1 text-gray-300 text-sm font-semibold truncate';
    const qtySpan=document.createElement('span'); qtySpan.className='text-gray-400 text-sm'; qtySpan.textContent=`Qty: ${item.quantity || 0}`;
    const priceSpan=document.createElement('span'); priceSpan.className='text-cyan-300 text-sm font-semibold'; priceSpan.textContent=`$${currency(item.unitPrice||0)}`;
    wrap.appendChild(nameSpan); wrap.appendChild(qtySpan); wrap.appendChild(priceSpan);
    // keep minimal datasets (no code)
    wrap.dataset.itemName = item.name || '';
    wrap.dataset.itemId   = item.id   || '';
    return wrap;
  }

  function openEditModal(orderData){
    qs('edit-order-id').value = orderData.id;
    qs('edit-contact-name').value = orderData.contactInfo?.fullName || '';
    qs('edit-order-total').value = orderData.total ?? 0;
    qs('edit-order-status').value = orderData.paymentStatus ?? 'Unpaid';
    const shippingCost = Number(orderData?.shippingCost ?? 0);
    const freeShip = (orderData?.promo?.type === 'free_shipping') || shippingCost === 0;
    const shipEl = document.getElementById('edit-shipping-display'); shipEl.textContent = freeShip ? 'FREE' : `$${currency(shippingCost)}`;

    const cont=qs('edit-order-items-list'); cont.innerHTML='';
    (orderData.items||[]).forEach(item=>cont.appendChild(createOrderItemElement(item)));

    const trackingArr = Array.isArray(orderData.tracking) ? orderData.tracking : [];
    setTrackingHidden(trackingArr); renderTrackingList(trackingArr);

    editOrderModal.classList.remove('hidden'); editOrderBackdrop.classList.remove('hidden');
    editOrderModal.classList.add('is-open'); editOrderBackdrop.classList.add('is-open');
  }
  function closeEditModal(){ editOrderModal.classList.remove('is-open'); editOrderBackdrop.classList.remove('is-open'); setTimeout(()=>{ editOrderModal.classList.add('hidden'); editOrderBackdrop.classList.add('hidden'); },300); }

  function handleAddTrackingEntry(){
    const carrierSel=qs('edit-track-carrier'); const numberInp=qs('edit-track-number');
    if(!carrierSel||!numberInp){ showModal('Tracking UI is not available in this view.'); return; }
    const carrier=carrierSel.value.trim(); const number=numberInp.value.trim();
    if(!carrier||!number){ showModal('Please select a carrier and enter a tracking number.'); return; }
    const t={ carrier, number, url:buildTrackingUrl(carrier,number), addedAt:new Date().toISOString() };
    const cur=readTrackingFromModal(); cur.push(t); setTrackingHidden(cur); renderTrackingList(cur); numberInp.value='';
  }

  // Save: only status, customer name, total (if changed), tracking; NO item changes, NO extra snapshot fields
  async function handleEditOrder(e){
    e.preventDefault();
    const orderId=qs('edit-order-id').value;
    const paymentStatus=qs('edit-order-status').value;
    const newCustomerName=qs('edit-contact-name').value.trim();
    const newTotal = Number(qs('edit-order-total').value || 0);

    if(!newCustomerName){ showModal('Customer name cannot be empty.'); return; }

    const existing = allOrdersCache.find(o=>o.id===orderId) || {};
    const existingShipping = Number(existing.shippingCost ?? 0);
    const newTracking = readTrackingFromModal ? readTrackingFromModal() : (existing.tracking || []);

    try{
      const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
      await updateDoc(orderRef, {
        paymentStatus,
        'contactInfo.fullName': newCustomerName,
        total: Number.isFinite(newTotal)? newTotal : existing.total,
        shippingCost: existingShipping,   // preserve
        tracking: newTracking             // keep shipping feature (tracking)
        // NOTE: intentionally not touching items, subtotal, promo, or any extra fields
      });
      showModal('Order updated successfully!');
      closeEditModal();
    }catch(err){
      console.error('Error updating order:',err);
      showModal(`Failed to update order: ${err.message}`);
    }
  }

  /* Add Inventory Item */
  async function handleAddItem(e){
    e.preventDefault();
    const name=newItemNameInput.value.trim();
    const id=newItemIdInput.value.trim();
    const blend=newItemBlendInput.checked;
    const productIsActive=newItemIsActiveInput.checked;
    const currentInventory=parseInt(newTotalKitsBoughtInput.value,10)*parseInt(newTotalVialsPerKitInput.value,10);
    const sellPricePerVial=parseFloat(newItemPriceInput.value);
    const totalVialWeight=parseFloat(newItemTotalVialWeightInput.value);
    const image=newItemImageInput.value.trim();
    const coa=newItemCoaInput.value.trim();
    const description=newItemDescriptionInput.value.trim();
    const vialsSold=parseInt(newItemVialsSoldInput.value,10);

    const costPerKit=parseFloat(newCostPerKitInput.value);
    const totalKitsBought=parseInt(newTotalKitsBoughtInput.value,10);
    const totalVialsPerKit=parseInt(newTotalVialsPerKitInput.value,10);
    const purchaseDate=newPurchaseDateInput.value;

    if(!name || !id){ showModal('Item Name and ID are required.'); return; }
    if(isNaN(currentInventory)||currentInventory<0){ showModal('Initial Inventory must be a non-negative number.'); return; }
    if(isNaN(sellPricePerVial)||sellPricePerVial<0){ showModal('Sell Price must be a non-negative number.'); return; }
    if(isNaN(totalVialWeight)||totalVialWeight<0){ showModal('Total Vial Weight must be a non-negative number.'); return; }
    if(isNaN(vialsSold)||vialsSold<0){ showModal('Vials Sold must be a non-negative number.'); return; }
    if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
    if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
    if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials Per Kit must be a non-negative number.'); return; }
    if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

    const newCostEntry = { costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
    const newItemCoa = { url: coa || 'N/A', lot: buildLotId(id, [newCostEntry]) };
    const newItem = { name, blend, productIsActive, productDescription: description || 'N/A', currentInventory, sellPricePerVial, totalVialWeight, image: image||'N/A', coa: newItemCoa, vialsSold, costHistory:[newCostEntry] };

    try{
      const itemRef = doc(db, INVENTORY_COLLECTION_PATH, id); // write at ID; no code field
      await setDoc(itemRef, newItem);
      showModal('New item added to inventory successfully!');
      addItemForm.reset();
    }catch(err){
      console.error('Error adding new item:',err);
      showModal(`Failed to add new item: ${err.message}`);
    }
  }

  async function handleEditInventoryItem(e){
    e.preventDefault();
    if(!editItemSelect){ showModal('Item selector not available.'); return; }

    const itemId = editItemSelect.value;
    if(!itemId){ showModal('Select an item to edit.'); return; }

    const original = inventoryCache[itemId];
    if(!original){
      showModal('Selected item is no longer available.');
      resetEditItemForm();
      return;
    }

    const name = (editItemNameInput?.value || '').trim();
    const currentInventoryVal = editItemCurrentInventoryInput?.value ?? '';
    const vialsSoldVal = editItemVialsSoldInput?.value ?? '';
    const priceVal = editItemPriceInput?.value ?? '';
    const totalWeightVal = editItemTotalVialWeightInput?.value ?? '';
    const image = (editItemImageInput?.value || '').trim();
    const coaInputValue = (editItemCoaInput?.value || '').trim();
    const coaLotInputValue = (editItemCoaLotInput?.value || '').trim();
    const description = (editItemDescriptionInput?.value || '').trim();
    const productIsActive = Boolean(editItemIsActiveInput?.checked);
    const blend = Boolean(editItemBlendInput?.checked);

    if(!name){ showModal('Item name cannot be empty.'); return; }

    const toNumber = (val) => {
      const num = Number(val);
      return Number.isFinite(num) ? num : NaN;
    };

    const currentInventory = toNumber(currentInventoryVal);
    const vialsSold = toNumber(vialsSoldVal);
    const sellPricePerVial = toNumber(priceVal);
    const totalVialWeight = toNumber(totalWeightVal);

    if(Number.isNaN(currentInventory) || currentInventory < 0){ showModal('Current inventory must be a non-negative number.'); return; }
    if(Number.isNaN(vialsSold) || vialsSold < 0){ showModal('Vials sold must be a non-negative number.'); return; }
    if(Number.isNaN(sellPricePerVial) || sellPricePerVial < 0){ showModal('Sell price must be a non-negative number.'); return; }
    if(Number.isNaN(totalVialWeight) || totalVialWeight < 0){ showModal('Total vial weight must be a non-negative number.'); return; }

    const normalized = {
      image: image || 'N/A',
      description: description || 'N/A'
    };
    const normalizedCoaUrl = coaInputValue || 'N/A';
    const sanitizeNa = (val) => {
      const str = (val ?? '').trim();
      if(!str) return 'N/A';
      return str.toUpperCase() === 'N/A' ? 'N/A' : str;
    };

    const existingCoaUrl = extractCoaUrl(original.coa) || 'N/A';
    const existingCoaLot = sanitizeNa(extractCoaLot(original.coa));

    let normalizedCoaLot = coaLotInputValue;
    if(!normalizedCoaLot){
      normalizedCoaLot = existingCoaLot !== 'N/A' ? existingCoaLot : '';
    }
    if(!normalizedCoaLot && normalizedCoaUrl !== existingCoaUrl && normalizedCoaUrl !== 'N/A'){
      normalizedCoaLot = buildLotId(itemId, inventoryCache[itemId]?.costHistory || []);
    }
    normalizedCoaLot = sanitizeNa(normalizedCoaLot);

    const numOrZero = (val) => {
      const num = Number(val);
      return Number.isFinite(num) ? num : 0;
    };

    const updateData = {};
    if(name !== (original.name ?? '')) updateData.name = name;
    if(currentInventory !== numOrZero(original.currentInventory)) updateData.currentInventory = currentInventory;
    if(vialsSold !== numOrZero(original.vialsSold)) updateData.vialsSold = vialsSold;
    if(sellPricePerVial !== numOrZero(original.sellPricePerVial)) updateData.sellPricePerVial = sellPricePerVial;
    if(totalVialWeight !== numOrZero(original.totalVialWeight)) updateData.totalVialWeight = totalVialWeight;
    if(productIsActive !== Boolean(original.productIsActive)) updateData.productIsActive = productIsActive;
    if(blend !== Boolean(original.blend)) updateData.blend = blend;

    const existingImage = (original.image && original.image !== 'N/A') ? original.image : 'N/A';
    if(normalized.image !== existingImage) updateData.image = normalized.image;

    const lotChanged = normalizedCoaLot !== existingCoaLot;
    if(normalizedCoaUrl !== existingCoaUrl || lotChanged){
      updateData.coa = { url: normalizedCoaUrl, lot: normalizedCoaLot };
    }

    const existingDescription = (original.productDescription && original.productDescription !== 'N/A') ? original.productDescription : 'N/A';
    if(normalized.description !== existingDescription) updateData.productDescription = normalized.description;

    if(Object.keys(updateData).length === 0){
      showModal('No changes to save.');
      return;
    }

    const docRef = doc(db, INVENTORY_COLLECTION_PATH, itemId);
    const originalLabel = editItemSaveBtn?.textContent;
    if(editItemSaveBtn){
      editItemSaveBtn.disabled = true;
      editItemSaveBtn.textContent = 'Saving...';
      editItemSaveBtn.classList.add('opacity-60','cursor-not-allowed');
    }

    try{
      await updateDoc(docRef, updateData);
      if(inventoryCache[itemId]) Object.assign(inventoryCache[itemId], updateData);
      showModal('Item updated successfully.');
      loadSelectedInventoryForEdit(itemId);
    }catch(err){
      console.error('Error updating inventory item:', err);
      showModal(`Failed to update item: ${err.message || 'Check console for details.'}`);
    }finally{
      if(editItemSaveBtn){
        editItemSaveBtn.disabled = false;
        editItemSaveBtn.textContent = originalLabel || 'Save Changes';
        editItemSaveBtn.classList.remove('cursor-not-allowed');
        editItemSaveBtn.classList.toggle('opacity-60', !editItemSelect.value);
      }
    }
  }

  async function handleDeprecateCurrentCoa(){
    if(!editItemSelect){ showModal('Item selector not available.'); return; }
    const itemId = editItemSelect.value;
    if(!itemId){ showModal('Select an item to edit before deprecating its COA.'); return; }

    const original = inventoryCache[itemId];
    if(!original){
      showModal('Selected item is no longer available.');
      resetEditItemForm();
      return;
    }

    const currentUrl = extractCoaUrl(original.coa);
    if(!currentUrl || currentUrl === 'N/A'){
      showModal('No COA URL to deprecate for this item.');
      updateDeprecateButton(original);
      return;
    }
    const currentLot = (typeof original.coa === 'object' && typeof original.coa.lot === 'string') ? original.coa.lot : '';
    const costHistoryForLot = Array.isArray(original.costHistory) ? original.costHistory : [];
    const archivedLot = currentLot || buildLotId(itemId, costHistoryForLot);
    const entry = { lot: archivedLot, url: currentUrl };
    const docRef = doc(db, INVENTORY_COLLECTION_PATH, itemId);

    const restoreLabel = editItemDeprecateBtn?.textContent;
    if(editItemDeprecateBtn){
      editItemDeprecateBtn.disabled = true;
      editItemDeprecateBtn.textContent = 'Deprecating...';
      editItemDeprecateBtn.classList.add('opacity-60','cursor-not-allowed');
    }

    try{
      const nextLot = computeNextCoaLot(itemId);
      const clearedCoa = { url: '', lot: nextLot };

      await updateDoc(docRef, {
        pastCoas: arrayUnion(entry),
        coa: clearedCoa
      });

      if(inventoryCache[itemId]){
        inventoryCache[itemId].coa = clearedCoa;
        const past = Array.isArray(inventoryCache[itemId].pastCoas) ? inventoryCache[itemId].pastCoas.slice() : [];
        past.push(entry);
        inventoryCache[itemId].pastCoas = past;
      }

      if(editItemCoaInput) editItemCoaInput.value = '';
      if(editItemCoaLotInput) editItemCoaLotInput.value = clearedCoa.lot;
      loadSelectedInventoryForEdit(itemId);
      showModal('Current COA archived and awaiting new documentation.');
    }catch(err){
      console.error('Failed to archive COA:', err);
      showModal(`Failed to archive COA: ${err.message || 'Check console for details.'}`);
      if(editItemDeprecateBtn){
        editItemDeprecateBtn.disabled = false;
      }
    }finally{
      if(editItemDeprecateBtn){
        editItemDeprecateBtn.textContent = restoreLabel || 'Deprecate';
        const itemForButton = inventoryCache[itemId];
        updateDeprecateButton(itemForButton);
      }
    }
  }

  /* Add Cost History */
async function handleNewCostHistory(e){
  e.preventDefault();
  const itemId=existingItemSelect.value;
  if(!itemId){ showModal('Please select an item from the dropdown.'); return; }

  const costPerKit=parseFloat(costPerKitInput.value);
  const totalKitsBought=parseInt(totalKitsBoughtInput.value,10);
  const totalVialsPerKit=parseInt(totalVialsPerKitInput.value,10);
  const purchaseDate=purchaseDateInput.value;
  const totalVialWeight=inventoryCache[itemId]?.totalVialWeight;

  if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
  if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
  if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials per Kit must be a non-negative number.'); return; }
  if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

  const newCostEntry={ costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
  const vialsToAdd = totalKitsBought * totalVialsPerKit;

  try{
    const itemRef=doc(db, INVENTORY_COLLECTION_PATH, itemId);
    await updateDoc(itemRef,{
      costHistory: arrayUnion(newCostEntry),
      currentInventory: increment(vialsToAdd)
    });
    showModal('New cost history added and inventory updated!');
    addCostForm.reset();
  }catch(err){
    console.error('Error adding new cost history:',err);
    showModal(`Failed to add new cost history: ${err.message}`);
  }
}

  function buildExternalOrderPayload(order){
    const items = Array.isArray(order.items)? order.items.map(i=>({
      id:i?.id??"",
      name:i?.name??"",
      quantity:Number(i?.quantity??0),
      unitPrice:Number(i?.unitPrice??0)
    })) : [];
    const computedSubtotal = items.reduce((s,i)=>s+(Number(i.unitPrice)*Number(i.quantity)),0);
    const shipping = Number(order.shippingCost ?? 0);
    const total = Number(order.total ?? (computedSubtotal + shipping));
    return {
      orderId: order.orderId || order.id,
      contactInfo: {
        fullName: order.contactInfo?.fullName ?? "",
        email: order.contactInfo?.email ?? "",
        phone: order.contactInfo?.phone ?? "",
        shippingAddress: order.contactInfo?.shippingAddress ?? ""
      },
      items,
      subtotal: Number(order.subtotal ?? computedSubtotal),
      shippingCost: shipping,
      total,
      paymentStatus: order.paymentStatus ?? "unpaid",
      timestampISO: (order.timestamp?.toDate?.() && order.timestamp.toDate().toISOString()) || new Date().toISOString(),
      tracking: (Array.isArray(order.tracking)?order.tracking:[]).map(t=>({
        carrier:t.carrier||"",
        number:t.number||"",
        url:t.url||buildTrackingUrl(t.carrier,t.number)
      }))
    };
  }

  /* Resend email (with tracking) */
  async function resendOrderEmailById(orderId,btn){
    const order=allOrdersCache.find(o=>o.id===orderId);
    if(!order){ showModal(`Order not found: ${orderId}`); return; }
    const payloadOrder = buildExternalOrderPayload(order);

    const original=btn?.textContent; if(btn){ btn.disabled=true; btn.textContent="Resending..."; btn.classList.add("opacity-70","cursor-not-allowed"); }
    try{ await resendFn({ order: payloadOrder }); showModal(`Resent confirmation to ${payloadOrder.contactInfo.email}`); }
    catch(err){ console.error("Resend failed:",err); showModal(`Resend failed: ${err.message||"See console"}`); }
    finally{ if(btn){ btn.disabled=false; btn.textContent=original||"Resend Email"; btn.classList.remove("opacity-70","cursor-not-allowed"); } }
  }

  async function sendTrackingEmail(orderId, trackingNumber, btn){
    const order = allOrdersCache.find(o=>o.id===orderId);
    if(!order){ showModal(`Order not found: ${orderId}`); return; }
    const payloadOrder = buildExternalOrderPayload(order);
    const targetTracking = trackingNumber || payloadOrder.tracking?.[0]?.number || "";
    if(!targetTracking){ showModal('No tracking number available for this order.'); return; }

    const original = btn?.textContent;
    if(btn){ btn.disabled = true; btn.textContent = 'Sending...'; btn.classList.add('opacity-70','cursor-not-allowed'); }
    try{
      await sendShippingFn({ order: payloadOrder, trackingNumber: targetTracking });
      showModal(`Shipping confirmation sent to ${payloadOrder.contactInfo.email || 'customer'}.`);
    }catch(err){
      console.error('Shipping confirmation failed:', err);
      showModal(`Failed to send shipping confirmation: ${err.message || 'See console'}`);
    }finally{
      if(btn){ btn.disabled = false; btn.textContent = original || 'Send Email'; btn.classList.remove('opacity-70','cursor-not-allowed'); }
    }
  }

  /* Events */
  function attachEventListeners(){
    qs('auth-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=qs('email').value; const password=qs('password').value;
      if(!isValidEmail(email)){ showModal('Please enter a valid email address.'); return; }
      try{ await signInWithEmailAndPassword(auth,email,password); showModal('Login successful!'); }
      catch(error){ console.error("Login failed:",error); let msg="Login failed. Check your credentials."; if(error.code==='auth/wrong-password') msg="Incorrect password. Please try again."; else if(error.code==='auth/user-not-found') msg="Admin user not found."; showModal(msg); }
    });

    qs('signout-btn').addEventListener('click', async ()=>{
      try{ await signOut(auth); showModal('Signed out successfully.'); }
      catch(error){ console.error("Sign out failed:",error); showModal(`Sign out failed: ${error.message}`); }
    });

    qs('close-modal-btn').addEventListener('click',()=>qs('alert-modal').classList.add('hidden'));

    qs('orders-container').addEventListener('click', (e)=>{
        // NEW: Delete button on card
      const delBtn = e.target.closest('.delete-order-card-btn');
      if (delBtn) {
        const orderId = delBtn.dataset.orderId;
        if (orderId) deleteOrderAndRollback(orderId, delBtn);
        return;
      }
      const editButton=e.target.closest('.edit-order-btn');
      if(editButton){ const orderId=editButton.dataset.orderId; const order=allOrdersCache.find(o=>o.id===orderId); if(order) openEditModal(order); return; }
      const resendButton=e.target.closest('.resend-order-btn');
      if(resendButton){ const orderId=resendButton.dataset.orderId; resendOrderEmailById(orderId,resendButton); return; }
      const sendTrackButton = e.target.closest('.send-tracking-email-btn');
      if(sendTrackButton){ const orderId=sendTrackButton.dataset.orderId; const track=sendTrackButton.dataset.track||""; if(orderId) sendTrackingEmail(orderId, track, sendTrackButton); return; }
    });

    if(editOrderForm) editOrderForm.addEventListener('submit', handleEditOrder);
    if(closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
    if(editOrderBackdrop) editOrderBackdrop.addEventListener('click', closeEditModal);

    if(addItemForm) addItemForm.addEventListener('submit', handleAddItem);
    if(addCostForm) addCostForm.addEventListener('submit', handleNewCostHistory);
    if(editItemSelect) editItemSelect.addEventListener('change', ()=>{
      loadSelectedInventoryForEdit(editItemSelect.value);
    });
    if(editItemDeprecateBtn) editItemDeprecateBtn.addEventListener('click', handleDeprecateCurrentCoa);
    if(editItemForm) editItemForm.addEventListener('submit', handleEditInventoryItem);

    TOOL_CONFIG.forEach((tool)=>{
      if(!tool.button || !tool.wrapper) return;
      tool.button.addEventListener('click', ()=>{
        const isHidden = tool.wrapper.classList.contains('hidden');
        if(isHidden){
          closeAllTools(tool);
          setToolOpen(tool,true);
        }else{
          setToolOpen(tool,false);
        }
      });
    });

    const addTrackBtn=qs('edit-track-add-btn'); if(addTrackBtn) addTrackBtn.addEventListener('click', handleAddTrackingEntry);
  }

  /* ============================
 * Delete order from card (rollback inventory & vialsSold)
 * ============================ */
/* Delete order from card (NO inventory changes) */
async function deleteOrderAndRollback(orderId, buttonEl) {
  const order = allOrdersCache.find(o => o.id === orderId);
  if (!order) { showModal(`Order not found: ${orderId}`); return; }

  const prettyId = order.orderId || orderId;
  const ok = window.confirm(`Delete order ${prettyId}? This WILL redistribute inventory and update vialsSold.`);
  if (!ok) return;

  // UI: disable while working
  const originalText = buttonEl?.textContent;
  if (buttonEl) {
    buttonEl.disabled = true;
    buttonEl.textContent = "Deleting...";
    buttonEl.classList.add("opacity-70", "cursor-not-allowed");
  }

  try {
    // Redistribute inventory and update vialsSold
    if (Array.isArray(order.items)) {
      for (const item of order.items) {
        const inv = window._getInvFromOrderItem(item);
        if (!inv) continue;
        const qty = Number(item.quantity || 0);
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), {
          currentInventory: increment(qty),
          vialsSold: increment(-qty)
        });
      }
    }
    await deleteDoc(doc(db, ORDERS_COLLECTION_PATH, orderId));
    showModal(`Order ${prettyId} deleted and inventory updated.`);
  } catch (err) {
    console.error("Delete failed:", err);
    showModal(`Failed to delete order: ${err.message || "See console"}`);
  } finally {
    if (buttonEl) {
      buttonEl.disabled = false;
      buttonEl.textContent = originalText || "Delete";
      buttonEl.classList.remove("opacity-70", "cursor-not-allowed");
    }
  }
}



  window.addEventListener('load', ()=>{
    try{
      onAuthStateChanged(auth,(user)=>{ updateUI(user); });
      attachEventListeners();
    }catch(err){ console.error('Init failed:',err); qs('status').textContent=`Error: ${err.message}`; }
  });
  </script>
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const codesEl = $("codes");
      const logEl = $("log");
      const endpointEl = $("endpoint");
      const adminKeyEl = $("adminKey");
      const toggleKeyBtn = $("toggleKey");

      toggleKeyBtn.addEventListener("click", () => {
        adminKeyEl.type = adminKeyEl.type === "password" ? "text" : "password";
        toggleKeyBtn.textContent = adminKeyEl.type === "password" ? "Show" : "Hide";
      });

      // --- Row template ---
      function newRow(data = {}) {
        const div = document.createElement("div");
        div.className = "code-card";
        div.innerHTML = `
      <div class="code-header">
        <strong>Promo code</strong>
        <button class="btn warn" type="button" data-action="remove">Remove</button>
      </div>

      <div class="row-4">
        <div>
          <label>Code</label>
          <input type="text" data-field="code" placeholder="WELCOME10" value="${esc(data.code || "")}" />
        </div>
        <div>
          <label>Type</label>
          <select data-field="type">
            <option value="percent">percent</option>
            <option value="fixed">fixed</option>
            <option value="free_shipping">free_shipping</option>
          </select>
        </div>
        <div>
          <label>Value</label>
          <input type="number" step="0.01" data-field="value" placeholder="10 (for 10%)" />
        </div>
        <div>
          <label>Label (optional)</label>
          <input type="text" data-field="label" placeholder="10% off" value="${esc(data.label || "")}" />
        </div>
      </div>

      <div class="row-4" style="margin-top:8px;">
        <div>
          <label>Active</label>
          <div style="display:flex;align-items:center;height:40px">
            <input type="checkbox" data-field="active" ${data.active === false ? "" : "checked"} />
          </div>
        </div>
        <div>
          <label>Global Usage Limit (optional)</label>
          <input type="number" data-field="usageLimit" placeholder="e.g. 500" value="${numOrEmpty(data.usageLimit)}" />
        </div>
        <div>
          <label>Per-User Limit (optional)</label>
          <input type="number" data-field="perUserLimit" placeholder="e.g. 1" value="${numOrEmpty(data.perUserLimit)}" />
        </div>
        <div>
          <label>Expires At (optional)</label>
          <input type="datetime-local" data-field="expiresAt" />
        </div>
      </div>
      `;

        // set selects/values post-DOM insert
        const typeSel = div.querySelector('[data-field="type"]');
        typeSel.value = data.type || "percent";

        const valueEl = div.querySelector('[data-field="value"]');
        if (typeof data.value !== "undefined") valueEl.value = data.value;

        const expiresEl = div.querySelector('[data-field="expiresAt"]');
        if (data.expiresAt) {
          const dt = toLocalDatetimeInput(data.expiresAt);
          if (dt) expiresEl.value = dt;
        }

        // uppercase CODE on input
        const codeEl = div.querySelector('[data-field="code"]');
        codeEl.addEventListener("input", () => { codeEl.value = codeEl.value.toUpperCase().replace(/\s+/g,''); });

        // disable value for free_shipping
        const onTypeChange = () => {
          if (typeSel.value === "free_shipping") {
            valueEl.value = "";
            valueEl.disabled = true;
          } else {
            valueEl.disabled = false;
          }
        };
        typeSel.addEventListener("change", onTypeChange);
        onTypeChange();

        // remove
        div.querySelector('[data-action="remove"]').addEventListener("click", () => {
          div.remove();
          note(`Removed a code row.`);
        });

        return div;
      }

      function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
      function numOrEmpty(v){ return (v === 0 || (typeof v === "number" && Number.isFinite(v))) ? String(v) : ""; }

      function toLocalDatetimeInput(v){
        // Accept ISO string, millis, or Date
        const d = v instanceof Date ? v : (typeof v === "number" ? new Date(v) : new Date(String(v)));
        if (isNaN(d)) return "";
        // datetime-local expects "YYYY-MM-DDTHH:mm"
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function fromDatetimeLocalToISO(s){
        if (!s) return undefined;
        const d = new Date(s);
        if (isNaN(d)) return undefined;
        return d.toISOString(); // server accepts ISO
      }

      function collectPayload(){
        const adminKey = adminKeyEl.value.trim();
        const endpoint = endpointEl.value.trim();
        if (!endpoint) throw new Error("Endpoint required.");
        if (!adminKey) throw new Error("Admin key required.");

        const rows = Array.from(codesEl.querySelectorAll(".code-card"));
        if (rows.length === 0) throw new Error("Add at least one code.");

        const codes = rows.map(card => {
          const get = sel => card.querySelector(sel);
          const code = (get('[data-field="code"]').value || "").trim().toUpperCase();
          const type = (get('[data-field="type"]').value || "").trim();
          const valueRaw = get('[data-field="value"]').value;
          const label = (get('[data-field="label"]').value || "").trim();
          const active = get('[data-field="active"]').checked;
          const usageLimitRaw = get('[data-field="usageLimit"]').value;
          const perUserLimitRaw = get('[data-field="perUserLimit"]').value;
          const expiresAtLocal = get('[data-field="expiresAt"]').value;

          if (!code) throw new Error("Each code row needs a CODE.");
          if (!type) throw new Error(`Code ${code}: type required.`);

          const toNum = (x) => {
            if (x === "" || x === null || typeof x === "undefined") return undefined;
            const n = Number(x);
            return Number.isFinite(n) ? n : undefined;
          };

          const doc = { code, type, active };
          if (label) doc.label = label;

          // only include value for percent/fixed
          if (type !== "free_shipping") {
            const v = toNum(valueRaw);
            if (typeof v === "undefined") throw new Error(`Code ${code}: value required for type "${type}".`);
            doc.value = v;
          }

          const usageLimit = toNum(usageLimitRaw);
          if (typeof usageLimit !== "undefined") doc.usageLimit = usageLimit;

          const perUserLimit = toNum(perUserLimitRaw);
          if (typeof perUserLimit !== "undefined") doc.perUserLimit = perUserLimit;

          const expiresAtISO = fromDatetimeLocalToISO(expiresAtLocal);
          if (expiresAtISO) doc.expiresAt = expiresAtISO;

          return doc;
        });

        return { endpoint, body: { adminKey, codes } };
      }

      function note(msg){ logEl.textContent = msg; logEl.classList.remove("muted"); }
      function show(obj, title=""){ logEl.textContent = (title ? title + "\n" : "") + JSON.stringify(obj, null, 2); logEl.classList.remove("muted"); }
      function warn(msg){ logEl.textContent = "⚠ " + msg; logEl.classList.remove("muted"); }
      function err(msg){ logEl.textContent = "❌ " + msg; logEl.classList.remove("muted"); }

      // Buttons
      $("addRow").addEventListener("click", () => {
        codesEl.appendChild(newRow());
        note("Added a code row.");
      });

      $("loadSample").addEventListener("click", () => {
        codesEl.innerHTML = "";
        codesEl.appendChild(newRow({ code:"WELCOME10", type:"percent", value:10, label:"10% off", active:true, perUserLimit:1 }));
        codesEl.appendChild(newRow({ code:"FREESHIP", type:"free_shipping", label:"Free shipping", active:true }));
        note("Loaded sample codes.");
      });

      $("preview").addEventListener("click", () => {
        try {
          const { body } = collectPayload();
          show(body, "Preview payload:");
        } catch (e) { err(e.message); }
      });

      $("push").addEventListener("click", async () => {
        try {
          const { endpoint, body } = collectPayload();
          show(body, "Sending payload...");
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(body)
          });
          const text = await res.text();
          let parsed; try { parsed = JSON.parse(text); } catch { parsed = { raw: text }; }
          show({ status: res.status, response: parsed }, "Response:");
        } catch (e) {
          err(e.message || String(e));
        }
      });

      $("exportJson").addEventListener("click", () => {
        try {
          const { body } = collectPayload();
          const blob = new Blob([JSON.stringify(body, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "promos.json";
          a.click();
          URL.revokeObjectURL(a.href);
          note("Exported promos.json");
        } catch (e) { err(e.message); }
      });

      $("importFile").addEventListener("change", async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        try {
          const text = await f.text();
          const obj = JSON.parse(text);
          if (!obj || !Array.isArray(obj.codes)) throw new Error("JSON must have a 'codes' array.");
          if (obj.adminKey) adminKeyEl.value = obj.adminKey;
          codesEl.innerHTML = "";
          for (const c of obj.codes) codesEl.appendChild(newRow(c));
          show(obj, "Imported JSON:");
        } catch (e) { err("Import failed: " + e.message); }
      });

      // start with one blank row
      codesEl.appendChild(newRow());

    })();
  </script>
</body>
</html>
