<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production-Ready Inventory & Order Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap">
  <style>
    body { font-family:'Roboto Mono',monospace; background:#0d0c1d; color:#e2e8f0 }
    .neon-glow{ box-shadow:0 0 5px #1e90ff,0 0 10px #1e90ff,0 0 15px #1e90ff,0 0 20px #1e90ff }
    .text-glow-fuchsia{ text-shadow:0 0 3px #d62d88,0 0 8px #d62d88 }
    .text-glow-cyan{ text-shadow:0 0 3px #0891b2,0 0 8px #0891b2 }
    .btn-neon-cyan{ background:#0891b2; color:#fff } .btn-neon-cyan:hover{ background:#06748c }
    .btn-neon-lime{ background:#65a30d; color:#000 } .btn-neon-lime:hover{ background:#4d820d }
    .btn-neon-red{ background:#dc2626; color:#fff } .btn-neon-red:hover{ background:#b91c1c }
    table{ width:100%; border-collapse:collapse; text-align:left }
    th,td{ padding:12px; border-bottom:1px solid #1f2937 }
    th{ background:#1e1b4b; font-weight:700; color:#93c5fd; text-transform:uppercase }
    tr:last-child td{ border-bottom:none }
    td.is-editing{ background:#1f2937; outline:2px solid #06b6d4; outline-offset:-2px }
    .order-card,.infographic-card{ background:#1f2937; border:1px solid #374151; box-shadow:0 4px 6px rgba(0,0,0,.1) }
    .infographic-grid{ display:grid; gap:1.5rem; grid-template-columns:repeat(1,minmax(0,1fr)) }
    @media (min-width:640px){ .infographic-grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (min-width:1024px){ .infographic-grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }
    .infographic-list li{ display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px dashed #374151 }
    .infographic-list li:last-child{ border-bottom:none }
    .infographic-list .rank{ font-weight:bold; color:#06b6d4 }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:40; opacity:0; transition:opacity .3s; pointer-events:none }
    .modal-backdrop.is-open{ opacity:1; pointer-events:auto }
    .modal-main{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:90%; max-width:600px; background:#111827; z-index:50; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.5); padding:2rem; transition:transform .3s,opacity .3s; opacity:0; pointer-events:none; max-height:90%; overflow-y:auto }
    .modal-main.is-open{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1) }
    .full-page-modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:#0d0c1d; z-index:50; display:none; align-items:center; justify-content:center }
    .full-page-modal.is-open{ display:flex }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

  <div class="bg-gray-800 p-8 rounded-xl shadow-2xl neon-glow w-full lg:px-12 xl:px-24 space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
      <h1 class="text-3xl font-bold text-center text-white text-glow-cyan">MIDWAY GRAY INVENTORY LOG</h1>
    </div>

    <div id="auth-buttons" class="space-x-4">
      <button id="add-cost-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold text-xs hidden">Add Cost History</button>
      <button id="signout-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold text-xs hidden">Sign Out</button>
    </div>

    <div id="status" class="text-center text-sm text-gray-400">Status: Initializing...</div>
    <div id="user-id-display" class="text-center text-xs text-gray-500 break-all">User ID: N/A</div>

    <!-- Login/Auth Form -->
    <div id="login-form" class="hidden">
      <h2 class="text-xl font-semibold text-white text-glow-fuchsia text-center mb-4">ADMIN ACCESS</h2>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-400">Admin ID</label>
          <input type="email" id="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="admin@domain.net" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-400">Admin Password</label>
          <input type="password" id="password" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="• • • • • •" required>
        </div>
        <div class="flex justify-center">
          <button type="submit" id="login-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full">Access System</button>
        </div>
      </form>
    </div>

    <div id="main-content" class="hidden space-y-8">
      <!-- Inventory Section -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Inventory Data Stream</h2>
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Blend</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Current Inventory</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Sell Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Amount Purchased</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Vials Sold</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Vial Weight (mg)</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">Image</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-20">COA</th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </div>

      <!-- Add Inventory Item -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Add New Inventory Item</h2>
        <form id="add-item-form" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div class="w-full">
              <label for="new-item-name" class="block text-sm font-medium text-gray-400">Item Name</label>
              <input type="text" id="new-item-name" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., MIDWAY GRAY 5mg" required>
            </div>
            <div class="w-full">
              <label for="new-item-id" class="block text-sm font-medium text-gray-400">Item ID</label>
              <input type="text" id="new-item-id" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., RT24" required>
            </div>
            <div class="w-full">
              <label for="new-item-vials-sold" class="block text-sm font-medium text-gray-400">Vials Sold (Initial)</label>
              <input type="number" id="new-item-vials-sold" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
            </div>
            <div class="w-full">
              <label for="new-item-price" class="block text-sm font-medium text-gray-400">Sell Price per Vial ($)</label>
              <input type="number" step="0.01" id="new-item-price" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
            </div>
            <div class="w-full">
              <label for="new-item-total-vial-weight" class="block text-sm font-medium text-gray-400">Total Vial Weight (mg)</label>
              <input type="number" step="0.01" id="new-item-total-vial-weight" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" value="0" min="0" required>
            </div>
            <div class="w-full">
              <div class="flex items-center space-x-2 mt-7">
                <input type="checkbox" id="new-item-blend" class="h-4 w-4 text-cyan-500 rounded-md focus:ring-cyan-500 border-gray-600">
                <label for="new-item-blend" class="block text-sm font-medium text-gray-400">Is a Blend?</label>
              </div>
            </div>
            <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
              <label for="new-item-image" class="block text-sm font-medium text-gray-400">Image URL</label>
              <input type="url" id="new-item-image" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/image.jpg">
            </div>
            <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
              <label for="new-item-coa" class="block text-sm font-medium text-gray-400">COA URL</label>
              <input type="url" id="new-item-coa" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://example.com/coa.pdf">
            </div>
          </div>

          <div class="space-y-4 mt-6 p-4 rounded-lg border-2 border-dashed border-gray-700">
            <h3 class="text-lg font-semibold text-white text-glow-fuchsia">Initial Cost History</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="w-full">
                <label for="new-cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
                <input type="number" step="0.01" id="new-cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="$0.00" required>
              </div>
              <div class="w-full">
                <label for="new-total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
                <input type="number" id="new-total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
              </div>
              <div class="w-full">
                <label for="new-total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
                <input type="number" id="new-total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0" required>
              </div>
              <div class="w-full col-span-1 sm:col-span-2 lg:col-span-3">
                <label for="new-purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
                <input type="date" id="new-purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" required>
              </div>
            </div>
          </div>

          <div class="flex justify-center mt-6">
            <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Item</button>
          </div>
        </form>
      </div>

      <!-- Totals -->
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-indigo-700">
          <h3 class="text-md font-semibold text-indigo-300">Total Cost</h3>
          <p id="total-cost" class="mt-1 text-2xl font-bold text-indigo-200">$0.00</p>
        </div>
        <div class="bg-purple-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-purple-700">
          <h3 class="text-md font-semibold text-purple-300">Total Revenue</h3>
          <p id="total-revenue" class="mt-1 text-2xl font-bold text-purple-200">$0.00</p>
        </div>
        <div class="bg-green-900 text-white p-6 rounded-xl shadow-lg text-center flex-1 border border-green-700">
          <h3 class="text-md font-semibold text-green-300">Total Profit</h3>
          <p id="total-profit" class="mt-1 text-2xl font-bold text-green-200">$0.00</p>
        </div>
      </div>

      <!-- Orders -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Order Data Stream</h2>
        <div id="orders-container" class="space-y-6">
          <div id="loading-orders" class="text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-cyan-500 border-solid rounded-full border-t-transparent"></div>
            <p class="mt-4 text-gray-500">Loading orders...</p>
          </div>
        </div>
      </div>

      <!-- Infographics -->
      <div class="space-y-4 mt-8">
        <h2 class="text-xl font-semibold text-white text-glow-fuchsia">Sales Infographics</h2>
        <div class="infographic-grid">
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Monthly Revenue</h3>
            <ul id="list-monthly-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Customers</h3>
            <ul id="list-top-customers" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Revenue)</h3>
            <ul id="list-top-products-revenue" class="infographic-list"></ul>
          </div>
          <div class="infographic-card rounded-lg p-4">
            <h3 class="text-md font-semibold text-center text-cyan-300 mb-4">Top Products (Quantity)</h3>
            <ul id="list-top-products-quantity" class="infographic-list"></ul>
          </div>
        </div>
        <div id="infographic-placeholder" class="text-center py-12 text-gray-500">
          No sales data to display yet.
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg text-center w-80 space-y-4 border-2 border-cyan-500">
      <p id="modal-message" class="text-lg"></p>
      <button id="close-modal-btn" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold hover:bg-cyan-600">ACKNOWLEDGE</button>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="edit-order-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-order-modal" class="modal-main hidden">
    <div class="flex justify-between items-center text-cyan-300 border-b pb-4 mb-4 border-gray-700">
      <h2 class="text-2xl font-bold">Edit Order</h2>
      <button id="close-edit-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="edit-order-form" class="space-y-4">
      <input type="hidden" id="edit-order-id">
      <div>
        <label for="edit-contact-name" class="block text-sm font-medium text-gray-400">Customer Name</label>
        <input type="text" id="edit-contact-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
      </div>
      <div>
        <label for="edit-order-total" class="block text-sm font-medium text-gray-400">Total Amount</label>
        <input type="number" step="0.01" id="edit-order-total" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500">
      </div>
      <div class="text-sm text-gray-400 -mt-2">
        Shipping (preserved): <span id="edit-shipping-display">$0.00</span>
      </div>
      <div>
        <label for="edit-order-status" class="block text-sm font-medium text-gray-400">Payment Status</label>
        <select id="edit-order-status" class="mt-1 block w-full bg-gray-900 border border-gray-700 text-gray-300 rounded-md shadow-sm p-2 focus:ring-cyan-500 focus:border-cyan-500" required>
          <option value="Paid">Paid</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <!-- Read-only Items -->
      <div class="space-y-4">
        <h3 class="text-md font-semibold text-gray-400 mt-4">Order Items:</h3>
        <div id="edit-order-items-list" class="space-y-2"></div>

        <!-- Shipping & Tracking (kept) -->
        <div class="space-y-4 mt-6">
          <h3 class="text-md font-semibold text-gray-400">Shipping & Tracking</h3>
          <div id="edit-order-tracking-list" class="space-y-2"></div>
          <input type="hidden" id="edit-order-tracking-hidden" value="[]">
          <div class="flex flex-col sm:flex-row gap-2 items-end">
            <div class="w-full sm:w-48">
              <label for="edit-track-carrier" class="block text-sm font-medium text-gray-400">Carrier</label>
              <select id="edit-track-carrier" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="">-- Select --</option>
                <option>USPS</option>
                <option>UPS</option>
                <option>FedEx</option>
                <option>DHL</option>
                <option>Other</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="edit-track-number" class="block text-sm font-medium text-gray-400">Tracking Number</label>
              <input id="edit-track-number" type="text" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" placeholder="e.g., 9400 1234 5678 9012 3456 78">
            </div>
            <button type="button" id="edit-track-add-btn" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto mt-4 sm:mt-0">Add Tracking</button>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button type="submit" class="btn-neon-cyan px-4 py-2 rounded-lg font-semibold">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Add Cost History Full-Page Modal -->
  <div id="add-cost-modal" class="full-page-modal">
    <div class="bg-gray-900 p-8 rounded-xl shadow-2xl w-full max-w-2xl">
      <div class="flex justify-between items-center text-lime-300 border-b pb-4 mb-4 border-gray-700">
        <h2 class="text-2xl font-bold">Add Cost History to Existing Item</h2>
        <button id="close-add-cost-modal-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="add-cost-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="w-full col-span-1 md:col-span-2">
            <label for="existing-item-select" class="block text-sm font-medium text-gray-400">Select Item</label>
            <select id="existing-item-select" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
              <option value="">-- Select an item --</option>
            </select>
          </div>
          <div class="w-full">
            <label for="cost-per-kit" class="block text-sm font-medium text-gray-400">Cost per Kit</label>
            <input type="number" step="0.01" id="cost-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="$0.00" required>
          </div>
          <div class="w-full">
            <label for="total-kits-bought" class="block text-sm font-medium text-gray-400">Total Kits Bought</label>
            <input type="number" id="total-kits-bought" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
          </div>
          <div class="w-full">
            <label for="total-vials-per-kit" class="block text-sm font-medium text-gray-400">Total Vials per Kit</label>
            <input type="number" id="total-vials-per-kit" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" placeholder="0" required>
          </div>
          <div class="w-full">
            <label for="purchase-date" class="block text-sm font-medium text-gray-400">Purchase Date</label>
            <input type="date" id="purchase-date" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm p-2 text-gray-300 focus:ring-lime-500 focus:border-lime-500" required>
          </div>
        </div>
        <div class="flex justify-center mt-6">
          <button type="submit" class="btn-neon-lime px-4 py-2 rounded-lg font-semibold w-full sm:w-auto">Add Cost Entry</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, setDoc, arrayUnion, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
    authDomain: "peptide-inventory.firebaseapp.com",
    projectId: "peptide-inventory",
    storageBucket: "peptide-inventory.firebasestorage.app",
    messagingSenderId: "547049240971",
    appId: "1:547049240971:web:83b2e836fee57bb41f578e",
    measurementId: "G-1W58JMJN37"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  try { getAnalytics(app); } catch (_) {}
  const fns = getFunctions(app);
  const resendFn = httpsCallable(fns, "resendOrderConfirmation");

  const qs = (id) => document.getElementById(id);
  let userId = null;
  let totalRevenue = 0;
  let totalCost = 0;
  let allOrdersCache = [];
  let previousOrdersCache = new Map();
  let inventoryCache = {};

  const processedTransitions = new Set();
  function transitionKey(before, after) {
    const b = before ? before.paymentStatus : '∅';
    const a = after  ? after.paymentStatus  : '∅';
    const itemsHash = JSON.stringify(after?.items || []);
    return `${after.id}|${b}->${a}|${itemsHash}`;
  }

  const INVENTORY_COLLECTION_PATH = 'inventory';
  const ORDERS_COLLECTION_PATH = 'orders';

  // Edit modal DOM
  const editOrderBackdrop = qs('edit-order-backdrop');
  const editOrderModal = qs('edit-order-modal');
  const closeEditModalBtn = qs('close-edit-modal-btn');
  const editOrderForm = qs('edit-order-form');

  // Add Item form inputs
  const addItemForm = qs('add-item-form');
  const newItemNameInput = qs('new-item-name');
  const newItemIdInput = qs('new-item-id');
  const newItemVialsSoldInput = qs('new-item-vials-sold');
  const newItemPriceInput = qs('new-item-price');
  const newItemTotalVialWeightInput = qs('new-item-total-vial-weight');
  const newItemBlendInput = qs('new-item-blend');
  const newItemImageInput = qs('new-item-image');
  const newItemCoaInput = qs('new-item-coa');
  const newCostPerKitInput = qs('new-cost-per-kit');
  const newTotalKitsBoughtInput = qs('new-total-kits-bought');
  const newTotalVialsPerKitInput = qs('new-total-vials-per-kit');
  const newPurchaseDateInput = qs('new-purchase-date');

  // Add Cost
  const addCostForm = qs('add-cost-form');
  const existingItemSelect = qs('existing-item-select');
  const costPerKitInput = qs('cost-per-kit');
  const totalKitsBoughtInput = qs('total-kits-bought');
  const totalVialsPerKitInput = qs('total-vials-per-kit');
  const purchaseDateInput = qs('purchase-date');

  const addCostModal = qs('add-cost-modal');
  const addCostBtn = qs('add-cost-btn');
  const closeAddCostModalBtn = qs('close-add-cost-modal-btn');

  function showModal(message){ qs('modal-message').textContent = message; qs('alert-modal').classList.remove('hidden'); }
  function isValidEmail(e){ return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase()); }
  function copyToClipboard(text){ const t=document.createElement('textarea'); t.value=text; document.body.appendChild(t); t.select(); try{ document.execCommand('copy'); showModal('Copied to clipboard!'); }catch(e){ showModal('Failed to copy.'); } finally{ document.body.removeChild(t); } }
  function formatTimestamp(ts){ if(!ts) return 'Unknown date'; try{ if(typeof ts.toDate==='function'){ return ts.toDate().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});} const d=new Date(ts); if(!isNaN(d.getTime())) return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}catch(_){} return 'Unknown date'; }
  function currency(n){ const num=typeof n==='number'?n:Number(n??0); return num.toFixed(2); }

  const CARRIERS = ["USPS","UPS","FedEx","DHL","Other"];
  function buildTrackingUrl(carrier, num){
    const n=(num||"").trim(); const c=(carrier||"").toLowerCase(); if(!n) return "";
    if(c==="usps") return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(n)}`;
    if(c==="ups") return `https://www.ups.com/track?loc=en_US&tracknum=${encodeURIComponent(n)}`;
    if(c==="fedex") return `https://www.fedex.com/fedextrack/?trknbr=${encodeURIComponent(n)}`;
    if(c==="dhl") return `https://www.dhl.com/us-en/home/tracking.html?tracking-id=${encodeURIComponent(n)}`;
    return `https://www.google.com/search?q=${encodeURIComponent((carrier||"tracking")+" "+n)}`;
  }

  let _trackingMemoryCache = [];
  function readTrackingFromModal(){ const hidden=qs('edit-order-tracking-hidden'); if(!hidden) return _trackingMemoryCache.slice(); try{ return JSON.parse(hidden.value||"[]"); }catch{ return []; } }
  function setTrackingHidden(arr){ const hidden=qs('edit-order-tracking-hidden'); _trackingMemoryCache=Array.isArray(arr)?arr.slice():[]; if(hidden) hidden.value=JSON.stringify(_trackingMemoryCache); }
  function renderTrackingList(arr){
    const list=qs('edit-order-tracking-list'); if(!list) return; list.innerHTML='';
    (arr||[]).forEach((t,idx)=>{ const url=t.url||buildTrackingUrl(t.carrier,t.number);
      const row=document.createElement('div'); row.className='flex items-center gap-2 p-2 border border-gray-700 rounded-md';
      row.innerHTML=`<span class="flex-1 text-gray-300 text-sm truncate"><span class="font-semibold">${t.carrier||'Carrier'}</span> — ${t.number||'—'}</span>
      <a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 text-xs">Open</a>
      <button type="button" class="btn-neon-red px-2 py-1 rounded-lg font-semibold text-xs" data-remove="${idx}">Remove</button>`;
      list.appendChild(row);
    });
    list.querySelectorAll('[data-remove]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.remove); const cur=readTrackingFromModal(); cur.splice(idx,1); setTrackingHidden(cur); renderTrackingList(cur);
      });
    });
  }

  function updateFinancialUI(){
    const profit = totalRevenue - totalCost;
    qs('total-cost').textContent = `$${totalCost.toFixed(2)}`;
    qs('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    qs('total-profit').textContent = `$${profit.toFixed(2)}`;
  }

  function updateUI(user){
    const status=qs('status'), userDisplay=qs('user-id-display'), mainContent=qs('main-content'), loginForm=qs('login-form'), signoutBtn=qs('signout-btn'), addCostBtn=qs('add-cost-btn');
    if(user){
      userId=user.uid; status.textContent='Status: Signed in'; userDisplay.textContent='User ID: '+userId;
      mainContent.classList.remove('hidden'); loginForm.classList.add('hidden'); signoutBtn.classList.remove('hidden'); addCostBtn.classList.remove('hidden');
      listenForInventory(); listenForOrders();
    }else{
      userId=null; status.textContent='Status: Signed out'; userDisplay.textContent='User ID: N/A';
      mainContent.classList.add('hidden'); loginForm.classList.remove('hidden'); signoutBtn.classList.add('hidden'); addCostBtn.classList.add('hidden');
    }
  }

  /* ============================
 * Inventory listener (RESTORED EDITING)
 * ============================ */
  /* ============================
 * Inventory listener (RESTORED EDITING + COST HISTORY SELECT BY ID)
 * ============================ */
function listenForInventory() {
  if (!userId) return;
  const ref = collection(db, INVENTORY_COLLECTION_PATH);

  onSnapshot(ref, (snap) => {
    const tbody = qs('inventory-list');
    tbody.innerHTML = '';
    // reset the cost-history select each refresh
    existingItemSelect.innerHTML = '<option value="">-- Select an item --</option>';

    if (snap.empty) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.setAttribute('colspan', '11');
      td.className = 'text-gray-500 italic px-6 py-4 whitespace-nowrap';
      td.textContent = 'No inventory items.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      // keep the select empty in this case
      return;
    }

    totalCost = 0;
    inventoryCache = {};

    // Build fast lookup maps for order/inventory joins
    const inventoryById = {};
    const inventoryByNameLower = {};

    snap.forEach((d) => {
      const item = d.data();
      const inv = { id: d.id, ...item };
      inventoryCache[d.id] = inv;
      inventoryById[d.id] = inv;
      if (item.name) inventoryByNameLower[item.name.toLowerCase()] = inv;
    });

    // helper available to the rest of the file:
    window._getInvFromOrderItem = function (it) {
      if (!it) return null;
      if (it.id && inventoryById[it.id]) return inventoryById[it.id];
      if (it.name && inventoryByNameLower[it.name.toLowerCase()]) return inventoryByNameLower[it.name.toLowerCase()];
      return null;
    };

    /* NEW: Populate the Cost History tool's dropdown with items by ID */
    if (existingItemSelect) {
      const previouslySelected = existingItemSelect.value || '';
      existingItemSelect.innerHTML = '<option value="">-- Select an item --</option>';

      const ids = Object.keys(inventoryById)
        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

      const frag = document.createDocumentFragment();
      ids.forEach((id) => {
        const inv = inventoryById[id];
        const opt = document.createElement('option');
        opt.value = id;
        // Show ID first, then name; include stock to help pick the right item at a glance
        const stock = Number.isFinite(inv?.currentInventory) ? inv.currentInventory : 0;
        opt.textContent = `${id} — ${inv?.name || '(no name)'} (${stock} in stock)`;
        frag.appendChild(opt);
      });
      existingItemSelect.appendChild(frag);

      // restore previous selection if it still exists
      if (previouslySelected && ids.includes(previouslySelected)) {
        existingItemSelect.value = previouslySelected;
      }
    }

    // ===== Table render (unchanged) =====
    snap.forEach((d) => {
      const item = d.data();
      const tr = document.createElement('tr');
      tr.dataset.id = d.id;
      tr.className = 'hover:bg-gray-700 transition-colors duration-150';

      const nameTd = document.createElement('td');
      nameTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-cyan-300';
      nameTd.textContent = item.name ?? '(no name)';
      nameTd.setAttribute('contenteditable', 'false');
      nameTd.dataset.field = 'name';

      const idTd = document.createElement('td');
      idTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      idTd.textContent = d.id; // show the Firestore doc id

      const blendTd = document.createElement('td');
      blendTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      blendTd.textContent = item.blend ? 'Yes' : 'No';

      const inventoryTd = document.createElement('td');
      inventoryTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      inventoryTd.textContent = item.currentInventory ?? 0;
      inventoryTd.setAttribute('contenteditable', 'false');
      inventoryTd.dataset.field = 'currentInventory';

      const priceTd = document.createElement('td');
      priceTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      priceTd.textContent = item.sellPricePerVial ? `$${item.sellPricePerVial}` : '$0';
      priceTd.setAttribute('contenteditable', 'false');
      priceTd.dataset.field = 'sellPricePerVial';

      const totalItemCostTd = document.createElement('td');
      totalItemCostTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      let totalItemCost = 0;
      if (Array.isArray(item.costHistory)) {
        totalItemCost = item.costHistory.reduce((sum, h) => {
          return sum + ((h.costPerKit || 0) * (h.totalKitsBought || 0));
        }, 0);
      }
      totalItemCostTd.textContent = `$${totalItemCost.toFixed(2)}`;

      const vialsSoldTd = document.createElement('td');
      vialsSoldTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      vialsSoldTd.textContent = item.vialsSold ?? 0;
      vialsSoldTd.setAttribute('contenteditable', 'false');
      vialsSoldTd.dataset.field = 'vialsSold';

      const totalVialWeightTd = document.createElement('td');
      totalVialWeightTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400';
      totalVialWeightTd.textContent = item.totalVialWeight ?? 0;
      totalVialWeightTd.setAttribute('contenteditable', 'false');
      totalVialWeightTd.dataset.field = 'totalVialWeight';

      const imageTd = document.createElement('td');
      imageTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
      imageTd.textContent = item.image ?? 'N/A';
      imageTd.dataset.field = 'image';
      imageTd.setAttribute('contenteditable', 'false');
      imageTd.addEventListener('click', () => {
        if (imageTd.textContent && imageTd.textContent !== 'N/A') copyToClipboard(imageTd.textContent);
      });

      const coaTd = document.createElement('td');
      coaTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-400 max-w-24 overflow-hidden text-ellipsis cursor-pointer';
      coaTd.textContent = item.coa ?? 'N/A';
      coaTd.dataset.field = 'coa';
      coaTd.setAttribute('contenteditable', 'false');
      coaTd.addEventListener('click', () => {
        if (coaTd.textContent && coaTd.textContent !== 'N/A') copyToClipboard(coaTd.textContent);
      });

      const actionTd = document.createElement('td');
      actionTd.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
      const editSaveBtn = document.createElement('button');
      editSaveBtn.textContent = 'Edit';
      editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';

      editSaveBtn.addEventListener('click', async () => {
        const isEditing = editSaveBtn.textContent === 'Edit';
        const editableTds = [nameTd, inventoryTd, priceTd, vialsSoldTd, totalVialWeightTd, imageTd, coaTd];

        if (isEditing) {
          editSaveBtn.textContent = 'Save';
          editSaveBtn.className = 'btn-neon-lime px-3 py-1 rounded-lg font-semibold text-xs';
          editableTds.forEach(td => {
            td.setAttribute('contenteditable', 'true');
            td.classList.add('is-editing');
          });
        } else {
          const docId = tr.dataset.id;
          const newName = nameTd.textContent.trim();
          const newQuantity = parseInt(inventoryTd.textContent.trim(), 10);
          let newPrice = priceTd.textContent.trim();
          newPrice = parseFloat(newPrice.replace(/^\$/, ''));
          const newVialsSold = parseInt(vialsSoldTd.textContent.trim(), 10);
          const newTotalVialWeight = parseFloat(totalVialWeightTd.textContent.trim());
          const newImage = imageTd.textContent.trim();
          const newCoa = coaTd.textContent.trim();

          const updateData = {};
          if (newName !== (item.name ?? '')) updateData.name = newName;
          if (!isNaN(newQuantity) && newQuantity !== item.currentInventory) updateData.currentInventory = newQuantity;
          if (!isNaN(newPrice) && newPrice !== item.sellPricePerVial) updateData.sellPricePerVial = newPrice;
          if (!isNaN(newVialsSold) && newVialsSold !== item.vialsSold) updateData.vialsSold = newVialsSold;
          if (!isNaN(newTotalVialWeight) && newTotalVialWeight !== item.totalVialWeight) updateData.totalVialWeight = newTotalVialWeight;
          if (newImage !== (item.image ?? '')) updateData.image = newImage;
          if (newCoa !== (item.coa ?? '')) updateData.coa = newCoa;

          try {
            if (Object.keys(updateData).length > 0) {
              await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, docId), updateData);
              showModal(`Data updated for ${newName || docId}.`);
            } else {
              showModal('No changes to save.');
            }
          } catch (e) {
            console.error('Error updating document:', e);
            showModal('Error updating data. Check console for details.');
          } finally {
            editSaveBtn.textContent = 'Edit';
            editSaveBtn.className = 'btn-neon-cyan px-3 py-1 rounded-lg font-semibold text-xs';
            editableTds.forEach(td => {
              td.setAttribute('contenteditable', 'false');
              td.classList.remove('is-editing');
            });
          }
        }
      });
      actionTd.appendChild(editSaveBtn);

      tr.appendChild(nameTd);
      tr.appendChild(idTd);
      tr.appendChild(blendTd);
      tr.appendChild(inventoryTd);
      tr.appendChild(priceTd);
      tr.appendChild(totalItemCostTd);
      tr.appendChild(vialsSoldTd);
      tr.appendChild(totalVialWeightTd);
      tr.appendChild(imageTd);
      tr.appendChild(coaTd);
      tr.appendChild(actionTd);
      tbody.appendChild(tr);

      if (Array.isArray(item.costHistory)) {
        totalCost += item.costHistory.reduce((sum, h) => sum + ((h.costPerKit || 0) * (h.totalKitsBought || 0)), 0);
      }
    });

    updateFinancialUI();
  }, (error) => {
    console.error('Error listening to inventory:', error);
    const tbody = qs('inventory-list');
    tbody.innerHTML = '';
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.setAttribute('colspan', '11');
    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-red-500';
    td.textContent = 'Error loading inventory.';
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}


  

  /* vialsSold adjustments on status changes (keep) */
  async function updateInventorySalesImpact(orderId,type,items){
    if(!items || items.length===0) return;
    for(const it of items){
      const inv=window._getInvFromOrderItem(it); if(!inv) continue;
      const qty=Number(it.quantity||0); const sign=(type==='increment')?1:-1;
      try{
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), { vialsSold: increment(sign*qty) });
      }catch(err){ console.error(`Error updating vialsSold for ${inv.id}:`,err); showModal(`Error updating vialsSold for an item in order ${orderId}.`); }
    }
  }

  async function compareOrderItemsAndUpdateVials(prevItems,currentItems){
    const changes=new Map();
    for(const it of prevItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)-Number(it.quantity||0)); }
    for(const it of currentItems||[]){ const inv=window._getInvFromOrderItem(it); if(!inv) continue; changes.set(inv.id,(changes.get(inv.id)||0)+Number(it.quantity||0)); }
    const ops=[]; for(const [invId,delta] of changes.entries()){ if(!delta) continue; ops.push(updateDoc(doc(db, INVENTORY_COLLECTION_PATH, invId),{ vialsSold: increment(delta) })); }
    await Promise.all(ops);
  }

  /* Orders listener */
  function listenForOrders(){
    const ordersContainer=qs('orders-container'); const loading=qs('loading-orders'); const ref=collection(db, ORDERS_COLLECTION_PATH);
    onSnapshot(ref, async (snap)=>{
      // Handle modifications only (no added/removed side-effects & no extra fields)
      for(const change of snap.docChanges()){
        const id=change.doc.id; const currentOrder={ id, ...change.doc.data() };
        if(change.doc.metadata.hasPendingWrites){ previousOrdersCache.set(id,currentOrder); continue; }
        if(change.type==='modified'){
          const prev=previousOrdersCache.get(id); if(!prev){ previousOrdersCache.set(id,currentOrder); continue; }
          const key=transitionKey(prev,currentOrder); if(processedTransitions.has(key)){ previousOrdersCache.set(id,currentOrder); continue; }
          processedTransitions.add(key);

          const wasPaid = prev.paymentStatus==='Paid';
          const isPaid  = currentOrder.paymentStatus==='Paid';
          const wasUnpaid = prev.paymentStatus==='Unpaid';
          const isUnpaid  = currentOrder.paymentStatus==='Unpaid';

          // if(wasUnpaid && isPaid)       updateInventorySalesImpact(currentOrder.id,'increment',currentOrder.items);
          // else if(wasPaid && isUnpaid)  updateInventorySalesImpact(currentOrder.id,'decrement',currentOrder.items);
          // else if(wasPaid && isPaid){
          //   const p=JSON.stringify(prev.items||[]), c=JSON.stringify(currentOrder.items||[]);
          //   if(p!==c) compareOrderItemsAndUpdateVials(prev.items||[], currentOrder.items||[]);
          // }
          previousOrdersCache.set(id,currentOrder);
        } else if(change.type==='added'){
          previousOrdersCache.set(id,currentOrder);
        }
      }
      if(processedTransitions.size>1000) processedTransitions.clear();

      // Rebuild UI
      loading.style.display='none'; ordersContainer.innerHTML='';
      if(snap.empty){
        ordersContainer.innerHTML=`<div class="text-center text-gray-500 py-12"><p class="text-lg">No orders found.</p><p class="text-sm mt-2">Your orders will appear here once they've been placed.</p></div>`;
        allOrdersCache=[]; totalRevenue=0; previousOrdersCache.clear(); updateFinancialUI(); renderInfographics(); return;
      }

      totalRevenue=0; allOrdersCache=snap.docs.map(d=>({ id:d.id, ...d.data() }));
      previousOrdersCache.clear(); snap.docs.forEach(d=>previousOrdersCache.set(d.id,{ id:d.id, ...d.data() }));

      const sorted=[...allOrdersCache].sort((a,b)=>{ const A=a.timestamp?.toMillis?.()??0; const B=b.timestamp?.toMillis?.()??0; return B-A; });

      sorted.forEach(order=>{
        const timestamp=formatTimestamp(order.timestamp);
        const items=Array.isArray(order.items)?order.items:[];
        const itemsList = items.map(item=>{
          const label = item.id || item.name || 'Item';
          const price = currency(item?.unitPrice ?? 0);
          const quantity = item?.quantity ?? 1;
          return `<li class="flex justify-between items-center mb-1"><span class="text-gray-400">${label} (x${quantity})</span><span class="font-medium text-cyan-300">$${price}</span></li>`;
        }).join('');

        const computed = items.reduce((s,it)=>s + (Number(it?.unitPrice||0)*Number(it?.quantity||1)),0);
        const totalSafe = (order.total!=null)?currency(order.total):currency(computed);
        const discountedSubtotal = Number(order.subtotal ?? computed);
        const shippingCostSafe = Number(order.shippingCost ?? 0);
        const hasFreeShip = shippingCostSafe===0 && (order.promo?.type==='free_shipping');
        const itemDiscount = Math.max(0, computed - discountedSubtotal);
        const status=order.paymentStatus||'Unknown';
        const statusClass = status==='Paid' ? 'bg-lime-900 text-lime-300' : 'bg-rose-900 text-rose-300';
        const contact=order.contactInfo||{};
        const orderIdText=order.orderId || order.id;
        const tracking=Array.isArray(order.tracking)?order.tracking:[];
        const trackingHtml = tracking.length
          ? tracking.map(t=>{
              const url=t.url||buildTrackingUrl(t.carrier,t.number);
              const label=`${t.carrier||"Carrier"}: ${t.number||"—"}`;
              return `<div class="flex items-center gap-2 text-xs"><a href="${url}" target="_blank" rel="noopener" class="underline text-cyan-300 hover:text-cyan-200">${label}</a><button type="button" class="btn-neon-cyan px-2 py-0.5 rounded copy-track" data-track="${t.number||""}">Copy</button></div>`;
            }).join("")
          : `<span class="text-gray-500 text-xs italic">No tracking added yet</span>`;

        if(order.paymentStatus==='Paid'){ totalRevenue += Number(order.total || computed); }

        const card=`
        <div class="order-card rounded-xl p-6 shadow-md border border-gray-700 relative">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start border-b pb-4 mb-4 border-gray-700">
            <div>
              <h3 class="text-lg font-bold text-cyan-500 mb-1">Order ID:
                <span class="font-normal text-sm sm:text-base break-words text-gray-300">${orderIdText}</span>
              </h3>
              <p class="text-sm text-gray-500">Order Placed on ${timestamp}</p>
            </div>
            <div class="mt-4 sm:mt-0 text-left sm:text-right">
              <p class="font-semibold text-lg text-cyan-500">Total: $${totalSafe}</p>
              <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${status}</span>
              <div class="mt-2 text-xs text-gray-400 space-y-1">
                <div><span class="text-gray-500">Subtotal:</span> $${currency(discountedSubtotal)}</div>
                ${itemDiscount>0?`<div><span class="text-gray-500">Items discount:</span> <span class="text-green-300 font-semibold">-$${currency(itemDiscount)}</span></div>`:``}
                <div><span class="text-gray-500">Shipping:</span> ${hasFreeShip?`<span class="text-green-300 font-semibold">FREE</span>`:`$${currency(shippingCostSafe)}`}</div>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <p class="font-semibold text-gray-400 mb-2">Order Items:</p>
            <ul class="list-none space-y-2 text-sm">${itemsList || '<li class="text-gray-500 italic">No items.</li>'}</ul>
          </div>

          <div>
            <p class="font-semibold text-gray-400 mb-2">Contact Info:</p>
            <div class="text-sm text-gray-500 space-y-1">
              <p><span class="font-medium">Name:</span> ${contact.fullName || 'Not Provided'}</p>
              <p><span class="font-medium">Email:</span> ${contact.email || 'Not Provided'}</p>
              <p><span class="font-medium">Phone:</span> ${contact.phone || 'Not Provided'}</p>
              <p><span class="font-medium">Address:</span> ${contact.shippingAddress || 'Not Provided'}</p>
            </div>
          </div>

          <div class="mt-4">
            <p class="font-semibold text-gray-400 mb-2">Tracking:</p>
            <div class="space-y-1">${trackingHtml}</div>
          </div>

        <div class="pt-10 bottom-4 right-4 flex space-x-2 items-end space-y-2">
          <button class="delete-order-card-btn btn-neon-red text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
            Delete
          </button>
          <button class="edit-order-btn btn-neon-lime text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
            Edit Order
          </button>
          <button class="resend-order-btn btn-neon-cyan text-xs px-3 py-1 rounded-lg" data-order-id="${order.id}">
            Resend Email
          </button>
        </div>

        </div>`;
        ordersContainer.insertAdjacentHTML('beforeend', card);
        const last=ordersContainer.lastElementChild;
        last.querySelectorAll('.copy-track').forEach(btn=>btn.addEventListener('click',()=>{ const v=btn.dataset.track||""; if(v) copyToClipboard(v); }));
      });

      updateFinancialUI(); renderInfographics();
    },(err)=>{
      console.error('Error listening to orders:',err);
      const ordersContainer=qs('orders-container'); const loading=qs('loading-orders');
      loading.style.display='none';
      ordersContainer.innerHTML = `<div class="text-center text-red-500 py-12"><p class="text-lg">An error occurred.</p><p class="text-sm mt-2">Check the console for more details.</p></div>`;
    });
  }

  function renderInfographics(){
    const placeholder=qs('infographic-placeholder');
    const m=qs('list-monthly-revenue'), c=qs('list-top-customers'), pr=qs('list-top-products-revenue'), pq=qs('list-top-products-quantity');
    m.innerHTML=''; c.innerHTML=''; pr.innerHTML=''; pq.innerHTML='';
    if(allOrdersCache.length===0){ placeholder.classList.remove('hidden'); return; }
    placeholder.classList.add('hidden');

    const monthly={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.timestamp){ const mo=o.timestamp.toDate().toLocaleString('en-US',{month:'short',year:'2-digit'}); monthly[mo]=(monthly[mo]||0)+(o.total||0);} });
    Object.keys(monthly).sort((a,b)=>{ const [ma,ya]=a.split(' '), [mb,yb]=b.split(' '); return new Date(`01 ${ma} 20${ya}`)-new Date(`01 ${mb} 20${yb}`); }).forEach(month=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${month}</span><span class="font-bold text-cyan-300">$${currency(monthly[month])}</span>`; m.appendChild(li);
    });

    const cust={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.contactInfo?.fullName){ const n=o.contactInfo.fullName; cust[n]=(cust[n]||0)+(o.total||0);} });
    Object.entries(cust).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; c.appendChild(li);
    });

    const prodRev={}; allOrdersCache.forEach(o=>{ if(o.paymentStatus==='Paid' && o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodRev[name]=(prodRev[name]||0)+((it.unitPrice||0)*(it.quantity||0)); }); } });
    Object.entries(prodRev).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,rev])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">$${currency(rev)}</span>`; pr.appendChild(li);
    });

    const prodQty={}; allOrdersCache.forEach(o=>{ if(o.items){ o.items.forEach(it=>{ const name=it.id || it.name || 'Unknown Item'; prodQty[name]=(prodQty[name]||0)+(it.quantity||0); }); } });
    Object.entries(prodQty).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([name,q])=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${name}</span><span class="font-bold text-cyan-300">${q} sold</span>`; pq.appendChild(li);
    });
  }

  /* Read-only order item element */
  function createOrderItemElement(item){
    const wrap=document.createElement('div');
    wrap.className='edit-order-item flex items-center gap-2 p-2 border border-gray-700 rounded-md';
    const label=item.id || item.name || 'Unknown Item';
    const nameSpan=document.createElement('span'); nameSpan.textContent=label; nameSpan.className='flex-1 text-gray-300 text-sm font-semibold truncate';
    const qtySpan=document.createElement('span'); qtySpan.className='text-gray-400 text-sm'; qtySpan.textContent=`Qty: ${item.quantity || 0}`;
    const priceSpan=document.createElement('span'); priceSpan.className='text-cyan-300 text-sm font-semibold'; priceSpan.textContent=`$${currency(item.unitPrice||0)}`;
    wrap.appendChild(nameSpan); wrap.appendChild(qtySpan); wrap.appendChild(priceSpan);
    // keep minimal datasets (no code)
    wrap.dataset.itemName = item.name || '';
    wrap.dataset.itemId   = item.id   || '';
    return wrap;
  }

  function openEditModal(orderData){
    qs('edit-order-id').value = orderData.id;
    qs('edit-contact-name').value = orderData.contactInfo?.fullName || '';
    qs('edit-order-total').value = orderData.total ?? 0;
    qs('edit-order-status').value = orderData.paymentStatus ?? 'Unpaid';
    const shippingCost = Number(orderData?.shippingCost ?? 0);
    const freeShip = (orderData?.promo?.type === 'free_shipping') || shippingCost === 0;
    const shipEl = document.getElementById('edit-shipping-display'); shipEl.textContent = freeShip ? 'FREE' : `$${currency(shippingCost)}`;

    const cont=qs('edit-order-items-list'); cont.innerHTML='';
    (orderData.items||[]).forEach(item=>cont.appendChild(createOrderItemElement(item)));

    const trackingArr = Array.isArray(orderData.tracking) ? orderData.tracking : [];
    setTrackingHidden(trackingArr); renderTrackingList(trackingArr);

    editOrderModal.classList.remove('hidden'); editOrderBackdrop.classList.remove('hidden');
    editOrderModal.classList.add('is-open'); editOrderBackdrop.classList.add('is-open');
  }
  function closeEditModal(){ editOrderModal.classList.remove('is-open'); editOrderBackdrop.classList.remove('is-open'); setTimeout(()=>{ editOrderModal.classList.add('hidden'); editOrderBackdrop.classList.add('hidden'); },300); }

  function handleAddTrackingEntry(){
    const carrierSel=qs('edit-track-carrier'); const numberInp=qs('edit-track-number');
    if(!carrierSel||!numberInp){ showModal('Tracking UI is not available in this view.'); return; }
    const carrier=carrierSel.value.trim(); const number=numberInp.value.trim();
    if(!carrier||!number){ showModal('Please select a carrier and enter a tracking number.'); return; }
    const t={ carrier, number, url:buildTrackingUrl(carrier,number), addedAt:new Date().toISOString() };
    const cur=readTrackingFromModal(); cur.push(t); setTrackingHidden(cur); renderTrackingList(cur); numberInp.value='';
  }

  // Save: only status, customer name, total (if changed), tracking; NO item changes, NO extra snapshot fields
  async function handleEditOrder(e){
    e.preventDefault();
    const orderId=qs('edit-order-id').value;
    const paymentStatus=qs('edit-order-status').value;
    const newCustomerName=qs('edit-contact-name').value.trim();
    const newTotal = Number(qs('edit-order-total').value || 0);

    if(!newCustomerName){ showModal('Customer name cannot be empty.'); return; }

    const existing = allOrdersCache.find(o=>o.id===orderId) || {};
    const existingShipping = Number(existing.shippingCost ?? 0);
    const newTracking = readTrackingFromModal ? readTrackingFromModal() : (existing.tracking || []);

    try{
      const orderRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
      await updateDoc(orderRef, {
        paymentStatus,
        'contactInfo.fullName': newCustomerName,
        total: Number.isFinite(newTotal)? newTotal : existing.total,
        shippingCost: existingShipping,   // preserve
        tracking: newTracking             // keep shipping feature (tracking)
        // NOTE: intentionally not touching items, subtotal, promo, or any extra fields
      });
      showModal('Order updated successfully!');
      closeEditModal();
    }catch(err){
      console.error('Error updating order:',err);
      showModal(`Failed to update order: ${err.message}`);
    }
  }

  /* Add Inventory Item */
  async function handleAddItem(e){
    e.preventDefault();
    const name=newItemNameInput.value.trim();
    const id=newItemIdInput.value.trim();
    const blend=newItemBlendInput.checked;
    const currentInventory=parseInt(newTotalKitsBoughtInput.value,10)*parseInt(newTotalVialsPerKitInput.value,10);
    const sellPricePerVial=parseFloat(newItemPriceInput.value);
    const totalVialWeight=parseFloat(newItemTotalVialWeightInput.value);
    const image=newItemImageInput.value.trim();
    const coa=newItemCoaInput.value.trim();
    const vialsSold=parseInt(newItemVialsSoldInput.value,10);

    const costPerKit=parseFloat(newCostPerKitInput.value);
    const totalKitsBought=parseInt(newTotalKitsBoughtInput.value,10);
    const totalVialsPerKit=parseInt(newTotalVialsPerKitInput.value,10);
    const purchaseDate=newPurchaseDateInput.value;

    if(!name || !id){ showModal('Item Name and ID are required.'); return; }
    if(isNaN(currentInventory)||currentInventory<0){ showModal('Initial Inventory must be a non-negative number.'); return; }
    if(isNaN(sellPricePerVial)||sellPricePerVial<0){ showModal('Sell Price must be a non-negative number.'); return; }
    if(isNaN(totalVialWeight)||totalVialWeight<0){ showModal('Total Vial Weight must be a non-negative number.'); return; }
    if(isNaN(vialsSold)||vialsSold<0){ showModal('Vials Sold must be a non-negative number.'); return; }
    if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
    if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
    if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials Per Kit must be a non-negative number.'); return; }
    if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

    const newCostEntry = { costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
    const newItem = { name, blend, currentInventory, sellPricePerVial, totalVialWeight, image: image||'N/A', coa: coa||'N/A', vialsSold, costHistory:[newCostEntry] };

    try{
      const itemRef = doc(db, INVENTORY_COLLECTION_PATH, id); // write at ID; no code field
      await setDoc(itemRef, newItem);
      showModal('New item added to inventory successfully!');
      addItemForm.reset();
    }catch(err){
      console.error('Error adding new item:',err);
      showModal(`Failed to add new item: ${err.message}`);
    }
  }

  /* Add Cost History */
async function handleNewCostHistory(e){
  e.preventDefault();
  const itemId=existingItemSelect.value;
  if(!itemId){ showModal('Please select an item from the dropdown.'); return; }

  const costPerKit=parseFloat(costPerKitInput.value);
  const totalKitsBought=parseInt(totalKitsBoughtInput.value,10);
  const totalVialsPerKit=parseInt(totalVialsPerKitInput.value,10);
  const purchaseDate=purchaseDateInput.value;
  const totalVialWeight=inventoryCache[itemId]?.totalVialWeight;

  if(isNaN(costPerKit)||costPerKit<0){ showModal('Cost Per Kit must be a non-negative number.'); return; }
  if(isNaN(totalKitsBought)||totalKitsBought<0){ showModal('Total Kits Bought must be a non-negative number.'); return; }
  if(isNaN(totalVialsPerKit)||totalVialsPerKit<0){ showModal('Total Vials per Kit must be a non-negative number.'); return; }
  if(!purchaseDate){ showModal('Purchase Date is required.'); return; }

  const newCostEntry={ costPerKit, purchaseDate, totalKitsBought, totalVialWeightInMg: totalVialWeight, totalVialsPerKit };
  const vialsToAdd = totalKitsBought * totalVialsPerKit;

  try{
    const itemRef=doc(db, INVENTORY_COLLECTION_PATH, itemId);
    await updateDoc(itemRef,{
      costHistory: arrayUnion(newCostEntry),
      currentInventory: increment(vialsToAdd)
    });
    showModal('New cost history added and inventory updated!');
    addCostForm.reset();
  }catch(err){
    console.error('Error adding new cost history:',err);
    showModal(`Failed to add new cost history: ${err.message}`);
  }
}

  /* Resend email (with tracking) */
  async function resendOrderEmailById(orderId,btn){
    const order=allOrdersCache.find(o=>o.id===orderId);
    if(!order){ showModal(`Order not found: ${orderId}`); return; }
    const items = Array.isArray(order.items)? order.items.map(i=>({ id:i?.id??"", name:i?.name??"", quantity:Number(i?.quantity??0), unitPrice:Number(i?.unitPrice??0) })) : [];
    const computedSubtotal = items.reduce((s,i)=>s+(Number(i.unitPrice)*Number(i.quantity)),0);
    const shipping = Number(order.shippingCost ?? 0);
    const total = Number(order.total ?? (computedSubtotal + shipping));
    const payloadOrder = {
      orderId: order.orderId || order.id,
      contactInfo: {
        fullName: order.contactInfo?.fullName ?? "",
        email: order.contactInfo?.email ?? "",
        phone: order.contactInfo?.phone ?? "",
        shippingAddress: order.contactInfo?.shippingAddress ?? ""
      },
      items,
      subtotal: Number(order.subtotal ?? computedSubtotal),
      shippingCost: shipping,
      total,
      paymentStatus: order.paymentStatus ?? "unpaid",
      timestampISO: (order.timestamp?.toDate?.() && order.timestamp.toDate().toISOString()) || new Date().toISOString(),
      tracking: (Array.isArray(order.tracking)?order.tracking:[]).map(t=>({ carrier:t.carrier||"", number:t.number||"", url:t.url||buildTrackingUrl(t.carrier,t.number) }))
    };

    const original=btn?.textContent; if(btn){ btn.disabled=true; btn.textContent="Resending..."; btn.classList.add("opacity-70","cursor-not-allowed"); }
    try{ await resendFn({ order: payloadOrder }); showModal(`Resent confirmation to ${payloadOrder.contactInfo.email}`); }
    catch(err){ console.error("Resend failed:",err); showModal(`Resend failed: ${err.message||"See console"}`); }
    finally{ if(btn){ btn.disabled=false; btn.textContent=original||"Resend Email"; btn.classList.remove("opacity-70","cursor-not-allowed"); } }
  }

  function openAddCostModal(){ addCostModal.classList.add('is-open'); }
  function closeAddCostModal(){ addCostModal.classList.remove('is-open'); }

  /* Events */
  function attachEventListeners(){
    qs('auth-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=qs('email').value; const password=qs('password').value;
      if(!isValidEmail(email)){ showModal('Please enter a valid email address.'); return; }
      try{ await signInWithEmailAndPassword(auth,email,password); showModal('Login successful!'); }
      catch(error){ console.error("Login failed:",error); let msg="Login failed. Check your credentials."; if(error.code==='auth/wrong-password') msg="Incorrect password. Please try again."; else if(error.code==='auth/user-not-found') msg="Admin user not found."; showModal(msg); }
    });

    qs('signout-btn').addEventListener('click', async ()=>{
      try{ await signOut(auth); showModal('Signed out successfully.'); }
      catch(error){ console.error("Sign out failed:",error); showModal(`Sign out failed: ${error.message}`); }
    });

    qs('close-modal-btn').addEventListener('click',()=>qs('alert-modal').classList.add('hidden'));

    qs('orders-container').addEventListener('click', (e)=>{
        // NEW: Delete button on card
      const delBtn = e.target.closest('.delete-order-card-btn');
      if (delBtn) {
        const orderId = delBtn.dataset.orderId;
        if (orderId) deleteOrderAndRollback(orderId, delBtn);
        return;
      }
      const editButton=e.target.closest('.edit-order-btn');
      if(editButton){ const orderId=editButton.dataset.orderId; const order=allOrdersCache.find(o=>o.id===orderId); if(order) openEditModal(order); return; }
      const resendButton=e.target.closest('.resend-order-btn');
      if(resendButton){ const orderId=resendButton.dataset.orderId; resendOrderEmailById(orderId,resendButton); }
    });

    if(editOrderForm) editOrderForm.addEventListener('submit', handleEditOrder);
    if(closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
    if(editOrderBackdrop) editOrderBackdrop.addEventListener('click', closeEditModal);

    if(addItemForm) addItemForm.addEventListener('submit', handleAddItem);
    if(addCostForm) addCostForm.addEventListener('submit', handleNewCostHistory);
    if(addCostBtn) addCostBtn.addEventListener('click', openAddCostModal);
    if(closeAddCostModalBtn) closeAddCostModalBtn.addEventListener('click', closeAddCostModal);

    const addTrackBtn=qs('edit-track-add-btn'); if(addTrackBtn) addTrackBtn.addEventListener('click', handleAddTrackingEntry);
  }

  /* ============================
 * Delete order from card (rollback inventory & vialsSold)
 * ============================ */
/* Delete order from card (NO inventory changes) */
async function deleteOrderAndRollback(orderId, buttonEl) {
  const order = allOrdersCache.find(o => o.id === orderId);
  if (!order) { showModal(`Order not found: ${orderId}`); return; }

  const prettyId = order.orderId || orderId;
  const ok = window.confirm(`Delete order ${prettyId}? This WILL redistribute inventory and update vialsSold.`);
  if (!ok) return;

  // UI: disable while working
  const originalText = buttonEl?.textContent;
  if (buttonEl) {
    buttonEl.disabled = true;
    buttonEl.textContent = "Deleting...";
    buttonEl.classList.add("opacity-70", "cursor-not-allowed");
  }

  try {
    // Redistribute inventory and update vialsSold
    if (Array.isArray(order.items)) {
      for (const item of order.items) {
        const inv = window._getInvFromOrderItem(item);
        if (!inv) continue;
        const qty = Number(item.quantity || 0);
        await updateDoc(doc(db, INVENTORY_COLLECTION_PATH, inv.id), {
          currentInventory: increment(qty),
          vialsSold: increment(-qty)
        });
      }
    }
    await deleteDoc(doc(db, ORDERS_COLLECTION_PATH, orderId));
    showModal(`Order ${prettyId} deleted and inventory updated.`);
  } catch (err) {
    console.error("Delete failed:", err);
    showModal(`Failed to delete order: ${err.message || "See console"}`);
  } finally {
    if (buttonEl) {
      buttonEl.disabled = false;
      buttonEl.textContent = originalText || "Delete";
      buttonEl.classList.remove("opacity-70", "cursor-not-allowed");
    }
  }
}



  window.addEventListener('load', ()=>{
    try{
      onAuthStateChanged(auth,(user)=>{ updateUI(user); });
      attachEventListeners();
    }catch(err){ console.error('Init failed:',err); qs('status').textContent=`Error: ${err.message}`; }
  });
  </script>
</body>
</html>
